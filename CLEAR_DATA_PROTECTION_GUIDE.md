# 🛡️ دليل حماية البيانات عند المسح

## 📋 نظرة عامة

هذا الملف يوضح آلية حماية المستخدمين عند عملية **مسح جميع البيانات** في نظام FinsPilot.

---

## 🔐 المستخدمون المحميون

### من يتم حمايته؟

عند تنفيذ عملية `perform_clear_all_data()` يتم حماية:

1. **جميع المستخدمين الـ Superusers** (`is_superuser=True`)
2. **المستخدم الذي قام بعملية المسح** (حتى لو لم يكن Superuser)

### الكود المسؤول (في `backup/views.py`):

```python
# حماية Superusers والمستخدم الحالي
deletable_users = User.objects.filter(
    is_superuser=False
).exclude(id=current_user_id)

# مسح المستخدمين العاديين فقط
cursor.execute(
    f'DELETE FROM "{table_name}" WHERE is_superuser = false AND id != %s;',
    [current_user_id] if current_user_id else [0]
)
```

---

## 🧪 السكريبت الاختباري: `test_comprehensive_backup.py`

### ماذا يفعل؟

1. **الخطوة 0**: أخذ نسخة احتياطية من PostgreSQL (أمان إضافي)
2. **الخطوة 1**: حساب البيانات الحالية
3. **الخطوة 2**: إنشاء نسخة احتياطية من خلال النظام
4. **الخطوة 3**: التحقق من محتوى النسخة
5. **الخطوة 3.5**: التأكد من وجود Superuser محمي
6. **الخطوة 4**: مسح جميع البيانات
7. **الخطوة 5**: التحقق من المسح (هل بقي المستخدم المحمي؟)
8. **الخطوة 6**: استعادة النسخة
9. **الخطوة 7**: حساب البيانات بعد الاستعادة
10. **الخطوة 8**: المقارنة الشاملة

---

## ✅ ماذا يتم التحقق منه في الخطوة 5؟

### 1. فحص المستخدمين المتبقين

```python
remaining_users = User.objects.all()
user_count = remaining_users.count()

if user_count == 0:
    # ❌ خطأ: تم مسح الجميع!
elif user_count == 1:
    # ✅ ممتاز: مستخدم واحد فقط
else:
    # ⚠️ تحذير: أكثر من مستخدم متبقي
```

### 2. فحص الجداول الحرجة

يتحقق من مسح:
- `customers.customersupplier` - العملاء والموردين
- `products.product` - المنتجات
- `sales.salesinvoice` - فواتير المبيعات
- `purchases.purchaseinvoice` - فواتير المشتريات
- `journal.journalentry` - القيود المحاسبية
- `journal.account` - الحسابات

### 3. تقييم نجاح المسح

- **المتوقع**: ~50 سجل متبقي (جداول Django الأساسية + المستخدم المحمي)
- **إذا أكثر من 100 سجل**: تحذير وعرض أكبر 10 جداول متبقية

---

## 📊 مثال على الإخراج المتوقع

```
الخطوة 5: التحقق من المسح...
السجلات المتبقية بعد المسح: 45

التحقق من حماية المستخدم الحالي...
✅ ممتاز: بقي مستخدم واحد فقط: test_admin (Superuser: True)

التحقق من الجداول الحرجة...
  ✅ customers.customersupplier: تم مسحه بالكامل
  ✅ products.product: تم مسحه بالكامل
  ✅ sales.salesinvoice: تم مسحه بالكامل
  ✅ purchases.purchaseinvoice: تم مسحه بالكامل
  ✅ journal.journalentry: تم مسحه بالكامل
  ✅ journal.account: تم مسحه بالكامل

✅ المسح ناجح: فقط 45 سجل متبقي (جداول النظام + المستخدم المحمي)
```

---

## 🚨 السيناريوهات المحتملة

### ✅ السيناريو المثالي

```
- البيانات الأصلية: 9,087 سجل
- بعد المسح: 45 سجل (1 Superuser + جداول Django)
- بعد الاستعادة: 9,591 سجل (105.55%)
```

### ⚠️ سيناريو التحذير

```
- البيانات الأصلية: 9,087 سجل
- بعد المسح: 250 سجل (أكثر من المتوقع)
- السبب: بعض الجداول لم تُمسح بالكامل
- الإجراء: فحص الجداول المتبقية وتحديد السبب
```

### ❌ سيناريو الخطأ

```
- البيانات الأصلية: 9,087 سجل
- بعد المسح: 0 سجل (تم مسح المستخدم المحمي!)
- السبب: خطأ في كود الحماية
- الإجراء: استعادة نسخة PostgreSQL فوراً
```

---

## 🔧 استخدام السكريبت

### التشغيل:

```bash
python test_comprehensive_backup.py
```

### التأكيد:

```
هل أنت متأكد تماماً من المتابعة؟ اكتب 'نعم متأكد' للمتابعة:
```

اكتب بالضبط: `نعم متأكد`

---

## 📁 الملفات الناتجة

1. **نسخة PostgreSQL**: `pg_backup_YYYYMMDD_HHMMSS.sql`
   - نسخة كاملة من قاعدة البيانات (أمان)
   - يمكن استعادتها بـ: `pg_restore -d FinsPilot pg_backup_*.sql`

2. **نسخة النظام**: `test_backup_YYYYMMDD_HHMMSS.json`
   - النسخة الاحتياطية من خلال النظام
   - يمكن استعادتها من واجهة `/ar/backup/`

3. **التقرير**: `backup_test_report_YYYYMMDD_HHMMSS.json`
   - تقرير مفصل بجميع الخطوات
   - يحتوي على الأخطاء والتحذيرات

---

## 🛡️ الإجراءات الاحترازية

### قبل التشغيل:

1. ✅ تأكد من وجود نسخة احتياطية خارجية
2. ✅ لا تشغل على بيئة الإنتاج مباشرة
3. ✅ جرب على بيئة اختبار أولاً
4. ✅ تأكد من وجود Superuser واحد على الأقل

### أثناء التشغيل:

1. 📊 راقب التقدم في الطرفية
2. ⚠️ لاحظ أي تحذيرات أو أخطاء
3. 📝 احفظ إخراج الطرفية للرجوع إليه

### بعد التشغيل:

1. ✅ تحقق من التقرير النهائي
2. ✅ قارن البيانات المستعادة
3. ✅ احتفظ بنسخة PostgreSQL لحين التأكد
4. ✅ راجع التحذيرات إن وجدت

---

## 🔍 استكشاف الأخطاء

### المشكلة: تم مسح المستخدم المحمي

**السبب**: خطأ في تمرير المستخدم لدالة `perform_clear_all_data()`

**الحل**: استعادة نسخة PostgreSQL:
```bash
pg_restore -U admin -d FinsPilot -c pg_backup_*.sql
```

### المشكلة: بيانات متبقية بعد المسح

**السبب**: بعض الجداول لها قيود foreign key محمية

**الحل**: فحص جدول `deletion_order` في `backup/views.py` وتعديل الترتيب

### المشكلة: فشل الاستعادة

**السبب**: تكرار في `entry_number` للقيود المحاسبية

**الحل**: الكود الجديد يحل هذه المشكلة تلقائياً (آخر commit)

---

## 📞 الدعم

للمزيد من المعلومات:
- راجع: `FIX_ENTRY_NUMBER_DUPLICATION.md`
- راجع: `FINAL_BACKUP_TEST_REPORT.md`
- راجع: `SAFE_RESTORE_GUIDE.md`

---

**تاريخ آخر تحديث**: 2025-10-06  
**الإصدار**: 2.0 (مع حماية المستخدمين المحسّنة)
