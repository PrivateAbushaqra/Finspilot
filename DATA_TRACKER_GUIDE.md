# 📊 دليل استخدام نظام تتبع البيانات - Data Tracker System

## 🎯 الهدف من النظام

تم إضافة نظام متقدم لتتبع وحفظ جميع البيانات التي يتم إرسالها من صفحة إنشاء القيد المحاسبي إلى الخادم. هذا النظام يساعدك على:

1. **فهم ما يتم إرساله بالضبط** - عرض جميع الحقول والقيم
2. **تتبع مسار البيانات** - معرفة أين تذهب البيانات بعد الضغط على "حفظ"
3. **الاحتفاظ بالسجل** - البيانات لا تُحذف بعد الإرسال أو إعادة التحميل
4. **تحليل المشاكل** - مراجعة البيانات المرسلة لحل أي مشاكل

---

## 📍 موقع النظام

يوجد النظام في صفحة إنشاء القيد المحاسبي:
```
http://127.0.0.1:8000/ar/journal/entries/create/
```

تجد لوحة التتبع **أسفل أزرار "إعادة تعيين" و "حفظ القيد"** مباشرة.

---

## 🖥️ مكونات لوحة التتبع

### 1️⃣ مؤشرات الحالة (في الأعلى)

- **الحالة (Status)**: 
  - 🟢 في الانتظار - لم يتم الإرسال بعد
  - 🟡 جاري الإرسال - جاري معالجة البيانات
  - ✅ نجح - تم الإرسال بنجاح
  - ❌ فشل - حدث خطأ

- **عدد المحاولات (Attempts)**: عدد مرات محاولة الإرسال

- **آخر محاولة (Last Try)**: وقت وتاريخ آخر محاولة إرسال

- **حجم البيانات (Data Size)**: حجم البيانات المرسلة بالكيلوبايت

### 2️⃣ التبويبات الأربعة

#### 📋 بيانات النموذج (Form Data)
- عرض جميع الحقول والقيم المرسلة بتنسيق سهل القراءة
- تلوين الحقول حسب نوعها:
  - 🏦 **أخضر**: حقول الحسابات (account)
  - 💰 **أزرق**: حقول المدين (debit)
  - 💸 **برتقالي**: حقول الدائن (credit)
  - 🗑️ **أحمر**: حقول الحذف (DELETE)
- تقسيم البيانات إلى أقسام:
  - معلومات القيد الأساسية
  - معلومات Formset
  - البنود الصالحة
  - جميع الحقول المرسلة

#### 💻 JSON
- عرض البيانات بصيغة JSON منسقة وملونة
- مفيد للمطورين والتحليل التقني
- يمكن نسخها واستخدامها في أدوات أخرى

#### 🌐 الشبكة (Network)
- معلومات الطلب (Request):
  - URL الخاص بالصفحة
  - الطريقة (Method): POST
  - نوع المحتوى (Content-Type)
  - وقت الإرسال
- معلومات الترويسة (Headers):
  - CSRF Token
  - User Agent

#### 📚 السجل (History)
- عرض جميع محاولات الإرسال السابقة
- لكل محاولة:
  - الحالة (نجح/فشل/معلق)
  - التاريخ والوقت
  - حجم البيانات
  - عدد الحقول
  - رسالة الخطأ (إن وجدت)
- يمكن الضغط على "عرض التفاصيل" لمراجعة أي محاولة سابقة

---

## 🔧 الأزرار والوظائف

### 🗑️ مسح السجل (Clear Log)
- يحذف جميع المحاولات السابقة من السجل
- يطلب تأكيد قبل الحذف
- مفيد عند البدء من جديد

### 📥 تصدير (Export)
- يحفظ جميع البيانات في ملف JSON
- اسم الملف: `journal-entry-submissions-{timestamp}.json`
- يمكن فتحه لاحقاً للمراجعة أو المشاركة

---

## 🚀 كيفية الاستخدام

### السيناريو 1: تتبع إرسال عادي
1. املأ بيانات القيد في النموذج
2. أضف البنود المطلوبة
3. اضغط على "حفظ القيد"
4. **انظر إلى لوحة التتبع**:
   - تظهر جميع البيانات المرسلة في تبويب "بيانات النموذج"
   - الحالة تتغير إلى "جاري الإرسال"
5. بعد ثانية واحدة، يتم الإرسال الفعلي
6. البيانات تبقى محفوظة حتى بعد إعادة تحميل الصفحة

### السيناريو 2: تحليل مشكلة
1. حاول إرسال قيد ولاحظ وجود خطأ
2. افتح تبويب "السجل" في لوحة التتبع
3. ابحث عن المحاولة الأخيرة (في الأعلى)
4. اضغط على "عرض التفاصيل"
5. راجع البيانات المرسلة في جميع التبويبات
6. ابحث عن:
   - حقول فارغة يجب أن تكون مملوءة
   - حقول account بدون قيمة
   - بنود غير متوازنة
   - أخطاء في الصيغة

### السيناريو 3: مقارنة محاولتين
1. افتح تبويب "السجل"
2. اضغط على "عرض التفاصيل" للمحاولة الأولى
3. انسخ البيانات من تبويب JSON
4. افتح المحاولة الثانية
5. قارن البيانات لإيجاد الاختلافات

### السيناريو 4: مشاركة البيانات مع المطور
1. اضغط على زر "تصدير"
2. يتم تحميل ملف JSON
3. أرسل الملف للمطور
4. المطور يمكنه فتحه ورؤية جميع التفاصيل

---

## 💾 التخزين المحلي (localStorage)

- البيانات تُحفظ في متصفحك في `localStorage`
- المفتاح: `journal_entry_submissions`
- يتم الاحتفاظ بآخر **20 محاولة** فقط
- البيانات تبقى حتى تقوم بمسحها يدوياً أو مسح بيانات المتصفح

---

## 🔍 فهم البيانات المعروضة

### حقول القيد الأساسية:
```
entry_number: رقم القيد
entry_date: تاريخ القيد
entry_type: نوع القيد (manual, automatic, etc.)
reference_type: نوع المرجع
reference_id: رقم المرجع
description: وصف القيد
```

### حقول Formset:
```
form-TOTAL_FORMS: إجمالي عدد النماذج (البنود)
form-INITIAL_FORMS: عدد النماذج الأولية
form-MIN_NUM_FORMS: الحد الأدنى للنماذج
form-MAX_NUM_FORMS: الحد الأقصى للنماذج
```

### حقول البند (لكل بند):
```
form-0-account: ID الحساب (مثل: 1, 2, 3)
form-0-account_search: اسم الحساب (للعرض فقط)
form-0-line_description: وصف البند
form-0-debit: المبلغ المدين
form-0-credit: المبلغ الدائن
form-0-DELETE: علامة الحذف (on/off)
form-0-id: ID البند (للتعديل)
```

---

## ⚠️ رسائل الخطأ الشائعة

### ❌ "يوجد بنود بها مبالغ ولكن بدون حساب محدد"
**السبب**: حقل `debit` أو `credit` ممتلئ ولكن حقل `account` فارغ

**الحل**: تأكد من تحديد حساب لكل بند يحتوي على مبلغ

### ⚠️ "لا توجد بنود صالحة للإرسال"
**السبب**: جميع البنود إما فارغة أو محذوفة

**الحل**: أضف بنداً واحداً على الأقل مع حساب ومبلغ

### ⚠️ "غير متوازن"
**السبب**: مجموع المدين لا يساوي مجموع الدائن

**الحل**: راجع المبالغ وتأكد من التوازن

---

## 🛠️ للمطورين

### الوصول إلى نظام التتبع في Console:
```javascript
// عرض السجل الكامل
DataTracker.getHistory()

// عرض المحاولة الحالية
DataTracker.currentSubmission

// حفظ محاولة يدوياً
DataTracker.saveSubmission({
    formData: {...},
    status: 'test',
    error: 'رسالة خطأ'
})

// مسح السجل
DataTracker.clear()

// تصدير البيانات
DataTracker.export()
```

### هيكل البيانات المحفوظة:
```javascript
{
    id: 1698234567890,           // Timestamp
    timestamp: "2025-10-25T...", // ISO String
    formData: {                  // جميع حقول النموذج
        entry_number: "...",
        "form-0-account": "1",
        // ... باقي الحقول
    },
    status: "success",           // pending/submitted/success/error
    url: "http://...",          // URL الصفحة
    method: "POST",             // HTTP Method
    size: 1234,                 // حجم البيانات بالبايت
    response: null,             // استجابة الخادم (إن وجدت)
    error: null                 // رسالة الخطأ (إن وجدت)
}
```

---

## 📝 ملاحظات مهمة

1. **البيانات محلية**: تُحفظ في متصفحك فقط ولا تُرسل لأي مكان آخر
2. **الخصوصية**: البيانات تبقى على جهازك
3. **التنظيف**: يُحفظ آخر 20 محاولة فقط تلقائياً
4. **التوافق**: يعمل مع جميع المتصفحات الحديثة
5. **الأداء**: لا يؤثر على سرعة الصفحة

---

## 🆘 الدعم

إذا واجهت أي مشاكل:
1. افتح Console المتصفح (F12)
2. ابحث عن رسائل الخطأ باللون الأحمر
3. صدّر البيانات وشاركها مع الفريق التقني
4. تحقق من علامة التبويب "Network" في أدوات المطور

---

## ✅ الخلاصة

نظام تتبع البيانات يوفر لك:
- ✅ رؤية كاملة لجميع البيانات المرسلة
- ✅ تتبع مسار البيانات من النموذج إلى الخادم
- ✅ حفظ دائم للسجل حتى بعد إعادة التحميل
- ✅ أدوات تحليل وتصدير متقدمة
- ✅ مساعدة فعالة في حل المشاكل

**الآن يمكنك معرفة بالضبط ما يحدث لبياناتك!** 🎉
