# توثيق: إدارة الرصيد الافتتاحي للمنتجات

## نظرة عامة

تم تطوير نظام إدارة الرصيد الافتتاحي للمنتجات وفقاً للمعايير الدولية لإعداد التقارير المالية (IFRS).

## المعايير الدولية المطبقة

### 1. IAS 2 - المخزون (Inventories)
- يتم قياس المخزون بالتكلفة أو صافي القيمة القابلة للتحقق، أيهما أقل
- يتم الاعتراف بالمخزون كأصل متداول
- يتم قياس التكلفة عند الاعتراف الأولي

### 2. IAS 1 - عرض القوائم المالية (Presentation of Financial Statements)
- يتم تصنيف المخزون ضمن الأصول المتداولة
- الرصيد الافتتاحي يؤثر على حقوق الملكية
- يتم عرض التغييرات في حقوق الملكية بشكل منفصل

## الوظائف الرئيسية

### 1. إنشاء منتج جديد مع رصيد افتتاحي

عند إنشاء منتج جديد مع رصيد افتتاحي، يقوم النظام بالتالي:

#### أ. إنشاء حركة مخزون
- النوع: وارد (in)
- نوع المرجع: opening_balance
- الكمية: كمية الرصيد الافتتاحي
- تكلفة الوحدة: تكلفة الرصيد / الكمية
- التكلفة الإجمالية: تكلفة الرصيد الافتتاحي
- المستودع: المستودع المحدد للرصيد الافتتاحي

#### ب. إنشاء قيد محاسبي
```
من ح/ المخزون (1501) - مدين
إلى ح/ حقوق الملكية (301) - دائن
المبلغ: تكلفة الرصيد الافتتاحي
```

#### ج. تسجيل في سجل الأنشطة
- يتم تسجيل جميع العمليات في سجل الأنشطة (Audit Log)
- يتم تتبع المستخدم والتاريخ والوقت

### 2. تحديث الرصيد الافتتاحي لمنتج موجود

عند تحديث الرصيد الافتتاحي لمنتج موجود، يقوم النظام بالتالي:

#### أ. فحص التغييرات
يتحقق النظام من حدوث تغيير في:
- كمية الرصيد الافتتاحي
- تكلفة الرصيد الافتتاحي
- المستودع المحدد

#### ب. حذف البيانات القديمة
إذا حدث تغيير:
1. حذف حركة المخزون القديمة للرصيد الافتتاحي
2. حذف القيد المحاسبي القديم المرتبط
3. حذف أطراف القيد القديمة
4. تحديث أرصدة الحسابات المتأثرة

#### ج. إنشاء بيانات جديدة
1. إنشاء حركة مخزون جديدة بالبيانات المحدثة
2. إنشاء قيد محاسبي جديد
3. إنشاء أطراف القيد الجديدة
4. تحديث أرصدة الحسابات

#### د. تسجيل التغييرات
- تسجيل حذف البيانات القديمة في سجل الأنشطة
- تسجيل إنشاء البيانات الجديدة في سجل الأنشطة

### 3. حساب المخزون الحالي

يتم حساب المخزون الحالي بالطريقة التالية:
```
المخزون الحالي = (الكميات الواردة - الكميات الصادرة) + الرصيد الافتتاحي
```

ملاحظات:
- يتم استبعاد حركات الرصيد الافتتاحي من الكميات الواردة لتجنب المضاعفة
- يتم إضافة الرصيد الافتتاحي بشكل منفصل

### 4. حساب المخزون في مستودع معين

```python
def get_stock_in_warehouse(self, warehouse):
    # الكميات الواردة في المستودع (ما عدا الرصيد الافتتاحي)
    incoming = الكميات_الواردة_في_المستودع
    
    # الكميات الصادرة من المستودع
    outgoing = الكميات_الصادرة_من_المستودع
    
    # إضافة الرصيد الافتتاحي إذا كان هذا هو مستودع الرصيد
    opening_balance = self.opening_balance_quantity if self.opening_balance_warehouse == warehouse else 0
    
    return (incoming - outgoing) + opening_balance
```

## الحسابات المحاسبية المطلوبة

لضمان عمل النظام بشكل صحيح، يجب توفر الحسابات التالية:

| كود الحساب | اسم الحساب | النوع | الوصف |
|------------|------------|-------|--------|
| 1501 | المخزون | أصل متداول | حساب المخزون الرئيسي |
| 301 | رأس المال / الأرباح المحتجزة | حقوق ملكية | حساب حقوق الملكية |

## التحقق من صحة البيانات

### عند الإنشاء:
1. الرصيد الافتتاحي يجب أن يكون >= 0
2. تكلفة الرصيد الافتتاحي يجب أن تكون >= 0
3. إذا كان الرصيد > 0، يجب تحديد المستودع
4. المستودع المحدد يجب أن يكون نشطاً

### عند التحديث:
1. نفس قواعد التحقق السابقة
2. يتم التحقق من التغييرات قبل المعالجة
3. يتم التأكد من حذف البيانات القديمة قبل إنشاء الجديدة

## الأمثلة

### مثال 1: إنشاء منتج جديد

```python
product = Product.objects.create(
    code='PROD-001',
    name='منتج تجريبي',
    category=category,
    product_type='physical',
    sale_price=100.000,
    opening_balance_quantity=50.000,
    opening_balance_cost=2500.000,  # 50 * 50
    opening_balance_warehouse=warehouse,
    is_active=True
)
```

النتيجة:
- حركة مخزون: 50 وحدة بتكلفة 2500
- قيد محاسبي: مدين المخزون 2500، دائن حقوق الملكية 2500
- المخزون الحالي: 50 وحدة

### مثال 2: تحديث الرصيد الافتتاحي

```python
# تحديث من خلال واجهة التحديث
product.opening_balance_quantity = 100.000
product.opening_balance_cost = 6000.000
product.save()
```

النتيجة:
- حذف الحركة القديمة (50 وحدة)
- حذف القيد القديم (2500)
- إنشاء حركة جديدة (100 وحدة بتكلفة 6000)
- إنشاء قيد جديد (مدين 6000، دائن 6000)
- المخزون الحالي: 100 وحدة

## الاختبار

تم اختبار النظام للتأكد من:
1. ✓ إنشاء حركة المخزون بشكل صحيح
2. ✓ إنشاء القيد المحاسبي بشكل صحيح
3. ✓ توازن القيد المحاسبي
4. ✓ حساب المخزون الحالي بشكل صحيح
5. ✓ تحديث الرصيد الافتتاحي بشكل صحيح
6. ✓ حذف البيانات القديمة عند التحديث
7. ✓ تسجيل جميع العمليات في سجل الأنشطة
8. ✓ التوافق مع IFRS (IAS 1 و IAS 2)

## الملاحظات المهمة

1. **المنتجات الخدمية**: لا يتم إنشاء حركات مخزون أو قيود محاسبية للمنتجات الخدمية
2. **التكرار**: النظام يمنع التكرار عن طريق حذف البيانات القديمة أولاً
3. **الأمان**: جميع العمليات مسجلة في Audit Log
4. **المستودعات**: لا يمكن استخدام المستودع الرئيسي (MAIN) للرصيد الافتتاحي
5. **الترجمة**: جميع الرسائل مترجمة وجاهزة للعرض بالعربية والإنجليزية

## استعلامات مفيدة

### الحصول على جميع المنتجات بها رصيد افتتاحي
```python
products = Product.objects.filter(opening_balance_quantity__gt=0).exclude(product_type='service')
```

### فحص حركات الرصيد الافتتاحي لمنتج
```python
movements = InventoryMovement.objects.filter(
    product=product,
    reference_type='opening_balance'
)
```

### فحص القيود المحاسبية للرصيد الافتتاحي
```python
entries = JournalEntry.objects.filter(
    description__icontains='رصيد افتتاحي'
)
```

## الصيانة

### حذف القيود المكررة
إذا حدث تكرار في القيود المحاسبية، يمكن تشغيل السكريبت التالي:

```python
from journal.models import JournalEntry, JournalLine
from django.db.models import Count

# البحث عن القيود المكررة
duplicate_entries = JournalEntry.objects.filter(
    description__icontains='رصيد افتتاحي'
).values('description', 'total_amount').annotate(
    count=Count('id')
).filter(count__gt=1)

# حذف القيود الإضافية
for dup in duplicate_entries:
    entries = JournalEntry.objects.filter(
        description=dup['description'],
        total_amount=dup['total_amount']
    ).order_by('id')
    
    # حذف كل القيود ما عدا الأول
    for entry in entries[1:]:
        JournalLine.objects.filter(journal_entry=entry).delete()
        entry.delete()
```

## المراجع

- IAS 2: Inventories - https://www.ifrs.org/issued-standards/list-of-standards/ias-2-inventories/
- IAS 1: Presentation of Financial Statements - https://www.ifrs.org/issued-standards/list-of-standards/ias-1-presentation-of-financial-statements/

---

**تاريخ آخر تحديث**: 15 أكتوبر 2025  
**الإصدار**: 1.0  
**الحالة**: تم الاختبار والتوثيق
