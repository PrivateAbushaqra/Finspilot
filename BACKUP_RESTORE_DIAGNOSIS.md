# تشخيص مشكلة النسخ الاحتياطي والاستعادة

## ملخص المشكلة

المستخدم أخذ نسخة احتياطية من الجهاز المحلي ورفعها على الريموت (Render.com)، وعند الاستعادة:
- ✅ عملية الرفع تكتمل بنجاح
- ❌ لا تظهر أي بيانات بعد الاستعادة

## نتائج الاختبار المحلي

### 1. اختبار إنشاء النسخة الاحتياطية
```
✅ إجمالي السجلات في قاعدة البيانات: 9,013 سجل
✅ إجمالي السجلات في النسخة الاحتياطية: 8,932 سجل
✅ النسخة الاحتياطية تحتوي على بيانات صحيحة
```

### 2. اختبار الاستعادة المحلية
```
✅ عملية الاستعادة تعمل بنجاح
✅ البيانات تُستعاد بشكل صحيح
```

## تشخيص السبب المحتمل

بما أن النسخة الاحتياطية تعمل محلياً بشكل صحيح، فالمشكلة على الأرجح في البيئة الريموت (Render.com):

### احتمالات المشكلة:

#### 1. ❌ مشكلة في الاستعادة على الريموت
**الأسباب المحتملة:**
- قاعدة البيانات PostgreSQL على الريموت قد لا تكون فارغة قبل الاستعادة
- وجود تضاربات في Foreign Keys بسبب بيانات قديمة
- السجلات يتم إنشاؤها لكن Signals تسبب أخطاء وتتراجع العملية (Rollback)
- عدم وجود صلاحيات كافية للمستخدم على الريموت
- مشاكل في sequences الخاصة بـ PostgreSQL

#### 2. ✅ مشكلة في عرض البيانات بعد الاستعادة
**الأسباب المحتملة:**
- البيانات موجودة فعلاً لكن هناك مشكلة في عرضها
- Cache لم يتم تحديثه بعد الاستعادة
- الجلسة (Session) لم تُحدّث بعد الاستعادة
- صلاحيات العرض تمنع رؤية البيانات

#### 3. ⚠️ مشكلة في رفع الملف
**الأسباب المحتملة:**
- حجم الملف كبير جداً (قد يتجاوز حدود Render)
- المهلة الزمنية (Timeout) للطلب تنتهي قبل إكمال الرفع
- الملف يتلف أثناء الرفع

## الحلول الموصى بها

### الحل 1: التحقق من وجود البيانات على الريموت

قم بتنفيذ هذا الكود على الريموت (عبر Django Shell):

```python
from django.apps import apps

# حساب عدد السجلات
total = 0
for app_config in apps.get_app_configs():
    for model in app_config.get_models():
        try:
            count = model.objects.count()
            if count > 0:
                print(f'{model._meta.label}: {count} سجل')
                total += count
        except:
            pass

print(f'إجمالي السجلات: {total}')
```

**التفسير:**
- ✅ إذا ظهرت أرقام كبيرة: **البيانات موجودة** والمشكلة في العرض
- ❌ إذا كانت الأرقام صفر: **المشكلة في الاستعادة**

### الحل 2: مسح البيانات قبل الاستعادة

على الريموت، قبل استعادة النسخة الاحتياطية:

1. **انتقل إلى صفحة النسخ الاحتياطي**
2. **فعّل خيار "مسح جميع البيانات قبل الاستعادة"** ☑️
3. **قم برفع النسخة الاحتياطية**

**السبب:** قد تكون هناك تضاربات مع بيانات قديمة موجودة.

### الحل 3: التحقق من سجلات الأخطاء (Logs)

على Render.com:

1. انتقل إلى **Dashboard → Your Service → Logs**
2. ابحث عن أخطاء أثناء عملية الاستعادة
3. ابحث عن كلمات مثل:
   - `FK_NOT_FOUND` (Foreign Key غير موجود)
   - `UNIQUE constraint` (تضارب في المفاتيح الفريدة)
   - `IntegrityError` (خطأ في سلامة البيانات)
   - `ROLLBACK` (تراجع عن العملية)

### الحل 4: استخدام صيغة XLSX بدلاً من JSON

إذا كان حجم ملف JSON كبير:

1. أنشئ نسخة احتياطية بصيغة **XLSX (Excel)**
2. حجم ملف Excel عادة أصغر
3. قد يكون الرفع أسرع

### الحل 5: إعادة تعيين Sequences بعد الاستعادة

إذا تمت الاستعادة لكن لا يمكن إضافة بيانات جديدة:

قم بتنفيذ هذا على الريموت (عبر Django Shell):

```python
from django.db import connection

def reset_all_sequences():
    with connection.cursor() as cursor:
        # جلب جميع الجداول
        cursor.execute("""
            SELECT tablename FROM pg_tables 
            WHERE schemaname = 'public'
        """)
        tables = cursor.fetchall()
        
        for table in tables:
            table_name = table[0]
            try:
                # إعادة تعيين sequence
                cursor.execute(f"""
                    SELECT setval(
                        pg_get_serial_sequence('{table_name}', 'id'),
                        COALESCE(MAX(id), 1),
                        true
                    ) FROM {table_name};
                """)
                print(f'✅ {table_name}')
            except:
                pass

reset_all_sequences()
print('تم إعادة تعيين جميع الـ sequences')
```

### الحل 6: فحص صلاحيات المستخدم

تأكد من أن المستخدم الذي يقوم بالاستعادة:
- ✅ لديه صلاحيات Superuser
- ✅ لديه صلاحيات الكتابة على قاعدة البيانات
- ✅ مسجل دخول بشكل صحيح

## خطوات التشخيص الموصى بها

### الخطوة 1: التحقق الأولي
```bash
# على الريموت، نفّذ:
python manage.py shell -c "
from django.contrib.auth import get_user_model;
User = get_user_model();
print(f'Users: {User.objects.count()}');
from sales.models import SalesInvoice;
print(f'Sales Invoices: {SalesInvoice.objects.count()}');
from products.models import Product;
print(f'Products: {Product.objects.count()}');
"
```

### الخطوة 2: فحص سجلات الاستعادة
```bash
# على الريموت، افحص آخر سجلات الاستعادة:
python manage.py shell -c "
from core.models import AuditLog;
recent = AuditLog.objects.filter(
    action_type__icontains='restore'
).order_by('-timestamp')[:10];
for log in recent:
    print(f'{log.timestamp}: {log.action_type} - {log.description}');
"
```

### الخطوة 3: محاولة استعادة بسيطة
1. أنشئ نسخة احتياطية صغيرة (فقط المستخدمين والإعدادات)
2. جرّب استعادتها على الريموت
3. إذا نجحت، المشكلة قد تكون في حجم البيانات أو وقت المعالجة

## معلومات إضافية

### حجم النسخة الاحتياطية
- النسخة المحلية تحتوي على **8,932 سجل**
- أكبر جدول: `core.AuditLog` (3,122 سجل)
- ثاني أكبر جدول: `journal.JournalLine` (1,884 سجل)

### التحسينات المطبقة
- ✅ تم إصلاح مشكلة `user.username` عندما يكون المستخدم `None`
- ✅ السيجنالات لا تعمل أثناء الاستعادة (تم تفعيل `is_restoring()`)
- ✅ معالجة أخطاء Foreign Keys المفقودة
- ✅ معالجة أخطاء Atomic Block في AuditLog

## الخلاصة

✅ **النسخة الاحتياطية صحيحة وتعمل محلياً**
✅ **عملية الاستعادة تعمل محلياً**
❓ **المشكلة على الأرجح في البيئة الريموت (Render.com)**

**التوصية الرئيسية:**
1. فعّل خيار "مسح البيانات قبل الاستعادة"
2. افحص سجلات الأخطاء على Render
3. تأكد من أن المستخدم لديه صلاحيات Superuser
4. جرّب استعادة نسخة صغيرة أولاً

إذا استمرت المشكلة، يرجى مشاركة:
- سجلات الأخطاء من Render Logs
- نتيجة اختبار عدد السجلات (الخطوة 1 في التشخيص)
- لقطة شاشة من عملية الاستعادة
