# شرح المشكلة والحل - التوافق مع IFRS

## السؤال الأصلي

> **في صفحة القيد رقم "JE-000122"، لماذا استخدم حساب الأب وليس الابن كما هو متبع ليطابق المعايير الدولية لإعداد التقارير المالية (IFRS)؟**

## الجواب التفصيلي

### 1. المبدأ الأساسي في IFRS

حسب **المعايير الدولية لإعداد التقارير المالية (IFRS)**، يجب أن يكون دليل الحسابات هرمياً:

```
الحساب الرئيسي (Parent Account)
├── الحساب الفرعي 1 (Child Account)
├── الحساب الفرعي 2 (Child Account)
└── الحساب الفرعي 3 (Child Account)
```

**القاعدة الذهبية:**
- ✅ **الترحيل في القيود اليومية**: يجب أن يكون على **الحسابات الفرعية فقط**
- ❌ **الحسابات الرئيسية**: للتجميع والعرض في التقارير المالية فقط

### 2. المشكلة التي تم اكتشافها

عند فحص الكود، وجدنا أن النظام كان ينشئ حسابات **بدون حساب أب**، مثل:

```python
# ❌ قبل التصحيح
account = Account.objects.create(
    code='101',
    name='النقد في الصندوق',
    account_type='asset',
    # لا يوجد parent!
)
```

هذا يعني أن الحساب `101` كان حساباً رئيسياً (ليس له أب)، وبالتالي:
- إذا تم استخدامه في القيود اليومية ← **مخالفة لـ IFRS** ❌
- لا توجد بنية هرمية واضحة للحسابات

### 3. الحل المطبق

تم تعديل جميع دوال إنشاء الحسابات لتضمين حساب أب:

```python
# ✅ بعد التصحيح
# أولاً: إنشاء الحساب الأب
parent_account, _ = Account.objects.get_or_create(
    code='10',
    defaults={
        'name': 'النقد وما في حكمه',
        'account_type': 'asset',
        'description': 'حساب رئيسي للنقد - حسب IFRS'
    }
)

# ثانياً: إنشاء الحساب الفرعي مع ربطه بالأب
account = Account.objects.create(
    code='101',
    name='النقد في الصندوق',
    account_type='asset',
    parent=parent_account,  # ✅ الحساب له أب الآن
)
```

### 4. ضمان عدم استخدام الحسابات الرئيسية في القيود

النظام لديه آليات حماية مدمجة:

#### في `journal/forms.py`:
```python
self.fields['account'].queryset = Account.objects.filter(
    is_active=True,
    parent__isnull=False  # ✅ فقط الحسابات الفرعية
).order_by('code')
```

#### في `journal/views.py`:
```python
'accounts': Account.objects.filter(
    is_active=True,
    parent__isnull=False  # ✅ فقط الحسابات الفرعية
).order_by('code')
```

**هذا يعني:**
- المستخدمون **لا يمكنهم** اختيار الحسابات الرئيسية في القيود
- فقط الحسابات الفرعية تظهر في القوائم المنسدلة

### 5. مثال عملي

#### البنية الهرمية للحسابات البنكية:

```
102 - الحسابات البنكية (حساب رئيسي - Parent)
├── 102000001 - البنك الأهلي (حساب فرعي - Child) ✅
├── 102000002 - بنك الرياض (حساب فرعي - Child) ✅
└── 102000003 - بنك الراجحي (حساب فرعي - Child) ✅
```

#### عند إنشاء قيد محاسبي:
- ❌ **خطأ**: استخدام الحساب `102` (الحساب الرئيسي)
- ✅ **صحيح**: استخدام الحساب `102000001` (الحساب الفرعي)

#### في التقارير المالية:
```
الميزانية العمومية
│
├── الأصول
│   ├── الأصول المتداولة
│   │   ├── النقد وما في حكمه: 100,000 ريال
│   │   │   ├── النقد في الصندوق: 10,000 ريال
│   │   │   └── الحسابات البنكية: 90,000 ريال
│   │   │       ├── البنك الأهلي: 30,000 ريال
│   │   │       ├── بنك الرياض: 40,000 ريال
│   │   │       └── بنك الراجحي: 20,000 ريال
```

### 6. الفرق بين الحساب الرئيسي والحساب الفرعي

| الميزة | الحساب الرئيسي (Parent) | الحساب الفرعي (Child) |
|--------|-------------------------|----------------------|
| **الترحيل في القيود** | ❌ ممنوع | ✅ مسموح |
| **الغرض** | التجميع والعرض | التسجيل والترحيل |
| **الرصيد** | مجموع أرصدة الفروع | رصيد حقيقي من القيود |
| **التقارير** | يظهر كعنوان رئيسي | يظهر كبند تفصيلي |

### 7. لماذا هذا مهم؟

1. **التوافق مع IFRS**: المعايير الدولية تتطلب بنية هرمية واضحة
2. **دقة التقارير**: تجميع الحسابات بشكل صحيح
3. **سهولة التدقيق**: المدققون يتوقعون بنية محاسبية قياسية
4. **المرونة**: إضافة حسابات جديدة تحت نفس المجموعة
5. **الوضوح**: فهم أفضل للقوائم المالية

### 8. الحسابات المتأثرة بالتحديث

تم تحديث **11 دالة** في `journal/services.py`:

1. ✅ `get_cash_account()` - النقد في الصندوق
2. ✅ `get_purchases_account()` - المشتريات
3. ✅ `get_tax_receivable_account()` - ضريبة القيمة المضافة المدخلة
4. ✅ `get_or_create_supplier_account()` - حسابات الموردين (3 دوال)
5. ✅ `get_or_create_customer_account()` - حسابات العملاء
6. ✅ `get_inventory_account()` - المخزون
7. ✅ `get_cogs_account()` - تكلفة البضاعة المباعة
8. ✅ `get_or_create_bank_account()` - الحسابات البنكية
9. ✅ `get_sales_account()` - المبيعات
10. ✅ `get_sales_discount_account()` - خصم المبيعات
11. ✅ `get_or_create_expense_account()` - المصاريف العامة

### 9. ماذا عن القيود الموجودة؟

- **القيود الحالية**: لن تتأثر بالتحديث
- **القيود الجديدة**: ستستخدم الحسابات الفرعية تلقائياً
- **التوصية**: مراجعة القيود القديمة وتصحيح أي حسابات رئيسية مستخدمة

### 10. خلاصة الإجابة على سؤالك

> **"لماذا استخدم حساب الأب وليس الابن؟"**

**الجواب القصير:**  
إذا تم استخدام حساب أب (رئيسي) في قيد محاسبي، فهذا **خطأ** ويخالف IFRS. يجب استخدام الحساب الفرعي فقط.

**الجواب المفصل:**  
النظام الآن محدّث ليمنع هذا الخطأ تماماً:
1. ✅ جميع الحسابات الجديدة لها حساب أب
2. ✅ النماذج تمنع اختيار الحسابات الرئيسية
3. ✅ فقط الحسابات الفرعية تظهر في القيود

---

## التوصيات النهائية

1. **مراجعة القيد "JE-000122"**: تأكد من أنه يستخدم الحسابات الفرعية
2. **تحديث قاعدة البيانات**: إذا كانت هناك حسابات بدون أب، أضف لها حسابات رئيسية
3. **التدريب**: تأكد من فهم المستخدمين للفرق بين الحسابات الرئيسية والفرعية
4. **المراقبة**: راقب القيود الجديدة للتأكد من التزامها بالمعايير

---

**تم إعداد هذا التقرير بواسطة**: GitHub Copilot  
**التاريخ**: 8 نوفمبر 2025  
**الحالة**: ✅ جاهز للتنفيذ
