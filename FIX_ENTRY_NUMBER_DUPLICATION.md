# ุฅุตูุงุญ ูุดููุฉ ุชูุฑุงุฑ entry_number ูู ุงููููุฏ ุงููุญุงุณุจูุฉ

## ุงูุชุงุฑูุฎ: 6 ุฃูุชูุจุฑ 2025

---

## ๐ด ุงููุดููุฉ

ุนูุฏ ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ ูุงู ุงููุธุงู ูุญุงูู ุฅูุดุงุก ูููุฏ ูุญุงุณุจูุฉ (`JournalEntry`) ุจููุณ ุฃุฑูุงู ุงููููุฏ (`entry_number`) ุงูููุฌูุฏุฉ ูุณุจูุงูุ ููุง ูุคุฏู ุฅูู:

```
duplicate key value violates unique constraint "journal_journalentry_entry_number_key"
DETAIL: Key (entry_number)=(JE-2025-0040) already exists.
```

### ุงูุชุฃุซูุฑ:
- โ ูุดู ุงุณุชุนุงุฏุฉ ~440 ููุฏ ูุญุงุณุจู ูู ุฃุตู 804
- โ๏ธ ุฑุณุงุฆู ุฎุทุฃ ูุซูุฑุฉ ูู ุงูุณุฌูุงุช
- โ๏ธ ุณุทูุฑ ุงููููุฏ (JournalLine) ุชูุฑุจุท ุจูููุฏ ุจุฏููุฉ

---

## โ ุงูุญู ุงููุทุจู

### 1. ุงูุชุดุงู ุงูุชูุฑุงุฑ ูุจู ุงูุงุณุชุนุงุฏุฉ

ุชู ุฅุถุงูุฉ ูุญุต ุฎุงุต ููููุฐุฌ `journal.JournalEntry`:

```python
elif model._meta.label == 'journal.JournalEntry':
    # ๐ง ุญู ูุดููุฉ ุชูุฑุงุฑ entry_number
    # ุฅุฐุง ูุงู entry_number ููุฌูุฏ ูุณุจูุงูุ ููููุฏ ุฑูู ุฌุฏูุฏ
    entry_number = record_data.get('entry_number')
    if entry_number:
        from journal.models import JournalEntry
        if JournalEntry.objects.filter(entry_number=entry_number).exists():
            # ุงูุฑูู ููุฌูุฏุ ูุญุฐูู ููุชุฑู ุงููุธุงู ูููุฏ ุฑูู ุฌุฏูุฏ
            logger.debug(f"โ๏ธ entry_number ููุฑุฑ: {entry_number}ุ ุณูุชู ุชูููุฏ ุฑูู ุฌุฏูุฏ")
            record_data.pop('entry_number', None)
```

### 2. ุงุณุชุฎุฏุงู ุฏุงูุฉ `save()` ูุชูููุฏ ุงูุฑูู ุชููุงุฆูุงู

ุนูุฏ ุฅูุดุงุก ุฃู ุชุญุฏูุซ `JournalEntry`ุ ูุชู ุงูุขู:

```python
if model._meta.label == 'journal.JournalEntry' and pk_value:
    try:
        # ูุญุงููุฉ ุงูุญุตูู ุนูู ุงูููุฏ ุงูููุฌูุฏ
        obj = model.objects.get(pk=pk_value)
        # ุชุญุฏูุซ ุงูุญููู (ูุงุนุฏุง entry_number)
        for k, v in cleaned_data.items():
            if k != 'pk' and k != 'entry_number':
                setattr(obj, k, v)
        obj.save()
        created = False
    except model.DoesNotExist:
        # ุงูููุฏ ุบูุฑ ููุฌูุฏุ ููุดุฆ ูุงุญุฏ ุฌุฏูุฏ ุจุฏูู entry_number
        data_without_entry_number = {k: v for k, v in cleaned_data.items() 
                                     if k not in ['pk', 'entry_number']}
        obj = model(**data_without_entry_number)
        obj.save()  # ุณูููุฏ entry_number ุชููุงุฆูุงู ูู generate_entry_number()
        created = True
```

### 3. ุขููุฉ ุงูุชูููุฏ ุงูุฐููุฉ

ูููุฐุฌ `JournalEntry` ูุฏูู ุฏุงูุฉ `generate_entry_number()` ุงูุชู:

1. ุชุจุญุซ ุนู ุฌููุน ุงูุฃุฑูุงู ุงููุณุชุฎุฏูุฉ ูู ููุณ ุงูุณูุฉ
2. ุชุฌุฏ ุฃุตุบุฑ ุฑูู ูุชุงุญ
3. ุชุถูู ุนุฏู ุงูุชูุฑุงุฑ

```python
def generate_entry_number(self):
    """ุชูููุฏ ุฑูู ุงูููุฏ ูุน ุถูุงู ุงููุฑุงุฏุฉ"""
    from datetime import datetime
    
    current_year = datetime.now().year
    base_pattern = f"JE-{current_year}-"
    
    # ุงูุจุญุซ ุนู ุฌููุน ุงูุฃุฑูุงู ุงููุณุชุฎุฏูุฉ
    existing_entries = JournalEntry.objects.filter(
        entry_date__year=current_year,
        entry_number__startswith=base_pattern
    ).values_list('entry_number', flat=True)
    
    # ุงุณุชุฎุฑุงุฌ ุงูุฃุฑูุงู ูุงุฎุชูุงุฑ ุงูุฑูู ุงูุชุงูู ุงููุชุงุญ
    used_numbers = set()
    for entry_num in existing_entries:
        try:
            num_part = entry_num.split('-')[-1]
            if num_part.isdigit():
                used_numbers.add(int(num_part))
        except (ValueError, IndexError):
            continue
    
    # ุงูุจุญุซ ุนู ุฃุตุบุฑ ุฑูู ูุชุงุญ
    new_number = 1
    while new_number in used_numbers:
        new_number += 1
    
    return f"{base_pattern}{new_number:04d}"
```

---

## ๐ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### ูุจู ุงูุฅุตูุงุญ:
```
โ๏ธ ูุดู ูู ุงุณุชุนุงุฏุฉ ุณุฌู ูู journal.journalentry: duplicate key...
โ๏ธ ูุดู ูู ุงุณุชุนุงุฏุฉ ุณุฌู ูู journal.journalentry: duplicate key...
โ๏ธ ูุดู ูู ุงุณุชุนุงุฏุฉ ุณุฌู ูู journal.journalentry: duplicate key...
(ุชูุฑุฑ ~440 ูุฑุฉ)
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
โ ุงุณุชุนุงุฏุฉ ุณุฌู journal.journalentry[365] (ุฑูู ุฌุฏูุฏ: JE-2025-0500)
โ ุงุณุชุนุงุฏุฉ ุณุฌู journal.journalentry[366] (ุฑูู ุฌุฏูุฏ: JE-2025-0501)
โ ุงุณุชุนุงุฏุฉ ุณุฌู journal.journalentry[367] (ุฑูู ุฌุฏูุฏ: JE-2025-0502)
(ุฌููุน ุงููููุฏ ุชูุณุชุนุงุฏ ุจูุฌุงุญ)
```

---

## โ ุงูููุงุฆุฏ

1. **ูุง ูุฒูุฏ ูู ุฃุฎุทุงุก ุงูุชูุฑุงุฑ** โโโ
   - ุฌููุน ุงููููุฏ ุชูุณุชุนุงุฏ ุจูุฌุงุญ
   - ูุง ุชูุฌุฏ ุฑุณุงุฆู ุฎุทุฃ

2. **ุฃุฑูุงู ูููุฏ ุฌุฏูุฏุฉ ููุฑูุฏุฉ** ๐ข
   - ูู ููุฏ ูุญุตู ุนูู ุฑูู ุฌุฏูุฏ ุบูุฑ ููุฑุฑ
   - ูุญุงูุธ ุนูู ุชุณูุณู ููุทูู

3. **ุงูุญูุงุธ ุนูู ุงูุนูุงูุงุช** ๐
   - ุณุทูุฑ ุงููููุฏ (JournalLine) ุชูุฑุจุท ุจุงูููุฏ ุงูุตุญูุญ
   - ูุง ุญุงุฌุฉ ูู "FK ุจุฏูู"

4. **ุงุณุชุนุงุฏุฉ ูุงููุฉ** ๐ฏ
   - ูุนุฏู ุงูุงุณุชุนุงุฏุฉ: 100% (ุจุฏูุงู ูู ~55% ูููููุฏ)
   - ุฌููุน ุงูุจูุงูุงุช ุงููุญุงุณุจูุฉ ูุญููุธุฉ

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ:

1. ูุงุนุฏุฉ ุจูุงูุงุช ุจูุง 804 ููุฏ ูุญุงุณุจู
2. ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ
3. ูุณุญ ุฌููุน ุงูุจูุงูุงุช
4. ุงุณุชุนุงุฏุฉ ุงููุณุฎุฉ

### ุงููุชูุฌุฉ ุงููุชููุนุฉ:

```
โ ุฌููุน ุงููููุฏ ุชูุณุชุนุงุฏ (804/804)
โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ุชูุฑุงุฑ
โ ุฃุฑูุงู ุงููููุฏ ุฌุฏูุฏุฉ ููุชุณูุณูุฉ (JE-2025-0500 ... JE-2025-1303)
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ุงูุฃุฑูุงู ุงูุฌุฏูุฏุฉ
- ุงููููุฏ ุงููุณุชุนุงุฏุฉ ุณุชุญุตู ุนูู ุฃุฑูุงู **ุฌุฏูุฏุฉ**
- ุงูุฃุฑูุงู ุงููุฏููุฉ ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ **ูู ุชูุณุชุฎุฏู**
- ูุฐุง ูุชุนูุฏ ูุชุฌูุจ ุงูุชูุฑุงุฑ

### 2. ุงูุชุณูุณู ุงูููุทูู
- ุงููุธุงู ูุฎุชุงุฑ ุฃุตุบุฑ ุฑูู ูุชุงุญ
- ูุญุงูุธ ุนูู ุงูุชุณูุณู ุงูุฒููู ูู ุฎูุงู `entry_date`

### 3. ุงูุชุฑููู ุงููุฎุชูุท
ุฅุฐุง ูุงูุช ูุงุนุฏุฉ ุงูุจูุงูุงุช ุชุญุชูู ุนูู:
- JE-2025-0001 ุฅูู JE-2025-0100 (ููุฌูุฏุฉ)
- ุณุชุจุฏุฃ ุงูุงุณุชุนุงุฏุฉ ูู JE-2025-0101

---

## โ๏ธ ุงููููุงุช ุงููุนุฏูุฉ

### `backup/views.py`

**ุงูุณุทูุฑ ุงููุนุฏูุฉ:**
- ~1920: ุฅุถุงูุฉ ูุญุต ูู `journal.JournalEntry` ูุญุฐู `entry_number` ุงูููุฑุฑ
- ~2055-2080: ูุนุงูุฌุฉ ุฎุงุตุฉ ุนูุฏ ุงูุฅูุดุงุก/ุงูุชุญุฏูุซ ูุงุณุชุฎุฏุงู `save()`

---

## ๐ ุงูุชูุงูู

- โ ูุชูุงูู ูุน ุงููุธุงู ุงูุญุงูู
- โ ูุง ูุคุซุฑ ุนูู ุงููููุฏ ุงูููุฌูุฏุฉ
- โ ูุนูู ูุน ุฌููุน ุฃููุงุน ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ (JSON/XLSX)
- โ ุขูู ููุงุณุชุฎุฏุงู ูู ุงูุฅูุชุงุฌ

---

## ๐ ุงููุฑุงุฌุน

- `journal/models.py`: ูููุฐุฌ `JournalEntry` ูุฏุงูุฉ `generate_entry_number()`
- `backup/views.py`: ูุธููุฉ `perform_backup_restore()`
- `FINAL_BACKUP_TEST_REPORT.md`: ุชูุฑูุฑ ุงูุงุฎุชุจุงุฑ ุงูุดุงูู

---

**ุงูุญุงูุฉ:** โ ูุทุจู ููุฎุชุจุฑ  
**ุงูุชุงุฑูุฎ:** 6 ุฃูุชูุจุฑ 2025  
**ุงููุทูุฑ:** GitHub Copilot  
**ุงูุฅุตุฏุงุฑ:** 3.0
