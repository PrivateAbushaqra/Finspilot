# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÙƒÙˆØ¯ Ø³Ø±ÙŠØ¹ Ù„Ù„ØµÙ‚ ÙÙŠ Django Shell Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# Ø§Ù„Ø®Ø·ÙˆØ§Øª:
# 1. Ø§ÙØªØ­ Django Shell Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…: python manage.py shell
# 2. Ø§Ù†Ø³Ø® ÙˆØ§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
# 3. Ø§Ø¶ØºØ· Enter
# 
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

from django.db import transaction
from sales.models import SalesInvoice
from cashboxes.models import Cashbox
from django.contrib.auth import get_user_model

User = get_user_model()

# Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¨Ø¯ÙˆÙ† ØµÙ†Ø¯ÙˆÙ‚
invoices = SalesInvoice.objects.filter(payment_type='cash', cashbox__isnull=True)
count = invoices.count()
total_amount = sum(invoice.total_amount for invoice in invoices)

print("=" * 70)
print(f"ğŸ“Š ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {count} ÙØ§ØªÙˆØ±Ø© Ù†Ù‚Ø¯ÙŠØ© Ø¨Ø¯ÙˆÙ† ØµÙ†Ø¯ÙˆÙ‚")
print(f"ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {total_amount:.3f} Ø¯ÙŠÙ†Ø§Ø±")
print("=" * 70)

if count == 0:
    print("âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© Ø¨ØµÙ†Ø¯ÙˆÙ‚! Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠØ¡ Ù„Ù„Ø¥ØµÙ„Ø§Ø­.")
else:
    # ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥ØµÙ„Ø§Ø­
    with transaction.atomic():
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù†Ø´Ø·
        default_user = User.objects.filter(is_active=True).first()
        
        if not default_user:
            print("âŒ Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…")
        else:
            # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
            cashbox, created = Cashbox.objects.get_or_create(
                name='Ù…Ø¨ÙŠØ¹Ø§Øª Ù†Ù‚Ø¯ÙŠØ© Ø³Ø§Ø¨Ù‚Ø©',
                defaults={
                    'balance': total_amount,
                    'currency': 'JOD',
                    'responsible_user': default_user,
                    'is_active': True,
                    'description': 'ØµÙ†Ø¯ÙˆÙ‚ ØªØ§Ø±ÙŠØ®ÙŠ Ù„Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØµÙ†Ø¯ÙˆÙ‚ Ù„Ù‡Ø§'
                }
            )
            
            if created:
                print(f"ğŸ“¦ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØµÙ†Ø¯ÙˆÙ‚ Ø¬Ø¯ÙŠØ¯: {cashbox.name}")
            else:
                print(f"ğŸ“¦ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: {cashbox.name}")
                cashbox.balance += total_amount
                cashbox.save()
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ§ØªÙŠØ±
            updated = invoices.update(cashbox=cashbox)
            
            print(f"ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« {updated} ÙØ§ØªÙˆØ±Ø©")
            print(f"ğŸ’° Ø±ØµÙŠØ¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: {cashbox.balance:.3f} Ø¯ÙŠÙ†Ø§Ø±")
            print("=" * 70)
            print("âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­!")
            print("=" * 70)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙƒÙˆØ¯ - ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ø¢Ù† Ø¨ÙƒØªØ§Ø¨Ø©: exit()
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
