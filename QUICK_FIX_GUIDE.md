# دليل سريع: حل مشكلة عدم ظهور البيانات بعد الاستعادة

## 📌 ملخص المشكلة
- ✅ النسخة الاحتياطية تُنشأ بنجاح محلياً
- ✅ الاستعادة تكتمل على الريموت
- ❌ البيانات لا تظهر بعد الاستعادة

## 🔍 التشخيص السريع

### الخطوة 1: تشغيل أداة التشخيص على الريموت

1. اذهب إلى **Render Dashboard**
2. افتح **Shell** للمشروع
3. نفّذ الأمر التالي:

```bash
python diagnose_remote.py
```

**ماذا سيحدث؟**
- سيفحص عدد السجلات في قاعدة البيانات
- سيتحقق من وجود المستخدمين
- سيعرض آخر عمليات الاستعادة
- سيقدم توصيات محددة حسب المشكلة

### الخطوة 2: تفسير النتائج

#### ✅ إذا أظهرت الأداة أن البيانات موجودة:

```
📊 إجمالي السجلات: 8932
👥 إجمالي المستخدمين: 5
✅ المنتجات: 150
```

**المشكلة:** البيانات موجودة لكن لا تظهر في الواجهة

**الحل:**
1. سجّل خروج ثم دخول مرة أخرى
2. امسح Cache المتصفح (Ctrl+Shift+Delete)
3. جرّب من متصفح آخر أو نافذة تصفح خاص

#### ❌ إذا أظهرت الأداة أن قاعدة البيانات فارغة:

```
📊 إجمالي السجلات: 0
❌ لا توجد أي بيانات في قاعدة البيانات!
```

**المشكلة:** عملية الاستعادة فشلت

**الحل:** اتبع الخطوة 3 أدناه

## 🔧 الحل الموصى به (إذا فشلت الاستعادة)

### الخطوة 3: استعادة صحيحة مع مسح البيانات

1. **على الجهاز المحلي:**
   - اذهب إلى صفحة النسخ الاحتياطي
   - أنشئ نسخة احتياطية جديدة
   - حمّل ملف النسخة (JSON أو XLSX)

2. **على الريموت (Render):**
   - سجّل دخول كمستخدم Superuser
   - اذهب إلى صفحة النسخ الاحتياطي
   - **⚠️ مهم جداً:** فعّل خيار **"مسح جميع البيانات قبل الاستعادة"** ☑️
   - ارفع ملف النسخة الاحتياطية
   - انتظر حتى تكتمل العملية

3. **بعد الاستعادة:**
   - سجّل خروج من الحساب
   - سجّل دخول مرة أخرى
   - تحقق من ظهور البيانات

## 📋 معلومات مهمة

### لماذا يجب مسح البيانات أولاً؟

عند الاستعادة بدون مسح:
- قد تحدث تضاربات في Foreign Keys
- قد تكون هناك بيانات قديمة تسبب أخطاء
- Signals قد تنشئ سجلات مكررة (رغم أننا أصلحنا هذا)

### ما الذي تم إصلاحه؟

✅ **مشكلة `user.username` عند None**
   - كان الكود يفشل عند إنشاء نسخة بدون مستخدم
   - تم إصلاحه لاستخدام 'system' كقيمة افتراضية

✅ **تعطيل Signals أثناء الاستعادة**
   - Signals في `purchases/signals.py` تتحقق من `is_restoring()`
   - لا تُنشئ قيود محاسبية مكررة أثناء الاستعادة

✅ **معالجة أخطاء AuditLog**
   - أخطاء Atomic Block تُعالج بشكل صحيح
   - لا تتسبب في فشل عملية الاستعادة

## 🚨 إذا استمرت المشكلة

### 1. افحص سجلات الأخطاء على Render

```
Render Dashboard → Your Service → Logs
```

ابحث عن:
- `IntegrityError`
- `FK_NOT_FOUND`
- `ROLLBACK`
- `duplicate key`

### 2. حاول نسخة احتياطية صغيرة أولاً

بدلاً من استعادة كل البيانات:
1. أنشئ نسخة من بيانات أساسية فقط (إعدادات + مستخدمين)
2. جرّب استعادتها على الريموت
3. إذا نجحت، جرّب النسخة الكاملة

### 3. تحقق من حجم الملف

- إذا كان الملف كبير جداً (>50MB)
- جرّب صيغة XLSX بدلاً من JSON
- أو قسّم البيانات إلى نسخ أصغر

## 📞 الحصول على المساعدة

إذا لم تحل المشكلة، يرجى توفير:

1. **نتائج أداة التشخيص:**
   ```bash
   python diagnose_remote.py > diagnosis.txt
   ```

2. **آخر 50 سطر من سجلات الأخطاء:**
   من Render Dashboard → Logs

3. **لقطة شاشة من عملية الاستعادة:**
   توضح الرسالة التي تظهر بعد الرفع

4. **حجم ملف النسخة الاحتياطية:**
   ```bash
   ls -lh backup_file.json
   ```

---

**آخر تحديث:** 6 أكتوبر 2025
**الإصدار:** 2.0
**الحالة:** تم اختبار النسخ والاستعادة محلياً ✅
