# نظام القيود المحاسبية التلقائية

## نظرة عامة

تم تطوير نظام شامل لإنشاء القيود المحاسبية تلقائياً عند إنشاء أي مستند في النظام. هذا النظام يضمن التكامل الكامل بين جميع العمليات والقيود المحاسبية.

## المكونات الرئيسية

### 1. خدمة القيود المحاسبية (JournalService)
الملف: `journal/services.py`

يحتوي على دوال شاملة لإنشاء القيود المحاسبية لجميع أنواع المستندات:
- `create_sales_invoice_entry()` - قيود فواتير المبيعات
- `create_purchase_invoice_entry()` - قيود فواتير المشتريات
- `create_receipt_voucher_entry()` - قيود سندات القبض
- `create_payment_voucher_entry()` - قيود سندات الصرف
- `create_sales_return_entry()` - قيود مردودات المبيعات
- `create_purchase_return_entry()` - قيود مردودات المشتريات
- `delete_journal_entry_by_reference()` - حذف القيود حسب المرجع

### 2. نظام الإشارات التلقائية (Signals)
الملف: `journal/signals.py`

يقوم بإنشاء القيود المحاسبية تلقائياً عند:
- إنشاء أي مستند جديد (`post_save`)
- حذف أي مستند (`post_delete`)

#### المستندات المدعومة:
- **فواتير المبيعات** (`sales.SalesInvoice`)
- **فواتير المشتريات** (`purchases.PurchaseInvoice`)
- **سندات القبض** (`receipts.PaymentReceipt`)
- **سندات الصرف** (`payments.PaymentVoucher`)
- **مردودات المبيعات** (`sales.SalesReturn`)
- **مردودات المشتريات** (`purchases.PurchaseReturn`)
- **الإيرادات والمصروفات** (`revenues_expenses.RevenueExpenseEntry`)
- **الأصول** (`assets_liabilities.Asset`)
- **الخصوم** (`assets_liabilities.Liability`)
- **قيود الإهلاك** (`assets_liabilities.DepreciationEntry`)

### 3. أمر إنشاء القيود للمستندات الموجودة
الملف: `journal/management/commands/create_missing_journal_entries.py`

يقوم بإنشاء قيود محاسبية للمستندات الموجودة التي لا تحتوي على قيود.

## كيفية الاستخدام

### 1. تفعيل النظام
النظام مفعل تلقائياً عند بدء Django من خلال `journal/apps.py`.

### 2. إنشاء قيود للمستندات الموجودة

```bash
# معاينة ما سيتم إنشاؤه
python manage.py create_missing_journal_entries --dry-run

# إنشاء القيود فعلياً
python manage.py create_missing_journal_entries

# إنشاء القيود وربطها بمستخدم محدد
python manage.py create_missing_journal_entries --user-id=1
```

### 3. التحقق من القيود

يمكنك التحقق من القيود المحاسبية في:
- صفحة القيود المحاسبية في لوحة الإدارة
- تقارير الحسابات
- قائمة القيود اليومية

## أنواع القيود المحاسبية

### 1. فواتير المبيعات
```
من حـ/ العملاء (أو الصندوق للنقدي)    [مدين]
    إلى حـ/ المبيعات                    [دائن]
    إلى حـ/ ضريبة المبيعات              [دائن]
```

### 2. فواتير المشتريات
```
من حـ/ المشتريات                       [مدين]
من حـ/ ضريبة المشتريات                 [مدين]
    إلى حـ/ الموردين (أو الصندوق للنقدي) [دائن]
```

### 3. سندات القبض
```
من حـ/ الصندوق/البنك                    [مدين]
    إلى حـ/ العملاء                     [دائن]
```

### 4. سندات الصرف
```
من حـ/ المصروف المحدد                   [مدين]
    إلى حـ/ الصندوق/البنك               [دائن]
```

### 5. مردودات المبيعات
```
من حـ/ مردودات المبيعات                 [مدين]
    إلى حـ/ العملاء (أو الصندوق)         [دائن]
```

### 6. مردودات المشتريات
```
من حـ/ الموردين (أو الصندوق)            [مدين]
    إلى حـ/ مردودات المشتريات            [دائن]
```

### 7. الإيرادات
```
من حـ/ الصندوق/البنك                    [مدين]
    إلى حـ/ الإيراد المحدد               [دائن]
```

### 8. المصروفات
```
من حـ/ المصروف المحدد                   [مدين]
    إلى حـ/ الصندوق/البنك               [دائن]
```

### 9. شراء الأصول
```
من حـ/ الأصل                           [مدين]
    إلى حـ/ الصندوق/البنك               [دائن]
```

### 10. الالتزامات
```
من حـ/ المصروف/الخدمة                  [مدين]
    إلى حـ/ الالتزام                    [دائن]
```

### 11. الإهلاك
```
من حـ/ مصروف الإهلاك                   [مدين]
    إلى حـ/ مجمع الإهلاك                [دائن]
```

## المميزات

### 1. تلقائية كاملة
- لا تحتاج لإدخال قيود يدوياً
- القيود تُنشأ فور حفظ أي مستند
- القيود تُحذف تلقائياً عند حذف المستند

### 2. أمان ودقة
- جميع القيود متوازنة (المدين = الدائن)
- نظام logging شامل لتتبع العمليات
- معالجة أخطاء متقدمة

### 3. مرونة
- يمكن تخصيص القيود لكل نوع مستند
- يمكن إضافة أنواع مستندات جديدة بسهولة
- يدعم عملات متعددة

### 4. تتبع شامل
- كل قيد مرتبط بالمستند الأصلي
- تتبع المستخدم الذي أنشأ القيد
- توقيت دقيق لكل عملية

## استكشاف الأخطاء

### 1. فحص الـ logs
```bash
# في وضع التطوير
tail -f logs/django.log

# أو فحص console Django
```

### 2. التحقق من الحسابات
تأكد من وجود جميع الحسابات المطلوبة:
- حسابات العملاء والموردين
- حسابات المبيعات والمشتريات
- حسابات الصناديق والبنوك
- حسابات الضرائب

### 3. فحص البيانات
```python
# في Django shell
from journal.models import JournalEntry
from sales.models import SalesInvoice

# فحص فاتورة معينة
invoice = SalesInvoice.objects.get(id=1)
entries = JournalEntry.objects.filter(
    reference_type='sales_invoice', 
    reference_id=invoice.id
)
print(f"القيود لفاتورة {invoice.invoice_number}: {entries.count()}")
```

## إضافة أنواع مستندات جديدة

لإضافة دعم لنوع مستند جديد:

1. **إضافة دالة في JournalService:**
```python
@staticmethod
def create_new_document_entry(document, user=None):
    # منطق إنشاء القيد
    pass
```

2. **إضافة إشارة في signals.py:**
```python
@receiver(post_save, sender='app.NewDocument')
def create_new_document_journal_entry(sender, instance, created, **kwargs):
    if created and instance.id:
        JournalService.create_new_document_entry(instance, instance.created_by)
```

3. **إضافة معالجة في management command:**
```python
def process_new_documents(self, user, dry_run):
    # منطق معالجة المستندات الموجودة
    pass
```

## الخلاصة

هذا النظام يوفر تكاملاً محاسبياً شاملاً وتلقائياً يضمن:
- دقة القيود المحاسبية
- عدم تفويت أي عملية
- سهولة المتابعة والمراجعة
- مرونة في التطوير والتوسع

النظام جاهز للاستخدام ويعمل تلقائياً مع جميع العمليات في النظام.
