# إصلاح حساب السعر في صفحات الفواتير

## 📋 التاريخ
**2025-10-10**

## 🎯 المشكلة
كانت صفحات إضافة وتعديل فواتير المبيعات تحسب السعر بطريقة مختلفة عن صفحة POS، مما يسبب عدم اتساق في الأسعار المعروضة.

## 🔍 السبب
- **سعر البيع المخزن** في جدول المنتجات (`sale_price`) هو **شامل للضريبة**
- صفحة **POS** تستخدم API خاص (`/sales/pos/product/{id}/`) يقوم بخصم الضريبة تلقائياً
- صفحات **الفواتير** كانت تحسب السعر محلياً (في JavaScript) بطريقة مزدوجة وغير متسقة

## ✅ الحل المطبق

### 1. **صفحة إضافة الفاتورة** (`templates/sales/invoice_add.html`)

#### **قبل الإصلاح:**
```javascript
// كان يحسب السعر مرتين:
// 1. من القيم الممررة من template
const templateDisplayedPrice = salePrice / (1 + taxRate / 100);
applyPrice(templateDisplayedPrice, 'template');

// 2. من POS API
fetch(`/sales/pos/product/${productId}/`)
    .then(data => applyPrice(data.product.price, 'pos'));
```

#### **بعد الإصلاح:**
```javascript
// الآن يعتمد فقط على POS API
priceInput.value = '...'; // رسالة تحميل
priceInput.disabled = true;

fetch(`/sales/pos/product/${productId}/`)
    .then(data => {
        priceInput.disabled = false;
        applyPrice(data.product.price, 'pos'); // السعر بدون ضريبة
        taxRateInput.value = data.product.tax_rate;
    });
```

### 2. **صفحة تعديل الفاتورة** (`templates/sales/invoice_edit.html`)

#### **قبل الإصلاح:**
```javascript
// كان يأخذ السعر مباشرة من data attribute (شامل الضريبة)
$('#new-product-select').change(function() {
    const price = selectedOption.data('price'); // سعر شامل الضريبة ❌
    $('#new-price').val(price);
});
```

#### **بعد الإصلاح:**
```javascript
// الآن يستدعي POS API
$('#new-product-select').change(function() {
    $.ajax({
        url: `/sales/pos/product/${productId}/`,
        success: function(data) {
            $('#new-price').val(data.product.price); // سعر بدون ضريبة ✅
            $('#new-tax-rate').val(data.product.tax_rate);
        }
    });
});
```

## 📊 مثال توضيحي

### **منتج بسعر 110 دينار (شامل ضريبة 10%)**

| الصفحة | قبل الإصلاح | بعد الإصلاح |
|--------|-------------|--------------|
| **POS** | 100 دينار ✅ | 100 دينار ✅ |
| **إضافة فاتورة** | ~90.91 أو 100 (غير متسق) ❌ | 100 دينار ✅ |
| **تعديل فاتورة** | 110 دينار ❌ | 100 دينار ✅ |

### **حساب الفاتورة:**
- **السعر (بدون ضريبة):** 100 دينار
- **الكمية:** 2
- **المبلغ الجزئي:** 100 × 2 = **200 دينار**
- **الضريبة (10%):** 200 × 0.10 = **20 دينار**
- **الإجمالي:** **220 دينار**

## 🎯 الفوائد

### 1. **الاتساق التام:**
- ✅ جميع الصفحات تستخدم نفس API
- ✅ نفس طريقة حساب السعر والضريبة
- ✅ نتائج متطابقة في كل مكان

### 2. **الموثوقية:**
- ✅ مصدر واحد للحقيقة (Single Source of Truth)
- ✅ الحساب في Backend (آمن ومركزي)
- ✅ تقليل الأخطاء البشرية

### 3. **الصيانة:**
- ✅ كود أبسط وأسهل للفهم
- ✅ إذا تغيرت طريقة الحساب، يكفي تعديل مكان واحد (في API)
- ✅ سهولة اختبار وتصحيح الأخطاء

## 🔧 الملفات المعدلة

1. **templates/sales/invoice_add.html**
   - السطور: 965-1072
   - التعديل: دالة `selectProduct()`

2. **templates/sales/invoice_edit.html**
   - السطور: 406-418
   - التعديل: معالج `$('#new-product-select').change()`

## 📝 ملاحظات مهمة

### **API المستخدم:**
```
GET /sales/pos/product/{product_id}/
```

**Response:**
```json
{
    "success": true,
    "product": {
        "id": 7,
        "name": "منتج تجريبي",
        "price": 100.000,        // السعر بدون ضريبة ✅
        "tax_rate": 10.00,
        "stock": 50.000,
        "barcode": "123456",
        "track_inventory": true
    }
}
```

### **الحساب في Backend:**
```python
# في sales/views.py - دالة pos_get_product()
displayed_price = float(product.sale_price)  # 110 (شامل الضريبة)
if tax_rate > 0:
    displayed_price = displayed_price / (1 + tax_rate / 100)  # 110 / 1.10 = 100
```

## ✅ التحقق من الإصلاح

### **خطوات الاختبار:**

1. **إضافة منتج بسعر 110 دينار وضريبة 10%**
2. **فتح صفحة POS** - يجب أن يظهر السعر: **100 دينار**
3. **فتح صفحة إضافة فاتورة** - اختيار نفس المنتج - السعر: **100 دينار** ✅
4. **فتح صفحة تعديل فاتورة** - إضافة نفس المنتج - السعر: **100 دينار** ✅

### **النتيجة المتوقعة:**
- ✅ السعر متطابق في جميع الصفحات
- ✅ الضريبة تُحسب بشكل صحيح
- ✅ الإجمالي النهائي صحيح

## 🔒 الأمان والأداء

### **الأمان:**
- ✅ الحساب في Backend (لا يمكن التلاعب به من المتصفح)
- ✅ استخدام `credentials: 'same-origin'` في fetch
- ✅ التحقق من الصلاحيات في API

### **الأداء:**
- ⚠️ استدعاء إضافي للـ API (acceptable overhead)
- ✅ يتم Cache في المتصفح
- ✅ رسالة "تحميل..." أثناء الانتظار (UX أفضل)

## 📚 معايير IFRS ذات الصلة

- **IAS 18:** الإيرادات - يجب فصل السعر عن الضريبة
- **IFRS 15:** الإيراد من العقود - يجب عرض السعر والضريبة بشكل منفصل
- **المعايير المحلية:** أغلب الدول تتطلب فصل الضريبة في الفواتير

## 🎓 الدروس المستفادة

1. **Single Source of Truth:** دائماً استخدم مصدر واحد للبيانات الحرجة
2. **Backend Validation:** الحسابات المهمة يجب أن تكون في Backend
3. **Consistency:** الاتساق بين الصفحات أهم من الأداء في كثير من الحالات
4. **User Feedback:** رسائل التحميل تحسن تجربة المستخدم حتى لو كان الانتظار قصير

---

**تم التوثيق بواسطة:** GitHub Copilot  
**المراجعة:** مطلوبة من فريق التطوير  
**الحالة:** ✅ مكتمل ومطبق
