{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}

{% block extra_css %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block title %}{% trans "Create Purchase Return" %}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-undo me-2"></i>
                        {% trans "Create Purchase Return" %}
                    </h3>
                    <a href="{% url 'purchases:return_list' %}" class="btn btn-outline-secondary float-end">
                        <i class="fas fa-arrow-left me-2"></i>
                        {% trans "Back to List" %}
                    </a>
                </div>

                <form method="post" id="returnForm">
                    {% csrf_token %}
                    
                    <div class="card-body">
                        <div class="row">
                            <!-- Return Information -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Return Number" %} <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="return_number" 
                                           value="{{ suggested_return_number }}" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Return Date" %} <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" name="date" 
                                           value="{% now 'Y-m-d' %}" required>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">{% trans "Return Type" %} <span class="text-danger">*</span></label>
                                    <select class="form-control" name="return_type" required>
                                        <option value="partial">{% trans "Partial Return" %}</option>
                                        <option value="full">{% trans "Full Return" %}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Original Invoice" %} <span class="text-danger">*</span></label>
                                    <select class="form-control" name="original_invoice" id="originalInvoiceSelect" required style="width: 100%;">
                                        <option value="">{% trans "Select Original Invoice" %}</option>
                                        {% for invoice in invoices %}
                                            <option value="{{ invoice.id }}" 
                                                    data-supplier="{{ invoice.supplier.name }}"
                                                    data-invoice="{{ invoice.supplier_invoice_number }}"
                                                    data-date="{{ invoice.date }}">
                                                {{ invoice.supplier_invoice_number }} - {{ invoice.supplier.name }} ({{ invoice.date }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Selected Invoice Information -->
                                <div id="invoiceInfo"></div>

                                <div class="mb-3">
                                    <label class="form-label">{% trans "Return Reason" %} <span class="text-danger">*</span></label>
                                    <select class="form-control" name="return_reason" required>
                                        <option value="">{% trans "Select Return Reason" %}</option>
                                        <option value="defective">{% trans "Defective Product" %}</option>
                                        <option value="wrong_item">{% trans "Wrong Item" %}</option>
                                        <option value="excess">{% trans "Excess Quantity" %}</option>
                                        <option value="expired">{% trans "Expired" %}</option>
                                        <option value="damaged">{% trans "Damaged During Transport" %}</option>
                                        <option value="other">{% trans "Other" %}</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">{% trans "Notes" %}</label>
                                    <textarea class="form-control" name="notes" rows="3" 
                                              placeholder="{% trans 'Enter any additional notes...' %}"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Items Section -->
                        <div class="row mt-4" id="invoiceItemsSection" style="display: none;">
                            <div class="col-12">
                                <h5 class="mb-3">{% trans "Available Invoice Items for Return" %}</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered" id="itemsTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>{% trans "Product Code" %}</th>
                                                <th>{% trans "Product Name" %}</th>
                                                <th>{% trans "Original Quantity" %}</th>
                                                <th>{% trans "Previously Returned" %}</th>
                                                <th>{% trans "Available for Return" %}</th>
                                                <th>{% trans "Return Quantity" %}</th>
                                                <th>{% trans "Unit Price" %}</th>
                                                <th>{% trans "Tax Rate" %}</th>
                                                <th>{% trans "Total" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="itemsTableBody">
                                            <!-- Items will be loaded here via AJAX -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Totals Section -->
                        <div class="row mt-4" id="totalsSection" style="display: none;">
                            <div class="col-12">
                                <div class="row justify-content-end">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>{% trans "Subtotal" %}:</span>
                                                    <span id="subtotalDisplay">0.00</span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>{% trans "Tax" %}:</span>
                                                    <span id="taxDisplay">0.00</span>
                                                </div>
                                                <hr>
                                                <div class="d-flex justify-content-between fw-bold">
                                                    <span>{% trans "Total" %}:</span>
                                                    <span id="totalDisplay">0.00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="row">
                            <div class="col-12 text-end">
                                <button type="submit" class="btn btn-success" id="saveButton" disabled>
                                    <i class="fas fa-save me-2"></i>
                                    {% trans "Save Return" %}
                                </button>
                                <a href="{% url 'purchases:return_list' %}" class="btn btn-secondary">
                                    <i class="fas fa-times me-2"></i>
                                    {% trans "Cancel" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const originalInvoiceSelect = document.getElementById('originalInvoiceSelect');
    const invoiceItemsSection = document.getElementById('invoiceItemsSection');
    const itemsTableBody = document.getElementById('itemsTableBody');
    const totalsSection = document.getElementById('totalsSection');
    const saveButton = document.getElementById('saveButton');
    
    // Initialize Select2 with search functionality
    $('#originalInvoiceSelect').select2({
        language: '{{ LANGUAGE_CODE }}',
        dir: '{{ LANGUAGE_CODE }}' === 'ar' ? 'rtl' : 'ltr',
        placeholder: '{% trans "Search by invoice number or supplier name..." %}',
        allowClear: true,
        width: '100%',
        matcher: function(params, data) {
            // If there are no search terms, return all data
            if ($.trim(params.term) === '') {
                return data;
            }
            
            // Do not display the item if there is no 'text' property
            if (typeof data.text === 'undefined') {
                return null;
            }
            
            // Check if the text contains the term
            const searchTerm = params.term.toLowerCase();
            const text = data.text.toLowerCase();
            const supplier = $(data.element).data('supplier') ? $(data.element).data('supplier').toLowerCase() : '';
            const invoice = $(data.element).data('invoice') ? $(data.element).data('invoice').toLowerCase() : '';
            
            // Search in invoice number, supplier name, and full text
            if (text.indexOf(searchTerm) > -1 || 
                supplier.indexOf(searchTerm) > -1 || 
                invoice.indexOf(searchTerm) > -1) {
                return data;
            }
            
            return null;
        }
    });
    
    // Handle invoice selection
    $('#originalInvoiceSelect').on('change', function() {
        const invoiceId = this.value;
        
        console.log('Invoice selected:', invoiceId);
        
        if (invoiceId) {
            loadInvoiceItems(invoiceId);
        } else {
            console.log('Invoice selection cancelled');
            document.getElementById('invoiceInfo').innerHTML = '';
            invoiceItemsSection.style.display = 'none';
            totalsSection.style.display = 'none';
            saveButton.disabled = true;
        }
    });
    
    function loadInvoiceItems(invoiceId) {
        console.log('Loading invoice items for ID:', invoiceId);
        
        // Show loading indicator
        const loadingMessage = document.createElement('div');
        loadingMessage.className = 'text-center text-muted py-3';
        loadingMessage.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% trans "Loading invoice items" %}...';
        itemsTableBody.innerHTML = '';
        itemsTableBody.appendChild(loadingMessage);
        
        // Build correct URL
        const url = `{% url 'purchases:get_invoice_items' 0 %}`.replace('0', invoiceId);
        console.log('Using URL:', url);
        
        fetch(url)
            .then(response => {
                console.log('Server response:', response.status, response.statusText);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Received data:', data);
                if (data.success) {
                    displayInvoiceItems(data.items);
                    
                    // Display invoice information
                    document.getElementById('invoiceInfo').innerHTML = `
                        <div class="alert alert-info">
                            <strong>{% trans "Invoice Number" %}:</strong> ${data.invoice_number}<br>
                            <strong>{% trans "Supplier" %}:</strong> ${data.supplier_name}
                        </div>
                    `;
                    
                    invoiceItemsSection.style.display = 'block';
                    totalsSection.style.display = 'block';
                    saveButton.disabled = false;
                } else {
                    console.error('Server error:', data.message);
                    alert('{% trans "Error" %}: ' + data.message);
                    invoiceItemsSection.style.display = 'none';
                    totalsSection.style.display = 'none';
                    saveButton.disabled = true;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('{% trans "An error occurred while loading invoice items. Please try again." %}');
                invoiceItemsSection.style.display = 'none';
                totalsSection.style.display = 'none';
                saveButton.disabled = true;
            });
    }
    
    function displayInvoiceItems(items) {
        itemsTableBody.innerHTML = '';
        
        if (items.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td colspan="9" class="text-center text-muted py-3">
                    <i class="fas fa-info-circle me-2"></i>
                    {% trans "No items available for return in this invoice" %}
                </td>
            `;
            itemsTableBody.appendChild(row);
            return;
        }
        
        items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><small>${item.product_code}</small></td>
                <td><strong>${item.product_name}</strong></td>
                <td class="text-center">${parseFloat(item.original_quantity).toFixed(3)}</td>
                <td class="text-center">${parseFloat(item.returned_quantity).toFixed(3)}</td>
                <td class="text-center"><span class="badge bg-success">${parseFloat(item.remaining_quantity).toFixed(3)}</span></td>
                <td>
                    <input type="number" class="form-control returned-qty" 
                           data-item-id="${item.id}"
                           data-tax-rate="${item.tax_rate}"
                           min="0" max="${item.remaining_quantity}" 
                           step="0.001" value="0" 
                           placeholder="0.000">
                    <input type="hidden" name="item_id[]" value="${item.id}">
                    <input type="hidden" name="returned_quantity[]" class="returned-quantity-hidden" value="0">
                </td>
                <td>
                    <input type="number" class="form-control unit-price-input" 
                           data-item-id="${item.id}"
                           value="${item.unit_price}" 
                           step="0.001" min="0" 
                           placeholder="0.000">
                    <input type="hidden" name="unit_price[]" class="unit-price-hidden" value="${item.unit_price}">
                </td>
                <td class="text-center">${parseFloat(item.tax_rate).toFixed(2)}%</td>
                <td class="item-total text-end fw-bold">0.00</td>
            `;
            
            itemsTableBody.appendChild(row);
        });
        
        // Add event listeners to quantity inputs
        document.querySelectorAll('.returned-qty').forEach(input => {
            input.addEventListener('input', function() {
                // Update hidden input
                const hiddenInput = this.parentElement.querySelector('.returned-quantity-hidden');
                if (hiddenInput) {
                    hiddenInput.value = this.value;
                }
                
                updateItemTotal(this);
                updateGrandTotals();
            });
        });
        
        // Add event listeners to unit price inputs
        document.querySelectorAll('.unit-price-input').forEach(input => {
            input.addEventListener('input', function() {
                // Update hidden input
                const hiddenInput = this.parentElement.querySelector('.unit-price-hidden');
                if (hiddenInput) {
                    hiddenInput.value = this.value;
                }
                
                updateItemTotal(this);
                updateGrandTotals();
            });
        });
        
        // Small delay to ensure all elements are added to DOM
        setTimeout(() => {
            updateGrandTotals();
        }, 100);
    }
    
    function updateItemTotal(input) {
        const row = input.closest('tr');
        const quantity = parseFloat(row.querySelector('.returned-qty').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.unit-price-input').value) || 0;
        const taxRateElement = row.querySelector('td:nth-child(8)'); // Tax rate column
        const taxRateText = taxRateElement ? taxRateElement.textContent : '0%';
        const taxRate = parseFloat(taxRateText.replace('%', '')) || 0;
        
        const subtotal = quantity * unitPrice;
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;
        
        const totalCell = row.querySelector('.item-total');
        totalCell.textContent = total.toFixed(3);
    }
    
    function updateGrandTotals() {
        let grandSubtotal = 0;
        let grandTax = 0;
        
        document.querySelectorAll('tbody tr').forEach(row => {
            const quantityInput = row.querySelector('.returned-qty');
            const priceInput = row.querySelector('.unit-price-input');
            const taxRateElement = row.querySelector('td:nth-child(8)'); // Tax rate column
            
            if (quantityInput && priceInput) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const unitPrice = parseFloat(priceInput.value) || 0;
                const taxRateText = taxRateElement ? taxRateElement.textContent : '0%';
                const taxRate = parseFloat(taxRateText.replace('%', '')) || 0;
                
                if (quantity > 0) {
                    const subtotal = quantity * unitPrice;
                    const taxAmount = subtotal * (taxRate / 100);
                    
                    grandSubtotal += subtotal;
                    grandTax += taxAmount;
                }
            }
        });
        
        const grandTotal = grandSubtotal + grandTax;
        
        // Check if DOM elements exist
        const subtotalEl = document.getElementById('subtotalDisplay');
        const taxEl = document.getElementById('taxDisplay');
        const totalEl = document.getElementById('totalDisplay');
        
        if (subtotalEl) subtotalEl.textContent = grandSubtotal.toFixed(3);
        if (taxEl) taxEl.textContent = grandTax.toFixed(3);
        if (totalEl) totalEl.textContent = grandTotal.toFixed(3);
    }
    
    function updateReturnedQuantities() {
        const quantities = [];
        document.querySelectorAll('.returned-qty').forEach(input => {
            quantities.push(input.value || '0');
        });
        
        // Remove existing hidden inputs
        document.querySelectorAll('input[name="returned_quantity[]"]').forEach(input => {
            input.remove();
        });
        
        // Add new hidden inputs
        quantities.forEach(qty => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'returned_quantity[]';
            hiddenInput.value = qty;
            document.getElementById('returnForm').appendChild(hiddenInput);
        });
    }
    
    // Form validation
    document.getElementById('returnForm').addEventListener('submit', function(e) {
        const hasReturnedItems = Array.from(document.querySelectorAll('.returned-qty'))
            .some(input => parseFloat(input.value) > 0);
        
        if (!hasReturnedItems) {
            e.preventDefault();
            alert('{% trans "You must enter a quantity for at least one item to return" %}');
            return false;
        }
        
        updateReturnedQuantities();
        return true;
    });
});
</script>
{% endblock extra_js %}
