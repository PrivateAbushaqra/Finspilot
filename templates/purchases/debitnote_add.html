{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Create Debit Note" %}{% endblock %}
{% block content %}
<div class="container">
  <h1>{% trans "Create Debit Note" %}</h1>
  <form method="post">{% csrf_token %}
    <div class="mb-3">
      <label class="form-label">{% trans "Number" %}</label>
      {% if sequence_error %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {{ sequence_error }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}
      <input class="form-control" name="note_number" value="{{ next_note_number }}" disabled>
    </div>
    <div class="mb-3">
      <label class="form-label">{% trans "Supplier" %}</label>
      <input id="supplier_search" class="form-control" list="supplier_list" placeholder="{% trans "Type to search supplier" %}">
      <datalist id="supplier_list"></datalist>
      <input type="hidden" name="supplier" id="supplier_id_hidden" value="">
      <small class="form-text text-muted">{% trans "Start typing to filter suppliers, then choose from the list." %}</small>
    </div>
    <div class="mb-3">
      <label class="form-label">{% trans "Date" %}</label>
      <input type="date" name="date" class="form-control" value="{{ today_date }}">
    </div>
    <div class="mb-3">
      <label class="form-label">{% trans "Supplier Debit Note Number (Source)" %}</label>
      <input name="supplier_debit_note_number" class="form-control" placeholder="{% trans "Enter supplier debit note number" %}" required>
      <small class="form-text text-muted">{% trans "Required field - Enter the supplier's debit note number" %}</small>
    </div>
    <div class="mb-3">
      <label class="form-label">{% trans "Amount" %}</label>
      <input name="subtotal" class="form-control" value="0" placeholder="{% trans "Enter the debit note amount" %}">
      <small class="form-text text-muted">{% trans "Note: No tax is applied to debit notes" %}</small>
    </div>
    <div class="mb-3">
      <label class="form-label">{% trans "Notes" %}</label>
      <textarea name="notes" class="form-control"></textarea>
    </div>
    <button class="btn btn-primary" type="submit">{% trans "Save" %}</button>
  </form>
</div>
<script>
(function(){
  const input = document.getElementById('supplier_search');
  const datalist = document.getElementById('supplier_list');
  const hidden = document.getElementById('supplier_id_hidden');
  let nameToId = {};

  function fetchResults(q){
    if(!q || q.length < 1) return;
    const url = new URL('{% url "customers:search_customers" %}', window.location.origin);
    url.searchParams.set('q', q);
    url.searchParams.set('limit', 10);
    fetch(url.toString(), {credentials: 'same-origin'})
      .then(r => r.json())
      .then(data => {
        nameToId = {};
        datalist.innerHTML = '';
        (data.results || []).forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.name;
          datalist.appendChild(opt);
          nameToId[item.name] = item.id;
        });
      }).catch(err => {
        console.error('supplier search error', err);
      });
  }

  let timer = null;
  input.addEventListener('input', function(e){
    hidden.value = '';
    const q = this.value.trim();
    if(timer) clearTimeout(timer);
    timer = setTimeout(()=> fetchResults(q), 250);
  });

  input.addEventListener('change', function(){
    const val = this.value.trim();
    if(val && nameToId[val]){
      hidden.value = nameToId[val];
    } else {
      hidden.value = '';
    }
  });

  document.addEventListener('DOMContentLoaded', function(){
    try{
      const initial = [];
      {% for s in suppliers|slice:":10" %}
        initial.push({id: {{ s.id }}, name: "{{ s.name|escapejs }}"});
      {% endfor %}
      initial.forEach(item => {
        const opt = document.createElement('option'); opt.value = item.name; datalist.appendChild(opt); nameToId[item.name]=item.id;
      });
    }catch(e){console.error(e)}
  });
})();
</script>
{% endblock %}
