{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}



{% block title %}{% trans "Add Purchase Invoice" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- {% trans "Critical CSS - Load First" %} -->
<style>
    .invoice-form {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .invoice-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .products-table {
        height: auto;
        overflow-y: visible;
        position: relative;
        z-index: 10;
        padding-bottom: 50px; /* مسافة أساسية أسفل الجدول */
    }
    
    .total-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    /* {% trans "CRITICAL: Add Product Button Styles - Load Immediately" %} */
    .btn-add-product {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border: none !important;
        border-radius: 25px !important;
        padding: 0.5rem 1rem !important;
        transition: all 0.3s ease !important;
        color: white !important;
        cursor: pointer !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 38px !important;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2) !important;
        text-decoration: none !important;
        font-weight: 500 !important;
    }
    
    .btn-add-product:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3) !important;
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
        color: white !important;
    }
    
    .btn-add-product:active {
        transform: translateY(0) !important;
        background: linear-gradient(135deg, #004085 0%, #002752 100%) !important;
    }
    
    .btn-add-product:focus {
        outline: 2px solid #0056b3 !important;
        outline-offset: 2px !important;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2) !important;
        color: white !important;
    }
    
    /* {% trans "Ensure button is always visible and styled" %} */
    .btn-add-product, .btn-add-product:visited {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        color: white !important;
    }
    
    .btn-remove-product {
        background: #dc3545;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-remove-product:hover {
        background: #c82333;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-plus-circle me-2"></i>
                    {% trans "Add New Purchase Invoice" %}
                </h2>
                <a href="{% url 'purchases:invoice_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-right me-2"></i>
                    {% trans "Back to List" %}
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="invoice-form">
                <div class="invoice-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        {% trans "Purchase Invoice Details" %}
                    </h5>
                </div>
                
                <!-- Hidden elements for translations -->
                <div id="unsaved-changes-translations" style="display: none;">
                    <span id="trans-unsaved-changes">{% trans "Unsaved Changes" context "unsaved_changes" %}</span>
                    <span id="trans-unsaved-message">{% trans "Are you sure you want to leave this page? You have unsaved changes." context "unsaved_changes" %}</span>
                    <span id="trans-cancel">{% trans "Cancel" context "unsaved_changes" %}</span>
                    <span id="trans-leave">{% trans "Leave" context "unsaved_changes" %}</span>
                </div>
                
                <div class="p-4">
                    <form method="post" id="invoiceForm">
                        {% csrf_token %}
                        <input type="hidden" name="payment_type" id="id_payment_type" value="credit">
                        
                        <!-- {% trans "Basic Invoice Information" %} -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-hashtag me-1"></i> {% trans "Invoice Number" %} *</label>
                                    <input type="text" class="form-control bg-light" name="invoice_number" id="invoice_number" 
                                           value="{{ next_invoice_number }}" readonly 
                                           title="{% trans 'Invoice number is automatically generated from sequence settings' %}">
                                    <div class="form-text">{% trans "Invoice number is automatically generated from sequence settings" %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-receipt me-1"></i> {% trans "Supplier Invoice Number" %} *</label>
                                    <input type="text" class="form-control" name="supplier_invoice_number" value="{{ form_data.supplier_invoice_number|default:'' }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-calendar me-1"></i> {% trans "Date" %} *</label>
                                    <input type="date" class="form-control" name="date" value="{{ form_data.date|default:'' }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-truck me-1"></i> {% trans "Supplier" %} *
                                        <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="openNewSupplierModal()" title="{% trans "Create Supplier" %} {% trans "New" %}">
                                            <i class="fas fa-user-plus me-1"></i> {% trans "New" %}
                                        </button>
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="supplier_search" placeholder="{% trans 'Type supplier name...' %}" autocomplete="off">
                                        <div id="supplier-dropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                            <!-- Supplier options will be populated here -->
                                        </div>
                                    </div>
                                    <select class="form-select d-none" name="supplier" id="supplierSelect" required>
                                        <option value="">{% trans "Choose Supplier" %}</option>
                                        {% for supplier in suppliers %}
                                        <option value="{{ supplier.id }}" {% if form_data.supplier_id and form_data.supplier_id == supplier.id|stringformat:"s" %}selected{% endif %}>{{ supplier.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div id="supplier-balance-info" class="mt-2" style="display: none;">
                                        <small class="text-info">
                                            <i class="fas fa-wallet me-1"></i>
                                            {% trans "Balance" %} {% trans "Supplier" %}: <span id="supplier-balance-amount" class="fw-bold"></span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-percentage me-1"></i> {% trans "Tax Settings" %}</label>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="is_tax_inclusive" id="is_tax_inclusive" {% if not can_toggle_invoice_tax %}disabled{% endif %} {% if can_toggle_invoice_tax %}checked{% endif %}>
                                        <label class="form-check-label" for="is_tax_inclusive">
                                            {% trans "Tax Inclusive" %}
                                        </label>
                                    </div>
                                    <div class="form-text">
                                        <strong>{% trans "Tax Calculation" %}:</strong> {% trans "When checked, tax is calculated and added. When unchecked, no tax is calculated." %}
                                        <br><small class="text-muted">{% trans "Default: Selected (calculates tax)" %}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- {% trans "Warehouse Row" %} -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-warehouse me-1"></i> {% trans "Warehouse" %} <span class="required-field">*</span></label>
                                    <select class="form-select" name="warehouse" id="id_warehouse" required>
                                        <option value="">{% trans "Select Warehouse" %}</option>
                                        {% for warehouse in warehouses %}
                                        <option value="{{ warehouse.id }}" {% if form_data.warehouse_id and form_data.warehouse_id == warehouse.id|stringformat:"s" %}selected{% elif not form_data.warehouse_id and default_warehouse and warehouse.id == default_warehouse.id %}selected{% endif %}>
                                            {{ warehouse.name }} - {{ warehouse.code }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" name="set_default_warehouse" id="set_default_warehouse">
                                        <label class="form-check-label" for="set_default_warehouse">
                                            {% trans "Set as default purchase warehouse" %}
                                        </label>
                                    </div>
                                    <div class="form-text">{% trans "Select the warehouse where products will be stored." %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label"><i class="fas fa-money-bill-wave me-1"></i> {% trans "Payment Method" %}</label>
                                    <select class="form-select" name="payment_method" id="id_payment_method">
                                        <option value="">{% trans "Select Payment Method" %}</option>
                                        <option value="cash" {% if form_data.payment_method == 'cash' %}selected{% endif %}>{% trans "Cash Payment" %}</option>
                                        <option value="check" {% if form_data.payment_method == 'check' %}selected{% endif %}>{% trans "Check Payment" %}</option>
                                        <option value="transfer" {% if form_data.payment_method == 'transfer' %}selected{% endif %}>{% trans "Bank Transfer" %}</option>
                                        <option value="credit" {% if form_data.payment_method == 'credit' %}selected{% endif %}>{% trans "Credit Payment" %}</option>
                                    </select>
                                </div>
                                
                                <!-- Cashbox selection (shown when cash is selected) -->
                                <div class="mb-3" id="cashbox_field" style="display: none;">
                                    <label class="form-label"><i class="fas fa-cash-register me-1"></i> {% trans "Cash Box" %} *</label>
                                    <select class="form-select" name="cashbox" id="id_cashbox">
                                        <option value="">{% trans "Select Cash Box" %}</option>
                                        {% for cashbox in cashboxes %}
                                        <option value="{{ cashbox.id }}" {% if form_data.cashbox_id and form_data.cashbox_id == cashbox.id|stringformat:"s" %}selected{% endif %}>{{ cashbox.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Bank account selection (shown when check or transfer is selected) -->
                                <div class="mb-3" id="bank_account_field" style="display: none;">
                                    <label class="form-label"><i class="fas fa-university me-1"></i> {% trans "Bank Account" %} *</label>
                                    <select class="form-select" name="bank_account" id="id_bank_account">
                                        <option value="">{% trans "Select Bank Account" %}</option>
                                        {% for account in bank_accounts %}
                                        <option value="{{ account.id }}" {% if form_data.bank_account_id and form_data.bank_account_id == account.id|stringformat:"s" %}selected{% endif %}>{{ account.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Check details (shown when check is selected) -->
                                <div id="check_fields" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label"><i class="fas fa-hashtag me-1"></i> {% trans "Check Number" %} *</label>
                                                <input type="text" class="form-control" name="check_number" id="id_check_number" value="{{ form_data.check_number|default:'' }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label"><i class="fas fa-calendar-check me-1"></i> {% trans "Check Date" %} *</label>
                                                <input type="date" class="form-control" name="check_date" id="id_check_date" value="{{ form_data.check_date|default:'' }}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- {% trans "Products Table" %} -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6><i class="fas fa-box me-2"></i> {% trans "Invoice Products" %}</h6>
                                <div>
                                    <!--<button type="button" class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                        <i class="fas fa-folder-plus me-2"></i>
                                        {% trans "أضف فئة" %}-->
                                    </button>
                                    <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                        <i class="fas fa-plus me-2"></i>
                                        {% trans "Create Product" %}
                                    </button>
                                    <button type="button" class="btn btn-add-product text-white" id="addProductBtn" tabindex="-1"
                                            title="{% trans "Click here to add a new product" %}" data-action="add-product">
                                        <i class="fas fa-plus me-1"></i>
                                        {% trans "Add Product" %}
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive products-table">
                                <table class="table table-bordered" id="productsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="15%">{% trans "Product Code" %}</th>
                                            <th width="31%">{% trans "Product" %}</th>
                                            <th width="8%">{% trans "Available Quantity" %}</th>
                                            <th width="8%">{% trans "Quantity" %}</th>
                                            <th width="8%">{% trans "Unit Price" %}</th>
                                            <th width="10%">{% trans "Tax Rate" %}</th>
                                            <th width="8%">{% trans "Total" %}</th>
                                            <th width="8%">{% trans "Tax Amount" %}</th>
                                            <th width="4%">{% trans "Delete" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableBody">
                                        <!-- {% trans "Rows will be added here by JavaScript" %} -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- المجاميع -->
                        <div class="total-section">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label"><i class="fas fa-sticky-note me-1"></i> {% trans "Notes" %}</label>
                                        <textarea class="form-control" name="notes" rows="3" placeholder="{% trans 'Enter any additional notes...' %}">{{ form_data.notes|default:'' }}</textarea>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-calculator me-2"></i> {% trans "Invoice Summary" %}</h6>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>{% trans "Subtotal" %}:</span>
                                                <strong id="subtotalDisplay">0.000 {% get_currency_symbol %}</strong>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>{% trans "Tax Amount" %}:</span>
                                                <strong id="taxDisplay">0.000 {% get_currency_symbol %}</strong>
                                            </div>
                                            <hr>
                                            <div class="d-flex justify-content-between">
                                                <strong>{% trans "Total Amount" %}:</strong>
                                                <strong class="text-success" id="totalDisplay">0.000 {% get_currency_symbol %}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- أزرار التحكم -->
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{% url 'purchases:invoice_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                {% trans "Cancel" %}
                            </a>
                            <button type="submit" class="btn btn-success" title="حفظ الفاتورة (Ctrl+Enter)">
                                <i class="fas fa-save me-2"></i>
                                {% trans "Save Invoice" %}
                                <small class="ms-1 text-muted">(Ctrl+Enter)</small>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal {% trans "No" %}ختيار المنتج -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    {% trans "Select Product for Invoice" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="productSearch" 
                               placeholder="{% trans 'Search for product by name, code, or description...' %}">
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>{% trans "Product Code" %}</th>
                                <th>{% trans "Product Name" %}</th>
                                <th>{% trans "Description" %}</th>
                                <th>{% trans "Available Quantity" %}</th>
                                <th>{% trans "Last Purchase Price" %}</th>
                                <th>{% trans "Tax Rate" %}</th>
                                <th>{% trans "Select" %}</th>
                            </tr>
                        </thead>
                        <tbody id="productList">
                            {% for product in products %}
                            <tr>
                                <td><small>{{ product.code }}</small></td>
                                <td><strong>{{ product.name }}</strong></td>
                                <td><small>{{ product.description|truncatechars:40|default:"{% trans 'No description available' %}" }}</small></td>
                                <td class="text-center">
                                    <span class="badge bg-{% if product.current_stock > 0 %}success{% else %}danger{% endif %}">
                                        {{ product.current_stock|floatformat:3 }}
                                    </span>
                                </td>
                                <td>
                                    {% if product.last_purchase_price > 0 %}
                                        <span class="text-success">{{ product.last_purchase_price|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">{% trans "Not specified" %}</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ product.tax_rate|floatformat:2 }}%</small></td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="selectProduct('{{ product.id|escapejs }}', '{{ product.code|escapejs }}', '{{ product.name|escapejs }}', '{{ product.last_purchase_price|default:0 }}', '{{ product.tax_rate }}', '{{ product.current_stock }}')"
                                            title="{% trans "Select" %} {{ product.name|escapejs }}">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                    <p>{% trans "No products available" %}</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        {% trans "Available products count" %}: {{ products|length }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let productRowCount = 0;
let currentRow = null;

// Global currency settings
let currencySettings = {
    decimalPlaces: 2, // Default value
    symbol: '{% get_currency_symbol %}',
    showSymbol: true
};

// Load currency settings from API
function loadCurrencySettings() {
    fetch('/settings/api/currency/')
        .then(response => response.json())
        .then(data => {
            if (data.decimal_places !== undefined) {
                currencySettings.decimalPlaces = data.decimal_places;
                currencySettings.symbol = data.symbol || '{% get_currency_symbol %}';
                currencySettings.showSymbol = data.show_symbol;
                console.log('Currency settings loaded:', currencySettings);
            }
        })
        .catch(error => {
            console.error('Error loading currency settings:', error);
            // Keep default values
        });
}

// Format currency using current settings
function formatCurrency(value) {
    try {
        const num = Number(value) || 0;
        return num.toFixed(currencySettings.decimalPlaces);
    } catch (e) {
        console.error('formatCurrency error', e);
        return (Number(value) || 0).toFixed(currencySettings.decimalPlaces);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // التأكد من تحميل Bootstrap
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap غير {% trans "Available" %}');
        alert('{% trans "Error" %}: {% trans "Bootstrap library is not loaded. Please reload the page." %}');
        return;
    }
    
    // Load currency settings first
    loadCurrencySettings();
    
    // {% trans "Set current date" %}
    const dateInput = document.querySelector('input[name="date"]');
    if (dateInput) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // {% trans "Add initial product row" %}
    addProductRow();
    
    // {% trans "Add event listener for tax inclusive checkbox change" %}
    const taxInclusiveCheckbox = document.getElementById('is_tax_inclusive');
    if (taxInclusiveCheckbox) {
        taxInclusiveCheckbox.addEventListener('change', function() {
            // {% trans "Recalculate all rows when checkbox state changes" %}
            const rows = document.querySelectorAll('#productsTableBody tr');
            rows.forEach(row => {
                const rowId = row.id.replace('productRow', '');
                if (rowId) {
                    calculateRowTotal(parseInt(rowId));
                }
            });
        });
    }
    
    // {% trans "Set focus on supplier field" %}
    setTimeout(() => {
        const supplierSearch = document.getElementById('supplier_search');
        if (supplierSearch) {
            supplierSearch.focus();
            console.log('✅ Focus set on supplier search field');
        }
    }, 200);
    
    console.log('{% trans "Purchase invoice add page loaded" %}');
});

function addProductRow() {
    try {
        productRowCount++;
        const tbody = document.getElementById('productsTableBody');
        
        if (!tbody) {
            console.error('{% trans "Products table not found" %}');
            return;
        }
        
        const row = document.createElement('tr');
        row.id = `productRow${productRowCount}`;
        
        let taxCells = `
            <td>
                <input type="number" class="form-control" name="tax_rate[]" id="taxRate${productRowCount}" 
                       min="0" step="0.01" placeholder="0.000" readonly style="background-color: #e9ecef;" tabindex="-1" onchange="calculateRowTotal(${productRowCount})">
            </td>`;
        
        let taxAmountCells = `
            <td>
                <input type="text" class="form-control tax-amount-input" id="rowTax${productRowCount}" readonly placeholder="0.000" style="background-color: #e9ecef;" tabindex="-1">
            </td>`;
        
        row.innerHTML = `
            <td>
                <input type="hidden" name="product_id[]" id="productId${productRowCount}">
                <input type="hidden" name="row_tax[]" id="hiddenRowTax${productRowCount}">
                <input type="hidden" name="tax_rate_hidden[]" id="hiddenTaxRate${productRowCount}">
                <div class="d-flex align-items-center">
                    <div class="position-relative flex-grow-1 me-2">
                        <input type="text" class="form-control product-code-input" id="productCode${productRowCount}" 
                               placeholder="{% trans 'Product code...' %}" autocomplete="off">
                        <div class="product-code-dropdown dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                            <!-- Product code options will be populated here -->
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="openProductModal(${productRowCount})" title="{% trans 'Select product' %}">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </td>
            <td>
                <div class="position-relative">
                    <input type="text" class="form-control product-name-input" 
                           placeholder="{% trans 'Type product name...' %}" autocomplete="off">
                    <div class="product-dropdown dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                        <!-- Product options will be populated here -->
                    </div>
                </div>
            </td>
            <td>
                <input type="text" class="form-control text-center" id="availableQuantity${productRowCount}" 
                       placeholder="0.000" readonly style="background-color: #e9ecef;" tabindex="-1">
            </td>
            <td>
                <input type="number" class="form-control" name="quantity[]" id="quantity${productRowCount}" 
                       min="0" step="0.001" placeholder="0" onchange="calculateRowTotal(${productRowCount})">
            </td>
            <td>
                <input type="number" class="form-control" name="unit_price[]" id="unitPrice${productRowCount}" 
                       min="0" step="0.001" placeholder="0.000" onchange="calculateRowTotal(${productRowCount})">
            </td>
            ${taxCells}
            <td>
                <input type="text" class="form-control total-input" id="rowTotal${productRowCount}" readonly placeholder="0.000" style="background-color: #e9ecef;" tabindex="-1">
            </td>
            ${taxAmountCells}
            <td class="text-center">
                <button type="button" class="btn btn-remove-product text-white" onclick="removeProductRow(${productRowCount})" title="{% trans 'Delete product' %}">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        
        console.log(`تم إضافة صف منتج جديد: productRow${productRowCount}`);
        
        // Attach event listeners to the new row
        attachRowEventListeners(row);
        
        // Setup product search for the new row (if functions are available)
        // Use setTimeout to ensure the row is fully added to DOM
        setTimeout(function() {
            if (typeof window.setupProductSearchForRow === 'function') {
                window.setupProductSearchForRow(row);
            }
        }, 100);
        
        // Focus on quantity input of the new row
        const newQuantityInput = document.getElementById(`quantity${productRowCount}`);
        if (newQuantityInput) {
            setTimeout(() => newQuantityInput.focus(), 10);
        }
        
        // زيادة المسافة الفارغة أسفل الجدول مع كل صف جديد
        const productsTable = document.querySelector('.products-table');
        if (productsTable) {
            const currentPadding = parseInt(window.getComputedStyle(productsTable).paddingBottom) || 50;
            const newPadding = currentPadding + 40; // زيادة 40px مع كل صف جديد
            productsTable.style.paddingBottom = newPadding + 'px';
            console.log('✅ Increased table bottom padding to:', newPadding + 'px');
        }
        
        // Mark as having unsaved changes
        hasUnsavedChanges = true;
        
    } catch (error) {
        console.error('{% trans "Error adding product row" %}:', error);
        alert('{% trans "Error adding new product row" %}');
    }
}

function removeProductRow(rowId) {
    const row = document.getElementById(`productRow${rowId}`);
    if (row) {
        // Check if this is the last row
        const allRows = document.querySelectorAll('#productsTableBody tr');
        if (allRows.length <= 1) {
            alert("{% trans 'Invoice must contain at least one product' %}");
            return;
        }
        
        row.remove();
        calculateTotals();
        
        // تقليل المسافة الفارغة أسفل الجدول عند حذف صف
        const productsTable = document.querySelector('.products-table');
        if (productsTable) {
            const currentPadding = parseInt(window.getComputedStyle(productsTable).paddingBottom) || 50;
            const newPadding = Math.max(50, currentPadding - 40); // تقليل 40px، لكن لا تقل عن 50px
            productsTable.style.paddingBottom = newPadding + 'px';
            console.log('✅ Decreased table bottom padding to:', newPadding + 'px');
        }
    }
}

function openProductModal(rowId) {
    currentRow = rowId;
    
    // {% trans "Ensure modal exists" %}
    const modalElement = document.getElementById('productModal');
    if (!modalElement) {
        console.error('{% trans "Product modal not found" %}');
        alert('{% trans "Error" %}: {% trans "Product selection window not found" %}');
        return;
    }
    
    try {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } catch (error) {
        console.error('{% trans "Error opening product modal" %}:', error);
        alert('{% trans "Error opening product selection window" %}');
    }
}

function selectProduct(productId, productCode, productName, lastPurchasePrice, taxRate, availableQuantity) {
    if (!currentRow) {
        console.error('{% trans "Current row not selected" %}');
        return;
    }
    
    try {
        const row = document.getElementById(`productRow${currentRow}`);
        if (!row) {
            console.error('{% trans "Product row not found" %}', currentRow);
            return;
        }
        
        const productIdInput = row.querySelector(`#productId${currentRow}`);
        const productCodeInput = row.querySelector(`#productCode${currentRow}`);
        const productNameInput = row.querySelector('.product-name-input');
        const availableQuantityInput = row.querySelector(`#availableQuantity${currentRow}`);
        const unitPriceInput = row.querySelector(`#unitPrice${currentRow}`);
        const taxRateInput = row.querySelector(`#taxRate${currentRow}`);
        const hiddenTaxRateInput = row.querySelector(`#hiddenTaxRate${currentRow}`);
        
        if (!productIdInput || !productCodeInput || !productNameInput) {
            console.error('{% trans "Product fields not found in row" %}', currentRow);
            return;
        }
        
        // {% trans "Fill product data" %}
        productIdInput.value = productId;
        productCodeInput.value = productCode;
        productNameInput.value = productName;
        
        // {% trans "Fill available quantity" %}
        if (availableQuantityInput) {
            availableQuantityInput.value = parseFloat(availableQuantity || 0).toFixed(3);
        }
        
        // {% trans "Update tax rate" %}
        console.log('{% trans "Filling tax rate" %}:', taxRate);
        if (taxRateInput) {
            taxRateInput.value = parseFloat(taxRate || 0).toFixed(2);
            console.log('{% trans "taxRateInput filled" %}:', taxRateInput.value);
        }
        if (hiddenTaxRateInput) {
            hiddenTaxRateInput.value = parseFloat(taxRate || 0).toFixed(2);
            console.log('{% trans "hiddenTaxRateInput filled" %}:', hiddenTaxRateInput.value);
        }
        
        // {% trans "Fill last purchase price as suggested value" %}
        if (lastPurchasePrice && parseFloat(lastPurchasePrice) > 0 && unitPriceInput) {
            unitPriceInput.value = parseFloat(lastPurchasePrice).toFixed(3);
            console.log('{% trans "Unit price filled" %}:', unitPriceInput.value);
        }
        
        // {% trans "Wait a bit to ensure all data is filled then calculate total" %}
        setTimeout(() => {
            calculateRowTotal(currentRow);
        }, 100);
        
        // {% trans "Close modal" %}
        const modalElement = document.getElementById('productModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
        
        // {% trans "Focus on quantity field" %}
        const quantityInput = row.querySelector(`#quantity${currentRow}`);
        if (quantityInput) {
            quantityInput.focus();
        }
        
    } catch (error) {
        console.error('{% trans "Error selecting product" %}:', error);
        alert('{% trans "Error selecting product" %}');
    }
}

function calculateRowTotal(rowId) {
    console.log('{% trans "Calculating row total" %}:', rowId);
    
    const quantity = parseFloat(document.getElementById(`quantity${rowId}`).value) || 0;
    const unitPrice = parseFloat(document.getElementById(`unitPrice${rowId}`).value) || 0;
    
    console.log('{% trans "Quantity" %}:', quantity, '{% trans "Price" %}:', unitPrice);
    
    // {% trans "Get tax rate from visible or hidden field" %}
    let taxRate = 0;
    const taxRateElement = document.getElementById(`taxRate${rowId}`);
    const hiddenTaxRateElement = document.getElementById(`hiddenTaxRate${rowId}`);
    
    if (taxRateElement && taxRateElement.value) {
        taxRate = parseFloat(taxRateElement.value) || 0;
        console.log('{% trans "Tax rate from visible field" %}:', taxRate);
    } else if (hiddenTaxRateElement && hiddenTaxRateElement.value) {
        taxRate = parseFloat(hiddenTaxRateElement.value) || 0;
        console.log('{% trans "Tax rate from hidden field" %}:', taxRate);
    }
    
    console.log('{% trans "Final tax rate" %}:', taxRate);
    
    // {% trans "Calculate subtotal (without tax)" %}
    const subtotal = quantity * unitPrice;
    
    // {% trans "Check tax inclusive checkbox state" %}
    const isTaxInclusive = document.getElementById('is_tax_inclusive').checked;
    
    // {% trans "Calculate tax amount" %}
    const taxAmount = isTaxInclusive ? subtotal * (taxRate / 100) : 0;
    
    // {% trans "Total amount" %}
    const total = subtotal + taxAmount;
    
    console.log('{% trans "Subtotal" %}:', subtotal, '{% trans "Tax" %}:', taxAmount, '{% trans "Total" %}:', total);
    
    // {% trans "Update subtotal field" %}
    const rowTotalElement = document.getElementById(`rowTotal${rowId}`);
    if (rowTotalElement) {
        rowTotalElement.value = subtotal.toFixed(currencySettings.decimalPlaces);
    }
    
    // {% trans "Update tax field if exists" %}
    const rowTaxElement = document.getElementById(`rowTax${rowId}`);
    if (rowTaxElement) {
        rowTaxElement.value = taxAmount.toFixed(currencySettings.decimalPlaces);
        console.log('{% trans "Visible tax field updated" %}:', taxAmount.toFixed(currencySettings.decimalPlaces));
    }
    
    // {% trans "Update hidden tax field" %}
    const hiddenTaxField = document.getElementById(`hiddenRowTax${rowId}`);
    if (hiddenTaxField) {
        hiddenTaxField.value = taxAmount.toFixed(currencySettings.decimalPlaces);
        console.log('{% trans "Hidden tax field updated" %}:', taxAmount.toFixed(currencySettings.decimalPlaces));
    }
    
    calculateTotals();
}

function calculateTotals() {
    let subtotal = 0;
    let totalTax = 0;
    
    // {% trans "Calculate subtotal and total taxes" %}
    const rows = document.querySelectorAll('#productsTableBody tr');
    rows.forEach(row => {
        const rowTotalInput = row.querySelector('[id^="rowTotal"]');
        let rowTaxInput = row.querySelector('[id^="rowTax"]');
        
        if (rowTotalInput && rowTotalInput.value) {
            subtotal += parseFloat(rowTotalInput.value) || 0;
        }
        
        // {% trans "If visible tax field not found, look for hidden field" %}
        if (!rowTaxInput) {
            rowTaxInput = row.querySelector('[id^="hiddenRowTax"]');
        }
        
        if (rowTaxInput && rowTaxInput.value) {
            totalTax += parseFloat(rowTaxInput.value) || 0;
        }
    });
    
    const total = subtotal + totalTax;
    
    // {% trans "Update display using currency settings" %}
    const decimalPlaces = currencySettings.decimalPlaces;
    document.getElementById('subtotalDisplay').textContent = subtotal.toFixed(decimalPlaces) + ' ' + currencySettings.symbol;
    document.getElementById('taxDisplay').textContent = totalTax.toFixed(decimalPlaces) + ' ' + currencySettings.symbol;
    document.getElementById('totalDisplay').textContent = total.toFixed(decimalPlaces) + ' ' + currencySettings.symbol;
}

function attachRowEventListeners(row) {
    const quantityInput = row.querySelector('[id^="quantity"]');
    const unitPriceInput = row.querySelector('[id^="unitPrice"]');
    const taxRateInput = row.querySelector('[id^="taxRate"]');
    
    // Calculate totals on quantity/unit price/tax rate change
    if (quantityInput) {
        quantityInput.addEventListener('input', function() {
            const rowId = this.id.replace('quantity', '');
            calculateRowTotal(rowId);
        });
    }
    
    if (unitPriceInput) {
        unitPriceInput.addEventListener('input', function() {
            const rowId = this.id.replace('unitPrice', '');
            calculateRowTotal(rowId);
        });
        
        // إزالة إضافة صف جديد عند الضغط على Tab
        // unitPriceInput.addEventListener('keydown', function(e) {
        //     if (e.key === 'Tab') {
        //         e.preventDefault();
        //         addProductRow();
        //     }
        // });
    }
    
    if (taxRateInput) {
        taxRateInput.addEventListener('input', function() {
            const rowId = this.id.replace('taxRate', '');
            calculateRowTotal(rowId);
        });
    }
    
    // Setup product search functionality for this row (will be called after functions are defined)
    // Mark row as needing search setup
    if (!row.hasAttribute('data-needs-search-setup')) {
        row.setAttribute('data-needs-search-setup', 'true');
    }
}

// {% trans "Search in products" %}
document.getElementById('productSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#productList tr');
    
    rows.forEach(row => {
        const productCode = row.cells[0].textContent.toLowerCase();
        const productName = row.cells[1].textContent.toLowerCase();
        const productDescription = row.cells[2].textContent.toLowerCase();
        const lastPurchasePrice = row.cells[3].textContent.toLowerCase();
        
        // {% trans "Search in available text only" %}
        let searchableText = productCode + ' ' + productName + ' ' + productDescription + ' ' + lastPurchasePrice;
        
        // {% trans "Add tax rate to search if exists" %}
        if (row.cells.length > 5) { // {% trans "means tax column exists" %}
            const productTax = row.cells[4].textContent.toLowerCase();
            searchableText += ' ' + productTax;
        }
        
        if (searchableText.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// {% trans "Validate form before submission" %}
document.getElementById('invoiceForm').addEventListener('submit', function(e) {
    // التحقق من المورد
    const supplierSelect = document.getElementById('supplierSelect');
    if (!supplierSelect || !supplierSelect.value) {
        e.preventDefault();
        alert('{% trans "يرجى اختيار المورد" %}');
        return false;
    }
    
    // التحقق من طريقة الدفع
    const paymentTypeSelect = document.getElementById('id_payment_type');
    if (!paymentTypeSelect || !paymentTypeSelect.value) {
        e.preventDefault();
        alert('{% trans "يرجى اختيار طريقة الدفع" %}');
        return false;
    }
    
    // التحقق من المستودع
    const warehouseSelect = document.getElementById('id_warehouse');
    if (!warehouseSelect || !warehouseSelect.value) {
        e.preventDefault();
        alert('{% trans "يرجى اختيار المستودع" %}');
        return false;
    }
    
    const rows = document.querySelectorAll('#productsTableBody tr');
    let hasProducts = false;
    
    rows.forEach(row => {
        const productId = row.querySelector('[name="product_id[]"]').value;
        const quantity = row.querySelector('[name="quantity[]"]').value;
        
        if (productId && quantity && parseFloat(quantity) > 0) {
            hasProducts = true;
        }
    });
    
    if (!hasProducts) {
        e.preventDefault();
        alert('{% trans "At least one product must be added to the invoice" %}!');
        return false;
    }
});

// {% trans "Supplier management functions" %}
function openNewSupplierModal() {
    console.log('{% trans "New supplier creation button clicked" %}');
    const modal = document.getElementById('newSupplierModal');
    if (modal) {
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        console.log('{% trans "Modal opened successfully" %}');
    } else {
        console.error('{% trans "Modal not found" %}');
        alert('{% trans "Error" %}: {% trans "Supplier creation window not found" %}');
    }
}

function saveNewSupplier() {
    console.log('{% trans "Starting to save new supplier" %}');
    const form = document.getElementById('newSupplierForm');
    const formData = new FormData(form);
    
    // {% trans "Add CSRF token" %}
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    console.log('{% trans "Sending data to server" %}...');
    
    fetch('{% url "customers:ajax_add_supplier" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        console.log('استجابة من الخادم:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('البيانات المستلمة:', data);
        if (data.success) {
            // {% trans "Add new supplier to list" %}
            const supplierSelect = document.getElementById('supplierSelect');
            const supplierDropdown = document.getElementById('supplier-dropdown');
            const supplierSearch = document.getElementById('supplier_search');
            
            const newOption = new Option(data.supplier.name, data.supplier.id, true, true);
            supplierSelect.add(newOption);
            supplierSelect.value = data.supplier.id;
            
            // Add to dropdown
            const newDropdownOption = document.createElement('button');
            newDropdownOption.type = 'button';
            newDropdownOption.className = 'dropdown-item';
            newDropdownOption.textContent = data.supplier.name;
            newDropdownOption.setAttribute('data-id', data.supplier.id);
            
            newDropdownOption.addEventListener('click', function() {
                supplierSearch.value = data.supplier.name;
                supplierSelect.value = data.supplier.id;
                supplierDropdown.style.display = 'none';
                // Trigger change event for balance update
                supplierSelect.dispatchEvent(new Event('change'));
            });
            
            supplierDropdown.appendChild(newDropdownOption);
            
            // Update search input
            supplierSearch.value = data.supplier.name;
            
            // {% trans "Close modal and reset form" %}
            const modal = bootstrap.Modal.getInstance(document.getElementById('newSupplierModal'));
            modal.hide();
            form.reset();
            
            alert('{% trans "Supplier created successfully" %}!');
            console.log('{% trans "Supplier saved successfully" %}');
        } else {
            console.error('{% trans "Server error" %}:', data.message);
            alert('{% trans "Error" %}: ' + (data.message || '{% trans "Error occurred while creating supplier" %}'));
        }
    })
    .catch(error => {
        console.error('{% trans "Error" %} في الشبكة:', error);
        alert('حدث {% trans "Error" %} أثناء إنشاء المورد. {% trans "Please try again" %}.');
    });
}

// {% trans "Function to update supplier balance" %}
function updateSupplierBalance() {
    const supplierSelect = document.getElementById('supplierSelect');
    const balanceInfo = document.getElementById('supplier-balance-info');
    const balanceAmount = document.getElementById('supplier-balance-amount');
    
    if (!supplierSelect.value) {
        balanceInfo.style.display = 'none';
        return;
    }
    
    // {% trans "Call API to get supplier information" %}
    const apiUrl = `/customers/api/customer/${supplierSelect.value}/`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('{% trans "Error getting supplier data" %}:', data.error);
                balanceInfo.style.display = 'none';
                return;
            }
            
            // {% trans "Get currency information from company" %}
            fetch('/settings/api/currency/')
                .then(currResponse => currResponse.json())
                .then(currencyData => {
                    // Update global currency settings
                    if (currencyData.decimal_places !== undefined) {
                        currencySettings.decimalPlaces = currencyData.decimal_places;
                        currencySettings.symbol = currencyData.symbol || '{% get_currency_symbol %}';
                        currencySettings.showSymbol = currencyData.show_symbol;
                    }
                    
                    // {% trans "View current balance" %}
                    const balance = parseFloat(data.current_balance);
                    const balanceText = balance.toLocaleString('ar-SA', {
                        minimumFractionDigits: currencySettings.decimalPlaces,
                        maximumFractionDigits: currencySettings.decimalPlaces
                    });
                    
                    // {% trans "Use currency from company settings" %}
                    let currencyText = '';
                    if (currencySettings.showSymbol && currencySettings.symbol) {
                        currencyText = currencySettings.symbol;
                    } else {
                        currencyText = currencyData.code || 'ر.س';
                    }
                    
                    balanceAmount.textContent = balanceText + ' ' + currencyText;
                    
                    // {% trans "Change text color based on balance" %}
                    if (balance > 0) {
                        balanceAmount.className = 'fw-bold text-success';
                    } else if (balance < 0) {
                        balanceAmount.className = 'fw-bold text-danger';
                    } else {
                        balanceAmount.className = 'fw-bold text-muted';
                    }
                    
                    balanceInfo.style.display = 'block';
                })
                .catch(currError => {
                    console.error('{% trans "Error getting currency data" %}:', currError);
                    // {% trans "In case of failure to get currency, use default currency" %}
                    const balance = parseFloat(data.current_balance);
                    const balanceText = balance.toLocaleString('ar-SA', {
                        minimumFractionDigits: currencySettings.decimalPlaces,
                        maximumFractionDigits: currencySettings.decimalPlaces
                    });
                    
                    balanceAmount.textContent = balanceText + ' ' + currencySettings.symbol;
                    
                    if (balance > 0) {
                        balanceAmount.className = 'fw-bold text-success';
                    } else if (balance < 0) {
                        balanceAmount.className = 'fw-bold text-danger';
                    } else {
                        balanceAmount.className = 'fw-bold text-muted';
                    }
                    
                    balanceInfo.style.display = 'block';
                });
        })
        .catch(error => {
            console.error('{% trans "Network error" %}:', error);
            balanceInfo.style.display = 'none';
        });
}

// {% trans "Bind event to supplier change" %}
document.getElementById('supplierSelect').addEventListener('change', updateSupplierBalance);
</script>

<!-- نافذة إنشاء مورد {% trans "New" %} -->
<div class="modal fade" id="newSupplierModal" tabindex="-1" aria-labelledby="newSupplierModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newSupplierModalLabel">
                    <i class="fas fa-plus me-2"></i>{% trans "Create New Supplier" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newSupplierForm">
                    {% csrf_token %}
                    
                    <!-- معلومات المورد الأساسية -->
                    <div class="mb-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">
                            <i class="fas fa-user me-2"></i>{% trans "Basic Supplier Information" %}
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Supplier Name" %} *</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Phone Number" %}</label>
                                    <input type="text" class="form-control" name="phone">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Email" %}</label>
                                    <input type="email" class="form-control" name="email">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Tax Number" %}</label>
                                    <input type="text" class="form-control" name="tax_number">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{% trans "Address" %}</label>
                            <textarea class="form-control" name="address" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">{% trans "City" %} <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="city" required>
                        </div>
                    </div>
                    
                    <!-- معلومات المورد المالية -->
                    <div class="mb-4">
                        <h6 class="text-success border-bottom pb-2 mb-3">
                            <i class="fas fa-money-bill-wave me-2"></i>ال{% trans "Information" %} المالية
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Credit Limit" %}</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="credit_limit" 
                                               value="0" step="0.001" min="0">
                                        <span class="input-group-text">{% get_currency_symbol %}</span>
                                    </div>
                                    <div class="form-text">{% trans "Maximum amount the supplier can be debited" %}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Initial Balance" %}</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="balance" 
                                               value="0" step="0.001">
                                        <span class="input-group-text">{% get_currency_symbol %}</span>
                                    </div>
                                    <div class="form-text">{% trans "Current Balance (positive: credit, negative: debit)" %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- معلومات إضافية -->
                    <div class="mb-3">
                        <h6 class="text-info border-bottom pb-2 mb-3">
                            <i class="fas fa-sticky-note me-2"></i>{% trans "Information" %} إضافية
                        </h6>
                        <div class="mb-3">
                            <label class="form-label">{% trans "Notes" %}</label>
                            <textarea class="form-control" name="notes" rows="2"></textarea>
                            <div class="form-text">{% trans "Any additional notes or information" %}</div>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_active" id="supplierIsActive" checked>
                            <label class="form-check-label" for="supplierIsActive">
                                {% trans "Active Supplier" %}
                            </label>
                            <div class="form-text">{% trans "Deactivating hides the supplier from lists" %}</div>
                        </div>
                    </div>
                    
                    <input type="hidden" name="type" value="supplier">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-success" onclick="saveNewSupplier()">
                    <i class="fas fa-save me-1"></i>{% trans "Save Supplier" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- {% trans "Critical JavaScript for Purchase Invoice - Enhanced" %} -->
<script>
// Enhanced Page Load Management for Purchase Invoice
let isPageReady = false;
let productRowCounter = 0;

function ensurePageReady() {
    console.log('🔄 Ensuring purchase invoice page readiness...');
    
    // Force apply critical styles to add product button
    const addBtn = document.getElementById('addProductBtn');
    if (addBtn) {
        // Force apply button styles immediately
        addBtn.style.cssText = `
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
            border: none !important;
            border-radius: 25px !important;
            padding: 0.5rem 1rem !important;
            transition: all 0.3s ease !important;
            color: white !important;
            cursor: pointer !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 38px !important;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2) !important;
            text-decoration: none !important;
            font-weight: 500 !important;
        `;
        console.log('✅ Purchase invoice button styles applied directly');
    }
    
    isPageReady = true;
}

// Enhanced button setup with multiple fallbacks
function setupAddProductButton() {
    console.log('🎯 Setting up add product button for purchase invoice...');
    
    const addBtn = document.getElementById('addProductBtn');
    if (!addBtn) {
        console.error('❌ Add product button not found for purchase invoice!');
        // Retry after a short delay
        setTimeout(setupAddProductButton, 500);
        return;
    }
    
    // Remove any existing listeners
    const newBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newBtn, addBtn);
    
    // Add click event listener
    newBtn.addEventListener('click', function(e) {
        console.log('🖱️ Purchase invoice add product button clicked');
        
        e.preventDefault();
        e.stopPropagation();
        
        try {
            // Call the existing addProductRow function if it exists
            if (typeof addProductRow === 'function') {
                addProductRow();
                console.log('✅ Product row added successfully for purchase invoice');
                
                // Focus on the first product code input of the new row
                setTimeout(() => {
                    const lastRow = document.querySelector('#productsTableBody tr:last-child');
                    if (lastRow) {
                        const productCodeInput = lastRow.querySelector('.product-code-input');
                        if (productCodeInput) {
                            productCodeInput.focus();
                            console.log('✅ Focus set on new product code input');
                        }
                    }
                }, 100);
            } else {
                console.error('❌ {% trans "addProductRow function not found" %}');
                alert('{% trans "Error: Product addition function not available. Please reload the page." %}');
            }
        } catch (error) {
            console.error('❌ {% trans "Error adding product row in purchase invoice" %}:', error);
            alert('{% trans "Error occurred while adding product. Please try again." %}');
        }
    });
    
    // {% trans "Ensure button styling" %}
    newBtn.style.cssText = `
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border: none !important;
        border-radius: 25px !important;
        padding: 0.5rem 1rem !important;
        transition: all 0.3s ease !important;
        color: white !important;
        cursor: pointer !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 38px !important;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2) !important;
        text-decoration: none !important;
        font-weight: 500 !important;
    `;
    
    console.log('✅ Purchase invoice add product button setup complete');
}

// Multiple initialization strategies
function initializePurchasePage() {
    console.log('🚀 Initializing purchase invoice page...');
    
    // Strategy 1: Immediate initialization
    ensurePageReady();
    
    // Strategy 2: Setup button event listeners
    setTimeout(setupAddProductButton, 100);
}

// Primary DOM Content Loaded handler
document.addEventListener('DOMContentLoaded', function() {
    console.log('📄 Purchase Invoice DOM Content Loaded');
    initializePurchasePage();
});

// Fallback: Window load handler
window.addEventListener('load', function() {
    console.log('🖼️ Purchase Invoice Window fully loaded');
    if (!isPageReady) {
        initializePurchasePage();
    }
});

// Additional fallback with timeout
setTimeout(function() {
    console.log('⏰ Purchase Invoice timeout fallback triggered');
    if (!isPageReady) {
        console.log('⚠️ Purchase Invoice page not ready, forcing initialization...');
        initializePurchasePage();
    }
}, 1000);

// Final styling enforcement - runs after everything else
function enforceButtonStyling() {
    const addBtn = document.getElementById('addProductBtn');
    if (addBtn) {
        // Force styling with maximum priority
        const criticalStyles = {
            'background': 'linear-gradient(135deg, #007bff 0%, #0056b3 100%)',
            'border': 'none',
            'border-radius': '25px',
            'padding': '0.5rem 1rem',
            'transition': 'all 0.3s ease',
            'color': 'white',
            'cursor': 'pointer',
            'display': 'inline-flex',
            'align-items': 'center',
            'justify-content': 'center',
            'min-height': '38px',
            'box-shadow': '0 2px 8px rgba(0, 123, 255, 0.2)',
            'text-decoration': 'none',
            'font-weight': '500'
        };
        
        // Apply each style with !important
        Object.entries(criticalStyles).forEach(([property, value]) => {
            addBtn.style.setProperty(property, value, 'important');
        });
        
        console.log('🎨 Final purchase invoice button styling enforced');
    }
}

// Run styling enforcement multiple times
setTimeout(enforceButtonStyling, 100);
setTimeout(enforceButtonStyling, 500);
setTimeout(enforceButtonStyling, 1000);
setTimeout(enforceButtonStyling, 2000);

// Continuous monitoring for styling
setInterval(function() {
    const addBtn = document.getElementById('addProductBtn');
    if (addBtn) {
        const computedStyle = window.getComputedStyle(addBtn);
        const bgColor = computedStyle.backgroundColor;
        
        // Check if button lost its blue styling
        if (!bgColor.includes('rgb(0, 123, 255)') && !bgColor.includes('rgb(0, 86, 179)')) {
            console.log('🔧 {% trans "Re-applying purchase invoice button styling" %}...');
            enforceButtonStyling();
        }
    }
}, 3000);

console.log('🚀 {% trans "Purchase Invoice Critical JavaScript loaded and monitoring started" %}');
</script>

<!-- Supplier Search and Filter JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const supplierSearch = document.getElementById('supplier_search');
    const supplierSelect = document.getElementById('supplierSelect');
    const supplierDropdown = document.getElementById('supplier-dropdown');
    
    // Store supplier data
    const suppliers = [
        {% for supplier in suppliers %}
        {id: {{ supplier.id }}, name: "{{ supplier.name|escapejs }}"},
        {% endfor %}
    ];
    
    if (supplierSearch && supplierSelect && supplierDropdown) {
        // Function to filter and show suppliers
        function filterSuppliers() {
            const searchTerm = supplierSearch.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                supplierDropdown.style.display = 'none';
                return;
            }
            
            // Clear previous options
            supplierDropdown.innerHTML = '';
            
            // Filter suppliers
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredSuppliers.length === 0) {
                supplierDropdown.style.display = 'none';
                return;
            }
            
            // Create dropdown options
            filteredSuppliers.forEach(supplier => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'dropdown-item';
                option.textContent = supplier.name;
                option.setAttribute('data-id', supplier.id);
                
                option.addEventListener('click', function() {
                    supplierSearch.value = supplier.name;
                    supplierSelect.value = supplier.id;
                    supplierDropdown.style.display = 'none';
                    // Trigger change event for balance update
                    supplierSelect.dispatchEvent(new Event('change'));
                });
                
                supplierDropdown.appendChild(option);
            });
            
            supplierDropdown.style.display = 'block';
        }
        
        // Handle input changes
        supplierSearch.addEventListener('input', filterSuppliers);
        
        // Handle focus to show all suppliers if empty
        supplierSearch.addEventListener('focus', function() {
            if (supplierSearch.value.trim() === '') {
                // Show all suppliers
                supplierDropdown.innerHTML = '';
                suppliers.forEach(supplier => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'dropdown-item';
                    option.textContent = supplier.name;
                    option.setAttribute('data-id', supplier.id);
                    
                    option.addEventListener('click', function() {
                        supplierSearch.value = supplier.name;
                        supplierSelect.value = supplier.id;
                        supplierDropdown.style.display = 'none';
                        // Trigger change event for balance update
                        supplierSelect.dispatchEvent(new Event('change'));
                    });
                    
                    supplierDropdown.appendChild(option);
                });
                supplierDropdown.style.display = 'block';
            }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!supplierSearch.contains(e.target) && !supplierDropdown.contains(e.target)) {
                supplierDropdown.style.display = 'none';
            }
        });
        
        // Handle blur with delay to allow click on dropdown items
        supplierSearch.addEventListener('blur', function() {
            setTimeout(() => {
                if (supplierSearch.value && !supplierSelect.value) {
                    // If user typed something but didn't select from dropdown, clear it
                    supplierSearch.value = '';
                    supplierSelect.value = '';
                }
            }, 200);
        });
        
        // Update search input when select changes (e.g., from new supplier modal)
        supplierSelect.addEventListener('change', function() {
            if (supplierSelect.value) {
                const selectedOption = supplierSelect.querySelector('option[value="' + supplierSelect.value + '"]');
                if (selectedOption) {
                    supplierSearch.value = selectedOption.textContent;
                }
            } else {
                supplierSearch.value = '';
            }
        });
    }
});
</script>

<!-- Product Name Search and Filter JavaScript -->
<script>
// Format currency function
function formatCurrency(value, overridePlaces) {
    try {
        const places = (typeof overridePlaces === 'number') ? overridePlaces : 2;
        if (value === null || value === undefined || isNaN(Number(value))) return (0).toFixed(places);
        return Number(value).toFixed(places);
    } catch(e) {
        console.error('formatCurrency error', e);
        return (Number(value) || 0).toFixed(2);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Store product data
    const products = [
        {% for product in products %}
        {
            id: '{{ product.id }}',
            code: '{{ product.code|escapejs }}',
            name: '{{ product.name|escapejs }}',
            description: '{{ product.description|escapejs|truncatechars:40|default:"No description available"|escapejs }}',
            last_purchase_price: '{{ product.last_purchase_price|default:0 }}',
            tax_rate: '{{ product.tax_rate }}',
            current_stock: '{{ product.current_stock }}'
        },
        {% endfor %}
    ];

    // Function to handle product search for each row
    function setupProductSearch(row) {
        const nameInput = row.querySelector('.product-name-input');
        const dropdown = row.querySelector('.product-dropdown');
        const productIdInput = row.querySelector('input[name="product_id[]"]');
        const codeInput = row.querySelector('input[id^="productCode"]');
        const availableQuantityInput = row.querySelector('input[id^="availableQuantity"]');
        const priceInput = row.querySelector('input[name="unit_price[]"]');
        const taxRateInput = row.querySelector('input[name="tax_rate[]"]');

        if (!nameInput || !dropdown) return;

        // Function to filter and show products
        function filterProducts() {
            const searchTerm = nameInput.value.toLowerCase().trim();

            if (searchTerm === '') {
                dropdown.style.display = 'none';
                return;
            }

            // Clear previous options
            dropdown.innerHTML = '';

            // Filter products
            const filteredProducts = products.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                product.code.toLowerCase().includes(searchTerm)
            );

            if (filteredProducts.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            // Create dropdown options
            filteredProducts.forEach(product => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'dropdown-item';
                option.innerHTML = `<strong>${product.name}</strong> (${product.code}) - ${product.current_stock} available`;
                option.setAttribute('data-product', JSON.stringify(product));

                option.addEventListener('click', function() {
                    // Fill all product fields
                    productIdInput.value = product.id;
                    codeInput.value = product.code;
                    nameInput.value = product.name;
                    if (availableQuantityInput) {
                        availableQuantityInput.value = formatCurrency(parseFloat(product.current_stock || 0), 3);
                    }
                    priceInput.value = formatCurrency(parseFloat(product.last_purchase_price || 0), 3);
                    taxRateInput.value = parseFloat(product.tax_rate) || 0;

                    dropdown.style.display = 'none';

                    // Calculate row total
                    const row = nameInput.closest('tr');
                    if (row && typeof calculateRowTotal === 'function') {
                        // Extract row number from row id
                        const rowId = row.id.replace('productRow', '');
                        calculateRowTotal(rowId);
                        calculateGrandTotal();
                    }
                });

                dropdown.appendChild(option);
            });

            dropdown.style.display = 'block';
        }

        // Handle input changes
        nameInput.addEventListener('input', filterProducts);

        // Handle focus to show all products if empty
        nameInput.addEventListener('focus', function() {
            if (nameInput.value.trim() === '') {
                // Show all products
                dropdown.innerHTML = '';
                products.slice(0, 10).forEach(product => { // Show first 10 products
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'dropdown-item';
                    option.innerHTML = `<strong>${product.name}</strong> (${product.code}) - ${product.current_stock} available`;
                    option.setAttribute('data-product', JSON.stringify(product));

                    option.addEventListener('click', function() {
                        // Fill all product fields
                        productIdInput.value = product.id;
                        codeInput.value = product.code;
                        nameInput.value = product.name;
                        if (availableQuantityInput) {
                            availableQuantityInput.value = formatCurrency(parseFloat(product.current_stock || 0), 3);
                        }
                        priceInput.value = formatCurrency(parseFloat(product.last_purchase_price || 0), 3);
                        taxRateInput.value = parseFloat(product.tax_rate) || 0;

                        dropdown.style.display = 'none';

                        // Calculate row total
                        const row = nameInput.closest('tr');
                        if (row && typeof calculateRowTotal === 'function') {
                            // Extract row number from row id
                            const rowId = row.id.replace('productRow', '');
                            calculateRowTotal(rowId);
                            calculateGrandTotal();
                        }
                    });

                    dropdown.appendChild(option);
                });
                dropdown.style.display = 'block';
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!nameInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Handle blur with delay to allow click on dropdown items
        nameInput.addEventListener('blur', function() {
            setTimeout(() => {
                if (nameInput.value && !productIdInput.value) {
                    // If user typed something but didn't select from dropdown, clear it
                    nameInput.value = '';
                }
            }, 200);
        });
    }

    // Function to handle product code search for each row
    function setupProductCodeSearch(row) {
        const codeInput = row.querySelector('.product-code-input');
        const dropdown = row.querySelector('.product-code-dropdown');
        const productIdInput = row.querySelector('input[name="product_id[]"]');
        const nameInput = row.querySelector('.product-name-input');
        const availableQuantityInput = row.querySelector('input[id^="availableQuantity"]');
        const priceInput = row.querySelector('input[name="unit_price[]"]');
        const taxRateInput = row.querySelector('input[name="tax_rate[]"]');

        if (!codeInput || !dropdown) return;

        // Function to filter and show products by code
        function filterProductsByCode() {
            const searchTerm = codeInput.value.toLowerCase().trim();

            if (searchTerm === '') {
                dropdown.style.display = 'none';
                return;
            }

            // Clear previous options
            dropdown.innerHTML = '';

            // Filter products by code
            const filteredProducts = products.filter(product =>
                product.code.toLowerCase().includes(searchTerm)
            );

            if (filteredProducts.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            // Create dropdown options
            filteredProducts.forEach(product => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'dropdown-item';
                option.innerHTML = `<strong>${product.code}</strong> - ${product.name} (${product.current_stock} available)`;
                option.setAttribute('data-product', JSON.stringify(product));

                option.addEventListener('click', function() {
                    // Fill all product fields
                    productIdInput.value = product.id;
                    codeInput.value = product.code;
                    nameInput.value = product.name;
                    if (availableQuantityInput) {
                        availableQuantityInput.value = formatCurrency(parseFloat(product.current_stock || 0), 3);
                    }
                    priceInput.value = formatCurrency(parseFloat(product.last_purchase_price || 0), 3);
                    taxRateInput.value = parseFloat(product.tax_rate) || 0;

                    dropdown.style.display = 'none';

                    // Calculate row total
                    const row = codeInput.closest('tr');
                    if (row && typeof calculateRowTotal === 'function') {
                        // Extract row number from row id
                        const rowId = row.id.replace('productRow', '');
                        calculateRowTotal(rowId);
                        calculateGrandTotal();
                    }
                });

                dropdown.appendChild(option);
            });

            dropdown.style.display = 'block';
        }

        // Handle input changes
        codeInput.addEventListener('input', filterProductsByCode);

        // Handle focus to show matching products if not empty
        codeInput.addEventListener('focus', function() {
            if (codeInput.value.trim() !== '') {
                filterProductsByCode();
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!codeInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Handle blur with delay to allow click on dropdown items
        codeInput.addEventListener('blur', function() {
            setTimeout(() => {
                if (codeInput.value && !productIdInput.value) {
                    // If user typed something but didn't select from dropdown, clear it
                    codeInput.value = '';
                }
            }, 200);
        });
    }

    // Setup product search for existing rows and new rows
    function setupAllProductSearches() {
        document.querySelectorAll('#productsTableBody tr').forEach(row => {
            // Check if row needs search setup (either not setup yet or marked as needing setup)
            if (!row.hasAttribute('data-product-search-setup') || row.hasAttribute('data-needs-search-setup')) {
                setupProductSearch(row);
                setupProductCodeSearch(row);
                row.setAttribute('data-product-search-setup', 'true');
                row.removeAttribute('data-needs-search-setup');
            }
        });
    }

    // Make setupProductSearchForRow available globally
    window.setupProductSearchForRow = function(row) {
        if (!row.hasAttribute('data-product-search-setup')) {
            setupProductSearch(row);
            setupProductCodeSearch(row);
            row.setAttribute('data-product-search-setup', 'true');
        }
    };

    // Initial setup for existing rows
    setupAllProductSearches();
});

// Keyboard shortcuts for invoice management
document.addEventListener('keydown', function(e) {
    // Shift+A to add new product row
    if (e.shiftKey && e.key.toLowerCase() === 'a' && !e.ctrlKey && !e.altKey) {
        // Don't trigger if user is typing in an input field
        const activeElement = document.activeElement;
        const isInputField = activeElement && (
            activeElement.tagName === 'INPUT' || 
            activeElement.tagName === 'TEXTAREA' || 
            activeElement.tagName === 'SELECT' ||
            activeElement.isContentEditable
        );
        
        if (!isInputField) {
            e.preventDefault();
            
            try {
                addProductRow();
                console.log('✅ Product row added via Shift+A shortcut');
                
                // Focus on the first product code input of the new row
                setTimeout(() => {
                    const lastRow = document.querySelector('#productsTableBody tr:last-child');
                    if (lastRow) {
                        const productCodeInput = lastRow.querySelector('.product-code-input');
                        if (productCodeInput) {
                            productCodeInput.focus();
                            console.log('✅ Focus set on new product code input');
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('❌ Error adding product row via Shift+A:', error);
            }
        }
    }
    
    // Shift+D to delete current product row
    if (e.shiftKey && e.key.toLowerCase() === 'd' && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        
        // Find the row containing the currently focused element
        const activeElement = document.activeElement;
        const currentRow = activeElement ? activeElement.closest('#productsTableBody tr') : null;
        
        if (currentRow) {
            // Get row ID
            const rowId = currentRow.id.replace('productRow', '');
            
            // Check if this is the last row
            const allRows = document.querySelectorAll('#productsTableBody tr');
            if (allRows.length <= 1) {
                alert("{% trans 'Cannot delete the last product row. At least one product row must remain.' %}");
                return;
            }
            
            // Show confirmation dialog
            if (confirm("{% trans 'Are you sure you want to delete this product row?' %}")) {
                // Find the previous row to focus after deletion
                const previousRow = currentRow.previousElementSibling;
                
                // Delete the row
                removeProductRow(rowId);
                console.log(`✅ Product row ${rowId} deleted via Shift+D shortcut`);
                
                // Focus on the first input of the previous row
                if (previousRow) {
                    setTimeout(() => {
                        const firstInput = previousRow.querySelector('input:not([type="hidden"]):not([readonly])');
                        if (firstInput) {
                            firstInput.focus();
                            console.log('✅ Focus moved to previous row');
                        }
                    }, 100);
                }
            }
        } else {
            alert("{% trans 'Please select a product row to delete by clicking on any field in that row.' %}");
        }
    }
    
    // Ctrl+Enter to save invoice
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault(); // Prevent default behavior
        
        const saveButton = document.querySelector('button[type="submit"][class*="btn-success"]');
        if (saveButton) {
            saveButton.click();
            console.log('Invoice save triggered via Ctrl+Enter shortcut');
        }
    }
    
    // Show shortcut hint on Ctrl+? or Ctrl+H
    if (e.ctrlKey && (e.key === '?' || e.key === 'h' || e.key.toLowerCase() === 'h')) {
        e.preventDefault();
        showKeyboardShortcuts();
    }
});

// Function to show keyboard shortcuts help
function showKeyboardShortcuts() {
    const shortcuts = [
        { key: 'Shift+A', description: '{% trans "إضافة سطر منتج جديد" %}' },
        { key: 'Shift+D', description: '{% trans "حذف سطر المنتج الحالي" %}' },
        { key: 'Ctrl+Enter', description: '{% trans "حفظ الفاتورة" %}' },
        { key: 'Ctrl+H or Ctrl+?', description: '{% trans "عرض اختصارات لوحة المفاتيح" %}' }
    ];
    
    let message = 'اختصارات لوحة المفاتيح:\n\n';
    shortcuts.forEach(shortcut => {
        message += `${shortcut.key}: ${shortcut.description}\n`;
    });
    
    alert(message);
}

// Unsaved changes warning
let hasUnsavedChanges = false;

// Track form changes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('invoiceForm');
    if (form) {
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                hasUnsavedChanges = true;
            });
        });
    }
});

// Intercept navigation links
document.addEventListener('click', function(e) {
    console.log('Click event detected, hasUnsavedChanges:', hasUnsavedChanges);
    if (hasUnsavedChanges && e.target.closest('a')) {
        const link = e.target.closest('a');
        const href = link.getAttribute('href');
        console.log('Link clicked:', href, 'has data-bs-toggle:', link.hasAttribute('data-bs-toggle'));
        if (href && !href.startsWith('#') && !href.startsWith('javascript:') && !link.hasAttribute('data-bs-toggle')) {
            e.preventDefault();
            console.log('Preventing default and showing modal for:', href);
            showUnsavedChangesModal(href);
        }
    }
});

// Function to show unsaved changes modal
function showUnsavedChangesModal(targetUrl) {
    console.log('showUnsavedChangesModal called with URL:', targetUrl);
    const transTitle = document.getElementById('trans-unsaved-changes').textContent;
    const transMessage = document.getElementById('trans-unsaved-message').textContent;
    const transCancel = document.getElementById('trans-cancel').textContent;
    const transLeave = document.getElementById('trans-leave').textContent;
    
    console.log('Translations:', {transTitle, transMessage, transCancel, transLeave});
    
    const modalHtml = `
        <div class="modal fade" id="unsavedChangesModal" tabindex="-1" aria-labelledby="unsavedChangesModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="unsavedChangesModalLabel">${transTitle}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${transMessage}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${transCancel}</button>
                        <button type="button" class="btn btn-primary" onclick="proceedToUrl('${targetUrl}')">${transLeave}</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('unsavedChangesModal'));
    modal.show();
    
    // Remove modal from DOM after hiding
    document.getElementById('unsavedChangesModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Function to proceed to URL
function proceedToUrl(url) {
    window.location.href = url;
}

// JavaScript للتعامل مع نافذة إضافة الفئة
const addCategoryModal = document.getElementById('addCategoryModal');
const addCategoryForm = document.getElementById('addCategoryForm');
const saveCategoryBtn = document.getElementById('saveCategoryBtn');
const categoryParentSelect = document.getElementById('categoryParent');

// تحميل قائمة الفئات الأساسية عند فتح النافذة
if (addCategoryModal) {
    addCategoryModal.addEventListener('show.bs.modal', function() {
        // تحميل قائمة الفئات الأساسية
        fetch('{% url "products:category_add_ajax" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Clear previous options
            categoryParentSelect.innerHTML = '<option value="">اختر الفئة الأب (اختياري)</option>';

            // Add new categories
            if (data.categories) {
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categoryParentSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('خطأ في تحميل الفئات:', error);
        });
    });

    // مسح النموذج عند إغلاق النافذة
    addCategoryModal.addEventListener('hidden.bs.modal', function() {
        addCategoryForm.reset();
        // إزالة رسائل الخطأ
        const errorElements = addCategoryForm.querySelectorAll('.is-invalid');
        errorElements.forEach(element => {
            element.classList.remove('is-invalid');
        });
        const errorMessages = addCategoryForm.querySelectorAll('.invalid-feedback');
        errorMessages.forEach(element => {
            element.remove();
        });
    });
}

// معالجة إرسال نموذج الفئة
if (addCategoryForm) {
    addCategoryForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // تعطيل الزر وإظهار التحميل
        const spinner = saveCategoryBtn.querySelector('.spinner-border');
        const btnText = saveCategoryBtn.querySelector('.btn-text');
        const icon = saveCategoryBtn.querySelector('.fas');

        saveCategoryBtn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = 'جاري الحفظ...';
        icon.style.display = 'none';

        // إرسال البيانات
        const formData = new FormData(addCategoryForm);

        fetch('{% url "products:category_add_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // إظهار رسالة نجاح
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // إدراج الرسالة في أعلى الصفحة
                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);

                // إغلاق النافذة
                const modal = bootstrap.Modal.getInstance(addCategoryModal);
                modal.hide();

                // تحديث قائمة الفئات المتاحة في modal المنتج
                if (addProductModal && productCategorySearch.length > 0) {
                    // إضافة الفئة الجديدة إلى قائمة الفئات
                    if (data.category) {
                        window.productCategories.push({
                            id: data.category.id,
                            name: data.category.name,
                            code: data.category.code || ''
                        });
                        
                        // تحديث data-categories attribute
                        var updatedData = window.productCategories.map(function(cat) {
                            return cat.id + '|' + cat.name + '|' + (cat.code || '');
                        }).join('||');
                        productCategorySearch.attr('data-categories', updatedData);
                        
                        // تحديث قيمة البحث إذا كانت الفئة المحددة
                        if (productCategoryHidden.val() == data.category.id) {
                            productCategorySearch.val(data.category.name);
                        }
                    }
                }

            } else {
                // إظهار رسالة خطأ
                alert('خطأ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('خطأ:', error);
            alert('حدث خطأ في الشبكة. يرجى المحاولة مرة أخرى.');
        })
        .finally(() => {
            // إعادة تفعيل الزر
            saveCategoryBtn.disabled = false;
            spinner.classList.add('d-none');
            btnText.textContent = 'حفظ الفئة';
            icon.style.display = 'inline';
        });
    });
}

// JavaScript للتعامل مع نافذة إضافة المنتج
const addProductModal = document.getElementById('addProductModal');
const addProductForm = document.getElementById('addProductForm');
const saveProductBtn = document.getElementById('saveProductBtn');
const productCategorySelect = document.getElementById('productCategory');

// تحميل قائمة الفئات عند فتح النافذة
if (addProductModal) {
    addProductModal.addEventListener('show.bs.modal', function() {
        // تحميل قائمة الفئات
        fetch('{% url "products:product_add_ajax" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Clear previous options
            productCategorySelect.innerHTML = '<option value="">اختر الفئة</option>';

            // Add new categories
            if (data.categories) {
                data.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    productCategorySelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('خطأ في تحميل الفئات:', error);
        });
    });

    // مسح النموذج عند إغلاق النافذة
    addProductModal.addEventListener('hidden.bs.modal', function() {
        addProductForm.reset();
        // إخفاء حساب الضريبة
        document.getElementById('productTaxCalculation').style.display = 'none';
        document.getElementById('productSerialNumberRow').style.display = 'none';
        // إزالة رسائل الخطأ
        const errorElements = addProductForm.querySelectorAll('.is-invalid');
        errorElements.forEach(element => {
            element.classList.remove('is-invalid');
        });
        const errorMessages = addProductForm.querySelectorAll('.invalid-feedback');
        errorMessages.forEach(element => {
            element.remove();
        });
    });
}

// معالجة إرسال نموذج المنتج
if (addProductForm) {
    addProductForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // تعطيل الزر وإظهار التحميل
        const spinner = saveProductBtn.querySelector('.spinner-border');
        const btnText = saveProductBtn.querySelector('.btn-text');
        const icon = saveProductBtn.querySelector('.fas');

        saveProductBtn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = 'جاري الحفظ...';
        icon.style.display = 'none';

        // إرسال البيانات
        const formData = new FormData(addProductForm);

        fetch('{% url "products:product_add_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // إظهار رسالة نجاح
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // إدراج الرسالة في أعلى الصفحة
                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);

                // إغلاق النافذة
                const modal = bootstrap.Modal.getInstance(addProductModal);
                modal.hide();

                // تحديث قائمة المنتجات المتاحة
                loadAvailableProducts(data.product);

            } else {
                // إظهار رسالة خطأ
                alert('خطأ: ' + data.error);
            }
        })
        .catch(error => {
            console.error('خطأ:', error);
            alert('حدث خطأ في الشبكة. يرجى المحاولة مرة أخرى.');
        })
        .finally(() => {
            // إعادة تفعيل الزر
            saveProductBtn.disabled = false;
            spinner.classList.add('d-none');
            btnText.textContent = 'حفظ المنتج';
            icon.style.display = 'inline';
        });
    });
}

// تحكم في عرض حقل الرقم التسلسلي
function toggleProductSerialNumberField() {
    const productType = document.getElementById('productType').value;
    const serialNumberRow = document.getElementById('productSerialNumberRow');

    if (productType === 'physical') {
        serialNumberRow.style.display = 'block';
    } else {
        serialNumberRow.style.display = 'none';
        document.getElementById('productSerialNumber').value = '';
    }
}

// دالة تحديث قائمة المنتجات المتاحة
function loadAvailableProducts(newProduct = null) {
    const productList = document.getElementById('productList');
    if (!productList) {
        console.error('قائمة المنتجات غير موجودة');
        return;
    }

    if (newProduct) {
        // إضافة المنتج الجديد إلى القائمة
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><small>${newProduct.code}</small></td>
            <td><strong>${newProduct.name}</strong></td>
            <td><small>منتج جديد</small></td>
            <td class="text-center">
                <span class="badge bg-success">0.000</span>
            </td>
            <td>
                <span class="text-muted">غير محدد</span>
            </td>
            <td><small>${newProduct.is_active ? '0.00%' : 'غير نشط'}</small></td>
            <td>
                <button type="button" class="btn btn-sm btn-primary" 
                        onclick="selectProduct('${newProduct.id}', '${newProduct.code}', '${newProduct.name}', '0', '0', '0')"
                        title="اختيار ${newProduct.name}">
                    <i class="fas fa-plus"></i>
                </button>
            </td>
        `;
        productList.appendChild(row);
    }
}

// حساب الضريبة
function calculateProductTax() {
    const sellingPrice = parseFloat(document.getElementById('productSellingPrice').value) || 0;
    const taxRate = parseFloat(document.getElementById('productTaxRate').value) || 0;

    if (sellingPrice > 0 && taxRate > 0) {
        const taxAmount = sellingPrice * (taxRate / 100);
        const priceWithTax = sellingPrice + taxAmount;

        document.getElementById('productBasePrice').textContent = sellingPrice.toFixed(3);
        document.getElementById('productTaxAmount').textContent = taxAmount.toFixed(3);
        document.getElementById('productPriceWithTax').textContent = priceWithTax.toFixed(3);
        document.getElementById('productTaxCalculation').style.display = 'block';
    } else {
        document.getElementById('productTaxCalculation').style.display = 'none';
    }
}

// إضافة مستمعي الأحداث
document.addEventListener('DOMContentLoaded', function() {
    // تحكم في حقل الرقم التسلسلي
    const productTypeSelect = document.getElementById('productType');
    if (productTypeSelect) {
        productTypeSelect.addEventListener('change', toggleProductSerialNumberField);
    }

    // حساب الضريبة
    const sellingPriceInput = document.getElementById('productSellingPrice');
    const taxRateInput = document.getElementById('productTaxRate');

    if (sellingPriceInput) {
        sellingPriceInput.addEventListener('input', calculateProductTax);
    }
    if (taxRateInput) {
        taxRateInput.addEventListener('input', calculateProductTax);
    }

    // تطبيق التحكم عند تحميل الصفحة
    toggleProductSerialNumberField();
});

// Category search functionality for product modal
$(document).ready(function() {
    // Parse categories from data attribute
    var productCategoriesData = $('#productCategorySearch').data('categories') || '';
    window.productCategories = []; // تعريف كمتغير عام
    
    if (productCategoriesData) {
        var categoryStrings = productCategoriesData.split('||');
        window.productCategories = categoryStrings.map(function(catStr) {
            var parts = catStr.split('|');
            return {
                id: parts[0],
                name: parts[1] || '',
                code: parts[2] || ''
            };
        });
    }

    var productCategorySearch = $('#productCategorySearch');
    var productCategoryDropdown = $('#productCategoryDropdown');
    var productCategoryHidden = $('#productCategory');

    // Function to filter and show categories
    function filterProductCategories() {
        var searchTerm = productCategorySearch.val().toLowerCase().trim();

        if (searchTerm === '') {
            productCategoryDropdown.hide();
            return;
        }

        // Clear previous options
        productCategoryDropdown.empty();

        // Filter categories
        var filteredCategories = window.productCategories.filter(function(category) {
            return category.name.toLowerCase().includes(searchTerm) ||
                   (category.code && category.code.toLowerCase().includes(searchTerm));
        });

        if (filteredCategories.length === 0) {
            productCategoryDropdown.hide();
            return;
        }

        // Create dropdown options
        filteredCategories.forEach(function(category) {
            var option = $('<button type="button" class="dropdown-item"></button>');
            option.html('<strong>' + category.name + '</strong>' + (category.code ? ' (' + category.code + ')' : ''));
            option.attr('data-category', JSON.stringify(category));

            option.on('click', function() {
                // Fill category data
                productCategoryHidden.val(category.id);
                productCategorySearch.val(category.name);
                productCategoryDropdown.hide();

                // Trigger change event for validation
                productCategoryHidden.trigger('change');
            });

            productCategoryDropdown.append(option);
        });

        productCategoryDropdown.show();
    }

    // Handle input changes
    productCategorySearch.on('input', filterProductCategories);

    // Handle focus to show all categories if empty
    productCategorySearch.on('focus', function() {
        if (productCategorySearch.val().trim() === '') {
            // Show all categories
            productCategoryDropdown.empty();
            window.productCategories.slice(0, 10).forEach(function(category) { // Show first 10 categories
                var option = $('<button type="button" class="dropdown-item"></button>');
                option.html('<strong>' + category.name + '</strong>' + (category.code ? ' (' + category.code + ')' : ''));
                option.attr('data-category', JSON.stringify(category));

                option.on('click', function() {
                    // Fill category data
                    productCategoryHidden.val(category.id);
                    productCategorySearch.val(category.name);
                    productCategoryDropdown.hide();

                    // Trigger change event for validation
                    productCategoryHidden.trigger('change');
                });

                productCategoryDropdown.append(option);
            });
            productCategoryDropdown.show();
        }
    });

    // Hide dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!productCategorySearch.is(e.target) && !productCategoryDropdown.is(e.target) && productCategoryDropdown.has(e.target).length === 0) {
            productCategoryDropdown.hide();
        }
    });

    // Handle blur with delay to allow click on dropdown items
    productCategorySearch.on('blur', function() {
        setTimeout(function() {
            if (productCategorySearch.val() && !productCategoryHidden.val()) {
                // If user typed something but didn't select from dropdown, clear it
                productCategorySearch.val('');
                productCategoryHidden.val('');
            }
        }, 200);
    });

    // Update search input when hidden field changes (e.g., from new category modal)
    productCategoryHidden.on('change', function() {
        if (productCategoryHidden.val()) {
            var selectedCategory = window.productCategories.find(function(cat) {
                return cat.id == productCategoryHidden.val();
            });
            if (selectedCategory) {
                productCategorySearch.val(selectedCategory.name);
            }
        } else {
            productCategorySearch.val('');
        }
    });

    // Handle search button click
    $('#productSearchCategoryBtn').on('click', function() {
        productCategorySearch.focus();
        if (productCategorySearch.val().trim() === '') {
            // Show all categories
            productCategoryDropdown.empty();
            window.productCategories.slice(0, 10).forEach(function(category) {
                var option = $('<button type="button" class="dropdown-item"></button>');
                option.html('<strong>' + category.name + '</strong>' + (category.code ? ' (' + category.code + ')' : ''));
                option.attr('data-category', JSON.stringify(category));

                option.on('click', function() {
                    productCategoryHidden.val(category.id);
                    productCategorySearch.val(category.name);
                    productCategoryDropdown.hide();
                    productCategoryHidden.trigger('change');
                });

                productCategoryDropdown.append(option);
            });
            productCategoryDropdown.show();
        }
    });
});

// Payment method field handling
$(document).ready(function() {
    const paymentMethodSelect = $('#id_payment_method');
    const cashboxField = $('#cashbox_field');
    const bankAccountField = $('#bank_account_field');
    const checkFields = $('#check_fields');
    const cashboxSelect = $('#id_cashbox');
    const bankAccountSelect = $('#id_bank_account');
    const checkNumberInput = $('#id_check_number');
    const checkDateInput = $('#id_check_date');

    function togglePaymentFields() {
        const selectedMethod = paymentMethodSelect.val();
        
        // Hide all payment-related fields first
        cashboxField.hide();
        bankAccountField.hide();
        checkFields.hide();
        
        // Remove required attributes
        cashboxSelect.prop('required', false);
        bankAccountSelect.prop('required', false);
        checkNumberInput.prop('required', false);
        checkDateInput.prop('required', false);
        
        // Show relevant fields based on selection
        if (selectedMethod === 'cash') {
            cashboxField.show();
            cashboxSelect.prop('required', true);
        } else if (selectedMethod === 'check') {
            bankAccountField.show();
            checkFields.show();
            bankAccountSelect.prop('required', true);
            checkNumberInput.prop('required', true);
            checkDateInput.prop('required', true);
        } else if (selectedMethod === 'transfer') {
            bankAccountField.show();
            bankAccountSelect.prop('required', true);
        }
    }

    // Initial toggle on page load
    togglePaymentFields();

    // Toggle on change
    paymentMethodSelect.on('change', togglePaymentFields);
});
</script>

<!-- نافذة إضافة منتج منبثقة -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">
                    <i class="fas fa-plus text-primary me-2"></i>
                    {% trans "Create New Product" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    {% csrf_token %}

                    <!-- Basic Information -->
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>{% trans "Basic Information" %}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">{% trans "Product Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productNameEn" class="form-label">{% trans "English Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productNameEn" name="name_en" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productType" class="form-label">{% trans "Product Type" %} <span class="text-danger">*</span></label>
                                <select class="form-control" id="productType" name="product_type" required>
                                    <option value="physical">{% trans "Physical Product" %}</option>
                                    <option value="service">{% trans "Service" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productSku" class="form-label">{% trans "Product Code (SKU)" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productSku" name="sku" placeholder="مثال: PROD-001" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productBarcode" class="form-label">{% trans "Barcode" %}</label>
                                <input type="text" class="form-control" id="productBarcode" name="barcode">
                            </div>
                        </div>
                    </div>

                    <!-- Serial Number field for pieces only -->
                    <div class="row" id="productSerialNumberRow" style="display: none;">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="productSerialNumber" class="form-label">
                                    {% trans "Serial Number" %}
                                    <small class="text-muted">{% trans "- For Warranty" %}</small>
                                </label>
                                <input type="text" class="form-control" id="productSerialNumber" name="serial_number"
                                       placeholder="مثال: SN123456789">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% trans "This field is for products sold per piece that need warranty (optional)" %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">الفئة <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="position-relative flex-grow-1">
                                        <input type="text" class="form-control" id="productCategorySearch" placeholder="اكتب للبحث عن الفئات..." autocomplete="off"
                                               data-categories="{% for category in categories %}{{ category.id }}|{{ category.name|escapejs }}|{{ category.code|escapejs }}{% if not forloop.last %}||{% endif %}{% endfor %}">
                                        <div id="productCategoryDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                            <!-- Category options will be populated here -->
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary" id="productSearchCategoryBtn" title="البحث عن الفئات">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <input type="hidden" id="productCategory" name="category" required>
                                    <button type="button" class="btn btn-outline-primary" id="productAddCategoryBtn" title="إضافة فئة جديدة"
                                            data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                        <i class="fas fa-plus"></i>
                                        إضافة فئة
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small class="text-muted">ابدأ الكتابة للبحث عن الفئات أو اضغط زر البحث</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productUnit" class="form-label">وحدة القياس <span class="text-danger">*</span></label>
                                <select class="form-select" id="productUnit" name="unit" required>
                                    <option value="piece">قطعة</option>
                                    <option value="kg">كيلوغرام</option>
                                    <option value="liter">لتر</option>
                                    <option value="meter">متر</option>
                                    <option value="box">صندوق</option>
                                    <option value="pack">حزمة</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing -->
                    <h6 class="mt-4 mb-3"><i class="fas fa-dollar-sign me-2"></i>التسعير</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productCostPrice" class="form-label">سعر الشراء</label>
                                <input type="number" class="form-control" id="productCostPrice" name="cost_price" step="0.001" min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productSellingPrice" class="form-label">سعر البيع <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productSellingPrice" name="selling_price" step="0.001" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productWholesalePrice" class="form-label">سعر الجملة</label>
                                <input type="number" class="form-control" id="productWholesalePrice" name="wholesale_price" step="0.001" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productTaxRate" class="form-label">
                                    <i class="fas fa-percentage text-primary me-1"></i>
                                    نسبة الضريبة % <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="productTaxRate" name="tax_rate"
                                           step="0.01" min="0" max="100" value="0" placeholder="مثال: 15" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    سيتم احتسابها تلقائياً في الفواتير
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info" style="display: none;" id="productTaxCalculation">
                                <h6 class="alert-heading">
                                    <i class="fas fa-calculator me-2"></i>
                                    حساب الضريبة
                                </h6>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>سعر البيع:</span>
                                    <span id="productBasePrice">0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>مبلغ الضريبة:</span>
                                    <span id="productTaxAmount">0.00</span>
                                </div>
                                <hr class="my-2">
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>السعر شامل الضريبة:</span>
                                    <span id="productPriceWithTax">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory -->
                    <h6 class="mt-4 mb-3"><i class="fas fa-warehouse me-2"></i>المخزون</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productOpeningBalance" class="form-label">
                                    <i class="fas fa-balance-scale text-success me-1"></i>
                                    الرصيد الافتتاحي
                                </label>
                                <input type="number" class="form-control" id="productOpeningBalance" name="opening_balance" step="0.001" min="0" value="0">
                                <small class="form-text text-muted">المخزون الأولي عند بدء استخدام النظام</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productMinStock" class="form-label">الحد الأدنى للمخزون</label>
                                <input type="number" class="form-control" id="productMinStock" name="min_stock" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productMaxStock" class="form-label">الحد الأقصى للمخزون</label>
                                <input type="number" class="form-control" id="productMaxStock" name="max_stock" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Description and Settings -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="productDescription" class="form-label">الوصف</label>
                                <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="productIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="productIsActive">
                                        {% trans "Active" %}
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="productTrackStock" name="track_stock" checked>
                                    <label class="form-check-label" for="productTrackStock">
                                        {% trans "Track Stock" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveProductBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        <i class="fas fa-save me-2"></i>
                        <span class="btn-text">{% trans "Save Product" %}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- نافذة إضافة فئة منبثقة -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">
                    <i class="fas fa-folder-plus text-warning me-2"></i>
                    {% trans "أضف فئة" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCategoryForm">
                <div class="modal-body">
                    {% csrf_token %}

                    <!-- Basic Information -->
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>{% trans "Basic Information" %}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryName" class="form-label">{% trans "Category Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="categoryName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryNameEn" class="form-label">{% trans "English Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="categoryNameEn" name="name_en" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryCode" class="form-label">{% trans "Category Code" %}</label>
                                <input type="text" class="form-control" id="categoryCode" name="code" placeholder="{% trans 'Example: CAT-001' %}">
                                <div class="form-text">{% trans "Unique code for the category (optional)" %}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryParent" class="form-label">{% trans "Parent Category" %}</label>
                                <select class="form-select" id="categoryParent" name="parent">
                                    <option value="">{% trans "Choose Parent Category (Optional)" %}</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="categoryDescription" class="form-label">{% trans "Description" %}</label>
                                <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="categoryIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="categoryIsActive">
                                        {% trans "Active" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="btn btn-warning" id="saveCategoryBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        <i class="fas fa-save me-2"></i>
                        <span class="btn-text">{% trans "Save Category" %}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
