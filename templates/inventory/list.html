{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}


{% block title %}{% trans "Inventory List" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .inventory-container {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .inventory-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .inventory-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
        cursor: pointer;
    }
    
    .inventory-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .table-striped tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .table th {
        border-top: none;
        white-space: nowrap;
        font-weight: 600;
        vertical-align: middle;
    }
    
    .table td {
        vertical-align: middle;
        white-space: nowrap;
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .stock-level {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .stock-good {
        background-color: #d4edda;
        color: #155724;
    }
    
    .stock-low {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .stock-critical {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .stock-out {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .action-btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        display: inline-block;
        margin: 0.25rem;
        transition: all 0.3s ease;
    }
    
    .action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .action-btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
    }
    
    .action-btn-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        color: white;
    }
    
    .action-btn-warning {
        background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
        color: #212529;
    }
    
    .action-btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
    }
    
    .stock-level {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .stock-good {
        background-color: #d4edda;
        color: #155724;
    }
    
    .stock-low {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .stock-critical {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .stock-out {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    /* Print Styles */
    @media print {
        .print-controls,
        .btn,
        .navbar,
        .sidebar,
        .card-header,
        nav {
            display: none !important;
        }
        
        .container-fluid {
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
        }
        
        .card {
            border: 1px solid #000 !important;
            box-shadow: none !important;
            margin-bottom: 1rem !important;
        }
        
        .inventory-card {
            border: 1px solid #ddd !important;
            margin-bottom: 0.5rem !important;
            break-inside: avoid;
        }
        
        body {
            font-size: 12px !important;
            color: #000 !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #000 !important;
            page-break-after: avoid;
        }
        
        .text-primary,
        .text-success,
        .text-danger,
        .text-warning,
        .text-info {
            color: #000 !important;
        }
        
        .print-table {
            width: 100% !important;
            border-collapse: collapse !important;
        }
        
        .print-table th,
        .print-table td {
            border: 1px solid #000 !important;
            padding: 8px !important;
            text-align: right !important;
        }
        
        .print-table th {
            background-color: #f5f5f5 !important;
            font-weight: bold !important;
        }
        
        .page-break {
            page-break-before: always;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-warehouse text-primary me-2"></i>
                        {% trans "Inventory Management" %}
                    </h1>
                    <p class="mb-0 text-muted">{% trans "Comprehensive overview of inventory and movements" %}</p>
                </div>
                <div class="print-controls">
                    <button type="button" class="btn btn-outline-primary" onclick="printInventoryReport()">
                        <i class="fas fa-print me-2"></i>
                        {% trans "Print" %} {% trans "Inventory Report" %}
                    </button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-bolt me-2"></i>
                                {% trans "Quick Operations" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <a href="{% url 'inventory:warehouse_list' %}" class="action-btn action-btn-primary w-100 text-center">
                                        <i class="fas fa-warehouse me-2"></i>
                                        {% trans "Warehouse Management" %}
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'inventory:movement_list' %}" class="action-btn action-btn-success w-100 text-center">
                                        <i class="fas fa-exchange-alt me-2"></i>
                                        {% trans "Inventory Movements" %}
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'inventory:transfer_list' %}" class="action-btn action-btn-warning w-100 text-center">
                                        <i class="fas fa-truck me-2"></i>
                                        {% trans "Inventory Transfer" %}
                                    </a>
                                </div>
                                <div class="col-md-3">
                                    <a href="{% url 'inventory:low_stock' %}" class="action-btn action-btn-info w-100 text-center">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        {% trans "Low Stock" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Total Products" %}</h6>
                                    <h3 class="mb-0">{{ total_products|default:0 }}</h3>
                                    <small>{% trans "Product" %}</small>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-box fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Active Warehouses" %}</h6>
                                    <h3 class="mb-0">{{ total_warehouses|default:0 }}</h3>
                                    <small>{% trans "Warehouse" %}</small>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-warehouse fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Low Stock" %}</h6>
                                    <h3 class="mb-0">{{ low_stock_items|default:0 }}</h3>
                                    <small>{% trans "Product" %}</small>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Today's Movements" %}</h6>
                                    <h3 class="mb-0">{{ today_movements|default:0 }}</h3>
                                    <small>{% trans "Movement" %}</small>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Movements and Quick Stats Row -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <!-- Recent Movements -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                {% trans "Latest Movements" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if recent_movements %}
                                {% for movement in recent_movements %}
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-{% if movement.type == 'in' %}arrow-down text-success{% elif movement.type == 'out' %}arrow-up text-danger{% else %}exchange-alt text-info{% endif %} fa-lg"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-0">{{ movement.product_name }}</h6>
                                        <small class="text-muted">
                                            {% if movement.type == 'in' %}{% trans "Incoming" %}
                                            {% elif movement.type == 'out' %}{% trans "Outgoing" %}
                                            {% else %}{% trans "Transfer" %}{% endif %}
                                            - {{ movement.quantity|floatformat:0 }}
                                        </small>
                                    </div>
                                    <div class="flex-shrink-0">
                                        <small class="text-muted">{{ movement.date|date:"H:i" }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center text-muted">
                                    <i class="fas fa-history fa-2x mb-2"></i>
                                    <p>{% trans "No recent movements" %}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <!-- Quick Stats -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>
                                {% trans "Quick Statistics" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="text-center">
                                        <h4 class="text-success">{{ total_in_value|default:0|currency_format }}</h4>
                                        <small class="text-muted">{% trans "Incoming value (without tax)" %}</small>
                                        <div class="mt-2">
                                            <h6 class="text-success mb-0">{{ total_in_value_with_tax|default:0|currency_format }}</h6>
                                            <small class="text-muted">({% trans "Including" %} {% trans "Tax" %})</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <h4 class="text-danger">{{ total_out_value|default:0|currency_format }}</h4>
                                        <small class="text-muted">{% trans "Outgoing value (without tax)" %}</small>
                                        <div class="mt-2">
                                            <h6 class="text-danger mb-0">{{ total_out_value_with_tax|default:0|currency_format }}</h6>
                                            <small class="text-muted">({% trans "Including" %} {% trans "Tax" %})</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <hr>
                                    <div class="text-center">
                                        <h4 class="text-primary">{{ total_inventory_value|default:0|currency_format }}</h4>
                                        <small class="text-muted">{% trans "Total inventory value (without tax)" %}</small>
                                        <div class="mt-2">
                                            <h5 class="text-primary mb-0">{{ total_inventory_value_with_tax|default:0|currency_format }}</h5>
                                            <small class="text-muted">({% trans "Including" %} {% trans "Tax" %})</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Overview - Full Width Table -->
            <div class="row">
                <div class="col-12">
                    <div class="inventory-container">
                        <div class="inventory-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    {% trans "Inventory Overview" %}
                                </h5>
                                <div>
                                    <a href="{% url 'inventory:export_excel' %}?{% if search %}search={{ search }}&{% endif %}{% if stock_level_filter %}stock_level={{ stock_level_filter }}&{% endif %}sort={{ current_sort }}&dir={{ sort_direction }}" 
                                       class="btn btn-success btn-sm">
                                        <i class="fas fa-file-excel me-1"></i>
                                        {% trans "Export to Excel" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3">
                            {% if inventory_items %}
                                <!-- Filter Form -->
                                <div class="mb-3">
                                    <form method="get" class="row g-3">
                                        <div class="col-md-6">
                                            <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="{% trans 'Search by product name or code' %}">
                                        </div>
                                        <div class="col-md-4">
                                            <select name="stock_level" class="form-control">
                                                <option value="">{% trans 'All Stock Levels' %}</option>
                                                <option value="good" {% if stock_level_filter == 'good' %}selected{% endif %}>{% trans 'Good Stock' %}</option>
                                                <option value="low" {% if stock_level_filter == 'low' %}selected{% endif %}>{% trans 'Low Stock' %}</option>
                                                <option value="critical" {% if stock_level_filter == 'critical' %}selected{% endif %}>{% trans 'Critical Stock' %}</option>
                                                <option value="out" {% if stock_level_filter == 'out' %}selected{% endif %}>{% trans 'Out of Stock' %}</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-primary w-100">{% trans 'Filter' %}</button>
                                        </div>
                                    </form>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>
                                                    <a href="?{% if current_sort == 'product_name' and sort_direction == 'asc' %}sort=product_name&dir=desc{% else %}sort=product_name&dir=asc{% endif %}" class="text-decoration-none" style="color: black !important;">
                                                        <i class="fas fa-box me-2"></i>{% trans "Product" %}
                                                        {% if current_sort == 'product_name' %}
                                                            {% if sort_direction == 'asc' %}
                                                                <i class="fas fa-sort-up ms-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-sort-down ms-1"></i>
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-sort ms-1"></i>
                                                        {% endif %}
                                                    </a>
                                                </th>
                                                <th>
                                                    <a href="?{% if current_sort == 'product_code' and sort_direction == 'asc' %}sort=product_code&dir=desc{% else %}sort=product_code&dir=asc{% endif %}" class="text-decoration-none" style="color: black !important;">
                                                        {% trans "Code" %}
                                                        {% if current_sort == 'product_code' %}
                                                            {% if sort_direction == 'asc' %}
                                                                <i class="fas fa-sort-up ms-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-sort-down ms-1"></i>
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-sort ms-1"></i>
                                                        {% endif %}
                                                    </a>
                                                </th>
                                                <th>
                                                    <a href="?{% if current_sort == 'warehouse_name' and sort_direction == 'asc' %}sort=warehouse_name&dir=desc{% else %}sort=warehouse_name&dir=asc{% endif %}" class="text-decoration-none" style="color: black !important;">
                                                        {% trans "Warehouse" %}
                                                        {% if current_sort == 'warehouse_name' %}
                                                            {% if sort_direction == 'asc' %}
                                                                <i class="fas fa-sort-up ms-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-sort-down ms-1"></i>
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-sort ms-1"></i>
                                                        {% endif %}
                                                    </a>
                                                </th>
                                                <th>
                                                    <a href="?{% if current_sort == 'quantity' and sort_direction == 'asc' %}sort=quantity&dir=desc{% else %}sort=quantity&dir=asc{% endif %}" class="text-decoration-none" style="color: black !important;">
                                                        {% trans "Quantity" %}
                                                        {% if current_sort == 'quantity' %}
                                                            {% if sort_direction == 'asc' %}
                                                                <i class="fas fa-sort-up ms-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-sort-down ms-1"></i>
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-sort ms-1"></i>
                                                        {% endif %}
                                                    </a>
                                                </th>
                                                <th>
                                                    <a href="?{% if current_sort == 'unit_price' and sort_direction == 'asc' %}sort=unit_price&dir=desc{% else %}sort=unit_price&dir=asc{% endif %}" class="text-decoration-none" style="color: black !important;">
                                                        {% trans "Unit Price" %}
                                                        {% if current_sort == 'unit_price' %}
                                                            {% if sort_direction == 'asc' %}
                                                                <i class="fas fa-sort-up ms-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-sort-down ms-1"></i>
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-sort ms-1"></i>
                                                        {% endif %}
                                                    </a>
                                                </th>
                                                <th>
                                                    <a href="?{% if current_sort == 'value' and sort_direction == 'asc' %}sort=value&dir=desc{% else %}sort=value&dir=asc{% endif %}" class="text-decoration-none" style="color: black !important;">
                                                        {% trans "Value" %}
                                                        {% if current_sort == 'value' %}
                                                            {% if sort_direction == 'asc' %}
                                                                <i class="fas fa-sort-up ms-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-sort-down ms-1"></i>
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-sort ms-1"></i>
                                                        {% endif %}
                                                    </a>
                                                </th>
                                                <th>
                                                    <a href="?{% if current_sort == 'stock_level' and sort_direction == 'asc' %}sort=stock_level&dir=desc{% else %}sort=stock_level&dir=asc{% endif %}" class="text-decoration-none" style="color: black !important;">
                                                        {% trans "Stock Status" %}
                                                        {% if current_sort == 'stock_level' %}
                                                            {% if sort_direction == 'asc' %}
                                                                <i class="fas fa-sort-up ms-1"></i>
                                                            {% else %}
                                                                <i class="fas fa-sort-down ms-1"></i>
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-sort ms-1"></i>
                                                        {% endif %}
                                                    </a>
                                                </th>
                                                <th class="text-center" style="color: black !important;">{% trans "Actions" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in inventory_items %}
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <i class="fas fa-box text-primary me-2"></i>
                                                        <strong>{{ item.product_name }}</strong>
                                                    </div>
                                                </td>
                                                <td>
                                                    <code>{{ item.product_code }}</code>
                                                </td>
                                                <td>{{ item.warehouse_name|default:"{% trans 'Main' %}" }}</td>
                                                <td>
                                                    <strong>{{ item.quantity|floatformat:0 }}</strong>
                                                    <small class="text-muted">{% trans "Piece" %}</small>
                                                </td>
                                                <td>
                                                    {% if item.quantity > 0 %}
                                                        <strong>{{ item.unit_price|floatformat:3 }}</strong>
                                                        <small class="text-muted">{{ base_currency.symbol|default:'{% trans "JOD" %}' }}</small>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <strong>{{ item.value|floatformat:3 }}</strong>
                                                    <small class="text-muted">{{ base_currency.symbol|default:'{% trans "JOD" %}' }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge 
                                                        {% if item.stock_level == 'good' %}bg-success
                                                        {% elif item.stock_level == 'low' %}bg-warning
                                                        {% elif item.stock_level == 'critical' %}bg-danger
                                                        {% else %}bg-secondary{% endif %}">
                                                        {% if item.stock_level == 'good' %}{% trans "Good Stock" %}
                                                        {% elif item.stock_level == 'low' %}{% trans "Low Stock" %}
                                                        {% elif item.stock_level == 'critical' %}{% trans "Critical Stock" %}
                                                        {% else %}{% trans "Out of Stock" %}{% endif %}
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="{% url 'inventory:product_detail' item.product_id %}" class="btn btn-outline-primary" title="{% trans "View" %} {% trans "Details" %}">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                        <button class="btn btn-outline-success view-details-modal" 
                                                                data-product-id="{{ item.product_id }}"
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#productDetailsModal"
                                                                title="{% trans "View" %} {% trans "Quick" %}">
                                                            <i class="fas fa-search"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                            {% else %}
                                <!-- Empty State -->
                                <div class="text-center py-5">
                                    <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                                    <h4>{% trans "No inventory data" %}</h4>
                                    <p class="text-muted">{% trans "No inventory data has been recorded yet." %}</p>
                                    <a href="{% url 'inventory:warehouse_list' %}" class="btn btn-primary">
                                        <i class="fas fa-warehouse me-2"></i>
                                        {% trans "Setup Warehouses" %}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-labelledby="productDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productDetailsModalLabel">
                    <i class="fas fa-box me-2"></i>
                    {% trans "Product Details" %} {% trans "in Inventory" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="productDetailsBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                    <p class="mt-2">{% trans "Loading data..." %}</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
                <a href="#" id="viewFullDetails" class="btn btn-primary">
                    <i class="fas fa-external-link-alt me-2"></i>
                    {% trans "View Full Details" %}
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers for inventory cards
    document.querySelectorAll('.inventory-card').forEach(card => {
        card.addEventListener('click', function(e) {
            if (!e.target.closest('.btn')) {
                // Navigate to detailed view
                console.log('Navigate to inventory details');
            }
        });
    });
    
    // Handle modal view details
    document.querySelectorAll('.view-details-modal').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            loadProductDetails(productId);
        });
    });
    
    function loadProductDetails(productId) {
        const modalBody = document.getElementById('productDetailsBody');
        const viewFullDetailsBtn = document.getElementById('viewFullDetails');
        
        // Set the full details link
        viewFullDetailsBtn.href = `/ar/inventory/product/${productId}/`;
        
        // Show loading
        modalBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <p class="mt-2">جاري تحميل البيانات...</p>
            </div>
        `;
        
        // Fetch product details
        fetch(`/ar/inventory/api/product/?product_id=${productId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('{% trans "Failed to load data" %}');
                }
                return response.json();
            })
            .then(data => {
                displayProductDetails(data);
            })
            .catch(error => {
                console.error('Error:', error);
                modalBody.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {% trans "Error loading data" %}: ${error.message}
                    </div>
                `;
            });
    }
    
    function displayProductDetails(data) {
        const modalBody = document.getElementById('productDetailsBody');
        
        // Determine stock level class
        let stockLevelClass = 'stock-good';
        if (data.stock_level === 'low') stockLevelClass = 'stock-low';
        else if (data.stock_level === 'critical') stockLevelClass = 'stock-critical';
        else if (data.stock_level === 'out') stockLevelClass = 'stock-out';
        
        modalBody.innerHTML = `
            <div class="row mb-4">
                <div class="col-md-8">
                    <h4>${data.product_name}</h4>
                    <p class="text-muted mb-1">كود المنتج: ${data.product_code}</p>
                    <p class="text-muted mb-1">{% trans "Category" %}: ${data.category || '{% trans "Not specified" %}'}</p>
                    <p class="text-muted">{% trans "Sale Price" %}: ${data.sale_price.toFixed(3)} {% get_currency_symbol %}</p>
                </div>
                <div class="col-md-4 text-end">
                    <span class="stock-level ${stockLevelClass}">
                        <i class="fas fa-warehouse me-2"></i>
                        ${data.stock_level_text}
                    </span>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="text-center bg-light p-3 rounded">
                        <i class="fas fa-boxes text-primary fa-2x mb-2"></i>
                        <h4 class="mb-1">${data.current_stock}</h4>
                        <small class="text-muted">{% trans "Current Stock" %}</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center bg-light p-3 rounded">
                        <i class="fas fa-arrow-down text-success fa-2x mb-2"></i>
                        <h4 class="mb-1">${data.total_in}</h4>
                        <small class="text-muted">{% trans "Total Incoming" %}</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center bg-light p-3 rounded">
                        <i class="fas fa-arrow-up text-danger fa-2x mb-2"></i>
                        <h4 class="mb-1">${data.total_out}</h4>
                        <small class="text-muted">{% trans "Total Outgoing" %}</small>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        آخر الحركات
                </div>
                <div class="card-body">
                    ${data.recent_movements.length > 0 ? 
                        data.recent_movements.map(movement => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                                <div>
                                    <span class="badge ${movement.type === 'in' ? 'bg-success' : movement.type === 'out' ? 'bg-danger' : 'bg-info'}">
                                        ${movement.type_text}
                                    </span>
                                    <strong class="ms-2">${movement.quantity}</strong>
                                    <small class="text-muted">- ${movement.warehouse}</small>
                                </div>
                                <small class="text-muted">${movement.date}</small>
                            </div>
                        `).join('') : 
                        '<div class="text-center text-muted py-3"><i class="fas fa-history fa-2x mb-2"></i><p>{% trans "No recent movements" %}</p></div>'
                    }
                </div>
            </div>
        `;
    }
    
    // Print Function
    window.printInventoryReport = function() {
        console.log('بدء {% trans "Print" %} {% trans "Inventory Report" %}...');
        
        let inventoryHTML = `
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1>{% trans "Inventory Report" %}</h1>
                <p>{% trans "Report Date" %}: ${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}</p>
            </div>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>{% trans "Product Code" %}</th>
                        <th>{% trans "Product Name" %}</th>
                        <th>{% trans "Warehouse" %}</th>
                        <th>{% trans "Quantity" %}</th>
                        <th>{% trans "Stock Status" %}</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        // Get inventory items from the table
        const inventoryRows = document.querySelectorAll('tbody tr');
        console.log('Number of inventory rows present:', inventoryRows.length);
        if (inventoryRows.length === 0) {
            inventoryHTML += `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">{% trans "No inventory data for" %} {% trans "Print" %}</td>
                </tr>
            `;
        } else {
            inventoryRows.forEach((row) => {
                try {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 5) {
                        const productName = cells[0].querySelector('strong').textContent.trim();
                        const productCode = cells[1].textContent.trim();
                        const warehouse = cells[2].textContent.trim();
                        const quantity = cells[3].querySelector('strong').textContent.trim();
                        const stockLevel = cells[4].textContent.trim();
                        
                        console.log('{% trans "Stock data:" %}', {productCode, productName, warehouse, quantity, stockLevel});
                        
                        inventoryHTML += `
                            <tr>
                                <td>${productCode}</td>
                                <td>${productName}</td>
                                <td>${warehouse}</td>
                                <td>${quantity}</td>
                                <td>${stockLevel}</td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    console.warn('Error processing inventory row:', error);
                }
            });
        }
        
        inventoryHTML += `
                </tbody>
            </table>
        `;
        
        // Create a new window for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>{% trans "Inventory Report" %}</title>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; direction: rtl; }
                        .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: right; }
                        .print-table th { background-color: #f5f5f5; font-weight: bold; }
                        h1 { text-align: center; margin-bottom: 20px; }
                        p { text-align: center; margin-bottom: 20px; }
                    </style>
                </head>
                <body>
                    ${inventoryHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }
});
</script>
{% endblock %}
