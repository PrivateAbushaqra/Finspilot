<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุงุฑ ุญูุธ ุงูููุชุฌ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">ุงุฎุชุจุงุฑ ุญูุธ ููุชุฌ ูู Modal</h1>
        
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#testModal">
            ูุชุญ ูุงูุฐุฉ ุฅูุดุงุก ููุชุฌ
        </button>
        
        <div id="resultArea" class="mt-4"></div>
    </div>
    
    <!-- Modal -->
    <div class="modal fade" id="testModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ุฅูุดุงุก ููุชุฌ ุฌุฏูุฏ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="testForm">
                    <div class="modal-body">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        
                        <div class="mb-3">
                            <label class="form-label">ุงุณู ุงูููุชุฌ *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ุฑูุฒ ุงูููุชุฌ (SKU) *</label>
                            <input type="text" class="form-control" name="sku" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ุงููุฆุฉ *</label>
                            <select class="form-control" name="category" required id="categorySelect">
                                <option value="">ุงุฎุชุฑ...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ุณุนุฑ ุงูุจูุน *</label>
                            <input type="number" step="0.01" class="form-control" name="sale_price" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ุงููุญุฏุฉ *</label>
                            <select class="form-control" name="unit" required>
                                <option value="piece">ูุทุนุฉ</option>
                                <option value="kg">ูุฌู</option>
                                <option value="liter">ูุชุฑ</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none me-2" id="spinner"></span>
                            ุญูุธ
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ุชุญููู ุงููุฆุงุช
        fetch('/ar/products/product-add-ajax/', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.categories) {
                const select = document.getElementById('categorySelect');
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            }
        });
        
        // ูุนุงูุฌุฉ ุงููููุฐุฌ
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('๐ ูููุฐุฌ ุชู ุฅุฑุณุงูู');
            
            const spinner = document.getElementById('spinner');
            spinner.classList.remove('d-none');
            
            const formData = new FormData(this);
            
            // ุทุจุงุนุฉ ุงูุจูุงูุงุช
            console.log('๐ค ุงูุจูุงูุงุช ุงููุฑุณูุฉ:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            
            // ุงูุญุตูู ุนูู CSRF token ูู cookie
            const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
            console.log('๐ CSRF Token:', csrftoken);
            
            fetch('/ar/products/product-add-ajax/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken || formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                console.log('๐ฅ ููุฏ ุงูุงุณุชุฌุงุจุฉ:', response.status);
                console.log('๐ฅ ููุน ุงููุญุชูู:', response.headers.get('content-type'));
                return response.text();
            })
            .then(text => {
                console.log('๐ฆ ูุต ุงูุงุณุชุฌุงุจุฉ:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('๐ฆ ุจูุงูุงุช JSON:', data);
                    
                    const resultArea = document.getElementById('resultArea');
                    if (data.success) {
                        resultArea.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                ${data.message || 'ุชู ุงูุญูุธ ุจูุฌุงุญ!'}
                                <br>
                                <strong>ID:</strong> ${data.product?.id}<br>
                                <strong>ุงูุงุณู:</strong> ${data.product?.name}<br>
                                <strong>ุงูุฑูุฒ:</strong> ${data.product?.code}
                            </div>
                        `;
                        // ุฅุบูุงู ุงููุงูุฐุฉ
                        bootstrap.Modal.getInstance(document.getElementById('testModal')).hide();
                    } else {
                        resultArea.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                ุฎุทุฃ: ${data.error || 'ูุดู ุงูุญูุธ'}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('โ ุฎุทุฃ ูู ุชุญููู JSON:', error);
                    document.getElementById('resultArea').innerHTML = `
                        <div class="alert alert-danger">
                            ุฎุทุฃ ูู ุชุญููู ุงูุงุณุชุฌุงุจุฉ: ${error.message}
                            <pre>${text.substring(0, 500)}</pre>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('โ ุฎุทุฃ ูู ุงูุดุจูุฉ:', error);
                document.getElementById('resultArea').innerHTML = `
                    <div class="alert alert-danger">
                        ุฎุทุฃ ูู ุงูุดุจูุฉ: ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                spinner.classList.add('d-none');
            });
        });
    </script>
</body>
</html>
