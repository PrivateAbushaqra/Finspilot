{% extends 'base.html' %}
{% load i18n %}
{% load custom_filters %}



{% block title %}{% trans "Create New Product" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-i    // Bind unit change event
    $('#unit').on('change', function() {
        toggleSerialNumberField();
        
        // If "service" is selected as unit, activate service product
        if ($(this).val() === 'service') {
            $('#is_service').prop('checked', true);
            toggleInventoryFields(true);
        }
    });
    
    // Bind events
    $('#selling_price, #tax_rate').on('input', calculateTax);
    
    // Improve user experience
    $('#tax_rate').on('input', function() {">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-plus text-primary me-2"></i>
                        {% trans "Create New Product" %}
                    </h1>
                    <p class="mb-0 text-muted">{% trans "Create a new product in the system" %}</p>
                </div>
                <div>
                    <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        {% trans "Back to List" %}
                    </a>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-box me-2"></i>
                        {% trans "Product Information" %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" autocomplete="off">
                        {% csrf_token %}
                        <input type="hidden" name="form_id" value="product_form_{{ random_id }}">
                        
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">{% trans "Product Name" %} <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name" autocomplete="off" 
                                           data-form-type="other" spellcheck="false" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name_en" class="form-label">{% trans "Name in English" %}</label>
                                    <input type="text" class="form-control" id="name_en" name="name_en" autocomplete="off" 
                                           data-form-type="other" spellcheck="false">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product_type" class="form-label">{% trans "Product Type" %} <span class="text-danger">*</span></label>
                                    <select class="form-control" id="product_type" name="product_type" required>
                                        <option value="physical">{% trans "Physical Product" %}</option>
                                        <option value="service">{% trans "Service" %}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sku" class="form-label">{% trans "Product Code (SKU)" %} <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="sku" name="sku" placeholder="{% trans "Example: PROD-001" %}" 
                                           autocomplete="off" data-form-type="other" spellcheck="false" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="barcode" class="form-label">{% trans "Barcode" %}</label>
                                    <input type="text" class="form-control" id="barcode" name="barcode" 
                                           autocomplete="off" data-form-type="other" spellcheck="false">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Serial Number field for pieces only -->
                        <div class="row" id="serial_number_row" style="display: none;">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="serial_number" class="form-label">
                                        {% trans "Serial Number" %}
                                        <small class="text-muted">- {% trans "For warranty" %}</small>
                                    </label>
                                    <input type="text" class="form-control" id="serial_number" name="serial_number" 
                                           placeholder="{% trans "Example: SN123456789" %}" autocomplete="off" 
                                           data-form-type="other" spellcheck="false">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "This field is for products sold by piece and need warranty (optional)" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category" class="form-label">{% trans "Category" %} <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <div class="position-relative flex-grow-1">
                                            <input type="text" class="form-control" id="categorySearch" placeholder="{% trans 'Type to search categories...' %}" autocomplete="off"
                                                   data-categories="{% for category in categories %}{{ category.id }}|{{ category.name|escapejs }}|{{ category.code|escapejs }}{% if not forloop.last %}||{% endif %}{% endfor %}">
                                            <div id="categoryDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                                <!-- Category options will be populated here -->
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-primary" id="searchCategoryBtn" title="{% trans "Search categories" %}">
                                            <i class="fas fa-search"></i>
                                        </button>
                                        <input type="hidden" id="category" name="category" required>
                                        <button type="button" class="btn btn-outline-primary" id="addCategoryBtn" title="{% trans "Add New Category" %}" 
                                                data-has-permission="{% if user.is_superuser or user.user_type == 'superadmin' or perms.products.can_add_categories_inline %}true{% else %}false{% endif %}">
                                            <i class="fas fa-plus"></i>
                                            {% trans "Add Category" %}
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <small class="text-muted">{% trans "Start typing to search for categories or click search button" %}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="is_service" name="is_service" onchange="toggleInventoryFields(this.checked)">
                                        <label class="form-check-label" for="is_service">
                                            <i class="fas fa-concierge-bell text-primary me-2"></i>
                                            <strong>{% trans "Service Product (Non-countable)" %}</strong>
                                        </label>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% trans "Service products do not affect inventory" %} {% trans "Service products do not need quantities" %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="unit" class="form-label">{% trans "Unit of Measurement" %} <span class="text-danger">*</span></label>
                                    <select class="form-select" id="unit" name="unit" required>
                                        <option value="piece">{% trans "Piece" %}</option>
                                        <option value="service">{% trans "Service" %}</option>
                                        <option value="kg">{% trans "Kilogram" %}</option>
                                        <option value="liter">{% trans "Liter" %}</option>
                                        <option value="meter">{% trans "Meter" %}</option>
                                        <option value="box">{% trans "Box" %}</option>
                                        <option value="pack">{% trans "Pack" %}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pricing -->
                        <h6 class="mt-4 mb-3">{% trans "Pricing" %}</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">{% trans "Cost Price" %}</label>
                                    <input type="text" class="form-control" value="{% trans 'Calculated automatically from purchases' %}" readonly disabled>
                                    <small class="form-text text-muted">{% trans "Cost is calculated from purchase invoices using weighted average method" %}</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sale_price" class="form-label">{% trans "Selling Price" %} <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="sale_price" name="sale_price" step="0.001" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="wholesale_price" class="form-label">{% trans "Wholesale Price" %}</label>
                                    <input type="number" class="form-control" id="wholesale_price" name="wholesale_price" step="0.001" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tax_rate" class="form-label">
                                        <i class="fas fa-percentage text-primary me-1"></i>
                                        {% trans "Tax Rate %" %} <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="tax_rate" name="tax_rate" 
                                               step="0.01" min="0" max="100" value="0" 
                                               placeholder="{% trans "Example: 15" %}" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "Will be calculated automatically in invoices" %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tax Calculation Display -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-info" style="display: none;" id="tax-calculation">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-calculator me-2"></i>
                                        {% trans "Tax Calculation" %}
                                    </h6>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>{% trans "Selling Price" %}:</span>
                                        <span id="base-price">0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>{% trans "Tax Amount" %}:</span>
                                        <span id="tax-amount">0.00</span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>{% trans "Price Including Tax" %}:</span>
                                        <span id="price-with-tax">0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inventory -->
                        <div id="inventory-section">
                            <h6 class="mt-4 mb-3">
                                <i class="fas fa-warehouse text-primary me-2"></i>
                                {% trans "Inventory Management" %}
                            </h6>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                {% trans "This section is for countable products only. Service products do not need inventory management." %}
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="opening_balance" class="form-label">
                                            <i class="fas fa-balance-scale text-success me-1"></i>
                                            {% trans "Opening Balance" %}
                                        </label>
                                        <input type="number" class="form-control" id="opening_balance" name="opening_balance" 
                                               step="0.001" min="0" value="0">
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% trans "Initial stock when starting to use the system" %}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="opening_balance_cost" class="form-label">
                                            <i class="fas fa-dollar-sign text-warning me-1"></i>
                                            {% trans "Opening Balance Cost" %} <span class="text-danger">*</span>
                                        </label>
                                        <input type="number" class="form-control" id="opening_balance_cost" name="opening_balance_cost" 
                                               step="0.001" min="0" value="0" required>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% trans "Total cost of the opening balance for FIFO inventory calculation" %}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="min_stock" class="form-label">{% trans "Minimum Stock Level" %}</label>
                                        <input type="number" class="form-control" id="min_stock" name="min_stock" min="0" value="0">
                                    </div>
                                </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="max_stock" class="form-label">{% trans "Maximum Stock Level" %}</label>
                                    <input type="number" class="form-control" id="max_stock" name="max_stock" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description and Image -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="description" class="form-label">{% trans "Description" %}</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" 
                                              autocomplete="off" data-form-type="other" spellcheck="false"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="image" class="form-label">{% trans "Product Image" %}</label>
                                    <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                        <label class="form-check-label" for="is_active">
                                            {% trans "Active" %}
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="track_stock" name="track_stock" checked>
                                        <label class="form-check-label" for="track_stock">
                                            {% trans "Track Inventory" %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                {% trans "Cancel" %}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                {% trans "Save Product" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden translation elements for JavaScript -->
<div style="display: none;" id="js-translations">
    <span data-trans="warning">{% trans "Warning" %}</span>
    <span data-trans="low-price-warning">{% trans "Selling price is lower than cost price. Are you sure?" %}</span>
    <span data-trans="yes-sure">{% trans "Yes, I'm sure" %}</span>
    <span data-trans="edit-price">{% trans "Edit Price" %}</span>
    <span data-trans="alert">{% trans "Alert" %}</span>
    <span data-trans="sku-warning">{% trans "We recommend the product code to be at least 3 characters for easy identification." %}</span>
    <span data-trans="success">{% trans "Completed Successfully!" %}</span>
    <span data-trans="error">{% trans "Error!" %}</span>
    <span data-trans="network-error">{% trans "Network Error!" %}</span>
    <span data-trans="save-error">{% trans "An error occurred while saving the category. Please try again." %}</span>
    <span data-trans="saving">{% trans "Saving..." %}</span>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Prevent autocomplete and browser interference
$(document).ready(function() {
    // Disable autocomplete for all form inputs
    $('input, textarea, select').attr('autocomplete', 'off');
    
    // Clear browser autocomplete suggestions
    $('input[type="text"], textarea').each(function() {
        $(this).attr('autocomplete', 'new-' + Math.random().toString(36).substring(2));
    });
    
    // Prevent browser from filling forms automatically
    setTimeout(function() {
        $('input[type="text"], textarea').each(function() {
            if ($(this).val() === 'The Form' || $(this).val().indexOf('The Form') !== -1) {
                $(this).val('');
            }
        });
    }, 100);
    
    // Monitor for unwanted changes and clear them
    $('input[type="text"], textarea').on('input', function() {
        var val = $(this).val();
        if (val === 'The Form' || val.indexOf('The Form') !== -1) {
            $(this).val('');
        }
    });
    
    // Additional protection against browser autocomplete
    $('form').on('submit', function() {
        $('input[type="text"], textarea').each(function() {
            if ($(this).val() === 'The Form' || $(this).val().indexOf('The Form') !== -1) {
                $(this).val('');
            }
        });
    });
});

// Function to get translated text for JavaScript
function getTranslation(key) {
    return document.querySelector('#js-translations [data-trans="' + key + '"]').textContent;
}

$(document).ready(function() {
    // Calculate tax when price or tax rate changes
    function calculateTax() {
        var sellingPrice = parseFloat($('#selling_price').val()) || 0;
        var taxRate = parseFloat($('#tax_rate').val()) || 0;
        
        if (sellingPrice > 0 && taxRate > 0) {
            var taxAmount = sellingPrice * (taxRate / 100);
            var priceWithTax = sellingPrice + taxAmount;
            
            $('#base-price').text(sellingPrice.toFixed(3));
            $('#tax-amount').text(taxAmount.toFixed(3));
            $('#price-with-tax').text(priceWithTax.toFixed(3));
            $('#tax-calculation').show();
        } else {
            $('#tax-calculation').hide();
        }
    }
    
    // Show/hide serial number field based on unit of measurement
    function toggleSerialNumberField() {
        var unit = $('#unit').val();
        var serialNumberRow = $('#serial_number_row');
        
        if (unit === 'piece') {
            serialNumberRow.show();
        } else {
            serialNumberRow.hide();
            $('#serial_number').val(''); // Clear value when hidden
        }
    }
    
    // Show/hide inventory fields for service products
    function toggleInventoryFields(isService) {
        var inventorySection = $('#inventory-section');
        
        if (isService) {
            inventorySection.hide();
            // Set values to zero for service products
            $('#current_stock').val(0);
            $('#min_stock').val(0);
            // Change unit of measurement to service
            $('#unit').val('service');
        } else {
            inventorySection.show();
            // Reset unit of measurement to piece
            if ($('#unit').val() === 'service') {
                $('#unit').val('piece');
            }
        }
        
        // Update serial number field
        toggleSerialNumberField();
    }
    
    // Bind unit change event
    $('#unit').on('change', function() {
        toggleSerialNumberField();
        
        // If "service" is selected as unit, enable service product
        if ($(this).val() === 'service') {
            $('#is_service').prop('checked', true);
            toggleInventoryFields(true);
        }
    });
    
    // Calculate opening balance cost automatically
    function calculateOpeningBalanceCost() {
        var openingBalance = parseFloat($('#opening_balance').val()) || 0;
        var costPrice = parseFloat($('#cost_price').val()) || 0;
        var costField = $('#opening_balance_cost');
        
        if (openingBalance > 0 && costPrice > 0) {
            var totalCost = openingBalance * costPrice;
            costField.val(totalCost.toFixed(3));
        } else if (openingBalance === 0) {
            costField.val(0);
        }
    }
    
    // Bind opening balance and cost price change events
    $('#opening_balance, #cost_price').on('input change', calculateOpeningBalanceCost);
    
    // Improve user experience
    $('#tax_rate').on('input', function() {
        var value = parseFloat($(this).val());
        if (value > 100) {
            $(this).val(100);
            calculateTax();
        } else if (value < 0) {
            $(this).val(0);
            calculateTax();
        }
    });
    
    // Add tooltips for help
    $('[data-bs-toggle="tooltip"]').tooltip();
    
    // Improve price validation
    $('#sale_price').on('blur', function() {
        var sellingPrice = parseFloat($(this).val()) || 0;
        // تم إزالة فحص سعر التكلفة لأنه يُحسب تلقائياً
        
        if (sellingPrice <= 0) {
            Swal.fire({
                icon: 'warning',
                title: 'تنبيه',
                text: 'يرجى إدخال سعر بيع صحيح',
                confirmButtonText: 'موافق'
            });
        }
    });
    
    // Improve product code input
    $('#sku').on('blur', function() {
        var sku = $(this).val().trim();
        if (sku && sku.length < 3) {
            Swal.fire({
                icon: 'info',
                title: getTranslation('alert'),
                text: getTranslation('sku-warning')
            });
        }
    });
    
    // Apply controls on page load and unit change
    $(document).ready(function() {
        toggleSerialNumberField();
        $('#unit').on('change', toggleSerialNumberField);
        
        // Initialize opening balance cost field
        toggleOpeningBalanceCost();
    });
});
</script>

<!-- Modal Add New Category -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">
                    <i class="fas fa-plus-circle text-primary me-2"></i>
                    {% trans "Add New Category" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryName" class="form-label">{% trans "Category Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="categoryName" name="name" required autocomplete="off" 
                                       data-form-type="other" spellcheck="false">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryNameEn" class="form-label">{% trans "English Name" %}</label>
                                <input type="text" class="form-control" id="categoryNameEn" name="name_en" autocomplete="off" 
                                       data-form-type="other" spellcheck="false">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryCode" class="form-label">{% trans "Category Code" %}</label>
                                <input type="text" class="form-control" id="categoryCode" name="code" placeholder="{% trans 'Example: ELECTRONICS' %}" 
                                       autocomplete="off" data-form-type="other" spellcheck="false">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryParent" class="form-label">{% trans "Parent Category" %}</label>
                                <select class="form-select" id="categoryParent" name="parent">
                                    <option value="">{% trans "Main Category" %}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="categoryDescription" class="form-label">{% trans "Description" %}</label>
                                <textarea class="form-control" id="categoryDescription" name="description" rows="3" 
                                          autocomplete="off" data-form-type="other" spellcheck="false"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="categorySortOrder" class="form-label">{% trans "Sort Order" %}</label>
                                <input type="number" class="form-control" id="categorySortOrder" name="sort_order" value="0">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="categoryIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="categoryIsActive">
                                        {% trans "Active" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">
                    <i class="fas fa-save me-2"></i>
                    {% trans "Save Category" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Category search functionality
    // Parse categories from data attribute
    var categoriesData = $('#categorySearch').data('categories') || '';
    var categories = [];
    
    if (categoriesData) {
        var categoryStrings = categoriesData.split('||');
        categories = categoryStrings.map(function(catStr) {
            var parts = catStr.split('|');
            return {
                id: parts[0],
                name: parts[1] || '',
                code: parts[2] || ''
            };
        });
    }

    var categorySearch = $('#categorySearch');
    var categoryDropdown = $('#categoryDropdown');
    var categoryHidden = $('#category');

    // Function to filter and show categories
    function filterCategories() {
        var searchTerm = categorySearch.val().toLowerCase().trim();

        if (searchTerm === '') {
            categoryDropdown.hide();
            return;
        }

        // Clear previous options
        categoryDropdown.empty();

        // Filter categories
        var filteredCategories = categories.filter(function(category) {
            return category.name.toLowerCase().includes(searchTerm) ||
                   (category.code && category.code.toLowerCase().includes(searchTerm));
        });

        if (filteredCategories.length === 0) {
            categoryDropdown.hide();
            return;
        }

        // Create dropdown options
        filteredCategories.forEach(function(category) {
            var option = $('<button type="button" class="dropdown-item"></button>');
            option.html('<strong>' + category.name + '</strong>' + (category.code ? ' (' + category.code + ')' : ''));
            option.attr('data-category', JSON.stringify(category));

            option.on('click', function() {
                // Fill category data
                categoryHidden.val(category.id);
                categorySearch.val(category.name);
                categoryDropdown.hide();

                // Trigger change event for validation
                categoryHidden.trigger('change');
            });

            categoryDropdown.append(option);
        });

        categoryDropdown.show();
    }

    // Handle input changes
    categorySearch.on('input', filterCategories);

    // Handle focus to show all categories if empty
    categorySearch.on('focus', function() {
        if (categorySearch.val().trim() === '') {
            // Show all categories
            categoryDropdown.empty();
            categories.slice(0, 10).forEach(function(category) { // Show first 10 categories
                var option = $('<button type="button" class="dropdown-item"></button>');
                option.html('<strong>' + category.name + '</strong>' + (category.code ? ' (' + category.code + ')' : ''));
                option.attr('data-category', JSON.stringify(category));

                option.on('click', function() {
                    // Fill category data
                    categoryHidden.val(category.id);
                    categorySearch.val(category.name);
                    categoryDropdown.hide();

                    // Trigger change event for validation
                    categoryHidden.trigger('change');
                });

                categoryDropdown.append(option);
            });
            categoryDropdown.show();
        }
    });

    // Hide dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!categorySearch.is(e.target) && !categoryDropdown.is(e.target) && categoryDropdown.has(e.target).length === 0) {
            categoryDropdown.hide();
        }
    });

    // Handle blur with delay to allow click on dropdown items
    categorySearch.on('blur', function() {
        setTimeout(function() {
            if (categorySearch.val() && !categoryHidden.val()) {
                // If user typed something but didn't select from dropdown, clear it
                categorySearch.val('');
                categoryHidden.val('');
            }
        }, 200);
    });

    // Update search input when hidden field changes (e.g., from new category modal)
    categoryHidden.on('change', function() {
        if (categoryHidden.val()) {
            var selectedCategory = categories.find(function(cat) {
                return cat.id == categoryHidden.val();
            });
            if (selectedCategory) {
                categorySearch.val(selectedCategory.name);
            }
        } else {
            categorySearch.val('');
        }
    });

    // Check if user has permission to add categories inline
    var hasPermission = $('#addCategoryBtn').data('has-permission') === 'true';
    
    if (hasPermission) {
        // Show add category button
        $('#addCategoryBtn').show();
        
        // Open modal popup
        $('#addCategoryBtn').on('click', function() {
            $('#categoryModal').modal('show');
            loadParentCategories();
        });
    } else {
        // Hide add category button if no permission
        $('#addCategoryBtn').hide();
    }
    
    // Load parent categories list
    function loadParentCategories() {
        $.get('{% url "products:category_add_ajax" %}', function(data) {
            var select = $('#categoryParent');
            select.empty();
            select.append('<option value="">{% trans "No parent category" %}</option>');
            
            if (data.categories) {
                data.categories.forEach(function(category) {
                    select.append('<option value="' + category.id + '">' + category.name + '</option>');
                });
            }
        });
    }
    
    // Save new category
    $('#saveCategoryBtn').on('click', function() {
        var formData = new FormData($('#categoryForm')[0]);
        
        // Add CSRF token to form data
        var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        if (!csrfToken) {
            csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        }
        formData.append('csrfmiddlewaretoken', csrfToken);
        
        // Show loading indicator
        var originalText = $(this).html();
        $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>' + getTranslation('saving'));
        $(this).prop('disabled', true);
        
        $.ajax({
            url: '{% url "products:category_add_ajax" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Add new category to the list
                    var newCategory = {
                        id: response.category.id,
                        name: response.category.name,
                        code: response.category.code || ''
                    };
                    categories.push(newCategory);
                    
                    // Update the data attribute
                    var updatedData = categories.map(function(cat) {
                        return cat.id + '|' + cat.name + '|' + cat.code;
                    }).join('||');
                    categorySearch.attr('data-categories', updatedData);
                    
                    // Select the new category
                    categoryHidden.val(response.category.id);
                    categorySearch.val(response.category.name);
                    
                    // Close modal and show success message
                    $('#categoryModal').modal('hide');
                    $('#categoryForm')[0].reset();
                    
                    Swal.fire({
                        icon: 'success',
                        title: getTranslation('success'),
                        text: response.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: getTranslation('error'),
                        text: response.error
                    });
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: getTranslation('network-error'),
                    text: getTranslation('save-error')
                });
            },
            complete: function() {
                // Reset button
                $('#saveCategoryBtn').html(originalText);
                $('#saveCategoryBtn').prop('disabled', false);
            }
        });
    });
    
    // Clear form when modal is closed
    $('#categoryModal').on('hidden.bs.modal', function() {
        $('#categoryForm')[0].reset();
        $('#categoryIsActive').prop('checked', true);
    });
});

// Category Search Modal Functions
function openCategorySearchModal() {
    $('#categorySearchModal').modal('show');
    // Focus on search input
    setTimeout(function() {
        $('#categorySearchInput').focus();
    }, 500);
}

function selectCategory(categoryId, categoryName, categoryCode) {
    $('#category').val(categoryId);
    $('#categorySearch').val(categoryName);
    $('#categoryDropdown').hide();
    $('#categorySearchModal').modal('hide');
    
    // Trigger change event for validation
    $('#category').trigger('change');
}

// Filter categories in modal
function filterCategoriesInModal() {
    const searchTerm = $('#categorySearchInput').val().toLowerCase().trim();
    const categoryItems = $('#categoryList .category-item');
    
    if (searchTerm === '') {
        categoryItems.show();
        return;
    }
    
    categoryItems.each(function() {
        const categoryName = $(this).data('name').toLowerCase();
        const categoryCode = $(this).data('code').toLowerCase();
        
        if (categoryName.includes(searchTerm) || categoryCode.includes(searchTerm)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// Bind search button
$('#searchCategoryBtn').on('click', function() {
    openCategorySearchModal();
});

// Bind search input in modal
$('#categorySearchInput').on('input', filterCategoriesInModal);

// Category Search Modal Functions
function openCategorySearchModal() {
    $('#categorySearchModal').modal('show');
    // Focus on search input
    setTimeout(function() {
        $('#categorySearchInput').focus();
    }, 500);
}

function selectCategory(categoryId, categoryName, categoryCode) {
    $('#category').val(categoryId);
    $('#categorySearch').val(categoryName);
    $('#categoryDropdown').hide();
    $('#categorySearchModal').modal('hide');
    
    // Trigger change event for validation
    $('#category').trigger('change');
}

// Filter categories in modal
function filterCategoriesInModal() {
    const searchTerm = $('#categorySearchInput').val().toLowerCase().trim();
    const categoryItems = $('#categoryList .category-item');
    
    if (searchTerm === '') {
        categoryItems.show();
        return;
    }
    
    categoryItems.each(function() {
        const categoryName = $(this).data('name').toLowerCase();
        const categoryCode = $(this).data('code').toLowerCase();
        
        if (categoryName.includes(searchTerm) || categoryCode.includes(searchTerm)) {
            $(this).show();
        } else {
            $(this).hide();
        }
    });
}

// Bind search button
$('#searchCategoryBtn').on('click', function() {
    openCategorySearchModal();
});

// Bind search input in modal
$('#categorySearchInput').on('input', filterCategoriesInModal);
</script>

<!-- Category Search Modal -->
<div class="modal fade" id="categorySearchModal" tabindex="-1" aria-labelledby="categorySearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categorySearchModalLabel">
                    <i class="fas fa-search me-2"></i>
                    {% trans "Select Category" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="categorySearchInput" placeholder="{% trans 'Search for category by name or code...' %}">
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>{% trans "Category Name" %}</th>
                                <th>{% trans "Category Code" %}</th>
                                <th>{% trans "Select" %}</th>
                            </tr>
                        </thead>
                        <tbody id="categoryList">
                            {% for category in categories %}
                            <tr class="category-item" data-name="{{ category.name }}" data-code="{{ category.code }}">
                                <td>{{ category.name }}</td>
                                <td>{{ category.code }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="selectCategory('{{ category.id }}', '{{ category.name|escapejs }}', '{{ category.code|escapejs }}')">
                                        {% trans "Select" %}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
