{% extends 'base.html' %}
{% load i18n %}
{% load l10n %}



{% block title %}{% trans "Edit Product" %} - {{ block.super }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-edit text-primary me-2"></i>
                        {% trans "Edit Product" %}
                    </h1>
                    <p class="mb-0 text-muted">{% trans "Edit product information" %}</p>
                </div>
                <div>
                    <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        {% trans "Back to List" %}
                    </a>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-box me-2"></i>
                        {% trans "Product Information" %}
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="hidden" id="has_movements" value="{% if has_movements %}true{% else %}false{% endif %}">
                        
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name" class="form-label">{% trans "Product Name" %} <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name" value="{{ product.name|default:'' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="name_en" class="form-label">{% trans "English Name" %}</label>
                                    <input type="text" class="form-control" id="name_en" name="name_en" value="{{ product.name_en|default:'' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product_type" class="form-label">{% trans "Product Type" %} <span class="text-danger">*</span></label>
                                    <select class="form-control" id="product_type" name="product_type" required>
                                        <option value="physical" {% if product.product_type == 'physical' %}selected{% endif %}>{% trans "Physical Product" %}</option>
                                        <option value="service" {% if product.product_type == 'service' %}selected{% endif %}>{% trans "Service" %}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sku" class="form-label">{% trans "رمز المنتج (SKU)" %}</label>
                                    <input type="text" class="form-control" id="sku" name="sku" value="{{ product.code|default:'' }}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sequence_number" class="form-label">{% trans "Sequence Number" %}</label>
                                    <input type="number" class="form-control" id="sequence_number" name="sequence_number" 
                                           value="{{ product.sequence_number }}" 
                                           {% if not user.is_superuser and not perms.products.can_edit_product_sequence_number %}readonly{% endif %}>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "Auto-calculated based on category (Category Number + 100, 101, ...)" %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="barcode" class="form-label">{% trans "Barcode" %}</label>
                                    <input type="text" class="form-control" id="barcode" name="barcode" value="{{ product.barcode|default:'' }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="serial_number" class="form-label">
                                        {% trans "Serial Number - For Warranty" %}
                                        <small class="text-muted">- {% trans "للكفالة" %}</small>
                                    </label>
                                    <input type="text" class="form-control" id="serial_number" name="serial_number" 
                                           value="{{ product.serial_number|default:'' }}" placeholder="{% trans 'Example: SN123456789' %}">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "This field is for products sold per piece that need warranty (optional)" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="category" class="form-label">{% trans "Category" %}</label>
                                    <div class="input-group">
                                        <select class="form-select" id="category" name="category">
                                            <option value="">{% trans "Select Category" %}</option>
                                            {% for category in categories %}
                                                <option value="{{ category.id }}" {% if product.category_id == category.id %}selected{% endif %}>{{ category.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-primary" id="addCategoryBtn" title="{% trans "Add New Category" %}">
                                            <i class="fas fa-plus"></i>
                                            {% trans "Add Category" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="is_service" name="is_service" 
                                               {% if product.is_service %}checked{% endif %} 
                                               onchange="toggleInventoryFields(this.checked)">
                                        <label class="form-check-label" for="is_service">
                                            <i class="fas fa-concierge-bell text-primary me-2"></i>
                                            <strong>{% trans "Service Product (Non-countable)" %}</strong>
                                        </label>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% trans "Service products do not affect inventory and do not need quantities" %}
                                        </div>
                                    </div>
                                </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="unit" class="form-label">{% trans "Unit of Measurement" %}</label>
                                    <select class="form-select" id="unit" name="unit">
                                        <option value="piece" {% if product.unit == 'piece' %}selected{% endif %}>{% trans "Piece" %}</option>
                                        <option value="service" {% if product.unit == 'service' %}selected{% endif %}>{% trans "Service" %}</option>
                                        <option value="kg" {% if product.unit == 'kg' %}selected{% endif %}>{% trans "Kilogram" %}</option>
                                        <option value="liter" {% if product.unit == 'liter' %}selected{% endif %}>{% trans "Liter" %}</option>
                                        <option value="meter" {% if product.unit == 'meter' %}selected{% endif %}>{% trans "Meter" %}</option>
                                        <option value="box" {% if product.unit == 'box' %}selected{% endif %}>{% trans "Box" %}</option>
                                        <option value="pack" {% if product.unit == 'pack' %}selected{% endif %}>{% trans "Pack" %}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pricing -->
                        <h6 class="mt-4 mb-3">{% trans "Pricing" %}</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="cost_price" class="form-label">{% trans "Cost Price" %}</label>
                                    <input type="number" class="form-control" id="cost_price" name="cost_price" step="0.001" min="0" value="{{ product.cost_price|unlocalize }}">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sale_price" class="form-label">{% trans "Sale Price" %} <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="sale_price" name="sale_price" step="0.001" min="0" value="{{ product.sale_price|unlocalize }}" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="wholesale_price" class="form-label">{% trans "Wholesale Price" %}</label>
                                    <input type="number" class="form-control" id="wholesale_price" name="wholesale_price" step="0.001" min="0" value="{{ product.wholesale_price|unlocalize }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tax_rate" class="form-label">
                                        <i class="fas fa-percentage text-primary me-1"></i>
                                        {% trans "Tax Rate" %} %
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="tax_rate" name="tax_rate" 
                                               step="0.01" min="0" max="100" value="{{ product.tax_rate|unlocalize }}" 
                                               placeholder="{% trans 'Example: 15' %}">
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "Will be calculated automatically in invoices" %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tax Calculation Display -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="alert alert-info" style="display: none;" id="tax-calculation">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-calculator me-2"></i>
                                        {% trans "Tax Calculation" %}
                                    </h6>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>{% trans "Sale Price" %}:</span>
                                        <span id="base-price">0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>{% trans "Tax Amount" %}:</span>
                                        <span id="tax-amount">0.00</span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>{% trans "Price Including Tax" %}:</span>
                                        <span id="price-with-tax">0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Linked Units Section -->
                        <h6 class="mt-4 mb-3">
                            <i class="fas fa-link text-primary me-2"></i>
                            {% trans "Linked Units Settings" %}
                        </h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            {% trans "Link this product with another unit (single/package) for flexible sales" %}
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="unit_type" class="form-label">
                                        <i class="fas fa-boxes text-primary me-1"></i>
                                        {% trans "Unit Type" %}
                                    </label>
                                    <select class="form-select" id="unit_type" name="unit_type">
                                        <option value="standalone" {% if product.unit_type == 'standalone' %}selected{% endif %}>{% trans "Standalone" %}</option>
                                        <option value="single" {% if product.unit_type == 'single' %}selected{% endif %}>{% trans "Single Unit" %}</option>
                                        <option value="package" {% if product.unit_type == 'package' %}selected{% endif %}>{% trans "Package" %}</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "Select unit type for linking" %}
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4" id="linked_product_container" {% if product.unit_type == 'standalone' %}style="display: none;"{% endif %}>
                                <div class="mb-3">
                                    <label for="linked_product" class="form-label">
                                        <i class="fas fa-exchange-alt text-success me-1"></i>
                                        {% trans "Linked Product" %}
                                    </label>
                                    <select class="form-select" id="linked_product" name="linked_product">
                                        <option value="">-- {% trans "Select Product" %} --</option>
                                        {% for prod in products %}
                                            <option value="{{ prod.id }}" {% if product.linked_product_id == prod.id %}selected{% endif %}>
                                                {{ prod.name }} ({{ prod.code }})
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "The linked product (single or package)" %}
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-4" id="conversion_factor_container" {% if product.unit_type != 'package' %}style="display: none;"{% endif %}>
                                <div class="mb-3">
                                    <label for="conversion_factor" class="form-label">
                                        <i class="fas fa-calculator text-warning me-1"></i>
                                        {% trans "Conversion Factor" %}
                                    </label>
                                    <input type="number" class="form-control" id="conversion_factor" name="conversion_factor" 
                                           step="0.001" min="0" value="{{ product.conversion_factor|unlocalize }}">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "Number of single units in one package" %}
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inventory -->
                        <div id="inventory-section">
                            <h6 class="mt-4 mb-3">
                                <i class="fas fa-warehouse text-primary me-2"></i>
                                {% trans "Inventory Management" %}
                            </h6>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                {% trans "This section is for countable products only. Service products do not need inventory management." %}
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="opening_balance" class="form-label">
                                            <i class="fas fa-balance-scale text-success me-1"></i>
                                            {% trans "Opening Balance" %}
                                            {% if has_movements %}
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="fas fa-lock me-1"></i>{% trans "Locked" %}
                                                </span>
                                            {% endif %}
                                        </label>
                                        <input type="number" class="form-control" id="opening_balance" name="opening_balance_quantity" 
                                               step="0.001" min="0" value="{{ product.opening_balance_quantity|unlocalize }}"
                                               {% if has_movements %}readonly style="background-color: #f8f9fa; cursor: not-allowed;"{% endif %}>
                                        {% if has_movements %}
                                            <div class="alert alert-warning mt-2 py-2">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                {% trans "You Cannot Modify the Opening Balance Because There are Transactions on This Product." %}
                                            </div>
                                        {% else %}
                                            <small class="form-text text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                {% trans "Initial stock when starting to use the system" %}
                                            </small>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="opening_balance_unit_cost" class="form-label">
                                            <i class="fas fa-coins text-primary me-1"></i>
                                            {% trans "Opening Balance Unit Cost" %}
                                            {% if has_movements %}
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="fas fa-lock me-1"></i>{% trans "Locked" %}
                                                </span>
                                            {% endif %}
                                        </label>
                                        <input type="number" class="form-control" id="opening_balance_unit_cost" name="opening_balance_unit_cost" 
                                               step="0.001" min="0" value="{{ product.opening_balance_unit_cost|default:0|unlocalize }}"
                                               {% if has_movements %}readonly style="background-color: #f8f9fa; cursor: not-allowed;"{% endif %}>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% trans "Cost per unit for opening balance (exclusive of VAT)" %}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="opening_balance_cost" class="form-label">
                                            <i class="fas fa-dollar-sign text-warning me-1"></i>
                                            {% trans "Opening Balance Total Cost" %} <span class="text-danger">*</span>
                                            {% if has_movements %}
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="fas fa-lock me-1"></i>{% trans "Locked" %}
                                                </span>
                                            {% endif %}
                                        </label>
                                        <input type="number" class="form-control" id="opening_balance_cost" name="opening_balance_cost" 
                                               step="0.001" min="0" value="{{ product.opening_balance_cost|unlocalize }}" 
                                               readonly style="background-color: #f8f9fa; cursor: not-allowed;"
                                                required>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-calculator me-1"></i>
                                            {% trans "Auto-calculated: Quantity × Unit Cost" %}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="opening_balance_warehouse" class="form-label">
                                            <i class="fas fa-warehouse text-info me-1"></i>
                                            {% trans "Opening Balance Warehouse" %}
                                        </label>
                                        <select class="form-control" id="opening_balance_warehouse" name="opening_balance_warehouse">
                                            <option value="">{% trans "Select Warehouse" %}</option>
                                            {% for warehouse in warehouses %}
                                            <option value="{{ warehouse.id }}" {% if product.opening_balance_warehouse and product.opening_balance_warehouse.id == warehouse.id %}selected{% endif %}>{{ warehouse.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            {% trans "Warehouse where the opening balance will be placed" %}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="current_stock" class="form-label">
                                            <i class="fas fa-warehouse text-primary me-1"></i>
                                            {% trans "Current Stock" %}
                                        </label>
                                        <input type="number" class="form-control" id="current_stock" 
                                               min="0" value="{{ product.current_stock|unlocalize }}" 
                                               readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                        <small class="form-text text-muted">
                                            <i class="fas fa-calculator me-1"></i>
                                            {% trans "Calculated automatically" %}: {% trans "Opening Balance" %} + {% trans "Incoming" %} - {% trans "Outgoing" %}
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="min_stock" class="form-label">{% trans "Minimum Stock Level" %}</label>
                                        <input type="number" class="form-control" id="min_stock" name="minimum_quantity" min="0" value="{% if product.minimum_quantity %}{{ product.minimum_quantity|unlocalize }}{% else %}0{% endif %}">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="max_stock" class="form-label">{% trans "Maximum Stock Level" %}</label>
                                        <input type="number" class="form-control" id="max_stock" name="maximum_quantity" min="0" value="{% if product.maximum_quantity %}{{ product.maximum_quantity|unlocalize }}{% else %}0{% endif %}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description and Image -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="description" class="form-label">{% trans "Description" %}</label>
                                    <textarea class="form-control" id="description" name="description" rows="4">{{ product.description|default:'' }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="image" class="form-label">{% trans "Product Image" %}</label>
                                    <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                    <small class="form-text text-muted">{% trans "Leave empty to keep current image" %}</small>
                                    {% if product.image %}
                                    <div class="mt-2">
                                        <img src="{{ product.image.url }}" alt="{% trans 'Current Product Image' %}" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                                        <p class="small text-muted mt-1">{% trans "Current Image" %}</p>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" {% if product.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="is_active">
                                            {% trans "Active" %}
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="track_stock" name="track_stock" {% if product.track_stock %}checked{% endif %}>
                                        <label class="form-check-label" for="track_stock">
                                            {% trans "Track Inventory" %}
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'products:product_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>
                                {% trans "Cancel" %}
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>
                                {% trans "Save Changes" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // حساب الضريبة عند تغيير {% trans "Price" %} أو نسبة الضريبة
    function calculateTax() {
        var sellingPrice = parseFloat($('#sale_price').val()) || 0;
        var taxRate = parseFloat($('#tax_rate').val()) || 0;
        
        if (sellingPrice > 0 && taxRate > 0) {
            var taxAmount = sellingPrice * (taxRate / 100);
            var priceWithTax = sellingPrice + taxAmount;
            
            $('#base-price').text(sellingPrice.toFixed(3));
            $('#tax-amount').text(taxAmount.toFixed(3));
            $('#price-with-tax').text(priceWithTax.toFixed(3));
            $('#tax-calculation').show();
        } else {
            $('#tax-calculation').hide();
        }
    }
    
    // إظهار/{% trans "Hide" %} حقل {% trans "Number" %} التسلسلي حسب وحدة القياس
    function toggleSerialNumberField() {
        var unit = $('#unit').val();
        var serialNumberRow = $('#serial_number_row');
        
        if (unit === 'piece') {
            serialNumberRow.show();
        } else {
            serialNumberRow.hide();
            $('#serial_number').val(''); // مسح القيمة عند ال{% trans "Hide" %}
        }
    }
    
    // إظهار/{% trans "Hide" %} حقول المخزون للمنتجات الخدمية
    function toggleInventoryFields(isService) {
        var inventorySection = $('#inventory-section');
        
        if (isService) {
            inventorySection.hide();
            // تعيين القيم إلى صفر للمنتجات الخدمية
            $('#current_stock').val(0);
            $('#min_stock').val(0);
            // تغيير وحدة القياس إلى خدمة
            $('#unit').val('service');
        } else {
            inventorySection.show();
            // إعادة تعيين وحدة القياس إلى قطعة
            if ($('#unit').val() === 'service') {
                $('#unit').val('piece');
            }
        }
        
        // تحديث حقل {% trans "Number" %} التسلسلي
        toggleSerialNumberField();
    }
    
    // حساب تكلفة الرصيد الافتتاحي تلقائياً
    function calculateOpeningBalanceCost() {
        var openingBalance = parseFloat($('#opening_balance').val()) || 0;
        var unitCost = parseFloat($('#opening_balance_unit_cost').val()) || 0;
        var costField = $('#opening_balance_cost');
        
        if (openingBalance > 0 && unitCost > 0) {
            var totalCost = openingBalance * unitCost;
            costField.val(totalCost.toFixed(3));
        } else {
            costField.val('0');
        }
    }
    
    // تبديل تفعيل حقل تكلفة الرصيد الافتتاحي
    function toggleOpeningBalanceCostField() {
        var costField = $('#opening_balance_cost');
        var hasMovements = $('#has_movements').val() === 'true';
        
        // الحقل readonly دائماً لأنه محسوب تلقائياً
        costField.prop('readonly', true);
        costField.css('background-color', '#f8f9fa');
        costField.css('cursor', 'not-allowed');
    }
    
    // تطبيق التحكم عند تحميل الصفحة وعند تغيير وحدة القياس
    $(document).ready(function() {
        // {% trans "Select" %} {% trans "Status" %} {% trans "First" %}ية بناءً على is_service
        var isService = $('#is_service').prop('checked');
        toggleInventoryFields(isService);
        
        toggleSerialNumberField();
        
        // تهيئة الرصيد الافتتاحي والمستودع
        // calculateOpeningBalanceCost(); // لا نستدعيها عند تحميل الصفحة للحفاظ على القيمة من قاعدة البيانات
        toggleOpeningBalanceWarehouse();
        toggleOpeningBalanceCostField();
        
        $('#unit').on('change', function() {
            toggleSerialNumberField();
            
            // إذا تم اختيار "خدمة" كوحدة قياس، تفعيل المنتج الخدمي
            if ($(this).val() === 'service') {
                $('#is_service').prop('checked', true);
                toggleInventoryFields(true);
            }
        });
    });
    
    // ربط الأحداث
    $('#sale_price, #tax_rate').on('input keyup', calculateTax);
    $('#opening_balance, #opening_balance_unit_cost').on('input change', calculateOpeningBalanceCost);
    
    // ربط حدث تغيير الرصيد الافتتاحي لمتطلب المستودع
    $('#opening_balance').on('input change', toggleOpeningBalanceWarehouse);
    $('#opening_balance').on('input change', toggleOpeningBalanceCostField);
    
    // حساب مبدئي عند تحميل الصفحة
    calculateTax();
    calculateOpeningBalanceCost();
    
    // تحسين تجربة المستخدم
    $('#tax_rate').on('input', function() {
        var value = parseFloat($(this).val());
        if (value > 100) {
            $(this).val(100);
            calculateTax();
        } else if (value < 0) {
            $(this).val(0);
            calculateTax();
        }
    });
    
    // تحسين التحقق من الأسعار
    $('#sale_price').on('blur', function() {
        var sellingPrice = parseFloat($(this).val()) || 0;
        var costPrice = parseFloat($('#cost_price').val()) || 0;
        
        if (costPrice > 0 && sellingPrice > 0 && sellingPrice < costPrice) {
            Swal.fire({
                icon: 'warning',
                title: '{% trans "Warning" %}',
                text: '{% trans "Sale price is less than cost price. Are you sure?" %}',
                showCancelButton: true,
                confirmButtonText: '{% trans "Yes, I am sure" %}',
                cancelButtonText: '{% trans "Edit Price" %}'
            }).then((result) => {
                if (!result.isConfirmed) {
                    $(this).focus();
                }
            });
        }
    });
    
    // تحسين تجربة المستخدم لحقل الرصيد الافتتاحي
    $('#opening_balance').on('input', function() {
        var value = parseFloat($(this).val());
        if (value < 0) {
            $(this).val(0);
        }
        
        // إعادة حساب تكلفة الرصيد الافتتاحي
        calculateOpeningBalanceCost();
        
        // تحديث متطلب مستودع الرصيد الافتتاحي
        toggleOpeningBalanceWarehouse();
    });
    
    $('#opening_balance_cost').on('input', function() {
        // منع التعديل اليدوي - الحقل للقراءة فقط
        calculateOpeningBalanceCost();
    });
    
    // تحسين التحقق من الأسعار
    $('#sale_price').on('blur', function() {
        var sellingPrice = parseFloat($(this).val()) || 0;
        var costPrice = parseFloat($('#cost_price').val()) || 0;
        
        if (costPrice > 0 && sellingPrice > 0 && sellingPrice < costPrice) {
            Swal.fire({
                icon: 'warning',
                title: '{% trans "Warning" %}',
                text: '{% trans "Sale price is less than cost price. Are you sure?" %}',
                showCancelButton: true,
                confirmButtonText: '{% trans "Yes, I am sure" %}',
                cancelButtonText: '{% trans "Edit Price" %}'
            }).then((result) => {
                if (!result.isConfirmed) {
                    $(this).focus();
                }
            });
        }
    });
});
</script>

<!-- Modal Add New Category -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalLabel">
                    <i class="fas fa-plus-circle text-primary me-2"></i>
                    {% trans "Add New Category" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="categoryName" class="form-label">{% trans "Category Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="categoryName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3 mt-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="categoryIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="categoryIsActive">
                                        {% trans "Active" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="categoryParent" class="form-label">{% trans "Parent Category" %}</label>
                                <select class="form-select" id="categoryParent" name="parent">
                                    <option value="">{% trans "No Parent Category" %}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="categoryDescription" class="form-label">{% trans "Description" %}</label>
                                <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-primary" id="saveCategoryBtn">
                    <i class="fas fa-save me-2"></i>
                    {% trans "Save Category" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// إدارة إضافة التصنيف الجديد
$(document).ready(function() {
    // فتح النافذة المنبثقة
    $('#addCategoryBtn').on('click', function() {
        $('#categoryModal').modal('show');
        loadParentCategories();
    });
    
    // تحميل {% trans "List" %} الفئات الأساسية
    function loadParentCategories() {
        $.get('{% url "products:category_add_ajax" %}', function(data) {
            var select = $('#categoryParent');
            select.empty();
            select.append('<option value="">{% trans "No Parent Category" %}</option>');
            
            if (data.categories) {
                data.categories.forEach(function(category) {
                    select.append('<option value="' + category.id + '">' + category.name + '</option>');
                });
            }
        });
    }
    
    // {% trans "Save" %} التصنيف ال{% trans "New" %}
    $('#saveCategoryBtn').on('click', function() {
        var formData = new FormData($('#categoryForm')[0]);
        
        // إظهار مؤشر التحميل
        var originalText = $(this).html();
        $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>جاري ال{% trans "Save" %}...');
        $(this).prop('disabled', true);
        
        $.ajax({
            url: '{% url "products:category_add_ajax" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // إضافة التصنيف الجديد إلى القائمة
                    var option = '<option value="' + response.category.id + '">' + response.category.name + '</option>';
                    $('#category').append(option);
                    $('#category').val(response.category.id);
                    
                    // إغلاق النافذة وإظهار رسالة نجاح
                    $('#categoryModal').modal('hide');
                    $('#categoryForm')[0].reset();
                    
                    Swal.fire({
                        icon: 'success',
                        title: '{% trans "Completed Successfully" %}!',
                        text: response.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '{% trans "Error" %}!',
                        text: response.error
                    });
                }
            },
            error: function(xhr, status, error) {
                Swal.fire({
                    icon: 'error',
                    title: '{% trans "Error" %} في الشبكة!',
                    text: 'حدث {% trans "Error" %} أثناء {% trans "Save" %} التصنيف. {% trans "Please try again" %}.'
                });
            },
            complete: function() {
                // إعادة تعيين الزر
                $('#saveCategoryBtn').html(originalText);
                $('#saveCategoryBtn').prop('disabled', false);
            }
        });
    });
    
    // مسح النموذج عند إغلاق النافذة
    $('#categoryModal').on('hidden.bs.modal', function() {
        $('#categoryForm')[0].reset();
        $('#categoryIsActive').prop('checked', true);
    });
    
    // Linked Units Control
    $('#unit_type').on('change', function() {
        const unitType = $(this).val();
        
        if (unitType === 'standalone') {
            $('#linked_product_container').hide();
            $('#conversion_factor_container').hide();
            $('#linked_product').val('');
            $('#conversion_factor').val('0');
        } else if (unitType === 'single') {
            $('#linked_product_container').show();
            $('#conversion_factor_container').hide();
            $('#conversion_factor').val('0');
        } else if (unitType === 'package') {
            $('#linked_product_container').show();
            $('#conversion_factor_container').show();
        }
    });
    
    // Initialize unit type visibility
    $('#unit_type').trigger('change');
});
</script>

{% endblock %}
