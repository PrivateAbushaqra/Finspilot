{% extends 'base.html' %}
{% load i18n %}
{% load tax_tags %}

{% block title %}{% trans "Trial Balance - Triangle" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-balance-scale me-2"></i>
        {% trans "Trial Balance" %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-outline-secondary me-2" onclick="window.print()">
            <i class="fas fa-print me-1"></i>
            {% trans "Print" %}
        </button>
        <button class="btn btn-outline-primary" onclick="exportToExcel()">
            <i class="fas fa-file-excel me-1"></i>
            {% trans "Export to Excel" %}
        </button>
    </div>
</div>

<!-- ف{% trans "No" %}تر ال{% trans "Report" %} -->
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="date_from" class="form-label">{% trans "From Date" %}</label>
                <input type="date" class="form-control" id="date_from" name="date_from" value="{{ request.GET.date_from }}">
            </div>
            <div class="col-md-3">
                <label for="date_to" class="form-label">{% trans "To Date" %}</label>
                <input type="date" class="form-control" id="date_to" name="date_to" value="{{ request.GET.date_to }}">
            </div>
            <div class="col-md-3">
                <label for="account_type" class="form-label">{% trans "Account Type" %}</label>
                <select class="form-select" id="account_type" name="account_type">
                    <option value="">{% trans "All Accounts" %}</option>
                    <option value="asset" {% if request.GET.account_type == 'asset' %}selected{% endif %}>{% trans "Assets" %}</option>
                    <option value="liability" {% if request.GET.account_type == 'liability' %}selected{% endif %}>{% trans "Liabilities" %}</option>
                    <option value="equity" {% if request.GET.account_type == 'equity' %}selected{% endif %}>{% trans "Equity" %}</option>
                    <option value="revenue" {% if request.GET.account_type == 'revenue' %}selected{% endif %}>{% trans "Revenues" %}</option>
                    <option value="expense" {% if request.GET.account_type == 'expense' %}selected{% endif %}>{% trans "Expenses" %}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>
                        {% trans "Generate Report" %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- ال{% trans "Report" %} -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-chart-bar me-2"></i>
            {% trans "Trial Balance as of" %} 
            {% if date_to %}
                {{ date_to|date:"Y-m-d" }}
            {% else %}
                {% trans "Today" %}
            {% endif %}
        </h5>
    </div>
    <div class="card-body">
        {% if trial_balance_data %}
        <div class="table-responsive">
            <table class="table table-striped" id="trialBalanceTable">
                <thead class="table-dark">
                    <tr>
                        <th>{% trans "Account Name" %}</th>
                        <th>{% trans "Account Type" %}</th>
                        <th class="text-end">{% trans "Debit Balance" %}</th>
                        <th class="text-end">{% trans "Credit Balance" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in trial_balance_data %}
                    <tr>
                        <td>{{ account.name }}</td>
                        <td>
                            {% if account.type == 'asset' %}
                                <span class="badge bg-primary">{% trans "Asset" %}</span>
                            {% elif account.type == 'liability' %}
                                <span class="badge bg-danger">{% trans "Liability" %}</span>
                            {% elif account.type == 'equity' %}
                                <span class="badge bg-info">{% trans "Equity" %}</span>
                            {% elif account.type == 'revenue' %}
                                <span class="badge bg-success">{% trans "Revenue" %}</span>
                            {% elif account.type == 'expense' %}
                                <span class="badge bg-warning">{% trans "Expense" %}</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if account.debit_balance > 0 %}
                                {{ account.debit_balance|currency_format }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% if account.credit_balance > 0 %}
                                {{ account.credit_balance|currency_format }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="2">{% trans "Total" %}</th>
                        <th class="text-end">{{ total_debits|currency_format }}</th>
                        <th class="text-end">{{ total_credits|currency_format }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- التحقق من التوازن -->
        <div class="row mt-3">
            <div class="col-md-6 offset-md-3">
                <div class="card {% if total_debits == total_credits %}border-success{% else %}border-danger{% endif %}">
                    <div class="card-body text-center">
                        {% if total_debits == total_credits %}
                            <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                            <h5 class="text-success">{% trans "Balanced" %}</h5>
                            <p class="text-muted">{% trans "Total Debit = Total Credit" %}</p>
                        {% else %}
                            <i class="fas fa-exclamation-circle text-danger fa-2x mb-2"></i>
                            <h5 class="text-danger">{% trans "Unbalanced" %}</h5>
                            <p class="text-muted">{% trans "There is a difference in the balance" %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">{% trans "No Data Found" %}</h4>
            <p class="text-muted">{% trans "No accounts or transactions in the specified period" %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- ملاحظات -->
<div class="card mt-3">
    <div class="card-body">
        <h6 class="card-title">
            <i class="fas fa-info-circle me-2"></i>
            {% trans "Important Notes" %}
        </h6>
        <ul class="mb-0">
            <li>{% trans "The trial balance shows total balances for accounts in the specified period" %}</li>
            <li>{% trans "Total Debit should equal Total Credit" %}</li>
            <li>{% trans "If unbalanced, review the accounting entries" %}</li>
            <li>{% trans "Data is updated automatically when adding new entries" %}</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function exportToExcel() {
    // {% trans "Export" %} ال{% trans "Table" %} إلى Excel
    const table = document.getElementById('trialBalanceTable');
    const wb = XLSX.utils.table_to_book(table);
    const fileName = '{% trans "Trial_Balance" %}_' + new Date().toISOString().slice(0, 10) + '.xlsx';
    XLSX.writeFile(wb, fileName);
}

// تحميل مكتبة XLSX لل{% trans "Export" %}
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
document.head.appendChild(script);
</script>
{% endblock %}
