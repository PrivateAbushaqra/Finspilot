{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block content %}
    <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        {% trans "Backup & Restore System" %}
                    </h3>
                    <div class="text-end small">
                        <div>{% trans "Total Backups" %}: <strong id="backupCount">{{ backups|length }}</strong></div>
                        {% if latest_backup %}
                        <div>{% trans "Latest Backup" %}: <strong>{{ latest_backup.created_at|date:"Y-m-d H:i" }}</strong></div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-plus-circle me-2"></i>
                                        {% trans "Create New Backup" %}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Ù†Ù…Ø§Ø°Ø¬ Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ ØªÙ†Ø³ÙŠÙ‚ -->
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>{% trans "Choose backup format" %}:</strong>
                                        {% trans "Click once on your preferred format. Each backup creates one file." %}
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-success w-100 backup-btn" data-format="json">
                                                <i class="fas fa-download me-2"></i>
                                                {% trans "JSON Backup" %}
                                                <small class="d-block mt-1">{% trans "Complete database backup" %}</small>
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-primary w-100 backup-btn" data-format="xlsx">
                                                <i class="fas fa-file-excel me-2"></i>
                                                {% trans "Excel Backup" %}
                                                <small class="d-block mt-1">{% trans "For data analysis" %}</small>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <button type="button" class="btn btn-outline-secondary btn-sm w-100" id="clearCacheBtn">
                                                <i class="fas fa-broom me-2"></i>
                                                {% trans "Clear Cache" %}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-muted small mt-2">
                                        <i class="fas fa-info-circle"></i>
                                        {% trans "JSON format for complete system backup, XLSX for data analysis" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">
                                        <i class="fas fa-upload me-2"></i>
                                        {% trans "Restore Backup" %}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="restoreUploadForm" method="post" enctype="multipart/form-data" action="{% url 'backup:restore_backup' %}">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label class="form-label">{% trans "Select backup file" %}</label>
                                            <input type="file" name="backup_file" class="form-control" accept=".json,.xlsx" required>
                                        </div>
                                        <div class="form-check mb-3">
                                            <input type="checkbox" name="clear_data" class="form-check-input" id="clearData">
                                            <label class="form-check-label text-danger" for="clearData">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                {% trans "Clear existing data before restore" %}
                                            </label>
                                        </div>
                                        <button type="submit" class="btn btn-warning w-100" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')">
                                            <i class="fas fa-undo me-2"></i>
                                            {% trans "Restore Backup" %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„ØªÙ‚Ø¯Ù… -->
                    <div class="card mb-4" id="tablesInfoCard" style="display: none;">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>
                                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØªØªØ¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="alert alert-info text-center">
                                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</strong><br>
                                        <span id="totalTables" class="h4">0</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-info text-center">
                                        <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</strong><br>
                                        <span id="totalRecords" class="h4">0</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="alert alert-success text-center">
                                        <strong>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</strong><br>
                                        <span id="estimatedTime" class="h4">Ø­Ø³Ø§Ø¨...</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù… -->
                            <div class="progress mb-3" style="height: 30px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="overallProgress" role="progressbar" style="width: 0%;" 
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>

                            <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
                            <div class="alert alert-primary" id="currentStatus">
                                <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span id="currentTableText">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...</span>
                            </div>

                            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù… -->
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„:</h6>
                                    <div id="tablesProgress" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© -->
                    <!-- Ù‚Ø³Ù… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ -->
                    {% if perms.backup.can_delete_advanced_data %}
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-trash-alt me-2"></i>
                                {% trans "Delete Data (Advanced)" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">{% trans "Select tables to delete data from. Dependent tables will be shown and cannot be deleted unless dependencies are selected as well." %}</p>
                            <div id="deletable-tables-container">
                                <div class="text-center text-muted py-3">{% trans "Loading tables..." %}</div>
                            </div>
                            <div class="mt-3">
                                <button id="deleteSelectedBtn" class="btn btn-danger">{% trans "Delete Selected Tables" %}</button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                {% trans "Existing Backups" %}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="backups-container">
                            {% if backups %}
                                <div class="table-responsive">
                                    <table class="table table-hover" id="backups-table">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>{% trans "Filename" %}</th>
                                                <th>{% trans "Size" %}</th>
                                                <th>{% trans "Created" %}</th>
                                                <th>{% trans "Type" %}</th>
                                                <th class="text-center">{% trans "Actions" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="backups-tbody">
                                            {% for backup in backups %}
                                                <tr>
                                                    <td>
                                                        <i class="fas fa-file-archive text-primary me-2"></i>
                                                        <strong>{{ backup.filename }}</strong>
                                                    </td>
                                                    <td>
                                                        {% if backup.size_formatted %}
                                                            {{ backup.size_formatted }}
                                                        {% else %}
                                                            <span class="text-muted">{% trans "Unknown" %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">
                                                            {{ backup.created_at|date:"Y-m-d H:i:s" }}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        {% if backup.filename|slice:"-5:" == ".json" %}
                                                            <span class="badge bg-success">JSON</span>
                                                        {% elif backup.filename|slice:"-5:" == ".xlsx" %}
                                                            <span class="badge bg-primary">XLSX</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">{% trans "Unknown" %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="btn-group" role="group">
                                                            <!-- ØªØ­Ù…ÙŠÙ„ -->
                                                            <a href="{% url 'backup:download_backup' backup.filename %}" 
                                                               class="btn btn-sm btn-outline-primary" 
                                                               title="{% trans 'Download' %}">
                                                                <i class="fas fa-download"></i>
                                                            </a>
                                                            
                                                            <!-- Ø§Ø³ØªØ¹Ø§Ø¯Ø© -->
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-outline-warning restore-btn" 
                                                                    data-filename="{{ backup.filename }}" 
                                                                    title="{% trans 'Restore' %}">
                                                                <i class="fas fa-undo"></i>
                                                            </button>
                                                            
                                                            <!-- Ø­Ø°Ù -->
                                                            {% if perms.backup.delete_backup %}
                                                                <button type="button" 
                                                                        class="btn btn-sm btn-outline-danger delete-btn" 
                                                                        data-filename="{{ backup.filename }}" 
                                                                        onclick="handleDeleteClick(this)"
                                                                        title="{% trans 'Delete' %}">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-5" id="no-backups-message">
                                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                                    <h5>{% trans "No backups found" %}</h5>
                                    <p>{% trans "Create your first backup using the form above" %}</p>
                                </div>
                            {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© -->
<div class="modal fade" id="restoreModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-undo me-2"></i>
                    {% trans "Restore Backup" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Are you sure you want to restore this backup?" %}</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>{% trans "Warning:" %}</strong>
                    {% trans "This action will replace existing data and cannot be undone!" %}
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="modalClearExisting">
                    <label class="form-check-label text-danger" for="modalClearExisting">
                        {% trans "Clear existing data before restore" %}
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-warning" id="confirmRestore">
                    <i class="fas fa-undo me-2"></i>
                    {% trans "Restore" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('ğŸ”§ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ');

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function refreshBackupsList() {
    fetch('{% url "backup:list_backups" %}')
    .then(function(response) {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©');
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            updateBackupsTable(data.backups);
            updateBackupCount(data.total);
        } else {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø®:', data.error);
        }
    })
    .catch(function(error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:', error);
        // Ø¹Ø¯Ù… Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ù†Ø§ Ø­ØªÙ‰ Ù„Ø§ Ù†Ø²Ø¹Ø¬Ù‡
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function updateBackupsTable(backups) {
    var container = document.getElementById('backups-container');
    var tbody = document.getElementById('backups-tbody');
    
    if (backups.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5" id="no-backups-message">
                <i class="fas fa-folder-open fa-3x mb-3"></i>
                <h5>{% trans "No backups found" %}</h5>
                <p>{% trans "Create your first backup using the form above" %}</p>
            </div>
        `;
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
    if (!tbody) {
        container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover" id="backups-table">
                    <thead class="table-dark">
                        <tr>
                            <th>{% trans "Filename" %}</th>
                            <th>{% trans "Size" %}</th>
                            <th>{% trans "Created" %}</th>
                            <th>{% trans "Type" %}</th>
                            <th class="text-center">{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody id="backups-tbody">
                    </tbody>
                </table>
            </div>
        `;
        tbody = document.getElementById('backups-tbody');
    }
    
    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    tbody.innerHTML = backups.map(function(backup) {
        var typeClass = backup.type === 'JSON' ? 'success' : 'primary';
        var typeIcon = backup.type === 'JSON' ? 'code' : 'file-excel';
        
        return `
            <tr>
                <td>
                    <i class="fas fa-file-archive text-primary me-2"></i>
                    <strong>${backup.filename}</strong>
                </td>
                <td>${backup.size_formatted}</td>
                <td>
                    <small class="text-muted">${backup.created_at}</small>
                </td>
                <td>
                    <span class="badge bg-${typeClass}">${backup.type}</span>
                </td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <a href="${backup.download_url}" 
                           class="btn btn-sm btn-outline-primary" 
                           title="{% trans 'Download' %}">
                            <i class="fas fa-download"></i>
                        </a>
                        <button type="button" 
                                class="btn btn-sm btn-outline-warning restore-btn" 
                                data-filename="${backup.filename}" 
                                title="{% trans 'Restore' %}">
                            <i class="fas fa-undo"></i>
                        </button>
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger delete-btn" 
                                data-filename="${backup.filename}" 
                                onclick="handleDeleteClick(this)"
                                title="{% trans 'Delete' %}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
    initializeRestoreButtons();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø³Ø®
function updateBackupCount(count) {
    var countElement = document.getElementById('backupCount');
    if (countElement) {
        countElement.textContent = count;
    }
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù€ AJAX
// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
var backupInterval = null;
var restoreInterval = null;
var tablesInfo = [];

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
function loadTablesInfo() {
    fetch('{% url "backup:backup_tables" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© JSON ÙˆÙ„ÙŠØ³ HTML
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© - Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            tablesInfo = data.tables;
            updateTablesDisplay(data);
        } else {
            throw new Error(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„');
        }
    })
    .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„:', error);
        alert('Ø®Ø·Ø£: ' + error.message + '\nÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰');
        // Ø¥Ø®ÙØ§Ø¡ Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        document.getElementById('tablesInfoCard').style.display = 'none';
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
function updateTablesDisplay(data) {
    document.getElementById('totalTables').textContent = data.total_tables;
    document.getElementById('totalRecords').textContent = data.total_records.toLocaleString();
    
    var tablesContainer = document.getElementById('tablesProgress');
    var html = '';
    
    data.tables.forEach(function(table, index) {
        html += `
            <div class="card mb-2" id="table-${index}">
                <div class="card-body p-2">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <strong>${table.display_name}</strong>
                            <br><small class="text-muted">${table.app_name}.${table.model_name}</small>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge bg-info">${table.record_count} Ø³Ø¬Ù„</span>
                        </div>
                        <div class="col-md-3">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" id="progress-${index}" 
                                     style="width: 0%;" aria-valuenow="0" 
                                     aria-valuemin="0" aria-valuemax="100">
                                    0%
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="badge bg-secondary" id="status-${index}">Ù…Ù†ØªØ¸Ø±</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    tablesContainer.innerHTML = html;
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
function updateTablesProgress(progressData) {
    if (progressData.tables_status && Array.isArray(progressData.tables_status)) {
        progressData.tables_status.forEach(function(table, index) {
            var progressBar = document.getElementById('progress-' + index);
            var statusBadge = document.getElementById('status-' + index);
            
            if (progressBar && statusBadge) {
                var progress = table.progress || 0;
                progressBar.style.width = progress + '%';
                progressBar.textContent = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                
                // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
                if (table.status === 'processing') {
                    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
                    statusBadge.className = 'badge bg-primary';
                    statusBadge.textContent = 'Ù…Ø¹Ø§Ù„Ø¬Ø©...';
                } else if (table.status === 'completed') {
                    progressBar.className = 'progress-bar bg-success';
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Ù…ÙƒØªÙ…Ù„';
                } else if (table.status === 'error') {
                    progressBar.className = 'progress-bar bg-danger';
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.textContent = 'Ø®Ø·Ø£';
                } else {
                    progressBar.className = 'progress-bar bg-secondary';
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.textContent = 'Ù…Ù†ØªØ¸Ø±';
                }
            }
        });
    }
}

// Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
function startRestoreProgressMonitoring() {
    if (restoreInterval) {
        clearInterval(restoreInterval);
    }
    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·Ù‡Ø§
    document.getElementById('tablesInfoCard').style.display = 'block';
    // Ù„Ø§ Ù†Ø¹Ø±Ù Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©Ø› Ø³Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª progress
    restoreInterval = setInterval(function() {
        fetch('{% url "backup:restore_progress" %}', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            const ct = r.headers.get('content-type');
            if (!ct || !ct.includes('application/json')) throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©');
            return r.json();
        })
        .then(data => {
            if (data.success && data.progress) {
                const p = data.progress;
                // Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¥Ù† Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø±Ø³ÙˆÙ…Ø©ØŒ Ø§Ø±Ø³Ù…Ù‡Ø§ Ù…Ù† tables_status
                if (p.tables_status && Array.isArray(p.tables_status)) {
                    const tables = p.tables_status.map(t => ({
                        app_name: t.app_name,
                        model_name: t.model_name,
                        display_name: t.display_name || (t.app_name + '.' + t.model_name),
                        record_count: t.record_count || 0,
                        status: t.status || 'pending',
                        progress: t.progress || 0
                    }));
                    updateTablesDisplay({ total_tables: tables.length, total_records: (p.total_records||0), tables });
                }
                updateBackupProgress(p);
                if (!p.is_running) {
                    clearInterval(restoreInterval);
                    restoreInterval = null;
                    if (p.status === 'completed') {
                        setTimeout(() => alert('âœ… ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­'), 500);
                    } else if (p.status === 'error') {
                        setTimeout(() => alert('âŒ Ø®Ø·Ø£: ' + (p.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£')), 500);
                    }
                }
            }
        })
        .catch(err => {
            console.warn('Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:', err);
            clearInterval(restoreInterval);
            restoreInterval = null;
        });
    }, 1000);
}

// ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°
function checkRestoreInProgress() {
    fetch('{% url "backup:restore_progress" %}', {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const ct = r.headers.get('content-type');
        if (!ct || !ct.includes('application/json')) throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©');
        return r.json();
    })
    .then(data => {
        if (data.success && data.progress && data.progress.is_running) {
            // Ø£Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ù† ØªÙˆÙØ±Øª ÙˆØ£Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
            const p = data.progress;
            if (p.tables_status && Array.isArray(p.tables_status)) {
                const tables = p.tables_status.map(t => ({
                    app_name: t.app_name,
                    model_name: t.model_name,
                    display_name: t.display_name || (t.app_name + '.' + t.model_name),
                    record_count: t.record_count || 0,
                    status: t.status || 'pending',
                    progress: t.progress || 0
                }));
                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ±Ø³Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                document.getElementById('tablesInfoCard').style.display = 'block';
                updateTablesDisplay({ total_tables: tables.length, total_records: (p.total_records||0), tables });
            }
            startRestoreProgressMonitoring();
        }
    })
    .catch(() => {});
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
function enableAllBackupButtons() {
    var buttons = document.querySelectorAll('.backup-btn');
    buttons.forEach(function(btn) {
        btn.disabled = false;
        btn.classList.remove('btn-secondary');
        btn.classList.add(btn.dataset.format === 'json' ? 'btn-primary' : 'btn-success');
        btn.innerHTML = btn.innerHTML.replace('Ø¬Ø§Ø±ÙŠ...', btn.dataset.format === 'json' ? 'JSON' : 'Excel');
    });
}

function createBackup(format) {
    var button = document.querySelector('.backup-btn[data-format="' + format + '"]');
    if (!button) return;
    
    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
    if (button.disabled) {
        return;
    }
    
    // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ù…Ù†Ø¹ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
    document.querySelectorAll('.backup-btn').forEach(btn => {
        btn.disabled = true;
        if (btn === button) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
        } else {
            btn.innerHTML = '<i class="fas fa-ban me-2"></i>Ù…Ù†ØªØ¸Ø±...';
        }
    });
    
    var originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';
    
    var csrf = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrf) {
        alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† - ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©');
        button.disabled = false;
        button.innerHTML = originalContent;
        return;
    }
    
    // ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    fetch('{% url "backup:backup_tables" %}', {
        method: 'HEAD',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
        document.getElementById('tablesInfoCard').style.display = 'block';
        loadTablesInfo();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚Ø¯Ù…
        var overallProgress = document.getElementById('overallProgress');
        var progressText = document.getElementById('progressText');
        overallProgress.style.width = '0%';
        overallProgress.setAttribute('aria-valuenow', 0);
        progressText.textContent = '0%';
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
        var formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrf.value);
        formData.append('format', format);
        
        return fetch('{% url "backup:create_backup" %}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
    })
    .then(function(response) {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
            startProgressMonitoring();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
            var checkInterval = setInterval(function() {
                refreshBackupsList();
            }, 2000);
            
            // ØªÙˆÙ‚Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©
            setTimeout(function() {
                clearInterval(checkInterval);
            }, 60000);
            
        } else {
            throw new Error(data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
        }
    })
    .catch(function(error) {
        alert('âŒ Ø®Ø·Ø£: ' + error.message);
        document.getElementById('tablesInfoCard').style.display = 'none';
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        enableAllBackupButtons();
    })
    .finally(function() {
        button.disabled = false;
        button.innerHTML = originalContent;
    });
}

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ØªÙ‚Ø¯Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
function startProgressMonitoring() {
    if (backupInterval) {
        clearInterval(backupInterval);
    }
    
    backupInterval = setInterval(function() {
        fetch('{% url "backup:backup_progress" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.progress) {
                updateBackupProgress(data.progress);
                
                // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŒ Ø£ÙˆÙ‚Ù Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
                if (!data.progress.is_running) {
                    clearInterval(backupInterval);
                    backupInterval = null;
                    
                    if (data.progress.status === 'completed') {
                        setTimeout(() => {
                            alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
                            refreshBackupsList();
                            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                            enableAllBackupButtons();
                        }, 1000);
                    } else if (data.progress.status === 'error') {
                        alert('âŒ Ø®Ø·Ø£: ' + (data.progress.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                        enableAllBackupButtons();
                    }
                }
            } else if (!data.success) {
                throw new Error(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø¯Ù…');
            }
        })
        .catch(error => {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
            clearInterval(backupInterval);
            backupInterval = null;
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
            enableAllBackupButtons();
        });
    }, 1000); // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…
function updateBackupProgress(progressData) {
    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…
    var overallProgress = document.getElementById('overallProgress');
    var progressText = document.getElementById('progressText');
    var percentage = progressData.percentage || 0;
    
    overallProgress.style.width = percentage + '%';
    overallProgress.setAttribute('aria-valuenow', percentage);
    progressText.textContent = percentage + '%';
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ
    var currentTableText = document.getElementById('currentTableText');
    if (progressData.current_table) {
        currentTableText.textContent = progressData.current_table;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
    var estimatedTime = document.getElementById('estimatedTime');
    if (progressData.estimated_time) {
        estimatedTime.textContent = progressData.estimated_time;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
    if (progressData.processed_tables !== undefined) {
        document.getElementById('totalTables').textContent = progressData.processed_tables + ' / ' + (progressData.total_tables || 0);
    }
    
    if (progressData.processed_records !== undefined) {
        document.getElementById('totalRecords').textContent = progressData.processed_records.toLocaleString() + ' / ' + ((progressData.total_records || 0)).toLocaleString();
    }
    
    // ØªØ­Ø¯ÙŠØ« ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙØ±Ø¯ÙŠØ©
    updateTablesProgress(progressData);
    
    // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    if (progressData.status === 'completed') {
        overallProgress.className = 'progress-bar bg-success';
        currentTableText.textContent = 'ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù†Ø¬Ø§Ø­!';
    } else if (progressData.status === 'error') {
        overallProgress.className = 'progress-bar bg-danger';
        currentTableText.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ';
    } else if (progressData.status === 'processing') {
        overallProgress.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙˆØ­ÙŠØ¯Ø©
function handleDeleteClick(button) {
    console.log('ğŸ—‘ï¸ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø°Ù');
    
    var filename = button.getAttribute('data-filename');
    if (!filename) {
        alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù');
        return;
    }
    
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: ' + filename + 'ØŸ\n\nâš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
        return;
    }
    
    var csrf = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrf) {
        alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù†');
        return;
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø²Ø±
    var originalContent = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Ø¥Ù†Ø´Ø§Ø¡ URL Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø­Ø°Ù
    var deleteUrl = '{% url "backup:delete_backup" "PLACEHOLDER" %}'.replace('PLACEHOLDER', filename);
    
    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrf.value,
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        credentials: 'same-origin'
    })
    .then(function(response) {
        if (!response.ok) {
            throw new Error('HTTP ' + response.status);
        }
        
        var contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„ÙŠØ³Øª JSON ØµØ§Ù„Ø­');
        }
        
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù†Ø´Ø·Ø©!');
            refreshBackupsList(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
        } else {
            throw new Error(data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
        }
    })
    .catch(function(error) {
        console.error('ğŸ’¥ Ø®Ø·Ø£:', error);
        alert('âŒ Ø®Ø·Ø£: ' + error.message);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        button.disabled = false;
        button.innerHTML = originalContent;
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
function initializeRestoreButtons() {
    var restoreButtons = document.querySelectorAll('.restore-btn');
    restoreButtons.forEach(function(btn) {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
        btn.replaceWith(btn.cloneNode(true));
    });
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
    document.querySelectorAll('.restore-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var filename = this.getAttribute('data-filename');
            selectedFilename = filename;
            var modal = new bootstrap.Modal(document.getElementById('restoreModal'));
            modal.show();
        });
    });
}

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
var selectedFilename = '';

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ');
    
    // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    document.querySelectorAll('.backup-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var format = this.getAttribute('data-format');
            createBackup(format);
        });
    });
    
    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´
    var clearCacheBtn = document.getElementById('clearCacheBtn');
    if (clearCacheBtn) {
        clearCacheBtn.addEventListener('click', function() {
            clearBackupCache();
        });
    }
    
    // ØªÙØ¹ÙŠÙ„ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    initializeRestoreButtons();
    // ØªÙ‡ÙŠØ¦Ø© Ø±Ø¨Ø· Ø¥Ø¯Ø§Ø±Ø© Ø­Ø°Ù Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    try { initDeletableBindings(); } catch(e){ console.warn('initDeletableBindings not ready', e); }
    
    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
    var confirmRestoreBtn = document.getElementById('confirmRestore');
    if (confirmRestoreBtn) {
        confirmRestoreBtn.addEventListener('click', function() {
            if (!selectedFilename) return;
            
            var clearData = document.getElementById('modalClearExisting').checked;
            // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± AJAX Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ©
            fetch('{% url "backup:restore_backup" %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ filename: selectedFilename, clear_data: clearData ? 'true' : 'false' }).toString()
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙˆØ§Ø¨Ø¯Ø£ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù…
                    const modalEl = document.getElementById('restoreModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                    startRestoreProgressMonitoring();
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ' + (data.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            })
            .catch(err => {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message);
            });
        });
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠ - Ù…Ø¹ ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    setTimeout(function() {
        // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        checkAuthenticationAndLoadData();
    // ÙØ­Øµ Ø¥Ù† ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
    checkRestoreInProgress();
    }, 500);
});

// Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function checkAuthenticationAndLoadData() {
    // ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    fetch('{% url "backup:list_backups" %}', {
        method: 'HEAD', // Ø§Ø³ØªØ®Ø¯Ø§Ù… HEAD Ù„Ù„ÙØ­Øµ ÙÙ‚Ø· Ø¯ÙˆÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (response.ok) {
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            refreshBackupsList();
        } else if (response.status === 401 || response.status === 403) {
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
            console.log('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - ØªØ®Ø·ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        } else {
            console.warn('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', response.status);
        }
    })
    .catch(error => {
        console.warn('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
    });
}

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
// Ø¯Ø§Ù„Ø© Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´
function clearBackupCache() {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ ÙƒØ§Ø´ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØŸ\nØ³ÙŠØ¤Ø¯ÙŠ Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„.')) {
        return;
    }
    
    var btn = document.getElementById('clearCacheBtn');
    var originalText = btn.innerHTML;
    
    // ØªØ¹Ø¯ÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø³Ø­...';
    
    fetch('{% url "backup:clear_backup_cache" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø¹ÙƒØ³ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            setTimeout(function() {
                location.reload();
            }, 1000);
        } else {
            showMessage('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´: ' + (data.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
        }
    })
    .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´:', error);
        showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
    })
    .finally(() => {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø±
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

window.handleDeleteClick = handleDeleteClick;
// ØªØ¹Ø±ÙŠÙ Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø­Ø°Ù Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)
function loadDeletableTables() {
    fetch('{% url "backup:deletable_tables" %}', {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        var container = document.getElementById('deletable-tables-container');
        if (!container) return;
        if (!data.success) {
            container.innerHTML = '<div class="text-danger">{% trans "Failed to load tables" %}</div>';
            return;
        }
        var html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th></th><th>{% trans "Table" %}</th><th>{% trans "Records" %}</th><th>{% trans "Dependents" %}</th><th>{% trans "Safe to delete" %}</th></tr></thead><tbody>';
        data.tables.forEach(function(t){
            var deps = (t.dependents && t.dependents.length) ? t.dependents.join(', ') : '-';
            var hasDeps = (t.dependents && t.dependents.length);
            var note = hasDeps ? '{% trans "Has dependents" %}' : '';
            // attach dependents as JSON in data-deps so client-side can auto-select them
            var depsJson = JSON.stringify(t.dependents || []);
            var rowClass = hasDeps ? 'has-deps' : '';
            html += `<tr class="${rowClass}"><td><input type="checkbox" class="del-table-checkbox" data-label="${t.label}" data-deps='${depsJson}'></td><td>${t.display_name}<br><small class="text-muted">${t.label}</small></td><td>${t.record_count}</td><td><small class="text-muted">${deps}</small></td><td>${note}</td></tr>`;
        });
    html += '</tbody></table></div>';
    container.innerHTML = html;
    // Ø¨Ø¹Ø¯ Ø¥Ø¯Ø±Ø§Ø¬ HTMLØŒ Ø§Ø±Ø¨Ø· Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
    try { attachDependencyHandlers(); } catch(e) { console.warn('attachDependencyHandlers error', e); }
    })
    .catch(err => {
        console.error('Error loading deletable tables', err);
        var container = document.getElementById('deletable-tables-container');
        if (container) container.innerHTML = '<div class="text-danger">{% trans "Error loading deletable tables" %}</div>';
    });
}

// Ø±Ø¨Ø· Ø­Ø¯Ø« ØªØºÙŠÙ‘Ø± checkbox Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
function attachDependencyHandlers() {
    var container = document.getElementById('deletable-tables-container');
    if (!container) return;

    // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬ Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆÙØ¬Ø¯
    if (container._depDelegatedHandler) {
        container.removeEventListener('change', container._depDelegatedHandler);
        container._depDelegatedHandler = null;
    }

    // Ù…ÙÙˆØ¶: ÙŠØ³ØªÙ…Ø¹ Ù„ØªØºÙŠÙ‘Ø± Ø£ÙŠ checkbox Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    var delegated = function(e) {
        var cb = e.target;
        if (!cb || !cb.classList || !cb.classList.contains('del-table-checkbox')) return;

        var checked = cb.checked;
        var deps;
        try { deps = JSON.parse(cb.dataset.deps || '[]'); } catch(err) { deps = []; }

        // Ù„ÙƒÙ„ ØªØ¨Ø¹ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©: Ø­Ø¯Ù‘Ø¯Ù‡Ø§ Ø£Ùˆ Ø£Ù„ØºÙ ØªØ­Ø¯ÙŠØ¯Ù‡Ø§ Ø¨Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© cb
        deps.forEach(function(dep){
            var target = document.querySelector('.del-table-checkbox[data-label="' + dep + '"]');
            if (!target || target.disabled) return;
            if (target.checked === checked) return;
            target.checked = checked;
            // Ø¯ÙÙ’Ø¹ Ø­Ø¯Ø« change Ù„ÙŠØªÙˆØ³Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
            var ev;
            try { ev = new Event('change', { bubbles: true }); }
            catch(e) { ev = document.createEvent('HTMLEvents'); ev.initEvent('change', true, false); }
            target.dispatchEvent(ev);
        });
    };

    container.addEventListener('change', delegated);
    container._depDelegatedHandler = delegated;
}

// ØªÙ‡ÙŠØ¦Ø© Ø±Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø­Ø°Ù Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ±Ø¨Ø· Ø²Ø± Ø§Ù„Ø­Ø°Ù
function initDeletableBindings() {
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    loadDeletableTables();

    var deleteBtn = document.getElementById('deleteSelectedBtn');
    if (!deleteBtn) return;

        deleteBtn.addEventListener('click', function() {
        var checkboxes = Array.from(document.querySelectorAll('.del-table-checkbox'));

        // Ø¨Ù†Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ù„ØµÙ‚ -> ØªØ¨Ø¹ÙŠØ§Øª Ù…Ù† DOM
        var labelToDeps = {};
        checkboxes.forEach(function(cb){
            try { labelToDeps[cb.dataset.label] = JSON.parse(cb.dataset.deps || '[]'); }
            catch(e) { labelToDeps[cb.dataset.label] = []; }
        });

        // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ØªÙŠ Ø§Ø®ØªØ§Ø±Ù‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ (ØªÙ„Ùƒ Ø§Ù„Ù…ÙØ¹Ù„Ù‘Ù…Ø©)
        var initialSelected = checkboxes.filter(function(cb){ return cb.checked; }).map(function(cb){ return cb.dataset.label; });

        if (!initialSelected || initialSelected.length === 0) {
            alert('{% trans "Please select at least one table to delete" %}');
            return;
        }

        // ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„ØªØ´Ù…Ù„ ÙƒÙ„ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„Ø© (closure)
        var closure = new Set();
        function addWithDeps(label){
            if (!label || closure.has(label)) return;
            closure.add(label);
            var deps = labelToDeps[label] || [];
            deps.forEach(function(d){ addWithDeps(d); });
        }
        initialSelected.forEach(function(l){ addWithDeps(l); });

        var selected = Array.from(closure);

        if (!confirm('{% trans "Are you sure you want to delete the selected tables? This action cannot be undone." %}')) {
            return;
        }

        var csrf = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrf) {
            alert('{% trans "CSRF token missing. Please reload the page." %}');
            return;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø°Ù
        fetch('{% url "backup:delete_tables" %}', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrf.value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ tables: selected, confirm: true })
        })
        .then(function(resp){
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            var ct = resp.headers.get('content-type') || '';
            if (!ct.includes('application/json')) throw new Error('Non-JSON response');
            return resp.json();
        })
        .then(function(data){
            if (data.success) {
                var msg = '{% trans "Selected tables deleted successfully" %}';
                if (data.audit_reassign_notifications && data.audit_reassign_notifications.length) {
                    data.audit_reassign_notifications.forEach(function(n){
                        msg += '\n- ' + (n.reassigned_count || 0) + ' {% trans "audit entries reassigned to" %} ' + n.fallback + ' ({% trans "table" %}: ' + n.table + ')';
                    });
                }
                alert(msg);
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                loadDeletableTables();
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø® Ø¥Ù† Ù„Ø²Ù…
                refreshBackupsList();
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ Ø§Ø­ØªØ§Ø¬
            } else {
                if (data.details) {
                    alert('{% trans "Cannot delete; blocked by dependencies:" %} ' + JSON.stringify(data.details));
                } else {
                    alert('{% trans "Error:" %} ' + (data.error || 'Unknown'));
                }
            }
        })
        .catch(function(err){
            console.error('Delete tables error', err);
            alert('{% trans "Error deleting tables:" %} ' + err.message);
        });
    });
}

// Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
    document.querySelectorAll('.backup-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            var format = this.getAttribute('data-format');
            createBackup(format);
        });
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    refreshBackupsList();

    // Ø§Ø¹ØªØ±Ø§Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
    var restoreForm = document.getElementById('restoreUploadForm');
    if (restoreForm) {
        restoreForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var fileInput = restoreForm.querySelector('input[name="backup_file"]');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
                return;
            }
            var formData = new FormData(restoreForm);
            fetch(restoreForm.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
                    document.getElementById('tablesInfoCard').style.display = 'block';
                    startRestoreProgressMonitoring();
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©: ' + (data.error || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            })
            .catch(err => {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message);
            });
        });
    }
});

console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
</script>
{% endblock %}
