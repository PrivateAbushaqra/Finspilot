{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}
{% load humanize %}


{% block title %}{% trans "Bank Transfers" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .transfers-container {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .transfers-header {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .transfer-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .transfer-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .transfer-amount {
        font-size: 1.2rem;
        font-weight: bold;
        color: #28a745;
    }
    
    .transfer-fees {
        color: #dc3545;
        font-size: 0.9rem;
    }
    
    .transfer-date {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .btn-add {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    
    .btn-add:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .account-badge {
        background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .transfer-arrow {
        color: #28a745;
        font-size: 1.5rem;
    }
    
    .btn-group-actions {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
    }
    
    .btn-action {
        min-width: 90px;
        font-size: 0.8rem;
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        margin: 2px;
    }
    
    @media (max-width: 768px) {
        .btn-action span {
            display: inline !important;
        }
        .btn-action {
            min-width: 80px;
            font-size: 0.75rem;
        }
    }
    
    /* Print Styles - Enhanced for table system */
    @media print {
        .print-controls,
        .btn,
        .navbar,
        .sidebar,
        .breadcrumb,
        .transfers-header .col-md-6:last-child,
        .input-group,
        .form-select,
        .empty-state,
        .btn-group-actions,
        .no-print {
            display: none !important;
        }
        
        .container-fluid {
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
        }
        
        body {
            font-size: 8pt !important;
            color: #000 !important;
            line-height: 1.1 !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #000 !important;
            page-break-after: avoid;
            text-align: center !important;
            font-size: 12pt !important;
            margin-bottom: 15px !important;
        }
        
        /* Create table header */
        #transfersList::before {
            content: "{% trans 'Transfer Number' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Date' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'From' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'To' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Amount' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Fees' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Type' %}";
            display: block;
            background-color: #f8f9fa !important;
            border: 2px solid #000 !important;
            padding: 8px !important;
            font-weight: bold !important;
            text-align: center !important;
            font-size: 9pt !important;
            border-bottom: 2px solid #000 !important;
        }
        
        /* Convert each transfer to table row */
        .transfer-card {
            display: block !important;
            border: 1px solid #000 !important;
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
            page-break-inside: avoid !important;
            box-shadow: none !important;
        }
        
        .transfer-card .card-body {
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .transfer-card .row {
            display: table-row !important;
            margin: 0 !important;
            border-bottom: 1px solid #ddd !important;
        }
        
        .transfer-card .col-md-3,
        .transfer-card .col-md-2,
        .transfer-card .col-md-1 {
            display: table-cell !important;
            border-right: 1px solid #ddd !important;
            padding: 4px 2px !important;
            vertical-align: middle !important;
            font-size: 7pt !important;
            width: auto !important;
            float: none !important;
        }
        
        /* Hide actions column */
        .transfer-card .col-md-3:last-child,
        .transfer-card .col-md-2:last-child {
            display: none !important;
        }
        
        /* Customize column view */
        .transfer-card .col-md-2:nth-child(1) { width: 15% !important; }  /* {% trans "Transfer Number" %} */
        .transfer-card .col-md-2:nth-child(2) { width: 12% !important; }  /* {% trans "Date" %} */
        .transfer-card .col-md-3:nth-child(3) { width: 25% !important; }  /* {% trans 'From' %} */
        .transfer-card .col-md-3:nth-child(4) { width: 25% !important; }  /* {% trans 'To' %} */
        .transfer-card .col-md-2:nth-child(5) { width: 13% !important; }  /* {% trans "Amount" %} */
        .transfer-card .col-md-1:nth-child(6) { width: 10% !important; }  /* Fees or Type */
        
        /* Text formatting */
        .transfer-card h6 {
            font-size: 7pt !important;
            margin: 0 !important;
            font-weight: bold !important;
        }
        
        .transfer-card small {
            font-size: 6pt !important;
            display: block !important;
        }
        
        .transfer-card .fw-bold {
            font-size: 7pt !important;
            font-weight: bold !important;
        }
        
        .transfer-amount {
            color: #000 !important;
            font-size: 7pt !important;
            font-weight: bold !important;
        }
        
        .transfer-fees {
            color: #000 !important;
            font-size: 6pt !important;
        }
        
        .transfer-date {
            color: #000 !important;
            font-size: 6pt !important;
        }
        
        .badge {
            color: black !important;
            border: 1px solid black !important;
            background-color: white !important;
            font-size: 6pt !important;
            padding: 1px 3px !important;
        }
        
        .text-primary, .text-success, .text-danger, .text-warning, .text-info {
            color: #000 !important;
        }
        
        /* Page settings for print view */
        @page {
            size: A4 landscape !important;
            margin: 0.5cm !important;
        }
        
        /* Hide unnecessary sub-elements */
        .transfer-arrow {
            display: none !important;
        }
        
        /* Improve account data view */
        .account-info {
            font-size: 6pt !important;
            line-height: 1.0 !important;
        }
        
        /* Prevent row breaks */
        .transfer-card {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }
        
        .page-break {
            page-break-before: always;
        }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-exchange-alt text-info me-2"></i>
                        {% trans "Bank Transfers" %}
                    </h1>
                    <nav aria-label="breadcrumb" class="mt-2">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">{% trans "Dashboard" %}</a></li>
                            <li class="breadcrumb-item active">{% trans "Bank Transfers" %}</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="printPage()">
                            <i class="fas fa-print me-2"></i>
                            {% trans "Print Full Report" %}
                        </button>
                        {% if perms.banks.add_banktransfer %}
                        <a href="{% url 'banks:transfer_add' %}" class="btn btn-add text-white">
                            <i class="fas fa-plus me-1"></i>
                            {% trans "Add New Transfer" %}
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Transfers Container -->
            <div class="transfers-container">
                <div class="transfers-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                {% trans "Bank Transfers List" %}
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <span class="me-3">
                                    <i class="fas fa-chart-line me-1"></i>
                                    {% trans "Total Transfers" %}: <strong>{{ total_transfers|default:0 }}</strong>
                                </span>
                                <div class="btn-group">
                                    {% if perms.banks.add_banktransfer %}
                                    <a href="{% url 'banks:transfer_add' %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-university me-1"></i>
                                        {% trans "Bank Transfer" %}
                                    </a>
                                    {% endif %}
                                    {% if perms.cashboxes.add_cashboxtransfer or perms.banks.add_banktransfer %}
                                    <a href="{% url 'banks:bank_cashbox_transfer_add' %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-money-check me-1"></i>
                                        {% trans "Bank/Cashbox Transfer" %}
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    <!-- Search and Filter Bar -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" placeholder="{% trans 'Search in transfers...' %}" id="searchTransfers">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="filterAccount">
                                <option value="">{% trans "All Accounts" %}</option>
                                <option value="1">{% trans "Main Current Account" %}</option>
                                <option value="2">{% trans "Savings Account" %}</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <span class="input-group-text">{% trans "From" %}</span>
                                <input type="date" class="form-control" id="dateFrom">
                                <span class="input-group-text">{% trans "To" %}</span>
                                <input type="date" class="form-control" id="dateTo">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary me-2" onclick="filterTransfers()">
                                <i class="fas fa-filter me-1"></i>
                                {% trans "Filter" %}
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>
                                {% trans "Reset" %}
                            </button>
                        </div>
                    </div>
                    
                    <!-- Transfers List -->
                    <div id="transfersList">
                        {% if bank_transfers or bank_cashbox_transfers %}
                            <div class="table-responsive">
                                <table class="table table-bordered" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>{% trans "Transfer Number" %}</th>
                                            <th>{% trans "Date" %}</th>
                                            <th>{% trans "From Account" %}</th>
                                            <th>{% trans "To Account" %}</th>
                                            <th>{% trans "Amount" %}</th>
                                            <th>{% trans "Journal Entry" %}</th>
                                            <th>{% trans "Created By" %}</th>
                                            <th>{% trans "Actions" %}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Bank to Bank Transfers -->
                                        {% for item in bank_transfers %}
                                        {% with transfer=item.transfer journal_entry=item.journal_entry %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'banks:transfer_detail' transfer.id %}" class="text-decoration-none">
                                                    <strong>{{ transfer.transfer_number }}</strong>
                                                </a>
                                                <br>
                                                <small class="badge bg-primary">{% trans "Bank Transfer" %}</small>
                                            </td>
                                            <td>{{ transfer.date|date:"j/n/Y" }}</td>
                                            <td>
                                                <strong>{{ transfer.from_account.name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ transfer.from_account.bank_name }}</small>
                                                {% if transfer.from_account.account_number %}
                                                <br>
                                                <small class="text-muted">{% trans "Account" %}: {{ transfer.from_account.account_number }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong>{{ transfer.to_account.name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ transfer.to_account.bank_name }}</small>
                                                {% if transfer.to_account.account_number %}
                                                <br>
                                                <small class="text-muted">{% trans "Account" %}: {{ transfer.to_account.account_number }}</small>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <strong>{{ transfer.amount|floatformat:3 }} {% get_currency_symbol %}</strong>
                                                {% if transfer.fees > 0 %}
                                                    <br>
                                                    <small class="text-danger">{% trans "Fees" %}: {{ transfer.fees|floatformat:3 }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if journal_entry %}
                                                    <a href="{% url 'journal:entry_detail' journal_entry.pk %}" class="text-decoration-none">
                                                        <strong>{{ journal_entry.entry_number }}</strong>
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ transfer.created_by.get_full_name|default:transfer.created_by.username }}</td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-info" title="{% trans "Print" %}" onclick="printTransferDetail('{{ transfer.transfer_number }}', 'bank')">
                                                        <i class="fas fa-print"></i>
                                                    </button>
                                                    <a href="{% url 'banks:transfer_detail' transfer.id %}" class="btn btn-sm btn-outline-primary" title="{% trans "View Details" %}">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if perms.banks.change_banktransfer %}
                                                    <a href="{% url 'banks:transfer_edit' transfer.id %}" class="btn btn-sm btn-outline-warning" title="{% trans "Edit" %}">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% endif %}
                                                    {% if perms.banks.delete_banktransfer %}
                                                    <button class="btn btn-sm btn-outline-danger" title="{% trans "Delete" %}" onclick="confirmDeleteTransfer('{{ transfer.id }}', '{{ transfer.transfer_number }}', 'bank')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endwith %}
                                        {% endfor %}
                                        
                                        <!-- Bank to Cashbox / Cashbox to Bank Transfers -->
                                        {% for item in bank_cashbox_transfers %}
                                        {% with transfer=item.transfer journal_entry=item.journal_entry %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'banks:cashbox_transfer_detail' transfer.id %}" class="text-decoration-none">
                                                    <strong>{{ transfer.transfer_number }}</strong>
                                                </a>
                                                <br>
                                                <small class="badge {% if transfer.transfer_type == 'bank_to_cashbox' %}bg-success{% else %}bg-warning{% endif %}">
                                                    {% if transfer.transfer_type == 'bank_to_cashbox' %}{% trans "Bank" %} → {% trans "Cashbox" %}{% else %}{% trans "Cashbox" %} → {% trans "Bank" %}{% endif %}
                                                </small>
                                            </td>
                                            <td>{{ transfer.date|date:"j/n/Y" }}</td>
                                            <td>
                                                {% if transfer.transfer_type == 'bank_to_cashbox' %}
                                                    <strong>{{ transfer.from_bank.name }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ transfer.from_bank.bank_name }}</small>
                                                    {% if transfer.from_bank.account_number %}
                                                    <br>
                                                    <small class="text-muted">{% trans "Account" %}: {{ transfer.from_bank.account_number }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <strong>{{ transfer.from_cashbox.name }}</strong>
                                                    <br>
                                                    <small class="text-muted">{% trans "Cashbox" %}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if transfer.transfer_type == 'bank_to_cashbox' %}
                                                    <strong>{{ transfer.to_cashbox.name }}</strong>
                                                    <br>
                                                    <small class="text-muted">{% trans "Cashbox" %}</small>
                                                {% else %}
                                                    <strong>{{ transfer.to_bank.name }}</strong>
                                                    <br>
                                                    <small class="text-muted">{{ transfer.to_bank.bank_name }}</small>
                                                    {% if transfer.to_bank.account_number %}
                                                    <br>
                                                    <small class="text-muted">{% trans "Account" %}: {{ transfer.to_bank.account_number }}</small>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                <strong>{{ transfer.amount|floatformat:3 }} {% get_currency_symbol %}</strong>
                                                {% if transfer.fees > 0 %}
                                                    <br>
                                                    <small class="text-danger">{% trans "Fees" %}: {{ transfer.fees|floatformat:3 }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if journal_entry %}
                                                    <a href="{% url 'journal:entry_detail' journal_entry.pk %}" class="text-decoration-none">
                                                        <strong>{{ journal_entry.entry_number }}</strong>
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ transfer.created_by.get_full_name|default:transfer.created_by.username }}</td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-info" title="{% trans "Print" %}" onclick="printTransferDetail('{{ transfer.transfer_number }}', 'cashbox')">
                                                        <i class="fas fa-print"></i>
                                                    </button>
                                                    <a href="{% url 'banks:cashbox_transfer_detail' transfer.id %}" class="btn btn-sm btn-outline-primary" title="{% trans "View Details" %}">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if perms.cashboxes.change_cashboxtransfer %}
                                                    <a href="{% url 'banks:cashbox_transfer_edit' transfer.id %}" class="btn btn-sm btn-outline-warning" title="{% trans "Edit" %}">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% endif %}
                                                    {% if perms.cashboxes.delete_cashboxtransfer %}
                                                    <button class="btn btn-sm btn-outline-danger" title="{% trans "Delete" %}" onclick="confirmDeleteTransfer('{{ transfer.id }}', '{{ transfer.transfer_number }}', 'cashbox')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endwith %}
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-dark">
                                            <td colspan="4" class="text-center fw-bold">{% trans "Total" %}</td>
                                            <td class="text-end fw-bold">
                                                {{ total_amounts|floatformat:3|intcomma }} {% get_currency_symbol %}
                                            </td>
                                            <td colspan="3"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        {% else %}
                            <!-- Empty State -->
                            <div class="empty-state">
                                <i class="fas fa-exchange-alt"></i>
                                <h5>{% trans "No bank transfers yet" %}</h5>
                                <p class="mb-3">{% trans "Start by adding a new bank transfer between your accounts or between banks and cashboxes" %}</p>
                                <div class="d-flex justify-content-center gap-2">
                                    {% if perms.banks.add_banktransfer %}
                                    <a href="{% url 'banks:transfer_add' %}" class="btn btn-add text-white">
                                        <i class="fas fa-university me-1"></i>
                                        {% trans "Transfer Between Banks" %}
                                    </a>
                                    {% endif %}
                                    {% if perms.cashboxes.add_cashboxtransfer or perms.banks.add_banktransfer %}
                                    <a href="{% url 'banks:bank_cashbox_transfer_add' %}" class="btn btn-success">
                                        <i class="fas fa-money-check me-1"></i>
                                        {% trans "Bank/Cashbox Transfer" %}
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Total Transfers" %}</h6>
                                    <h3 class="mb-0">{{ total_transfers|default:0 }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-exchange-alt fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Total Amount" %}</h6>
                                    <h3 class="mb-0">{{ total_amounts|default:0|floatformat:3 }}</h3>
                                    <small>{% get_currency_symbol %}</small>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-money-bill-wave fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Total Fees" %}</h6>
                                    <h3 class="mb-0">{{ total_fees|default:0|floatformat:3 }}</h3>
                                    <small>{% get_currency_symbol %}</small>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-receipt fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "This Month" %}</h6>
                                    <h3 class="mb-0">{{ this_month_transfers|default:0 }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-calendar-alt fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default date range (current month)
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
    document.getElementById('dateTo').value = lastDay.toISOString().split('T')[0];
});

function filterTransfers() {
    // This will be implemented when we have actual data
    console.log('Filtering transfers...');
    
    const searchTerm = document.getElementById('searchTransfers').value;
    const selectedAccount = document.getElementById('filterAccount').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    // Show loading state
    const transfersList = document.getElementById('transfersList');
    transfersList.innerHTML = '<div class="text-center p-4"><i class="fas fa-spinner fa-spin fa-2x"></i><br>{% trans "Searching..." %}</div>';
    
    // Simulate API call
    setTimeout(() => {
        transfersList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h5>{% trans "No search results found" %}</h5>
                <p class="mb-3">{% trans "Try changing search criteria" %}</p>
            </div>
        `;
    }, 1000);
}

function resetFilters() {
    document.getElementById('searchTransfers').value = '';
    document.getElementById('filterAccount').selectedIndex = 0;
    
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    document.getElementById('dateFrom').value = firstDay.toISOString().split('T')[0];
    document.getElementById('dateTo').value = lastDay.toISOString().split('T')[0];
    
    filterTransfers();
}

// Delete confirmation
document.addEventListener('click', function(e) {
    if (e.target.closest('.btn-outline-danger')) {
        if (!confirm('{% trans "Are you sure you want to delete this transfer?" %}\n\n{% trans "The transfer will be canceled and the affected account balances will be updated." %}')) {
            e.preventDefault();
        }
    }
});

// Print functionality - convert cards to table for printing
function printPage() {
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    
    // Get current date and time
    const now = new Date();
    const dateString = now.toLocaleDateString('ar-SA');
    const timeString = now.toLocaleTimeString('ar-SA');
    
    // Build the printable content
    let printContent = `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{% trans "Bank Transfers Report" %}</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin: 20px;
                    direction: rtl;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 20px;
                }
                .header h1 {
                    color: #333;
                    margin: 0;
                    font-size: 24px;
                }
                .header p {
                    color: #666;
                    margin: 5px 0;
                    font-size: 14px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                    font-size: 12px;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: right;
                }
                th {
                    background-color: #f8f9fa;
                    font-weight: bold;
                    color: #333;
                }
                tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .transfer-amount {
                    color: #28a745;
                    font-weight: bold;
                }
                .transfer-fees {
                    color: #dc3545;
                    font-size: 10px;
                }
                .summary {
                    margin-top: 30px;
                    padding: 15px;
                    background-color: #f8f9fa;
                    border-radius: 5px;
                }
                .summary h3 {
                    margin: 0 0 10px 0;
                    color: #333;
                }
                .summary-row {
                    display: flex;
                    justify-content: space-around;
                    margin-bottom: 10px;
                }
                .summary-item {
                    text-align: center;
                }
                .summary-value {
                    font-size: 18px;
                    font-weight: bold;
                    color: #007bff;
                }
                .footer {
                    margin-top: 50px;
                    text-align: center;
                    font-size: 14px;
                    color: #666;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                }
                @media print {
                    body { margin: 0; }
                    .header { page-break-after: avoid; }
                    table { page-break-inside: auto; }
                    tr { page-break-inside: avoid; page-break-after: auto; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>{% trans "Bank Transfers Report" %}</h1>
                <p>{% trans "Generated on" %}: ${dateString} {% trans "at" %} ${timeString}</p>
                <p>{% trans "Total Transfers" %}: {{ total_transfers|default:0 }}</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>{% trans "Transfer Number" %}</th>
                        <th>{% trans "Date" %}</th>
                        <th>{% trans "From Account" %}</th>
                        <th>{% trans "To Account" %}</th>
                        <th>{% trans "Amount" %}</th>
                        <th>{% trans "Journal Entry" %}</th>
                        <th>{% trans "Created By" %}</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Get all table rows and convert to printable rows
    const tableRows = document.querySelectorAll('#transfersList table tbody tr');
    tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) {  // Ensure we have enough cells
            const transferNumber = cells[0]?.textContent?.trim() || '';
            const transferDate = cells[1]?.textContent?.trim() || '';
            const fromAccount = cells[2]?.textContent?.trim() || '';
            const toAccount = cells[3]?.textContent?.trim() || '';
            const amount = cells[4]?.textContent?.trim() || '0.000';
            const journalEntry = cells[5]?.textContent?.trim() || '';
            const createdBy = cells[6]?.textContent?.trim() || '';
            
            printContent += `
                <tr>
                    <td>${transferNumber}</td>
                    <td>${transferDate}</td>
                    <td>${fromAccount}</td>
                    <td>${toAccount}</td>
                    <td class="transfer-amount">${amount}</td>
                    <td>${journalEntry}</td>
                    <td>${createdBy}</td>
                </tr>
            `;
        }
    });
    
    printContent += `
                </tbody>
            </table>
            
            <div class="summary">
                <h3>{% trans "Summary" %}</h3>
                <div class="summary-row">
                    <div class="summary-item">
                        <div>{% trans "Total Transfers" %}</div>
                        <div class="summary-value">{{ total_transfers|default:0 }}</div>
                    </div>
                    <div class="summary-item">
                        <div>{% trans "Bank Transfers" %}</div>
                        <div class="summary-value">{{ bank_transfers|length }}</div>
                    </div>
                    <div class="summary-item">
                        <div>{% trans "Cashbox Transfers" %}</div>
                        <div class="summary-value">{{ bank_cashbox_transfers|length }}</div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p class="text-center">{% trans "FinsPilot Software" %}</p>
            </div>
        </body>
        </html>
    `;
    
    // Write content to print window
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Wait for content to load then print
    printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
    };
}

// Print Function
window.printTransferReport = function() {
    console.log('{% trans "Starting to print bank transfers report..." %}');
    
    let transferHTML = `
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1>{% trans "Bank Transfers Report" %}</h1>
            <p>{% trans "Report Date" %}: ${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}</p>
        </div>
        <table class="print-table">
            <thead>
                <tr>
                    <th>{% trans "Transfer Number" %}</th>
                    <th>{% trans "Date" %}</th>
                    <th>{% trans "From Account" %}</th>
                    <th>{% trans "To Account" %}</th>
                    <th>{% trans "Amount" %}</th>
                    <th>{% trans "Fees" %}</th>
                    <th>{% trans "Description" %}</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    // Get transfer data from the page
    const transferCards = document.querySelectorAll('.transfer-card:not(.d-none)');
    console.log('Number of existing transfer cards:', transferCards.length);
    
    if (transferCards.length === 0) {
        transferHTML += `
            <tr>
                <td colspan="7" style="text-align: center; padding: 20px;">{% trans "No transfers to print" %}</td>
            </tr>
        `;
    } else {
        transferCards.forEach((card) => {
            try {
                const transferNumber = card.querySelector('.fw-bold')?.textContent.trim() || 'Not specified';
                const transferDate = card.querySelector('.transfer-date')?.textContent.trim() || 'Not specified';
                const fromAccount = card.querySelectorAll('.account-badge')[0]?.textContent.trim() || 'Not specified';
                const toAccount = card.querySelectorAll('.account-badge')[1]?.textContent.trim() || 'Not specified';
                const amount = card.querySelector('.transfer-amount')?.textContent.trim() || '0';
                const fees = card.querySelector('.transfer-fees')?.textContent.replace('{% trans "Fees" %}: ', '').trim() || '0';
                const description = card.querySelector('.text-muted')?.textContent.trim() || 'No description';
                
                console.log('Transfer data:', {transferNumber, transferDate, fromAccount, toAccount, amount, fees, description});
                
                transferHTML += `
                    <tr>
                        <td>${transferNumber}</td>
                        <td>${transferDate}</td>
                        <td>${fromAccount}</td>
                        <td>${toAccount}</td>
                        <td>${amount}</td>
                        <td>${fees}</td>
                        <td>${description}</td>
                    </tr>
                `;
            } catch (error) {
                console.warn('Error processing transfer card:', error);
            }
        });
    }
    
    transferHTML += `
            </tbody>
        </table>
    `;
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>{% trans "Bank Transfers Report" %}</title>
                <meta charset="UTF-8">
                <style>
                    body { font-family: Arial, sans-serif; direction: rtl; }
                    .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: right; }
                    .print-table th { background-color: #f5f5f5; font-weight: bold; }
                    h1 { text-align: center; margin-bottom: 20px; }
                    p { text-align: center; margin-bottom: 20px; }
                </style>
            </head>
            <body>
                ${transferHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
    printWindow.close();
}

// Print single transfer detail function
function printTransferDetail(transferNumber, transferType) {
    console.log(`{% trans "Print Transfer Details" %}: ${transferNumber} {% trans "of type" %}: ${transferType}`);
    
    // Find the transfer card
    const transferCards = document.querySelectorAll('.transfer-card');
    let transferCard = null;
    
    for (let card of transferCards) {
        const cardNumber = card.querySelector('.fw-bold')?.textContent.trim();
        if (cardNumber === transferNumber) {
            transferCard = card;
            break;
        }
    }
    
    if (!transferCard) {
        alert('Transfer data not found for printing');
        return;
    }
    
    try {
        const transferDate = transferCard.querySelector('.transfer-date')?.textContent.trim() || 'Not specified';
        const accountBadges = transferCard.querySelectorAll('.account-badge');
        const fromAccount = accountBadges[0]?.textContent.trim() || 'Not specified';
        const toAccount = accountBadges[1]?.textContent.trim() || 'Not specified';
        const amount = transferCard.querySelector('.transfer-amount')?.textContent.trim() || '0';
        const feesElement = transferCard.querySelector('.transfer-fees');
        const fees = feesElement ? feesElement.textContent.replace('{% trans "Fees" %}: ', '').trim() : '0';
        
        // Search for description in comment element
        const commentElement = transferCard.querySelector('.text-muted');
        let description = 'No description';
        if (commentElement) {
            const commentText = commentElement.textContent.trim();
            // Remove text that starts with comment icon
            description = commentText.replace(/^\s*.*?:\s*/, '').trim() || 'No description';
        }
        
        const badge = transferCard.querySelector('.badge')?.textContent.trim() || '';
        
        const transferHTML = `
            <div style="text-align: center; margin-bottom: 2rem; border-bottom: 2px solid #000; padding-bottom: 1rem;">
                <h1>{% trans "Voucher" %} {% trans "Transfer" %}</h1>
                <h2>{% trans "Transfer Number" %}: ${transferNumber}</h2>
                <p>{% trans "Date" %}: ${transferDate}</p>
                <p>{% trans "Transfer Type" %}: ${badge}</p>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
                    <tr>
                        <td style="border: 1px solid #000; padding: 10px; font-weight: bold; background-color: #f5f5f5;">{% trans "From Account" %}:</td>
                        <td style="border: 1px solid #000; padding: 10px;">${fromAccount}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 10px; font-weight: bold; background-color: #f5f5f5;">{% trans "To Account" %}:</td>
                        <td style="border: 1px solid #000; padding: 10px;">${toAccount}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 10px; font-weight: bold; background-color: #f5f5f5;">{% trans "Transfer Amount" %}:</td>
                        <td style="border: 1px solid #000; padding: 10px; font-size: 1.2rem; color: #28a745;">${amount}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 10px; font-weight: bold; background-color: #f5f5f5;">{% trans "Fees" %}:</td>
                        <td style="border: 1px solid #000; padding: 10px; color: #dc3545;">${fees}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 10px; font-weight: bold; background-color: #f5f5f5;">{% trans "Description" %}:</td>
                        <td style="border: 1px solid #000; padding: 10px;">${description}</td>
                    </tr>
                </table>
            </div>
            
            <div style="margin-top: 3rem; display: flex; justify-content: space-between;">
                <div style="text-align: center; border-top: 1px solid #000; padding-top: 10px; width: 200px;">
                    <p>{% trans "Accountant Signature" %}</p>
                </div>
                <div style="text-align: center; border-top: 1px solid #000; padding-top: 10px; width: 200px;">
                    <p>{% trans "Manager Signature" %}</p>
                </div>
            </div>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>{% trans "Bank Transfers Report" %}</title>
                    <meta charset="UTF-8">
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            direction: rtl; 
                            margin: 20px;
                            font-size: 14px;
                        }
                        h1, h2 { text-align: center; margin-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        td { border: 1px solid #000; padding: 8px; text-align: right; }
                        .signature-area { margin-top: 50px; }
                        @media print {
                            body { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    ${transferHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        
        // Add short delay before printing to ensure content loading
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 500);
        
    } catch (error) {
        console.error('Error in printing transfer:', error);
        alert('An error occurred while setting up printing');
    }
}

// Delete confirmation function
function confirmDeleteTransfer(transferId, transferNumber, transferType) {
    if (confirm(`{% trans "Are you sure you want to delete transfer number" %} "${transferNumber}"?\n\n{% trans "Warning: This action cannot be undone and will affect balances!" %}`)) {
        deleteTransfer(transferId, transferType);
    }
}

// Delete transfer function
function deleteTransfer(transferId, transferType) {
    // Get CSRF token from the meta tag or hidden input
    let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!csrfToken) {
        csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    }
    if (!csrfToken) {
        csrfToken = '{{ csrf_token }}';
    }
    
    let deleteUrl;
    if (transferType === 'bank') {
        deleteUrl = `{% url 'banks:transfer_delete' 0 %}`.replace('0', transferId);
    } else if (transferType === 'cashbox') {
        deleteUrl = `{% url 'banks:cashbox_transfer_delete' 0 %}`.replace('0', transferId);
    }
    
    // Show loading state
    const loadingElement = document.createElement('div');
    loadingElement.innerHTML = `
        <div class="d-flex justify-content-center align-items-center p-4">
            <div class="spinner-border text-danger me-2" role="status">
                <span class="visually-hidden">{% trans "Deleting..." %}</span>
            </div>
            <span>{% trans "Deleting transfer..." %}</span>
        </div>
    `;
    document.getElementById('transfersList').appendChild(loadingElement);
    
    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (response.ok) {
            // Reload the page to reflect changes
            window.location.reload();
        } else {
            throw new Error('Failed to delete transfer');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{% trans "An error occurred while deleting the transfer. Please try again." %}');
        loadingElement.remove();
    });
}
</script>

<!-- CSRF Token for AJAX requests -->
<form style="display: none;">
    {% csrf_token %}
</form>
{% endblock %}
