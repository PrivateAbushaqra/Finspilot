{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}
{% load l10n %}

{% block title %}{% trans "Transfer" %} {% trans "Between Bank and Cashbox" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .transfer-container {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .transfer-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .form-section {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #f8f9fa;
    }
    
    .section-title {
        color: #495057;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .balance-info {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        border-radius: 6px;
        padding: 0.75rem;
        margin-top: 0.5rem;
    }
    
    .balance-amount {
        font-weight: bold;
        color: #1976d2;
    }
    
    .btn-submit {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        color: white;
    }
    
    .transfer-preview {
        background: #fff3cd;
        border: 1px solid #ffeeba;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .arrow-icon {
        font-size: 2rem;
        color: #28a745;
    }
    
    .check-section {
        background: #e8f5e8;
        border: 1px solid #c3e6c3;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    /* Print Styles */
    @media print {
        .btn,
        .navbar,
        .sidebar,
        nav,
        .breadcrumb,
        .transfer-header .col-md-6:last-child,
        .print-hide {
            display: none !important;
        }
        
        .container-fluid {
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
        }
        
        .transfer-container {
            box-shadow: none !important;
            border-radius: 0 !important;
        }
        
        .transfer-header {
            background: #f8f9fa !important;
            color: #000 !important;
            border-bottom: 2px solid #000 !important;
        }
        
        .form-section {
            border: 1px solid #000 !important;
            break-inside: avoid;
        }
        
        body {
            font-size: 12px !important;
            color: #000 !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #000 !important;
        }
        
        .form-control {
            border: 1px solid #000 !important;
            background: transparent !important;
        }
        
        .page-break {
            page-break-before: always;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="transfer-container">
                <div class="transfer-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="fas fa-exchange-alt me-2"></i>
                                {% trans "Transfer" %} {% trans "Between Bank and Cashbox" %}
                            </h4>
                            <p class="mb-0 mt-2 opacity-75">{% trans "Create" %} {% trans "Transfer" %} {% trans "New" %} {% trans "Between Bank Account and Cashboxes" %}</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-outline-light me-2" onclick="printTransferForm()">
                                <i class="fas fa-print me-1"></i>
                                {% trans "Print" %} {% trans "Form" %}
                            </button>
                            <a href="{% url 'banks:transfer_list' %}" class="btn btn-light">
                                <i class="fas fa-arrow-right me-1"></i>
                                {% trans "Back to" %} {% trans "List" %}
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" id="transferForm">
                        {% csrf_token %}
                        
                        <!-- {% trans "Information" %} ال{% trans "Transfer" %} الأساسية -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-info-circle me-2"></i>
                                {% trans "Information" %} {% trans "Transfer" %} {% trans "Basic" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="transfer_number" class="form-label">{% trans "Transfer" %} {% trans "Number" %}</label>
                                    <input type="text" class="form-control" id="transfer_number" 
                                           {% if transfer_sequence %}value="{{ transfer_sequence.get_formatted_number }}"{% endif %}
                                           readonly style="background-color: #e9ecef;">
                                    <div class="form-text">{% trans "Generated automatically from the sequencing system" %}</div>
                                </div>
                                
                                <div class="col-md-3">
                                    <label for="date" class="form-label">{% trans "Transfer" %} {% trans "Date" %} <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="date" name="date" required>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="transfer_type" class="form-label">{% trans "Transfer" %} {% trans "Type" %} <span class="text-danger">*</span></label>
                                    <select class="form-select" id="transfer_type" name="transfer_type" required>
                                        <option value="">{% trans "Choose" %} {% trans "Transfer" %} {% trans "Type" %}</option>
                                        <option value="bank_to_cashbox">{% trans "From Bank to Cashbox" %}</option>
                                        <option value="cashbox_to_bank">{% trans "From Cashbox to Bank" %}</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- اختيار البنك والصندوق -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-university me-2"></i>
                                {% trans "Choose Bank and Cashbox" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="bank" class="form-label">{% trans "Bank Account" %} <span class="text-danger">*</span></label>
                                    <select class="form-select" id="bank" name="bank" required>
                                        <option value="">{% trans "Choose Bank Account" %}</option>
                                        {% for bank in banks %}
                                            <option value="{{ bank.id }}" data-balance="{{ bank.balance|default_if_none:0|unlocalize }}" data-currency="{{ bank.currency|default:'JOD' }}" data-bank-name="{{ bank.bank_name }}">
                                                {{ bank.name }} ({{ bank.bank_name }}) - {{ bank.account_number }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div id="bankBalance" class="balance-info d-none">
                                        <i class="fas fa-wallet me-1"></i>
                                        {% trans "Current" %} {% trans "Balance" %}: <span class="balance-amount"></span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <label for="cashbox" class="form-label">{% trans "Cashbox" %} <span class="text-danger">*</span></label>
                                    <select class="form-select" id="cashbox" name="cashbox" required>
                                        <option value="">{% trans "Choose Cashbox" %}</option>
                                        {% for cashbox in cashboxes %}
                                            <option value="{{ cashbox.id }}" data-balance="{{ cashbox.balance|default_if_none:0|unlocalize }}" data-currency="{{ cashbox.currency|default:'JOD' }}">
                                                {{ cashbox.name }}
                                                {% if cashbox.location %} - {{ cashbox.location }}{% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div id="cashboxBalance" class="balance-info d-none">
                                        <i class="fas fa-cash-register me-1"></i>
                                        {% trans "Current" %} {% trans "Balance" %}: <span class="balance-amount"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- {% trans "Information" %} {% trans "Check" %} -->
                        <div class="form-section check-section">
                            <h5 class="section-title">
                                <i class="fas fa-money-check me-2"></i>
                                {% trans "Information" %} {% trans "Bank Check" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="check_number" class="form-label">{% trans "Check Number" %} <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="check_number" name="check_number" required>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="check_date" class="form-label">{% trans "Check Date" %} <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="check_date" name="check_date" required>
                                </div>
                                
                                <div class="col-md-4" style="display: none;">
                                    <label for="check_bank_name" class="form-label">{% trans "Bank Name for Check" %} <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="check_bank_name" name="check_bank_name" required readonly>
                                    <div class="form-text text-muted">{% trans "Filled automatically based on the selected bank account" %}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- {% trans "Amounts" %} -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-dollar-sign me-2"></i>
                                {% trans "Details" %} {% trans "Amounts" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="amount" class="form-label">{% trans "Transfer" %} {% trans "Amount" %} <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="amount" name="amount" 
                                               step="0.001" min="0.001" required>
                                        <span class="input-group-text">{{ base_currency.symbol|default:"ر.أ" }}</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="fees" class="form-label">{% trans "Transfer" %} {% trans "Fees" %}</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="fees" name="fees" 
                                               step="0.001" min="0" value="0">
                                        <span class="input-group-text">{{ base_currency.symbol|default:"ر.أ" }}</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="exchange_rate" class="form-label">{% trans "Exchange Rate" %}</label>
                                    <input type="number" class="form-control" id="exchange_rate" name="exchange_rate" 
                                           step="0.0001" min="0.0001" value="1">
                                    <div class="form-text">1.0000 {% trans "for the same currency" %}</div>
                                </div>
                            </div>
                            
                            <div class="transfer-preview d-none" id="transferPreview">
                                <div class="row align-items-center">
                                    <div class="col-md-4 text-center">
                                        <strong id="fromAccount">{% trans "Sender" %}</strong>
                                        <div class="text-muted">{% trans "Amount" %} {% trans "Deducted" %}: <span id="deductedAmount">0.000</span></div>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <i class="fas fa-arrow-right arrow-icon"></i>
                                    </div>
                                    <div class="col-md-4 text-center">
                                        <strong id="toAccount">{% trans "Receiver" %}</strong>
                                        <div class="text-muted">{% trans "Amount" %} {% trans "Added" %}: <span id="addedAmount">0.000</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- {% trans "Description" %} -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-comment me-2"></i>
                                {% trans "Description" %} {% trans "and Notes" %}
                            </h5>
                            
                            <div class="row">
                                <div class="col-12">
                                    <label for="description" class="form-label">{% trans "Transfer" %} {% trans "Description" %} <span class="text-danger">*</span></label>
                                    <textarea class="form-control" id="description" name="description" rows="3" required
                                              placeholder="{% trans "Enter a detailed description of the reason for the Transfer" %}..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- {% trans "Action Buttons" %} -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-submit me-3">
                                <i class="fas fa-save me-1"></i>
                                {% trans "Create" %} {% trans "Transfer" %}
                            </button>
                            <a href="{% url 'banks:transfer_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>
                                {% trans "Cancel" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // وظيفة لملء اسم البنك للشيك تلقائياً
    function updateCheckBankName() {
        const bankSelect = document.getElementById('bank');
        const checkBankNameInput = document.getElementById('check_bank_name');
        const selectedOption = bankSelect.options[bankSelect.selectedIndex];
        
        if (selectedOption.value) {
            const bankName = selectedOption.dataset.bankName;
            if (bankName) {
                checkBankNameInput.value = bankName;
            }
        } else {
            checkBankNameInput.value = '';
        }
    }
    
    // تعيين تاريخ {% trans "Today" %} كقيمة افتراضية
    const dateInput = document.getElementById('date');
    const checkDateInput = document.getElementById('check_date');
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    checkDateInput.value = today;
    
    // تحديث اسم البنك للشيك في حالة وجود قيمة محددة مسبقاً
    updateCheckBankName();
    
    // {% trans "View" %} أرصدة الحسابات
    const bankSelect = document.getElementById('bank');
    const cashboxSelect = document.getElementById('cashbox');
    const bankBalanceDiv = document.getElementById('bankBalance');
    const cashboxBalanceDiv = document.getElementById('cashboxBalance');
    
    bankSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (selectedOption.value) {
            const balance = selectedOption.dataset.balance;
            const currency = selectedOption.dataset.currency;
            
            // {% trans "Improve Balance View to avoid precision loss and handle Empty values" %}
            let formattedBalance = '0.000';
            if (balance && balance !== 'None' && balance !== 'null') {
                const parsedBalance = parseFloat(balance);
                if (!isNaN(parsedBalance)) {
                    formattedBalance = parsedBalance.toFixed(3);
                }
            }
            bankBalanceDiv.querySelector('.balance-amount').textContent = 
                formattedBalance + ' ' + (currency || 'JOD');
            bankBalanceDiv.classList.remove('d-none');
        } else {
            bankBalanceDiv.classList.add('d-none');
        }
        
        // {% trans "Update check bank name" %}
        updateCheckBankName();
        updatePreview();
    });
    
    cashboxSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const balance = selectedOption.dataset.balance;
            const currency = selectedOption.dataset.currency;
            
            // {% trans "Improve Balance View to avoid precision loss and handle Empty values" %}
            let formattedBalance = '0.000';
            if (balance && balance !== 'None' && balance !== 'null') {
                const parsedBalance = parseFloat(balance);
                if (!isNaN(parsedBalance)) {
                    formattedBalance = parsedBalance.toFixed(3);
                }
            }
            cashboxBalanceDiv.querySelector('.balance-amount').textContent = 
                formattedBalance + ' ' + (currency || 'JOD');
            cashboxBalanceDiv.classList.remove('d-none');
        } else {
            cashboxBalanceDiv.classList.add('d-none');
        }
        updatePreview();
    });
    
    // {% trans "Update Transfer Preview" %}
    function updatePreview() {
        const transferType = document.getElementById('transfer_type').value;
        const bankOption = bankSelect.options[bankSelect.selectedIndex];
        const cashboxOption = cashboxSelect.options[cashboxSelect.selectedIndex];
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const fees = parseFloat(document.getElementById('fees').value) || 0;
        const exchangeRate = parseFloat(document.getElementById('exchange_rate').value) || 1;
        
        if (transferType && bankOption.value && cashboxOption.value && amount > 0) {
            const preview = document.getElementById('transferPreview');
            const fromAccount = document.getElementById('fromAccount');
            const toAccount = document.getElementById('toAccount');
            const deductedAmount = document.getElementById('deductedAmount');
            const addedAmount = document.getElementById('addedAmount');
            
            if (transferType === 'bank_to_cashbox') {
                fromAccount.textContent = bankOption.text.split(' (')[0];
                toAccount.textContent = cashboxOption.text.split(' -')[0];
                deductedAmount.textContent = (amount + fees).toFixed(3);
                addedAmount.textContent = (amount * exchangeRate).toFixed(3);
            } else {
                fromAccount.textContent = cashboxOption.text.split(' -')[0];
                toAccount.textContent = bankOption.text.split(' (')[0];
                deductedAmount.textContent = (amount + fees).toFixed(3);
                addedAmount.textContent = (amount * exchangeRate).toFixed(3);
            }
            
            preview.classList.remove('d-none');
        } else {
            document.getElementById('transferPreview').classList.add('d-none');
        }
    }
    
    // {% trans "Bind events to update preview" %}
    document.getElementById('transfer_type').addEventListener('change', function() {
        updatePreview();
        updateCheckBankName();
    });
    document.getElementById('amount').addEventListener('input', updatePreview);
    document.getElementById('fees').addEventListener('input', updatePreview);
    document.getElementById('exchange_rate').addEventListener('input', updatePreview);
    
    // {% trans "Validate form before submission" %}
    document.getElementById('transferForm').addEventListener('submit', function(e) {
        // {% trans "Prevent duplicate submission" %}
        if (this.getAttribute('data-submitting') === 'true') {
            e.preventDefault();
            return false;
        }
        
        const transferType = document.getElementById('transfer_type').value;
        const bankSelect = document.getElementById('bank');
        const cashboxSelect = document.getElementById('cashbox');
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const fees = parseFloat(document.getElementById('fees').value) || 0;
        
        // {% trans "Check that all required fields are filled" %}
        if (!transferType) {
            e.preventDefault();
            alert('{% trans "Please choose Transfer type" %}');
            return false;
        }
        
        if (!bankSelect.value) {
            e.preventDefault();
            alert('{% trans "Please choose bank account" %}');
            return false;
        }
        
        if (!cashboxSelect.value) {
            e.preventDefault();
            alert('{% trans "Please choose cashbox" %}');
            return false;
        }
        
        if (amount <= 0) {
            e.preventDefault();
            alert('{% trans "Please enter a valid amount greater than zero" %}');
            return false;
        }
        
        // {% trans "Check that the check bank name has been filled" %}
        const checkBankName = document.getElementById('check_bank_name').value.trim();
        if (!checkBankName) {
            e.preventDefault();
            alert('{% trans "Bank name for check is required. Please choose bank account first." %}');
            return false;
        }
        
        // {% trans "Check sufficient Balance" %}
        let sourceBalance = 0;
        let sourceName = '';
        
        if (transferType === 'bank_to_cashbox') {
            const selectedBank = bankSelect.options[bankSelect.selectedIndex];
            if (selectedBank && selectedBank.value) {
                const balanceValue = selectedBank.dataset.balance;
                sourceBalance = parseFloat(balanceValue) || 0;
                sourceName = selectedBank.text.split(' (')[0].trim();
            }
        } else if (transferType === 'cashbox_to_bank') {
            const selectedCashbox = cashboxSelect.options[cashboxSelect.selectedIndex];
            if (selectedCashbox && selectedCashbox.value) {
                const balanceValue = selectedCashbox.dataset.balance;
                sourceBalance = parseFloat(balanceValue) || 0;
                sourceName = selectedCashbox.text.split(' -')[0].trim();
            }
        }
        
        const totalRequired = amount + fees;
        
        // {% trans "Check that source is specified and Balance is valid" %}
        if (!sourceName) {
            e.preventDefault();
            alert('{% trans "Please choose Transfer source first" %}');
            return false;
        }
        
        // {% trans "Check that Balance is a valid number (can be zero)" %}
        if (isNaN(sourceBalance)) {
            e.preventDefault();
            alert('{% trans "Error" %} {% trans "in reading source Balance. Please try again." %}');
            return false;
        }
        
        if (totalRequired > sourceBalance) {
            e.preventDefault();
            alert(`{% trans "Balance" %} ${sourceName} {% trans "insufficient!" %}\n{% trans "Current Balance" %}: ${sourceBalance.toFixed(3)}\n{% trans "Required Amount" %}: ${totalRequired.toFixed(3)}`);
            return false;
        }
        
        // {% trans "Set submission state to prevent duplicate submission" %}
        this.setAttribute('data-submitting', 'true');
        
        // {% trans "Disable submit button" %}
        const submitButton = this.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> {% trans "Sending..." %}';
        }
        
        // {% trans "Re-enable form after 10 seconds in case of Failed submission" %}
        setTimeout(() => {
            this.setAttribute('data-submitting', 'false');
            if (submitButton) {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-save me-1"></i> {% trans "Create Transfer" %}';
            }
        }, 10000);
    });
});

// {% trans "Print Function" %}
function printTransferForm() {
    window.print();
}
</script>
{% endblock %}
