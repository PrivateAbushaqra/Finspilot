{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}


{% block title %}{% trans "Bank Accounts" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .accounts-container {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .accounts-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
    }
    
    .account-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }
    
    .account-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .account-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .status-active {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .balance-positive {
        color: #28a745;
        font-weight: bold;
    }
    
    .balance-negative {
        color: #dc3545;
        font-weight: bold;
    }
    
    .balance-zero {
        color: #6c757d;
    }
    
    .btn-add {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        transition: all 0.3s ease;
    }
    
    .btn-add:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* CSS for print - convert cards to table */
    @media print {
        .container-fluid {
            max-width: none !important;
            width: 100% !important;
        }
        
        /* Hide elements not needed for printing */
        .breadcrumb, .btn-add, .search-section, .no-print,
        .btn-group, .alert, .pagination {
            display: none !important;
        }
        
        /* Create printable table header */
        #accountsList::before {
            content: "{% trans 'Account Name' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Bank' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Account Number' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Balance' %}\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0\00a0 {% trans 'Status' %}";
            display: block;
            background-color: #f8f9fa !important;
            border: 2px solid #000 !important;
            padding: 8px !important;
            font-weight: bold !important;
            text-align: center !important;
            font-size: 10pt !important;
            border-bottom: 2px solid #000 !important;
        }
        
    /* Transfer each account card into a table-like row */
        .account-card {
            display: block !important;
            border: 1px solid #000 !important;
            margin: 0 !important;
            padding: 0 !important;
            background: white !important;
            page-break-inside: avoid !important;
            box-shadow: none !important;
        }
        
        .account-card .card-body {
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .account-card .row {
            display: table-row !important;
            margin: 0 !important;
            border-bottom: 1px solid #ddd !important;
        }
        
        .account-card .col-md-3:first-child,
        .account-card .col-md-2 {
            display: table-cell !important;
            border-right: 1px solid #ddd !important;
            padding: 6px 4px !important;
            vertical-align: middle !important;
            font-size: 8pt !important;
            width: auto !important;
            float: none !important;
        }
        
        /* Customize column widths */
        .account-card .col-md-3:first-child {
            width: 35% !important;
        }
        
        .account-card .col-md-2:nth-child(2) {
            width: 20% !important;
        }
        
        .account-card .col-md-2:nth-child(3) {
            width: 20% !important;
        }
        
        .account-card .col-md-2:nth-child(4) {
            width: 15% !important;
        }
        
        .account-card .col-md-3:last-child {
            display: none !important; /* Hide actions column */
        }
        
        /* Text formatting */
        .account-card h6 {
            font-size: 8pt !important;
            margin: 0 !important;
            font-weight: bold !important;
        }
        
        .account-card small {
            font-size: 7pt !important;
            display: block !important;
        }
        
        .account-card .fw-bold {
            font-size: 8pt !important;
            font-weight: bold !important;
        }
        
        .balance-positive {
            color: #000 !important;
        }
        
        .balance-negative {
            color: #000 !important;
        }
        
        .account-status {
            font-size: 7pt !important;
            border: 1px solid #000 !important;
            padding: 2px 4px !important;
            background: white !important;
            color: black !important;
        }
        
    /* Page settings for print view */
        @page {
            size: A4 landscape !important;
            margin: 0.5cm !important;
        }
        
        body {
            font-size: 8pt !important;
            line-height: 1.1 !important;
        }
        
        h1 {
            font-size: 12pt !important;
            text-align: center !important;
            margin-bottom: 15px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-university text-primary me-2"></i>
                        {% trans "Bank Accounts" %}
                    </h1>
                    <nav aria-label="breadcrumb" class="mt-2">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">{% trans "Dashboard" %}</a></li>
                            <li class="breadcrumb-item active">{% trans "Bank Accounts" %}</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    {% if perms.banks.add_bankaccount %}
                    <a href="{% url 'banks:account_add' %}" class="btn btn-add text-white">
                        <i class="fas fa-plus me-1"></i>
                        {% trans "Add New Account" %}
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Messages -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
            
            <!-- Accounts Container -->
            <div class="accounts-container">
                <div class="accounts-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                {% trans "Bank Accounts List" %}
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="d-flex justify-content-end align-items-center">
                                <button type="button" onclick="printPage()" class="btn btn-primary btn-sm me-3" style="background-color: #007bff; border-color: #007bff;">
                                    <i class="fas fa-print me-1"></i>
                                    {% trans "Print Full Report" %}
                                </button>
                                <span class="me-3">
                                    <i class="fas fa-chart-line me-1"></i>
                                    {% trans "Total Accounts" %}: <strong>{{ total_accounts }}</strong>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-4">
                    <!-- Search and Filter Bar -->
                    <div class="row mb-4 no-print">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" placeholder="{% trans 'Search in accounts...' %}" id="searchAccounts">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterCurrency">
                                <option value="">{% trans "All Currencies" %}</option>
                                {% get_active_currencies as currencies %}
                                {% for currency in currencies %}
                                    <option value="{{ currency.code }}">{{ currency.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filterStatus">
                                <option value="">{% trans "All Accounts" %}</option>
                                <option value="active">{% trans "Active Only" %}</option>
                                <option value="inactive">{% trans "Inactive Only" %}</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Accounts List -->
                    <div id="accountsList">
                        {% if accounts %}
                            {% for account in accounts %}
                            <div class="account-card">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <h6 class="mb-1 fw-bold">{{ account.name }}</h6>
                                            <small class="text-muted">{{ account.bank_name }}</small>
                                        </div>
                                        <div class="col-md-2">
                                            <small class="text-muted">{% trans "Account Number" %}:</small>
                                            <div class="fw-bold">{{ account.account_number }}</div>
                                        </div>
                                        <div class="col-md-2">
                                            <small class="text-muted">{% trans "Balance" %}:</small>
                                            <div class="{% if account.actual_balance >= 0 %}balance-positive{% else %}balance-negative{% endif %}">
                                                {{ account.actual_balance|floatformat:3 }} {{ account.currency }}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="account-status {% if account.is_active %}status-active{% else %}status-inactive{% endif %}">
                                                {% if account.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                                            </span>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <div class="btn-group btn-group-sm no-print">
                                                <a href="{% url 'banks:account_detail' account.pk %}" class="btn btn-outline-primary" title="{% trans 'View Account Details' %}">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{% url 'banks:account_transactions' account.pk %}" class="btn btn-outline-info" title="{% trans 'View Account Transactions' %}">
                                                    <i class="fas fa-list"></i>
                                                </a>
                                                {% if perms.banks.change_bankaccount or request.user.is_superuser %}
                                                    <a href="{% url 'banks:account_edit' account.pk %}" class="btn btn-outline-warning" title="{% trans 'Edit Account' %}">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                {% elif perms.banks.can_edit_banks_account %}
                                                    <a href="{% url 'banks:account_edit' account.pk %}" class="btn btn-outline-warning" title="{% trans 'Edit Account' %}">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                {% endif %}
                                                {% if account.is_active %}
                                                <a href="{% url 'banks:transfer_add' %}" class="btn btn-outline-info" title="{% trans 'Transfer From/To Account' %}">
                                                    <i class="fas fa-exchange-alt"></i>
                                                </a>
                                                {% endif %}
                                                {% if perms.banks.change_bankaccount %}
                                                <button class="btn btn-outline-{% if account.is_active %}secondary{% else %}success{% endif %} toggle-status-btn" 
                                                        data-account-id="{{ account.pk }}" 
                                                        data-account-name="{{ account.name }}"
                                                        data-current-status="{% if account.is_active %}active{% else %}inactive{% endif %}"
                                                        title="{% if account.is_active %}{% trans 'Deactivate' %}{% else %}{% trans 'Activate' %}{% endif %} {% trans 'Account' %}">
                                                    <i class="fas fa-{% if account.is_active %}pause{% else %}play{% endif %}"></i>
                                                </button>
                                                {% endif %}
                                                
                                                {% if user.is_superuser %}
                                                <button class="btn btn-outline-warning clear-transactions-btn" 
                                                        data-account-id="{{ account.pk }}" 
                                                        data-account-name="{{ account.name }}" 
                                                        title="{% trans 'Delete All Account Transactions' %}">
                                                    <i class="fas fa-eraser"></i>
                                                </button>
                                                {% endif %}
                                                
                                                {% if perms.banks.delete_bankaccount or perms.banks.can_delete_banks_account or perms.users.can_delete_accounts %}
                                                <button class="btn btn-outline-danger delete-account-btn" 
                                                        data-account-id="{{ account.pk }}" 
                                                        data-account-name="{{ account.name }}" 
                                                        data-account-balance="{{ account.actual_balance }}"
                                                        title="{% trans 'Delete Account' %}">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% endif %}
                                                
                                                {% if user.is_superuser %}
                                                <button class="btn btn-danger superadmin-delete-btn" 
                                                        data-account-id="{{ account.pk }}" 
                                                        data-account-name="{{ account.name }}" 
                                                        title="{% trans 'Absolute Delete (SuperAdmin Only)' %}">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <!-- Empty State -->
                        <div class="empty-state">
                            <i class="fas fa-university"></i>
                            <h5>{% trans "No bank accounts yet" %}</h5>
                            <p class="mb-3">{% trans "Start by adding a new bank account to manage your finances" %}</p>
                            {% if perms.banks.add_bankaccount %}
                                <a href="{% url 'banks:account_add' %}" class="btn btn-add text-white">
                                    <i class="fas fa-plus me-1"></i>
                                    {% trans "Add First Account" %}
                                </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Total Accounts" %}</h6>
                                    <h3 class="mb-0">{{ total_accounts }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-university fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Active Accounts" %}</h6>
                                    <h3 class="mb-0">{{ active_accounts }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-check-circle fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Total Balances" %}</h6>
                                    {% for currency, balance in balances_by_currency.items %}
                                        <div class="mb-1">
                                            <h5 class="mb-0">{{ balance|floatformat:3 }}</h5>
                                            <small>{{ currency }}</small>
                                        </div>
                                    {% empty %}
                                        <h3 class="mb-0">0.000</h3>
                                        <small>{% get_currency_symbol %}</small>
                                    {% endfor %}
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-coins fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">{% trans "Number of Currencies" %}</h6>
                                    <h3 class="mb-0">{{ currencies_count }}</h3>
                                </div>
                                <div class="ms-3">
                                    <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">{% trans "Confirm Deletion" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Are you sure you want to delete the bank account" %} "<span id="deleteAccountName"></span>"?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {% trans "Warning: This action cannot be undone!" %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        {% trans "Delete Account" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SuperAdmin Absolute Delete Modal -->
<div class="modal fade" id="superAdminDeleteModal" tabindex="-1" aria-labelledby="superAdminDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="superAdminDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {% trans "SuperAdmin Absolute Deletion" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="fw-bold text-danger">{% trans "Are you sure you want to perform absolute deletion for bank account" %} "<span id="superAdminDeleteAccountName"></span>"?</p>
                <div class="alert alert-danger">
                    <h6 class="alert-heading">
                        <i class="fas fa-skull-crossbones me-2"></i>
                        {% trans "CRITICAL WARNING:" %}
                    </h6>
                    <ul class="mb-0">
                        <li>{% trans "This will delete the account permanently" %}</li>
                        <li>{% trans "All transactions related to this account will be deleted" %}</li>
                        <li>{% trans "All transfers related to this account will be deleted" %}</li>
                        <li>{% trans "This action is irreversible and bypasses all safety checks" %}</li>
                        <li>{% trans "Only SuperAdmin can perform this operation" %}</li>
                    </ul>
                </div>
                <p class="text-muted small">{% trans "This operation will be logged in the audit log." %}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <form id="superAdminDeleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt me-1"></i>
                        {% trans "Absolute Delete" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toggle Status Confirmation Modal -->
<div class="modal fade" id="toggleStatusModal" tabindex="-1" aria-labelledby="toggleStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="toggleStatusModalLabel">{% trans "Confirm Status Change" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Are you sure you want to" %} <span id="toggleAction"></span> {% trans "the bank account" %} "<span id="toggleAccountName"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <form id="toggleStatusForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary" id="toggleStatusBtn">
                        <i class="fas fa-check me-1"></i>
                        {% trans "Confirm" %}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Print functionality - convert cards to table for printing
function printPage() {
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    
    // Get current date and time
    const now = new Date();
    const dateString = now.toLocaleDateString('ar-SA');
    const timeString = now.toLocaleTimeString('ar-SA');
    
    // Build the printable content
    let printContent = `
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{% trans "Bank Accounts Report" %}</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    margin: 20px;
                    direction: rtl;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 20px;
                }
                .header h1 {
                    color: #333;
                    margin: 0;
                    font-size: 24px;
                }
                .header p {
                    color: #666;
                    margin: 5px 0;
                    font-size: 14px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                    font-size: 12px;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: right;
                }
                th {
                    background-color: #f8f9fa;
                    font-weight: bold;
                    color: #333;
                }
                tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .balance-positive {
                    color: #28a745;
                    font-weight: bold;
                }
                .balance-negative {
                    color: #dc3545;
                    font-weight: bold;
                }
                .status-active {
                    color: #28a745;
                    font-weight: bold;
                }
                .status-inactive {
                    color: #dc3545;
                    font-weight: bold;
                }
                .summary {
                    margin-top: 30px;
                    padding: 15px;
                    background-color: #f8f9fa;
                    border-radius: 5px;
                }
                .summary h3 {
                    margin: 0 0 10px 0;
                    color: #333;
                }
                .summary-row {
                    display: flex;
                    justify-content: space-around;
                    margin-bottom: 10px;
                }
                .summary-item {
                    text-align: center;
                }
                .summary-value {
                    font-size: 18px;
                    font-weight: bold;
                    color: #007bff;
                }
                .footer {
                    margin-top: 50px;
                    text-align: center;
                    font-size: 14px;
                    color: #666;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                }
                @media print {
                    body { margin: 0; }
                    .header { page-break-after: avoid; }
                    table { page-break-inside: auto; }
                    tr { page-break-inside: avoid; page-break-after: auto; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>{% trans "Bank Accounts Report" %}</h1>
                <p>{% trans "Generated on" %}: ${dateString} {% trans "at" %} ${timeString}</p>
                <p>{% trans "Total Accounts" %}: {{ total_accounts }}</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>{% trans "Account Name" %}</th>
                        <th>{% trans "Bank Name" %}</th>
                        <th>{% trans "Account Number" %}</th>
                        <th>{% trans "Balance" %}</th>
                        <th>{% trans "Currency" %}</th>
                        <th>{% trans "Status" %}</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Get all account cards and convert to table rows
    const accountCards = document.querySelectorAll('.account-card');
    accountCards.forEach(card => {
        const name = card.querySelector('h6')?.textContent?.trim() || '';
        const bankName = card.querySelector('small')?.textContent?.trim() || '';
        const accountNumber = card.querySelector('.col-md-2 div.fw-bold')?.textContent?.trim() || '';
        const balanceElement = card.querySelector('.col-md-2 .balance-positive, .col-md-2 .balance-negative');
        const balance = balanceElement?.textContent?.trim() || '0.000';
        const currency = balanceElement?.textContent?.split(' ').pop() || '';
        const statusElement = card.querySelector('.account-status');
        const status = statusElement?.textContent?.trim() || '';
        
        printContent += `
            <tr>
                <td>${name}</td>
                <td>${bankName}</td>
                <td>${accountNumber}</td>
                <td class="${balanceElement?.classList.contains('balance-positive') ? 'balance-positive' : 'balance-negative'}">${balance}</td>
                <td>${currency}</td>
                <td class="${statusElement?.classList.contains('status-active') ? 'status-active' : 'status-inactive'}">${status}</td>
            </tr>
        `;
    });
    
    printContent += `
                </tbody>
            </table>
            
            <div class="summary">
                <h3>{% trans "Summary" %}</h3>
                <div class="summary-row">
                    <div class="summary-item">
                        <div>{% trans "Total Accounts" %}</div>
                        <div class="summary-value">{{ total_accounts }}</div>
                    </div>
                    <div class="summary-item">
                        <div>{% trans "Active Accounts" %}</div>
                        <div class="summary-value">{{ active_accounts }}</div>
                    </div>
                    <div class="summary-item">
                        <div>{% trans "Inactive Accounts" %}</div>
                        <div class="summary-value">{{ inactive_accounts }}</div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p class="text-center">{% trans "FinsPilot Software" %}</p>
            </div>
        </body>
        </html>
    `;
    
    // Write content to print window
    printWindow.document.write(printContent);
    printWindow.document.close();
    
    // Wait for content to load then print
    printWindow.onload = function() {
        printWindow.print();
        printWindow.close();
    };
}

document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.getElementById('searchAccounts');
    const filterCurrency = document.getElementById('filterCurrency');
    const filterStatus = document.getElementById('filterStatus');
    
    function filterAccounts() {
        // This will be implemented when we have actual data
        console.log('Filtering accounts...');
    }
    
    if (searchInput) searchInput.addEventListener('input', filterAccounts);
    if (filterCurrency) filterCurrency.addEventListener('change', filterAccounts);
    if (filterStatus) filterStatus.addEventListener('change', filterAccounts);
    
    // Delete functionality
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const deleteForm = document.getElementById('deleteForm');
    const deleteAccountNameSpan = document.getElementById('deleteAccountName');
    
    // SuperAdmin Delete functionality
    const superAdminDeleteModal = new bootstrap.Modal(document.getElementById('superAdminDeleteModal'));
    const superAdminDeleteForm = document.getElementById('superAdminDeleteForm');
    const superAdminDeleteAccountNameSpan = document.getElementById('superAdminDeleteAccountName');
    
    // Toggle status functionality
    const toggleStatusModal = new bootstrap.Modal(document.getElementById('toggleStatusModal'));
    const toggleStatusForm = document.getElementById('toggleStatusForm');
    const toggleAccountNameSpan = document.getElementById('toggleAccountName');
    const toggleActionSpan = document.getElementById('toggleAction');
    
    document.addEventListener('click', function(e) {
        // Handle delete button clicks
        if (e.target.closest('.delete-account-btn')) {
            e.preventDefault();
            
            const button = e.target.closest('.delete-account-btn');
            const accountId = button.getAttribute('data-account-id');
            const accountName = button.getAttribute('data-account-name');
            const accountBalance = parseFloat(button.getAttribute('data-account-balance'));
            
            // فحص ال{% trans "Balance" %} وإعطاء رسائل توضيحية
            if (accountBalance !== 0) {
                const message = `{% trans "Cannot delete account" %} "${accountName}" {% trans "because its balance is" %} ${accountBalance.toFixed(3)}\n\n{% trans "Correct way:" %}\n1. {% trans "Go to transfers page and transfer all money to another account" %}\n2. {% trans "Come back here and click delete again - the account will be deleted even if it has transactions!" %}\n\n{% trans "Or (for Superadmin):" %}\n- {% trans "Click Clear All Transactions then Delete Account" %}`;
                alert(message);
                return;
            }
            
            // تحديث نموذج الحذف
            const deleteUrl = '{% url "banks:account_delete" 0 %}'.replace('/0/', '/' + accountId + '/');
            deleteForm.action = deleteUrl;
            deleteAccountNameSpan.textContent = accountName;
            
            // {% trans "View" %} نافذة {% trans "Confirmation" %} الحذف
            deleteModal.show();
        }
        
        // Handle SuperAdmin delete button clicks
        if (e.target.closest('.superadmin-delete-btn')) {
            e.preventDefault();
            
            const button = e.target.closest('.superadmin-delete-btn');
            const accountId = button.getAttribute('data-account-id');
            const accountName = button.getAttribute('data-account-name');
            
            // تحديث نموذج الحذف المطلق
            const deleteUrl = '{% url "banks:account_superadmin_delete" 0 %}'.replace('/0/', '/' + accountId + '/');
            superAdminDeleteForm.action = deleteUrl;
            superAdminDeleteAccountNameSpan.textContent = accountName;
            
            // عرض نافذة التأكيد للحذف المطلق
            superAdminDeleteModal.show();
        }
        
        // Handle toggle status button clicks
        if (e.target.closest('.toggle-status-btn')) {
            e.preventDefault();
            
            const button = e.target.closest('.toggle-status-btn');
            const accountId = button.getAttribute('data-account-id');
            const accountName = button.getAttribute('data-account-name');
            const currentStatus = button.getAttribute('data-current-status');
            
            // تحديث نموذج تغيير {% trans "Status" %}
            const toggleUrl = '{% url "banks:account_toggle_status" 0 %}'.replace('/0/', '/' + accountId + '/');
            toggleStatusForm.action = toggleUrl;
            toggleAccountNameSpan.textContent = accountName;
            
            if (currentStatus === 'active') {
                toggleActionSpan.textContent = '{% trans "deactivate" %}';
            } else {
                toggleActionSpan.textContent = '{% trans "activate" %}';
            }
            
            // {% trans "View" %} نافذة {% trans "Confirmation" %} تغيير {% trans "Status" %}
            toggleStatusModal.show();
        }
        
        // Handle clear transactions button clicks (Superadmin only)
        if (e.target.closest('.clear-transactions-btn')) {
            e.preventDefault();
            
            const button = e.target.closest('.clear-transactions-btn');
            const accountId = button.getAttribute('data-account-id');
            const accountName = button.getAttribute('data-account-name');
            
            const message = `{% trans "Are you sure you want to delete all transactions for account" %} "${accountName}"?\n\n⚠️ {% trans "Important warning:" %}\n- {% trans "This action cannot be undone!" %}\n- {% trans "All transfers related to this account will be deleted" %}\n- {% trans "All affected account balances will be automatically reset" %}\n- {% trans "This account balance will return to initial balance" %}`;
            if (confirm(message)) {
                // إنشاء نموذج {% trans "Hidden" %} لإرسال طلب POST
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "banks:clear_account_transactions" 0 %}'.replace('/0/', '/' + accountId + '/');
                
                // {% trans "Add" %} CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrfmiddlewaretoken';
                csrfInput.value = csrfToken;
                form.appendChild(csrfInput);
                
                // {% trans "Add" %} النموذج للصفحة وإرساله
                document.body.appendChild(form);
                form.submit();
            }
        }
    });
});
</script>
{% endblock %}
