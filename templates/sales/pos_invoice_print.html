{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load currency_tags %}

{% block title %}{% trans "POS Invoice Print" %} - {{ invoice.invoice_number }}{% endblock %}

{% block extra_css %}
<style>
    @media print {
        body {
            margin: 0;
            padding: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.2;
            width: 80mm; /* عرض قياسي لطابعات POS */
            margin: 0 auto;
        }

        .no-print {
            display: none !important;
        }

        .pos-receipt {
            width: 100%;
            max-width: 80mm;
        }
    }

    @media screen {
        body {
            background: #f8f9fa;
            margin: 0;
            padding: 20px;
        }

        .pos-receipt {
            width: 80mm;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.2;
        }
    }

    .receipt-header {
        text-align: center;
        border-bottom: 1px dashed #000;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    .company-name {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .company-info {
        font-size: 10px;
        margin-bottom: 3px;
    }

    .receipt-title {
        font-size: 14px;
        font-weight: bold;
        margin: 10px 0;
        text-decoration: underline;
    }

    .invoice-info {
        margin-bottom: 10px;
        font-size: 11px;
    }

    .invoice-info div {
        margin-bottom: 2px;
    }

    .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
        font-size: 11px;
    }

    .items-table th,
    .items-table td {
        text-align: left;
        padding: 2px 0;
        border-bottom: 1px dotted #ccc;
    }

    .items-table .item-name {
        width: 60%;
    }

    .items-table .item-qty {
        width: 15%;
        text-align: center;
    }

    .items-table .item-price {
        width: 25%;
        text-align: right;
    }

    .totals-section {
        border-top: 1px dashed #000;
        padding-top: 5px;
        margin-top: 10px;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3px;
        font-size: 11px;
    }

    .grand-total {
        font-weight: bold;
        font-size: 13px;
        border-top: 1px solid #000;
        padding-top: 5px;
        margin-top: 5px;
    }

    .footer {
        text-align: center;
        margin-top: 15px;
        font-size: 10px;
        border-top: 1px dashed #000;
        padding-top: 10px;
    }

    .thank-you {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .print-info {
        margin-top: 10px;
        font-size: 9px;
        color: #666;
    }

    .powered-by {
        margin-top: 5px;
        font-size: 8px;
        color: #999;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-receipt">
    <!-- رأس الفاتورة -->
    <div class="receipt-header">
        {% if company_settings.logo %}
            <img src="{{ company_settings.logo.url }}" alt="Logo" style="max-width: 60px; max-height: 40px; margin-bottom: 5px;">
        {% endif %}

        <div class="company-name">
            {% get_current_language as LANGUAGE_CODE %}
            {% if LANGUAGE_CODE == 'ar' %}
                {% if company_settings.company_name %}
                    {{ company_settings.company_name }}
                {% else %}
                    {% trans "Company Name" %}
                {% endif %}
            {% else %}
                {% if company_settings.company_name_en %}
                    {{ company_settings.company_name_en }}
                {% else %}
                    {% if company_settings.company_name %}
                        {{ company_settings.company_name }}
                    {% else %}
                        {% trans "Company Name" %}
                    {% endif %}
                {% endif %}
            {% endif %}
        </div>

        {% if company_settings.company_address %}
            <div class="company-info">{{ company_settings.company_address }}</div>
        {% endif %}

        {% if company_settings.company_phone %}
            <div class="company-info">{% trans "Phone" %}: {{ company_settings.company_phone }}</div>
        {% endif %}

        {% if company_settings.company_email %}
            <div class="company-info">{{ company_settings.company_email }}</div>
        {% endif %}
    </div>

    <!-- عنوان الفاتورة -->
    <div class="receipt-title">
        {% trans "SALES INVOICE" %}
    </div>

    <!-- معلومات الفاتورة -->
    <div class="invoice-info">
        <div><strong>{% trans "Invoice No" %}:</strong> {{ invoice.invoice_number }}</div>
        <div><strong>{% trans "Date" %}:</strong> {{ invoice.invoice_date|date:"d/m/Y H:i" }}</div>
        {% if invoice.customer %}
            <div><strong>{% trans "Customer" %}:</strong> {{ invoice.customer.name }}</div>
        {% endif %}
        {% if invoice.cashbox %}
            <div><strong>{% trans "Cashbox" %}:</strong> {{ invoice.cashbox.name }}</div>
        {% endif %}
    </div>

    <!-- جدول الأصناف -->
    <table class="items-table">
        <thead>
            <tr>
                <th class="item-name">{% trans "Item" %}</th>
                <th class="item-qty">{% trans "Qty" %}</th>
                <th class="item-price">{% trans "Price" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td class="item-name">{{ item.product.name }}</td>
                <td class="item-qty">{{ item.quantity }}</td>
                <td class="item-price">{{ item.unit_price|floatformat:3 }}</td>
            </tr>
            {% if item.discount_amount and item.discount_amount > 0 %}
            <tr>
                <td colspan="3" style="text-align: right; font-size: 10px; color: #666;">
                    {% trans "Discount" %}: {{ item.discount_amount|floatformat:3 }}
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>

    <!-- الإجماليات -->
    <div class="totals-section">
        <div class="total-row">
            <span>{% trans "Subtotal" %}:</span>
            <span>{{ invoice.subtotal|floatformat:3 }}</span>
        </div>

        {% if invoice.discount_amount and invoice.discount_amount > 0 %}
        <div class="total-row">
            <span>{% trans "Discount" %}:</span>
            <span>{{ invoice.discount_amount|floatformat:3 }}</span>
        </div>
        {% endif %}

        {% if invoice.tax_amount and invoice.tax_amount > 0 %}
        <div class="total-row">
            <span>{% trans "Tax" %}:</span>
            <span>{{ invoice.tax_amount|floatformat:3 }}</span>
        </div>
        {% endif %}

        <div class="total-row grand-total">
            <span>{% trans "TOTAL" %}:</span>
            <span>{{ invoice.total_amount|floatformat:3 }} {% get_currency_symbol %}</span>
        </div>

        {% if invoice.payment_method %}
        <div class="total-row">
            <span>{% trans "Payment" %}:</span>
            <span>{{ invoice.get_payment_method_display }}</span>
        </div>
        {% endif %}
    </div>

    <!-- تذييل الفاتورة -->
    <div class="footer">
        <div class="thank-you">
            {% trans "Thank you for your Visiting us!" %}
        </div>

        <div>
            {% trans "Visit us again" %}
        </div>

        <div class="print-info">
            {% trans "Printed on" %}: {{ invoice.created_at|date:"d/m/Y H:i:s" }}
        </div>

        <div class="powered-by">
            Powered By FinsPilot Software
        </div>
    </div>
</div>

<script>
    // طباعة تلقائية عند تحميل الصفحة
    window.onload = function() {
        window.print();
    };

    // إغلاق النافذة بعد الطباعة (اختياري)
    window.onafterprint = function() {
        // يمكن إضافة منطق إغلاق النافذة هنا إذا لزم الأمر
    };
</script>
{% endblock %}