{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}



{% block title %}{% trans "Add Sales Invoice" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<!-- Critical CSS - Load First -->
<style>
    /* Critical styles loaded immediately */
    .form-container {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .form-header {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid #007bff;
    }
    
    .product-row {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .summary-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    /* CRITICAL: Add Product Button Styles - Load Immediately */
    .btn-add-product {
        background: linear-gradient(45deg, #28a745, #20c997) !important;
        border: none !important;
        color: white !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
        position: relative !important;
        overflow: hidden !important;
        padding: 0.375rem 1rem !important;
        border-radius: 0.375rem !important;
        font-weight: 500 !important;
        text-decoration: none !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 38px !important;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2) !important;
    }
    
    .btn-add-product:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3) !important;
        background: linear-gradient(45deg, #218838, #1bac7a) !important;
        color: white !important;
    }
    
    .btn-add-product:active {
        transform: translateY(0) !important;
        background: linear-gradient(45deg, #1e7e34, #179f6f) !important;
    }
    
    .btn-add-product:focus {
        outline: 2px solid #20c997 !important;
        outline-offset: 2px !important;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2) !important;
        color: white !important;
    }
    
    /* Ensure button is always visible and styled */
    .btn-add-product, .btn-add-product:visited {
        background: linear-gradient(45deg, #28a745, #20c997) !important;
        color: white !important;
    }
    
    .required-field {
        color: #dc3545;
    }
    
    .stock-warning {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107 !important;
    }
    
    .product-code-input {
        font-family: 'Courier New', monospace;
        font-weight: bold;
    }
    
    .products-table {
        height: auto;
        overflow-y: visible;
        position: relative;
        z-index: 10;
        padding-bottom: 50px; /* ŸÖÿ≥ÿßŸÅÿ© ÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ¨ÿØŸàŸÑ */
    }
    
    /* Ensure dropdowns appear above everything */
    .product-dropdown, .product-code-dropdown {
        z-index: 1000 !important;
        position: absolute !important;
    }
    
    .btn-remove-product {
        background: #dc3545;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }
    
    .btn-remove-product:hover {
        background: #c82333;
        color: white;
    }
    
    #productsTable th {
        background-color: #343a40;
        color: white;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
    }
    
    #productsTable td {
        vertical-align: middle;
    }

    /* Product Dropdown Arrow Navigation Styles */
    .product-dropdown .dropdown-item.active,
    .product-code-dropdown .dropdown-item.active {
        background-color: #007bff !important;
        color: white !important;
    }
    
    .product-dropdown .dropdown-item,
    .product-code-dropdown .dropdown-item {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    
    .product-dropdown .dropdown-item:hover,
    .product-code-dropdown .dropdown-item:hover {
        background-color: #0056b3 !important;
        color: white !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-plus-circle text-success me-2"></i>
                {% trans "Add Sales Invoice" %}
            </h2>
            <p class="text-muted mb-0">{% trans "Create a New Sales Invoice" %}</p>
        </div>
        <div>
            <a href="{% url 'sales:invoice_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                {% trans "Back to List" %}
            </a>
        </div>
    </div>

    <!-- Form Container -->
    <div class="form-container">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
        
        <div class="form-header">
            <h3>
                <i class="fas fa-file-invoice-dollar text-primary me-2"></i>
                {% trans "Sales Invoice Information" %}
            </h3>
            <p class="text-muted mb-0">{% trans "Please fill all required fields" %}</p>
        </div>
        
        <!-- Hidden elements for translations -->
        <div id="unsaved-changes-translations" style="display: none;">
            <span id="trans-unsaved-changes">{% trans "Unsaved Changes" context "unsaved_changes" %}</span>
            <span id="trans-unsaved-message">{% trans "Are you sure you want to leave this page? You have unsaved changes." context "unsaved_changes" %}</span>
            <span id="trans-cancel">{% trans "Cancel" context "unsaved_changes" %}</span>
            <span id="trans-leave">{% trans "Leave" context "unsaved_changes" %}</span>
        </div>
        
    <form method="post" id="salesInvoiceForm" novalidate>
            {% csrf_token %}
            <input type="hidden" name="inclusive_tax" value="0">
            
            <!-- Invoice Information Section -->
            <div class="form-section">
                <h5>
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Invoice Information" %}
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="id_invoice_number" class="form-label">
                                {% trans "Invoice Number" %} <span class="required-field">*</span>
                            </label>
                            {% if sequence_error %}
                                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    {{ sequence_error }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endif %}
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-hashtag"></i>
                                </span>
                                {% if can_edit_invoice_number %}
                                    <input type="text" class="form-control" id="id_invoice_number" name="invoice_number"
                                           value="{% if manual_invoice %}{{ manual_invoice }}{% else %}{{ next_invoice_number }}{% endif %}" 
                                           title="{% trans 'You can edit the invoice number or leave the field for automatic generation' %}">
                                {% else %}
                                    <input type="text" class="form-control bg-light" 
                                           value="{% if manual_invoice %}{{ manual_invoice }}{% else %}{{ next_invoice_number }}{% endif %}" 
                                           readonly
                                           title="{% trans 'Invoice number will be automatically generated from the document numbering system' %}">
                                {% endif %}
                            </div>
                            <small class="form-text text-muted">
                                {% if can_edit_invoice_number %}
                                    {% trans "You can edit the invoice number or leave the field for automatic generation" %}
                                {% else %}
                                    {% trans "Invoice number will be automatically created when saved (you do not have permission to edit the number)" %}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="id_date" class="form-label">
                                {% trans "Invoice Date" %} <span class="required-field">*</span>
                            </label>
                            {% if can_edit_date %}
                                <input type="date" class="form-control" id="id_date" name="date" 
                                       value="{% if invoice_date %}{{ invoice_date }}{% else %}{{ today_date }}{% endif %}" required
                                       title="{% trans 'You can edit the invoice date' %}">
                                <small class="form-text text-muted">
                                    {% trans "You can edit the invoice date as needed" %}
                                </small>
                            {% else %}
                                <input type="date" class="form-control bg-light" id="id_date" name="date" 
                                       value="{% if invoice_date %}{{ invoice_date }}{% else %}{{ today_date }}{% endif %}" readonly
                                       title="{% trans 'Today date (you do not have permission to edit date)' %}">
                                <small class="form-text text-muted">
                                    {% trans "Invoice date is fixed to today's date (you do not have permission to edit date)" %}
                                </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="customer_search" class="form-label">
                                {% trans "Customer" %} <span class="required-field">*</span>
                                <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="openNewCustomerModal()" title="{% trans 'Create new customer' %}">
                                    <i class="fas fa-user-plus me-1"></i> {% trans "New" %}
                                </button>
                            </label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="customer_search" placeholder="{% trans 'Type customer name...' %}" autocomplete="off">
                                <div id="customer-dropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                    <!-- Customer options will be populated here -->
                                </div>
                            </div>
                            <select class="form-select d-none" id="id_customer" name="customer" required>
                                <option value="">{% trans "Select Customer" %}</option>
                                {% for customer in customers %}
                                    <option value="{{ customer.id }}" {% if customer_id and customer.id|stringformat:"s" == customer_id %}selected{% endif %}>{{ customer.name }}</option>
                                {% endfor %}
                            </select>
                            <div id="customer-balance-info" class="mt-2" style="display: none;">
                                <small class="text-info">
                                    <i class="fas fa-wallet me-1"></i>
                                    {% trans "Customer Balance" %}: <span id="customer-balance-amount" class="fw-bold"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="id_creator_name" class="form-label">{% trans "User Name" %}</label>
                            {% if can_change_creator %}
                                <select class="form-select" id="id_creator_name" name="creator_user">
                                    <option value="">{% trans "Select User" %}</option>
                                    {% for u in all_users %}
                                        <option value="{{ u.id }}" {% if u.username == request.user.username %}selected{% endif %}>{{ u.first_name }} {{ u.last_name }}{% if not u.first_name and not u.last_name %} ({{ u.username }}){% endif %}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">{% trans "Select the user who will be recorded as the creator of this invoice" %}</small>
                            {% else %}
                                <input type="text" class="form-control bg-light" id="id_creator_name" value="{{ creator_full_name }}" readonly>
                                <small class="form-text text-muted">{% trans "The name of the user creating this invoice (first and last)" %}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- {% trans "Warehouse Row" %} -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-warehouse me-1"></i> {% trans "Warehouse" %} <span class="required-field">*</span></label>
                            <select class="form-select" id="id_warehouse" name="warehouse" required>
                                <option value="">{% trans "Select Warehouse" %}</option>
                                {% for warehouse in warehouses %}
                                <option value="{{ warehouse.id }}" {% if warehouse_id and warehouse.id|stringformat:"s" == warehouse_id %}selected{% elif not warehouse_id and default_warehouse and warehouse.id == default_warehouse.id %}selected{% endif %}>
                                    {{ warehouse.name }} - {{ warehouse.code }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" name="set_default_warehouse" id="set_default_warehouse">
                                <label class="form-check-label" for="set_default_warehouse">
                                    {% trans "Set as default sales warehouse" %}
                                </label>
                            </div>
                            <div class="form-text">{% trans "Select the warehouse from which products will be issued." %}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- {% trans "Empty space for balance" %} -->
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="id_payment_type" class="form-label">
                                {% trans "Payment Method" %} <span class="required-field">*</span>
                            </label>
                            <select class="form-select" id="id_payment_type" name="payment_type" required>
                                <option value="">{% trans "Select Payment Method" %}</option>
                                <option value="cash" {% if payment_type == "cash" %}selected{% endif %}>{% trans "Cash" %}</option>
                                <option value="credit" {% if payment_type == "credit" %}selected{% endif %}>{% trans "Credit (Deferred)" %}</option>
                                <!--<option value="check" {% if payment_type == "check" %}selected{% endif %}>{% trans "Check" %}</option>
                                <option value="bank_transfer" {% if payment_type == "bank_transfer" %}selected{% endif %}>{% trans "Bank Transfer" %}</option>
                                <option value="installment" {% if payment_type == "installment" %}selected{% endif %}>{% trans "Installment" %}</option>-->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿµŸÜÿßÿØŸäŸÇ: ÿ™ÿ∏Ÿáÿ± ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± "ŸÜŸÇÿØÿßŸã" ŸÅŸÇÿ∑ -->
                        <!-- ÿßŸÑÿ¥ŸäŸÉÿßÿ™ ÿ™ŸèÿπÿßŸÑÿ¨ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ≥ŸÜÿØ ÿßŸÑŸÇÿ®ÿ∂ -->
                        <div class="mb-3" id="cashbox_container" style="display: none;">
                            <label for="id_cashbox" class="form-label">
                                {% trans "Cash Box" %} <span class="required-field">*</span>
                            </label>
                            <select class="form-select" id="id_cashbox" name="cashbox">
                                <option value="">{% trans "Select Cash Box" %}</option>
                                {% for cashbox in cashboxes %}
                                <option value="{{ cashbox.id }}" 
                                    {% if cashbox_id and cashbox.id|stringformat:"s" == cashbox_id %}
                                        selected
                                    {% elif not cashbox_id and default_cashbox and cashbox.id == default_cashbox.id %}
                                        selected
                                    {% endif %}>
                                    {{ cashbox.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="id_set_default_cashbox" name="set_default_cashbox">
                                <label class="form-check-label" for="id_set_default_cashbox">
                                    {% trans "Set as default cash box" %}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div class="form-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>
                        <i class="fas fa-box me-1"></i>
                        {% trans "Products" %}
                    </h5>
                    <div>
                        {% if user.is_superuser or perms.products.can_add_products %}
                        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addProductModal">
                            <i class="fas fa-plus me-2"></i>
                            {% trans "Create Product" %}
                        </button>
                        {% endif %}                        
                        <button type="button" class="btn btn-add-product" id="addProductBtn" tabindex="-1"
                                title="{% trans "Click to add a new product" %}" data-action="add-product">
                                <i class="fas fa-plus me-1"></i>
                                {% trans "Add Product  " %}
                                <small class="ms-1 text-muted">(Shift+A)</small>
                        </button>
                    </div>
                    <div id="warehouseRequiredMessage" class="text-danger mt-2" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {% trans "Please select the warehouse first before adding products." %}
                    </div>
                </div>
                
                <div class="table-responsive products-table">
                    <table class="table table-bordered" id="productsTable">
                        <thead class="table-dark">
                            <tr>
                                <th width="15%">{% trans "Product Code" %}</th>
                                <th width="31%">{% trans "Product" %}</th>
                                <th width="8%">{% trans "Available Quantity" %}</th>
                                <th width="8%">{% trans "Quantity" %}</th>
                                <th width="8%">
                                    {% trans "Price" %}
                                    <i class="fas fa-info-circle ms-1" 
                                       data-bs-toggle="tooltip" 
                                       data-bs-placement="top" 
                                       title="{% trans 'When inclusive tax is enabled: Enter the price INCLUDING tax. The system will automatically calculate the base price. When not enabled: Enter the base price WITHOUT tax.' %}"
                                       style="cursor: help; font-size: 0.85em;"></i>
                                </th>
                                <th width="10%">{% trans "Tax %" %}</th>
                                <th width="8%">{% trans "Tax Amount" %}</th>
                                <th width="8%">{% trans "Total" %}</th>
                                <th width="4%">{% trans "Delete" %}</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            {% for item in existing_products %}
                            <tr class="product-row{% if item.id|stringformat:'s' in stock_warnings %} stock-warning{% endif %}" id="productRow{{ forloop.counter }}">
                                <td>
                                    <input type="hidden" name="products[]" class="product-id-input" value="{{ item.id }}">
                                    <input type="hidden" name="tax_rates[]" class="tax-rate-hidden-input" value="{{ item.tax_rate }}">
                                    <input type="hidden" name="tax_amounts[]" class="tax-amount-hidden-input">
                                    <div class="d-flex align-items-center">
                                        <div class="position-relative flex-grow-1 me-2">
                                            <input type="text" class="form-control product-code-input" 
                                                   placeholder="{% trans 'Product code...' %}" autocomplete="off" value="{{ item.code }}">
                                            <div class="product-code-dropdown dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                                <!-- Product code options will be populated here -->
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="openProductModal({{ forloop.counter }})">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <div class="position-relative">
                                        <input type="text" class="form-control product-name-input" 
                                               placeholder="{% trans 'Type product name...' %}" autocomplete="off" value="{{ item.name }}">
                                        <div class="product-dropdown dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                            <!-- Product options will be populated here -->
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <input type="text" class="form-control text-center available-quantity-input" 
                                           placeholder="0.000" readonly style="background-color: #e9ecef;" tabindex="-1" value="{{ item.current_stock|floatformat:3 }}">
                                </td>
                                <td>
                                    <input type="number" class="form-control quantity-input" 
                                           name="quantities[]" min="0.001" value="{{ item.quantity }}" step="0.001">
                                </td>
                                <td>
                                    <input type="number" class="form-control price-input" 
                                           name="prices[]" min="0" value="{{ item.price }}" step="0.001">
                                </td>
                                <td>
                                    <input type="number" class="form-control tax-rate-input" 
                                           min="0" max="100" step="0.01" value="{{ item.tax_rate }}" readonly style="background-color: #e9ecef;" tabindex="-1">
                                </td>
                                <td>
                                    <input type="text" class="form-control tax-amount-input" readonly style="background-color: #e9ecef;" tabindex="-1">
                                </td>
                                <td>
                                    <input type="text" class="form-control total-input" readonly style="background-color: #e9ecef;" tabindex="-1">
                                </td>
                                <td class="text-center">
                                    <button type="button" class="btn btn-remove-product" onclick="removeProductRow({{ forloop.counter }})" title="{% trans 'Delete' %}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                            <!-- {% trans "Product rows will be added here by JavaScript" %} -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Additional Information Section -->
            <div class="form-section">
                <h5>
                    <i class="fas fa-info-circle me-1"></i>
                    {% trans "Additional Information" %}
                </h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="id_discount" class="form-label">{% trans "Discount" %}</label>
                            <input type="number" class="form-control" id="id_discount" name="discount" 
                                   min="0" step="0.01" value="{% if discount_amount %}{{ discount_amount }}{% else %}0{% endif %}">
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <!-- {% trans "Empty space for balance" %} -->
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="id_notes" class="form-label">{% trans "Notes" %}</label>
                    <textarea class="form-control" id="id_notes" name="notes" rows="3" 
                              placeholder="{% trans 'Any additional notes...' %}">{% if notes %}{{ notes }}{% endif %}</textarea>
                </div>
            </div>

            <!-- Invoice Summary -->
            <div class="summary-section">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-3">{% trans "Invoice Summary" %}</h5>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" value="1" id="id_inclusive_tax" name="inclusive_tax" checked
                                {% if not can_toggle_invoice_tax %} disabled {% endif %}>
                            <label class="form-check-label" for="id_inclusive_tax">
                                {% trans "Inclusive Tax" %}
                                <i class="fas fa-info-circle ms-1" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="{% trans 'When checked: Enter prices WITH tax included, system will calculate base price automatically. When unchecked: Enter base prices WITHOUT tax.' %}"
                                   style="cursor: help; font-size: 0.85em;"></i>
                            </label>
                            <small class="d-block text-muted">{% trans "When checked: Prices entered include tax. System extracts base price automatically" %}</small>
                        </div>
                        <div class="summary-details">
                            <div class="d-flex justify-content-between mb-2">
                                <span>{% trans "Subtotal" %}:</span>
                                <strong id="subtotalDisplay">0.000 {% get_currency_symbol %}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>{% trans "Discount" %}:</span>
                                <strong id="discountDisplay">0.000 {% get_currency_symbol %}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>{% trans "Tax" %}:</span>
                                <strong id="taxDisplay">0.000 {% get_currency_symbol %}</strong>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between mb-0">
                                <span class="h5">{% trans "Final Total" %}:</span>
                                <strong class="h5 text-warning" id="totalDisplay">0.00 {% get_currency_symbol %}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex gap-3">
                        <button type="submit" name="action" value="save" class="btn btn-primary btn-lg" title="ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© (Ctrl+Enter)">
                            <i class="fas fa-save me-2"></i>
                            {% trans "Save Invoice" %}
                            <small class="ms-1 text-muted">(Ctrl+Enter)</small>
                        </button>
                        {% if show_skip_button %}
                        <button type="submit" name="skip_stock_check" value="true" class="btn btn-warning btn-lg">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {% trans "ÿ™ÿÆÿ∑Ÿä ŸÅÿ≠ÿµ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ Ÿà ÿ≠ŸÅÿ∏" %}
                        </button>
                        {% endif %}
                        <button type="submit" name="action" value="save_and_send" class="btn btn-success btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>
                            {% trans "Save and Send" %}
                        </button>
                        <a href="{% url 'sales:invoice_list' %}" class="btn btn-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>
                            {% trans "Cancel" %}
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
const stockWarnings = {{ stock_warnings|safe }};
</script>

<script>
// Client-side pre-submit validation to show errors inline
document.getElementById('salesInvoiceForm').addEventListener('submit', function(e){
    try{
        // Clear previous alerts
        document.querySelectorAll('.client-validation-alert').forEach(el=>el.remove());

        const customer = document.getElementById('id_customer') ? document.getElementById('id_customer').value : '';
        const paymentType = document.getElementById('id_payment_type') ? document.getElementById('id_payment_type').value : '';
        const warehouse = document.getElementById('id_warehouse') ? document.getElementById('id_warehouse').value : '';
        const productsExist = document.querySelectorAll('#productsTableBody tr').length > 0;
        if(!customer){
            e.preventDefault();
            const container = document.querySelector('.form-container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger client-validation-alert';
            alert.textContent = "{% trans 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿπŸÖŸäŸÑ ŸÇÿ®ŸÑ ÿßŸÑÿ≠ŸÅÿ∏' %}";
            container.insertBefore(alert, container.firstChild);
            alert.scrollIntoView({behavior: 'smooth', block: 'center'});
            return false;
        }
        if(!paymentType){
            e.preventDefault();
            const container = document.querySelector('.form-container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger client-validation-alert';
            alert.textContent = "{% trans 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ' %}";
            container.insertBefore(alert, container.firstChild);
            alert.scrollIntoView({behavior: 'smooth', block: 'center'});
            return false;
        }
        if(!warehouse){
            e.preventDefault();
            const container = document.querySelector('.form-container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger client-validation-alert';
            alert.textContent = "{% trans 'Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ' %}";
            container.insertBefore(alert, container.firstChild);
            alert.scrollIntoView({behavior: 'smooth', block: 'center'});
            return false;
        }
        if(!productsExist){
            e.preventDefault();
            const container = document.querySelector('.form-container');
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger client-validation-alert';
            alert.textContent = "{% trans 'Ÿäÿ±ÿ¨Ÿâ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ' %}";
            container.insertBefore(alert, container.firstChild);
            alert.scrollIntoView({behavior: 'smooth', block: 'center'});
            return false;
        }
    }catch(err){
        console.error('Client-side validation error', err);
    }
});
</script>

<script>
// Apply stock warnings styling
document.addEventListener('DOMContentLoaded', function() {
    // ÿØÿßŸÑÿ© ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ
    function checkWarehouseRequirement() {
        const warehouseSelect = document.getElementById('id_warehouse');
        const addProductBtn = document.getElementById('addProductBtn');
        const messageDiv = document.getElementById('warehouseRequiredMessage');
        
        if (warehouseSelect && warehouseSelect.value) {
            // ŸÖÿ≥ÿ™ŸàÿØÿπ ŸÖÿÆÿ™ÿßÿ±ÿå ŸÅÿπŸÑ ÿßŸÑÿ≤ÿ± Ÿàÿ£ÿÆŸÅŸê ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
            addProductBtn.disabled = false;
            addProductBtn.classList.remove('disabled');
            if (messageDiv) messageDiv.style.display = 'none';
        } else {
            // ŸÑÿß ŸÖÿ≥ÿ™ŸàÿØÿπ ŸÖÿÆÿ™ÿßÿ±ÿå ÿπÿ∑ŸÑ ÿßŸÑÿ≤ÿ± Ÿàÿ£ÿ∏Ÿáÿ± ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©
            addProductBtn.disabled = true;
            addProductBtn.classList.add('disabled');
            if (messageDiv) messageDiv.style.display = 'block';
        }
    }
    
    // ÿ™ÿ≠ŸÇŸÇ ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
    checkWarehouseRequirement();
    
    // ÿ™ÿ≠ŸÇŸÇ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ
    const warehouseSelect = document.getElementById('id_warehouse');
    if (warehouseSelect) {
        warehouseSelect.addEventListener('change', checkWarehouseRequirement);
    }
    
    document.querySelectorAll('.product-row').forEach(row => {
        const productIdInput = row.querySelector('.product-id-input');
        if (productIdInput && productIdInput.value && stockWarnings[productIdInput.value]) {
            row.classList.add('stock-warning');
        }
    });

    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ
    const warehouseSelect = document.getElementById('id_warehouse');
    if (warehouseSelect) {
        warehouseSelect.addEventListener('change', function() {
            document.querySelectorAll('.product-row').forEach(row => {
                const productIdInput = row.querySelector('.product-id-input');
                const availableQuantityInput = row.querySelector('.available-quantity-input');
                if (productIdInput && productIdInput.value && availableQuantityInput) {
                    if (warehouseSelect.value) {
                        fetch(`/ar/sales/api/product-stock/${productIdInput.value}/${warehouseSelect.value}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.stock !== undefined) {
                                    availableQuantityInput.value = formatCurrency(parseFloat(data.stock), 3);
                                    if (parseFloat(data.stock) <= 0) {
                                        row.classList.add('stock-warning');
                                    } else {
                                        row.classList.remove('stock-warning');
                                    }
                                }
                            })
                            .catch(error => console.error('Error fetching stock:', error));
                    } else {
                        // ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ≥ÿ™ŸàÿØÿπÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑÿπÿßŸÖ
                        // ŸÑŸÉŸÜ ŸÜÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸäŸá ŸÖŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ£ŸàŸÑŸäÿ©
                        // ŸÑŸÑÿ®ÿ≥ÿßÿ∑ÿ©ÿå ÿßÿ™ÿ±ŸÉŸá ŸÉŸÖÿß ŸáŸà
                    }
                }
            });
        });
    }
});
</script>

{% get_base_currency as base_currency %}
<script>
// Use template-provided base currency decimal places (server-side truth)
const currencyDecimalPlaces = {% if base_currency %}{{ base_currency.decimal_places }}{% else %}2{% endif %};

function formatCurrency(value, overridePlaces){
    try{
        const places = (typeof overridePlaces === 'number') ? overridePlaces : currencyDecimalPlaces;
        if (value === null || value === undefined || isNaN(Number(value))) return (0).toFixed(places);
        return Number(value).toFixed(places);
    }catch(e){
        console.error('formatCurrency error', e);
        return (Number(value) || 0).toFixed(currencyDecimalPlaces);
    }
}
</script>

<!-- Product Selection Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">
                    <i class="fas fa-search me-2"></i>
                    {% trans "Select Product" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="productSearch" placeholder="{% trans 'Search for product by code or name...' %}">
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>{% trans "Product Code" %}</th>
                                <th>{% trans "Product Name" %}</th>
                                <th>{% trans "Description" %}</th>
                                <th>{% trans "Available Quantity" %}</th>
                                <th>{% trans "Sale Price" %}</th>
                                <th>{% trans "Tax Rate" %}</th>
                                <th>{% trans "Select" %}</th>
                            </tr>
                        </thead>
                        <tbody id="productList">
                            {% for product in products %}
                            <tr>
                                <td>{{ product.code }}</td>
                                <td>{{ product.name }}</td>
                                <td>{{ product.description|truncatechars:50|default:"{% trans 'No description available' %}" }}</td>
                                <td class="text-center">
                                    <span class="badge bg-{% if product.current_stock > 0 %}success{% else %}danger{% endif %}">
                                        {{ product.current_stock|floatformat:3 }}
                                    </span>
                                </td>
                                <td>{{ product.sale_price|floatformat:2 }}</td>
                                <td>{{ product.tax_rate|floatformat:2 }}%</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-primary" 
                                            onclick="selectProduct('{{ product.id }}', '{{ product.code }}', '{{ product.name }}', '{{ product.sale_price }}', '{{ product.tax_rate }}', '{{ product.current_stock }}')">
                                        {% trans "Select" %}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Price hook removed (debug instrumentation cleaned up)

let productRowCounter = {{ existing_products|length|default:0 }};
let currentRow = null;
let buttonClickCount = 0; // ŸÑÿ™ÿ™ÿ®ÿπ ÿπÿØÿØ ÿßŸÑŸÜŸÇÿ±ÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ≤ÿ±
let isPageReady = false;

// Enhanced Page Load Management
function ensurePageReady() {
    console.log('üîÑ Ensuring page readiness...');
    
    // Force apply critical styles
    const addBtn = document.getElementById('addProductBtn');
    if (addBtn) {
        // Force apply button styles immediately
        addBtn.style.cssText = `
            background: linear-gradient(45deg, #28a745, #20c997) !important;
            border: none !important;
            color: white !important;
            padding: 0.375rem 1rem !important;
            border-radius: 0.375rem !important;
            font-weight: 500 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 38px !important;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2) !important;
            cursor: pointer !important;
            text-decoration: none !important;
            transition: all 0.3s ease !important;
        `;
        console.log('‚úÖ Button styles applied directly');
    }

    isPageReady = true;
}

// Multiple initialization strategies
function initializePage() {
    console.log('üöÄ Initializing invoice page...');
    
    // Strategy 1: Immediate initialization
    ensurePageReady();
    
    // Strategy 2: Add first product row
    setTimeout(() => {
        if (document.getElementById('productsTableBody')) {
            addProductRow();
        }
    }, 100);
    
    // Strategy 3: Setup button event listeners
    setupAddProductButton();
    
    // Strategy 4: Set focus on customer field
    setTimeout(() => {
        const customerSearch = document.getElementById('customer_search');
        if (customerSearch) {
            customerSearch.focus();
            console.log('‚úÖ Focus set on customer search field');
        }
    }, 200);
}

// Enhanced button setup with multiple fallbacks
function setupAddProductButton() {
    console.log('üéØ Setting up add product button...');
    
    const addBtn = document.getElementById('addProductBtn');
    if (!addBtn) {
        console.error('‚ùå Add product button not found!');
        // Retry after a short delay
        setTimeout(setupAddProductButton, 500);
        return;
    }
    
    // Remove any existing listeners
    const newBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newBtn, addBtn);
    
    // Add new event listener
    newBtn.addEventListener('click', function(e) {
        buttonClickCount++;
        console.log(`üñ±Ô∏è Button click #${buttonClickCount}`);
        
        e.preventDefault();
        e.stopPropagation();
        
        try {
            addProductRow();
            console.log('‚úÖ Product row added successfully');
        } catch (error) {
            console.error('‚ùå Error adding product row:', error);
            alert("{% trans 'An error occurred while adding the product. Please try again.' %}");
        }
    });
    
    // ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿπÿßŸÑÿ¨ Tab ŸÑŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
    newBtn.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' && !e.shiftKey) {
            e.preventDefault();
            try {
                addProductRow();
                console.log('‚úÖ Product row added via Tab key');
            } catch (error) {
                console.error('‚ùå Error adding product row via Tab:', error);
            }
        }
    });
    
    // Ensure button styling
    newBtn.style.cssText = `
        background: linear-gradient(45deg, #28a745, #20c997) !important;
        border: none !important;
        color: white !important;
        padding: 0.375rem 1rem !important;
        border-radius: 0.375rem !important;
        font-weight: 500 !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        min-height: 38px !important;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2) !important;
        cursor: pointer !important;
        text-decoration: none !important;
        transition: all 0.3s ease !important;
    `;
    
    console.log('‚úÖ Add product button setup complete');
}

// Primary DOM Content Loaded handler
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM Content Loaded');
    initializePage();
});

// Fallback: Window load handler
window.addEventListener('load', function() {
    console.log('üñºÔ∏è Window fully loaded');
    if (!isPageReady) {
        initializePage();
    }
});

// Additional fallback with timeout
setTimeout(function() {
    console.log('‚è∞ Timeout fallback triggered');
    if (!isPageReady) {
        console.log('‚ö†Ô∏è Page not ready, forcing initialization...');
        initializePage();
    }
}, 1000);

// Enhanced addProductRow function

function addProductRow() {
    console.log('{% trans "Starting addProductRow execution..." %}');
    
    try {
        productRowCounter++;
        console.log('{% trans "Row counter:" %}', productRowCounter);
        
        const tbody = document.getElementById('productsTableBody');
        if (!tbody) {
            console.error('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ {% trans "Table" %} ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™');
            alert("{% trans 'Error: Products table not found' %}");
            return;
        }
        
        console.log('{% trans "Products table found, creating new row..." %}');
        
        const row = document.createElement('tr');
        row.id = `productRow${productRowCounter}`;
        row.innerHTML = `
        <td>
            <input type="hidden" name="products[]" class="product-id-input">
            <input type="hidden" name="tax_rates[]" class="tax-rate-hidden-input">
            <input type="hidden" name="tax_amounts[]" class="tax-amount-hidden-input">
            <div class="d-flex align-items-center">
                <div class="position-relative flex-grow-1 me-2">
                    <input type="text" class="form-control product-code-input" 
                           placeholder="{% trans 'Product code...' %}" autocomplete="off">
                    <div class="product-code-dropdown dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                        <!-- Product code options will be populated here -->
                    </div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="openProductModal(${productRowCounter})">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </td>
        <td>
            <div class="position-relative">
                <input type="text" class="form-control product-name-input" 
                       placeholder="{% trans 'Type product name...' %}" autocomplete="off">
                <div class="product-dropdown dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                    <!-- Product options will be populated here -->
                </div>
            </div>
        </td>
        <td>
            <input type="text" class="form-control text-center available-quantity-input" 
                   placeholder="0.000" readonly style="background-color: #e9ecef;" tabindex="-1">
        </td>
        <td>
            <input type="number" class="form-control quantity-input" 
                   name="quantities[]" min="0.001" value="1.000" step="0.001">
        </td>
        <td>
            <input type="number" class="form-control price-input" 
                   name="prices[]" min="0" step="0.001">
        </td>
        <td>
            <input type="number" class="form-control tax-rate-input" 
                   min="0" max="100" step="0.01" value="0" readonly style="background-color: #e9ecef;" tabindex="-1">
        </td>
        <td>
            <input type="text" class="form-control tax-amount-input" readonly style="background-color: #e9ecef;" tabindex="-1">
        </td>
        <td>
            <input type="text" class="form-control total-input" readonly style="background-color: #e9ecef;" tabindex="-1">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-remove-product" onclick="removeProductRow(${productRowCounter})" title="{% trans "Delete" %}">
                <i class="fas fa-times"></i>
            </button>
        </td>
    `;
    
    console.log('{% trans "Row content created, adding to table..." %}');
    tbody.appendChild(row);
    console.log('{% trans "Row added to table successfully" %}');
    
    // Attach event listeners to the new row
    console.log('{% trans "Attaching events to new row..." %}');
    attachRowEventListeners(row);
    console.log('{% trans "addProductRow completed successfully" %}');
    
    // ÿ™ÿ±ŸÉŸäÿ≤ ÿßŸÑŸÖÿ§ÿ¥ÿ± ÿπŸÑŸâ ÿÆÿßŸÜÿ© ÿ±ŸÖÿ≤ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸä ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ¨ÿØŸäÿØ
    setTimeout(function() {
        const newCodeInput = row.querySelector('.product-code-input');
        if (newCodeInput) {
            newCodeInput.focus();
            console.log('‚úÖ Focus set on product code input for new row');
        }
    }, 100);
    
    // ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑŸÅÿßÿ±ÿ∫ÿ© ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ¨ÿØŸàŸÑ ŸÖÿπ ŸÉŸÑ ÿµŸÅ ÿ¨ÿØŸäÿØ
    const productsTable = document.querySelector('.products-table');
    if (productsTable) {
        const currentPadding = parseInt(window.getComputedStyle(productsTable).paddingBottom) || 50;
        const newPadding = currentPadding + 20; // ÿ≤ŸäÿßÿØÿ© 20px ŸÖÿπ ŸÉŸÑ ÿµŸÅ ÿ¨ÿØŸäÿØ
        productsTable.style.paddingBottom = newPadding + 'px';
        console.log('‚úÖ Increased table bottom padding to:', newPadding + 'px');
    }
    
    // Mark as having unsaved changes
    hasUnsavedChanges = true;
    
    } catch (error) {
    console.error('{% trans "Error in addProductRow:" %}', error);
    alert("{% trans 'Error while adding product row' %}: " + (error && error.message ? error.message : ''));
        // {% trans "Restore counter in case of error" %}
        if (productRowCounter > 0) {
            productRowCounter--;
        }
    }
}

function removeProductRow(rowId) {
    const row = document.getElementById(`productRow${rowId}`);
    if (row) {
        // Check if this is the last row
        const allRows = document.querySelectorAll('#productsTableBody tr');
        if (allRows.length <= 1) {
            alert("{% trans 'Invoice must contain at least one product' %}");
            return;
        }
        
        row.remove();
        calculateGrandTotal();
        
        // ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑŸÅÿßÿ±ÿ∫ÿ© ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ¨ÿØŸàŸÑ ÿπŸÜÿØ ÿ≠ÿ∞ŸÅ ÿµŸÅ
        const productsTable = document.querySelector('.products-table');
        if (productsTable) {
            const currentPadding = parseInt(window.getComputedStyle(productsTable).paddingBottom) || 50;
            const newPadding = Math.max(50, currentPadding - 20); // ÿ™ŸÇŸÑŸäŸÑ 20pxÿå ŸÑŸÉŸÜ ŸÑÿß ÿ™ŸÇŸÑ ÿπŸÜ 50px
            productsTable.style.paddingBottom = newPadding + 'px';
            console.log('‚úÖ Decreased table bottom padding to:', newPadding + 'px');
        }
    }
}

function openProductModal(rowId) {
    currentRow = rowId;
    const modal = new bootstrap.Modal(document.getElementById('productModal'));
    modal.show();
}

function selectProduct(productId, productCode, productName, salePrice, taxRate, availableQuantity) {
    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ ÿ£ŸàŸÑÿßŸã
    const warehouseSelect = document.getElementById('id_warehouse');
    if (!warehouseSelect || !warehouseSelect.value) {
        alert('{% trans "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ ÿ£ŸàŸÑÿßŸã ŸÇÿ®ŸÑ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨" %}');
        return;
    }
    
    // Use POS product endpoint as authoritative source for sale price when available.
    try {
        if (!currentRow) return;
        const row = document.getElementById(`productRow${currentRow}`);
        if (!row) return;

        const productIdInput = row.querySelector('.product-id-input');
        const codeInput = row.querySelector('.product-code-input');
        const nameInput = row.querySelector('.product-name-input');
        const availableQuantityInput = row.querySelector('.available-quantity-input');
        const priceInput = row.querySelector('.price-input');
        const taxRateInput = row.querySelector('.tax-rate-input');

        // Fill the product basic information first
        productIdInput.value = productId;
        codeInput.value = productCode;
        nameInput.value = productName;
        if (availableQuantityInput) {
            availableQuantityInput.value = formatCurrency(parseFloat(availableQuantity || 0), 3);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπ ÿßŸÑŸÖÿÆÿ™ÿßÿ±
        const warehouseSelect = document.getElementById('id_warehouse');
        if (warehouseSelect && warehouseSelect.value) {
            fetch(`/ar/sales/api/product-stock/${productId}/${warehouseSelect.value}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.stock !== undefined) {
                        availableQuantityInput.value = formatCurrency(parseFloat(data.stock), 3);
                        // ÿ•ÿ∞ÿß ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ 0 ÿ£Ÿà ÿ£ŸÇŸÑÿå ÿ£ÿ∂ŸÅ ÿ™ÿ≠ÿ∞Ÿäÿ±ÿßŸã ÿ®ÿµÿ±ŸäÿßŸã
                        if (parseFloat(data.stock) <= 0) {
                            row.classList.add('stock-warning');
                        } else {
                            row.classList.remove('stock-warning');
                        }
                    }
                })
                .catch(error => console.error('Error fetching stock:', error));
        }

        // Helper to apply a numeric price into the input with attributes
        function applyPrice(displayedPrice, source) {
            const valid = (displayedPrice === null || displayedPrice === undefined || displayedPrice === '') ? NaN : Number(displayedPrice);
            const finalVal = Number.isFinite(valid) ? valid : 0;
            priceInput.value = formatCurrency(finalVal, 3);
            priceInput.setAttribute('data-original-price', priceInput.value);
            if (source) priceInput.setAttribute('data-price-source', source);
        }

        // Calculate displayed price for template salePrice
        const templateDisplayedPrice = (() => {
            const price = parseFloat(salePrice) || 0;
            const currentTaxRate = parseFloat(taxRate) || 0;
            return currentTaxRate > 0 ? price / (1 + currentTaxRate / 100) : price;
        })();

        // First use the calculated displayed price from template
        applyPrice(templateDisplayedPrice, 'template');

        // Then try to fetch authoritative product data from POS endpoint
        try {
            const endpoint = `/sales/pos/product/${encodeURIComponent(productId)}/`;
            fetch(endpoint, { credentials: 'same-origin' })
                .then(response => response.json())
                .then(data => {
                    if (data && data.success && data.product) {
                        const posPrice = parseFloat(data.product.price);
                        if (Number.isFinite(posPrice)) {
                            // If POS price differs from current by more than a tiny delta, use POS price
                            const current = parseFloat(priceInput.value) || 0;
                            if (Math.abs(current - posPrice) > 0.0001) {
                                applyPrice(posPrice, 'pos');
                                console.info(`selectProduct: price for product ${productId} taken from POS endpoint: ${posPrice}`);
                            } else {
                                // still mark source
                                priceInput.setAttribute('data-price-source', 'pos');
                            }
                        } else {
                            console.warn('{% trans "POS endpoint returned invalid price for product" %}', productId, data.product.price);
                        }

                        // tax rate from POS if available, otherwise use template value
                        taxRateInput.value = parseFloat(data.product.tax_rate || taxRate) || 0;
                    } else {
                        // POS endpoint did not return product data; fall back to passed values
                        taxRateInput.value = parseFloat(taxRate) || 0;
                        console.warn('{% trans "POS product endpoint did not return product data, using template values" %}', productId);
                    }

                    // Close modal and recalc totals
                    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    if (modal) modal.hide();
                    calculateRowTotal(row);
                    calculateGrandTotal();
                    
                    // Focus on quantity input
                    const quantityInput = row.querySelector('.quantity-input');
                    if (quantityInput) {
                        quantityInput.focus();
                    }
                })
                .catch(err => {
                    // On network error or other fetch failure, keep template price and log warning
                    taxRateInput.value = parseFloat(taxRate) || 0;
                    console.warn('{% trans "Failed to fetch POS product data, using template sale price" %}', err);

                    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    if (modal) modal.hide();
                    calculateRowTotal(row);
                    calculateGrandTotal();
                });
        } catch (e) {
            // If constructing/fetching fails, ensure we still close modal and calculate totals
            taxRateInput.value = parseFloat(taxRate) || 0;
            const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
            if (modal) modal.hide();
            calculateRowTotal(row);
            calculateGrandTotal();
        }

        // Defensive check after a short delay: if something else overwrote the price programmatically, revert
        setTimeout(() => {
            try {
                const currentPrice = parseFloat(priceInput.value) || 0;
                const original = parseFloat(priceInput.getAttribute('data-original-price')) || 0;
                if (Math.abs(currentPrice - original) > 0.0001) {
                    console.warn(`Price for product ${productId} at row ${currentRow} was changed programmatically from ${original} to ${currentPrice}`);
                    setTimeout(() => {
                        try {
                                if (document.activeElement !== priceInput) {
                                priceInput.value = formatCurrency(original, 3);
                                calculateRowTotal(row);
                                calculateGrandTotal();
                                console.info(`Price at row ${currentRow} reverted to original sale price ${original}`);
                            } else {
                                console.info(`User is editing price at row ${currentRow}, not reverting`);
                            }
                        } catch (err) {
                            console.error('Error during price revert check:', err);
                        }
                    }, 150);
                }
            } catch (err) {
                console.error('Error verifying price overwrite:', err);
            }
        }, 250);

    } catch (e) {
        console.error('selectProduct error:', e);
    }
}

function attachRowEventListeners(row) {
    const quantityInput = row.querySelector('.quantity-input');
    const priceInput = row.querySelector('.price-input');
    const taxRateInput = row.querySelector('.tax-rate-input');
    const totalInput = row.querySelector('.total-input');
    
    // Calculate totals on quantity/price/tax rate change
    quantityInput.addEventListener('input', function() {
        calculateRowTotal(row);
        calculateGrandTotal();
    });
    
    priceInput.addEventListener('input', function() {
        calculateRowTotal(row);
        calculateGrandTotal();
    });
    
    taxRateInput.addEventListener('input', function() {
        calculateRowTotal(row);
        calculateGrandTotal();
    });
    
    // ÿ•ÿ≤ÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿµŸÅ ÿ¨ÿØŸäÿØ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ Tab
    // if (priceInput) {
    //     priceInput.addEventListener('keydown', function(e) {
    //         if (e.key === 'Tab') {
    //             e.preventDefault();
    //             addProductRow();
    //         }
    //     });
    // }
}

function calculateRowTotal(row) {
    const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
    const priceInput = parseFloat(row.querySelector('.price-input').value) || 0;
    const taxRate = parseFloat(row.querySelector('.tax-rate-input').value) || 0;
    
    // {% trans "Check inclusive tax status" %}
    const isInclusiveTax = document.getElementById('id_inclusive_tax').checked;
    
    let taxAmount, total, actualUnitPrice;
    
    if (isInclusiveTax && taxRate > 0) {
        // {% trans "If tax is inclusive: User enters price WITH tax, we need to extract base price" %}
        // {% trans "Entered price includes tax, so: Base Price = Entered Price √∑ (1 + Tax Rate)" %}
        actualUnitPrice = priceInput / (1 + (taxRate / 100));
        
        // {% trans "Calculate base total (quantity √ó base price)" %}
        const baseTotal = quantity * actualUnitPrice;
        
        // {% trans "Tax amount = Base total √ó Tax rate" %}
        taxAmount = baseTotal * (taxRate / 100);
        
        // {% trans "Total = quantity √ó entered price (price WITH tax)" %}
        total = quantity * priceInput;
    } else if (isInclusiveTax && taxRate === 0) {
        // {% trans "If tax is inclusive but rate is 0, price remains as entered" %}
        actualUnitPrice = priceInput;
        taxAmount = 0;
        total = quantity * priceInput;
    } else {
        // {% trans "If tax is not inclusive: No tax, price remains as entered" %}
        actualUnitPrice = priceInput;
        taxAmount = 0;
        total = quantity * priceInput;
    }
    
    // {% trans "Display results" %}
    row.querySelector('.tax-amount-input').value = formatCurrency(taxAmount);
    row.querySelector('.total-input').value = formatCurrency(total);
    
    // {% trans "Store the actual unit price (base price without tax) for backend processing" %}
    if (!row.querySelector('.actual-unit-price-hidden')) {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.className = 'actual-unit-price-hidden';
        row.appendChild(hiddenInput);
    }
    row.querySelector('.actual-unit-price-hidden').value = actualUnitPrice;
    
    // {% trans "Update hidden fields" %}
    if (row.querySelector('.tax-rate-hidden-input')) {
        row.querySelector('.tax-rate-hidden-input').value = taxRate;
    }
    if (row.querySelector('.tax-amount-hidden-input')) {
        row.querySelector('.tax-amount-hidden-input').value = formatCurrency(taxAmount);
    }
}

function calculateGrandTotal() {
    let subtotal = 0;
    let totalTax = 0;
    
    // {% trans "Check inclusive tax status" %}
    const isInclusiveTax = document.getElementById('id_inclusive_tax').checked;
    
    // {% trans "Sum totals from all rows" %}
    document.querySelectorAll('#productsTableBody tr').forEach(row => {
        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
        const priceInput = parseFloat(row.querySelector('.price-input').value) || 0;
        const taxRate = parseFloat(row.querySelector('.tax-rate-input').value) || 0;
        
        if (quantity > 0 && priceInput > 0) {
            if (isInclusiveTax && taxRate > 0) {
                // {% trans "If tax is inclusive: Extract base price from entered price" %}
                const actualUnitPrice = priceInput / (1 + (taxRate / 100));
                const baseTotal = quantity * actualUnitPrice;
                const taxAmount = baseTotal * (taxRate / 100);
                
                subtotal += baseTotal;
                totalTax += taxAmount;
            } else {
                // {% trans "If tax is not inclusive or rate is 0: No tax" %}
                const rowSubtotal = quantity * priceInput;
                
                subtotal += rowSubtotal;
                totalTax += 0;
            }
        }
    });
    
    const discount = parseFloat(document.getElementById('id_discount').value) || 0;
    
    // {% trans "Calculate final total" %}
    const finalTotal = subtotal + totalTax - discount;
    
    // {% trans "Update display" %}
    document.getElementById('subtotalDisplay').textContent = formatCurrency(subtotal) + ' {% get_currency_symbol %}';
    document.getElementById('discountDisplay').textContent = formatCurrency(discount) + ' {% get_currency_symbol %}';
    document.getElementById('taxDisplay').textContent = formatCurrency(totalTax) + ' {% get_currency_symbol %}';
    document.getElementById('totalDisplay').textContent = formatCurrency(finalTotal) + ' {% get_currency_symbol %}';
}

// Search in products modal
document.getElementById('productSearch').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#productList tr');
    
    rows.forEach(row => {
        const productCode = row.cells[0].textContent.toLowerCase();
        const productName = row.cells[1].textContent.toLowerCase();
        const productDescription = row.cells[2].textContent.toLowerCase();
        
        if (productCode.includes(searchTerm) || productName.includes(searchTerm) || 
            productDescription.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Handle Enter key in product search to select first visible product
document.getElementById('productSearch').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        console.log('üîç Enter pressed in product search modal');
        
        // Find the first visible product row
        const visibleRows = Array.from(document.querySelectorAll('#productList tr')).filter(row => 
            row.style.display !== 'none'
        );
        
        console.log(`üìã Found ${visibleRows.length} visible products`);
        
        if (visibleRows.length > 0) {
            const firstRow = visibleRows[0];
            const selectButton = firstRow.querySelector('button[onclick*="selectProduct"]');
            
            if (selectButton) {
                console.log('‚úÖ Found select button, extracting product data...');
                
                // Simply click the button instead of trying to extract and call manually
                selectButton.click();
                console.log('‚úÖ Button clicked programmatically');
            } else {
                console.error('‚ùå No select button found in first row');
            }
        } else {
            console.warn('‚ö†Ô∏è No visible products found');
        }
    }
});

// Calculate totals when discount changes
document.getElementById('id_discount').addEventListener('input', calculateGrandTotal);

// Calculate totals when inclusive tax checkbox changes
document.getElementById('id_inclusive_tax').addEventListener('change', function() {
    // ÿ•ÿπÿßÿØÿ© ÿ≠ÿ≥ÿßÿ® ÿ¨ŸÖŸäÿπ ÿßŸÑÿµŸÅŸàŸÅ ÿπŸÜÿØ ÿ™ÿ∫ŸäŸäÿ± ÿ≠ÿßŸÑÿ© "ÿ¥ÿßŸÖŸÑ ÿ∂ÿ±Ÿäÿ®ÿ©"
    document.querySelectorAll('#productsTableBody tr').forEach(row => {
        calculateRowTotal(row);
    });
    calculateGrandTotal();
});

// Form validation
document.getElementById('salesInvoiceForm').addEventListener('submit', function(e) {
    const productRows = document.querySelectorAll('#productsTableBody tr');
    let hasValidProducts = false;
    
    // {% trans "Check for valid products" %}
    productRows.forEach(row => {
        const productId = row.querySelector('.product-id-input').value;
        const quantity = row.querySelector('.quantity-input').value;
        const price = row.querySelector('.price-input').value;
        
        if (productId && quantity && price && parseFloat(quantity) > 0 && parseFloat(price) >= 0) {
            hasValidProducts = true;
        }
    });
    
    if (!hasValidProducts) {
        e.preventDefault();
        alert("{% trans 'Please add at least one product with valid quantity and price' %}");
        return;
    }
    
    // {% trans "Check customer" %}
    const customer = document.getElementById('id_customer').value;
    if (!customer) {
    e.preventDefault();
    alert("{% trans 'Please select a customer' %}");
        return;
    }
    
    // {% trans "Check payment type" %}
    const paymentType = document.getElementById('id_payment_type').value;
    if (!paymentType) {
    e.preventDefault();
    alert("{% trans 'Please select a payment method' %}");
        return;
    }
    
    // {% trans "Check cashbox for cash payments" %}
    if (paymentType === 'cash') {
        const cashbox = document.getElementById('id_cashbox').value;
        if (!cashbox) {
            e.preventDefault();
            alert("{% trans 'Cash Box is required for cash payments' %}");
            return;
        }
    }
    
    // {% trans "Check invoice date" %}
    const invoiceDate = document.getElementById('id_date').value;
    if (!invoiceDate) {
    e.preventDefault();
    alert("{% trans 'Please select the invoice date' %}");
        return;
    }
});

// {% trans "Customer window management functions" %}
function openNewCustomerModal() {
    console.log('{% trans "Open new customer window" %}');
    const modal = document.getElementById('newCustomerModal');
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
}

function saveNewCustomer() {
    console.log('{% trans "Start saving new customer" %}');
    const form = document.getElementById('newCustomerForm');
    const formData = new FormData(form);
    
    // {% trans "Add CSRF token" %}
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    console.log('{% trans "Sending data to server..." %}');
    
    fetch('{% url "customers:ajax_add_customer" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        console.log('{% trans "Server response:" %}', response.status, response.statusText);
        console.log('{% trans "Response headers:" %}', response.headers);
        return response.text().then(text => {
            console.log('{% trans "Raw response text:" %}', text);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText} - ${text}`);
            }
            try {
                return JSON.parse(text);
            } catch (e) {
                throw new Error(`Invalid JSON response: ${text}`);
            }
        });
    })
    .then(data => {
        console.log('{% trans "Parsed data:" %}', data);
        if (data.success) {
            console.log('{% trans "Success: Customer created" %}', data.customer);
            try {
                // {% trans "Add new customer to list" %}
                const customerSelect = document.getElementById('id_customer');
                const customerSearch = document.getElementById('customer_search');
                
                if (!customerSelect) {
                    console.error('{% trans "Customer select not found" %}');
                    return;
                }
                
                // Add to select dropdown
                const newOption = new Option(data.customer.name, data.customer.id, true, true);
                customerSelect.add(newOption);
                customerSelect.value = data.customer.id;
                
                // Add to customers array for search functionality
                if (typeof customers !== 'undefined') {
                    customers.push({
                        id: data.customer.id,
                        name: data.customer.name
                    });
                    console.log('{% trans "Customer added to search array" %}', customers.length, 'customers');
                }
                
                // Update search input
                if (customerSearch) {
                    customerSearch.value = data.customer.name;
                }
                
                // Trigger change event for balance update
                customerSelect.dispatchEvent(new Event('change'));
                
                // {% trans "Close window and reset form" %}
                const modal = bootstrap.Modal.getInstance(document.getElementById('newCustomerModal'));
                if (modal) {
                    modal.hide();
                }
                form.reset();
                
                alert("{% trans 'Customer created successfully!' %}");
                console.log("{% trans 'Customer saved successfully' %}");
            } catch (jsError) {
                console.error('{% trans "JavaScript error after success:" %}', jsError);
                alert("{% trans 'Customer created but there was an error updating the form. Please refresh the page.' %}");
            }
        } else {
            console.error('{% trans "Server error:" %}', data.message);
            alert('{% trans "Error" %}: ' + (data.message || '{% trans "An error occurred while creating the customer" %}'));
        }
    })
    .catch(error => {
        console.error('{% trans "Network error:" %}', error);
        // Try to parse error response if it's JSON
        if (error.response && error.response.json) {
            error.response.json().then(errData => {
                alert('{% trans "Error" %}: ' + (errData.message || '{% trans "An error occurred while creating the customer" %}'));
            }).catch(() => {
                alert('{% trans "An error occurred while creating the customer. Please try again." %}');
            });
        } else {
            alert('{% trans "An error occurred while creating the customer. Please try again." %}');
        }
    });
    }

// {% trans "Function to update customer balance" %}
function updateCustomerBalance() {
    const customerSelect = document.getElementById('id_customer');
    const balanceInfo = document.getElementById('customer-balance-info');
    const balanceAmount = document.getElementById('customer-balance-amount');
    
    if (!customerSelect.value) {
        balanceInfo.style.display = 'none';
        return;
    }
    
    // {% trans "Call API to get customer information" %}
    const apiUrl = `/customers/api/customer/${customerSelect.value}/`;
    
    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('{% trans "Error getting customer data:" %}', data.error);
                balanceInfo.style.display = 'none';
                return;
            }
            
            // {% trans "Get currency information from company" %}
            fetch('/settings/api/currency/')
                .then(currResponse => currResponse.json())
                .then(currencyData => {
                    // {% trans "View current balance" %}
                    const balance = parseFloat(data.current_balance);
                    const balanceText = balance.toLocaleString('ar-SA', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    // {% trans "Use company settings currency" %}
                    let currencyText = '';
                    if (currencyData.show_symbol && currencyData.symbol) {
                        currencyText = currencyData.symbol;
                    } else {
                        currencyText = currencyData.code || '{% get_currency_symbol %}';
                    }
                    
                    balanceAmount.textContent = balanceText + ' ' + currencyText;
                    
                    // {% trans "Change text color based on balance" %}
                    if (balance > 0) {
                        balanceAmount.className = 'fw-bold text-success';
                    } else if (balance < 0) {
                        balanceAmount.className = 'fw-bold text-danger';
                    } else {
                        balanceAmount.className = 'fw-bold text-muted';
                    }
                    
                    balanceInfo.style.display = 'block';
                })
                .catch(currError => {
                    console.error('{% trans "Error getting currency data:" %}', currError);
                    // {% trans "In case of failed currency retrieval, use default currency" %}
                    const balance = parseFloat(data.current_balance);
                    const balanceText = balance.toLocaleString('ar-SA', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    
                    balanceAmount.textContent = balanceText + ' ÿ±.ÿ≥';
                    
                    if (balance > 0) {
                        balanceAmount.className = 'fw-bold text-success';
                    } else if (balance < 0) {
                        balanceAmount.className = 'fw-bold text-danger';
                    } else {
                        balanceAmount.className = 'fw-bold text-muted';
                    }
                    
                    balanceInfo.style.display = 'block';
                });
        })
        .catch(error => {
            console.error('{% trans "Network error:" %}', error);
            balanceInfo.style.display = 'none';
        });
}

// {% trans "Link event to customer change" %}
document.getElementById('id_customer').addEventListener('change', updateCustomerBalance);
</script>

<!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿπŸÖŸäŸÑ {% trans "New" %} -->
<div class="modal fade" id="newCustomerModal" tabindex="-1" aria-labelledby="newCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="newCustomerModalLabel">
                    <i class="fas fa-user-plus me-2"></i>{% trans "Add" %} {% trans "Customer" %} {% trans "New" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newCustomerForm">
                    {% csrf_token %}
                    
                    <!-- Basic Information -->
                    <div class="form-section mb-4" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; background: #f8f9fa;">
                        <h6 class="section-title" style="color: #495057; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e9ecef;">
                            <i class="fas fa-info-circle me-2"></i>{% trans "Basic Information" %}
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{% trans "Full Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required>
                                <div class="form-text">{% trans "Customer Name or Supplier Name as it appears in invoices" %}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{% trans "Phone Number" %}</label>
                                <input type="tel" class="form-control" name="phone">
                                <div class="form-text">{% trans "Primary phone number for communication" %}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{% trans "Email" %}</label>
                                <input type="email" class="form-control" name="email">
                                <div class="form-text">{% trans "Email for sending invoices and reports" %}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{% trans "Tax Number" %}</label>
                                <input type="text" class="form-control" name="tax_number">
                                <div class="form-text">{% trans "Registered tax number for company or individual" %}</div>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">{% trans "Address" %}</label>
                                <textarea class="form-control" name="address" rows="3"></textarea>
                                <div class="form-text">{% trans "Complete address for customer or supplier" %}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{% trans "City" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="city" required>
                                <div class="form-text">{% trans "City where the customer or supplier is located" %}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Information -->
                    <div class="form-section mb-4" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; background: #f8f9fa;">
                        <h6 class="section-title" style="color: #495057; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e9ecef;">
                            <i class="fas fa-money-bill-wave me-2"></i>{% trans "Financial Information" %}
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{% trans "Credit Limit" %}</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% get_currency_symbol %}</span>
                                    <input type="number" class="form-control" name="credit_limit" 
                                           value="0" step="0.001" min="0">
                                </div>
                                <div class="form-text">{% trans "Maximum amount the customer can owe" %}</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{% trans "Initial Balance" %}</label>
                                <div class="input-group">
                                    <span class="input-group-text">{% get_currency_symbol %}</span>
                                    <input type="number" class="form-control" name="balance" 
                                           value="0" step="0.001">
                                </div>
                                <div class="form-text">{% trans "ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßŸÅÿ™ÿ™ÿßÿ≠Ÿä (ŸÖŸàÿ¨ÿ®: ÿßŸÑÿπŸÖŸäŸÑ ŸÖÿØŸäŸÜ ŸÑŸÑÿ¥ÿ±ŸÉÿ©ÿå ÿ≥ÿßŸÑÿ®: ÿßŸÑÿ¥ÿ±ŸÉÿ© ŸÖÿØŸäŸÜÿ© ŸÑŸÑÿπŸÖŸäŸÑ)" %}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="form-section mb-3" style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; background: #f8f9fa;">
                        <h6 class="section-title" style="color: #495057; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e9ecef;">
                            <i class="fas fa-sticky-note me-2"></i>{% trans "Additional Information" %}
                        </h6>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">{% trans "Notes" %}</label>
                                <textarea class="form-control" name="notes" rows="3"></textarea>
                                <div class="form-text">{% trans "Any notes or additional information" %}</div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="customerIsActive" checked>
                                    <label class="form-check-label" for="customerIsActive">
                                        {% trans "Active Account" %}
                                    </label>
                                    <div class="form-text">{% trans "Deactivating hides the account from lists" %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <input type="hidden" name="type" value="customer">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>{% trans "Cancel" %}
                </button>
                <button type="button" class="btn btn-success" onclick="saveNewCustomer()">
                    <i class="fas fa-save me-2"></i>{% trans "Save Account" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Critical JavaScript - Load After Content -->
<script>
// Final styling enforcement - runs after everything else
function enforceButtonStyling() {
    const addBtn = document.getElementById('addProductBtn');
    if (addBtn) {
        // Force styling with maximum priority
        const criticalStyles = {
            'background': 'linear-gradient(45deg, #28a745, #20c997)',
            'border': 'none',
            'color': 'white',
            'padding': '0.375rem 1rem',
            'border-radius': '0.375rem',
            'font-weight': '500',
            'display': 'inline-flex',
            'align-items': 'center',
            'justify-content': 'center',
            'min-height': '38px',
            'box-shadow': '0 2px 8px rgba(40, 167, 69, 0.2)',
            'cursor': 'pointer',
            'text-decoration': 'none',
            'transition': 'all 0.3s ease'
        };
        
        // Apply each style with !important
        Object.entries(criticalStyles).forEach(([property, value]) => {
            addBtn.style.setProperty(property, value, 'important');
        });
        
        console.log('üé® Final button styling enforced');
    }
}

// Run styling enforcement multiple times
document.addEventListener('DOMContentLoaded', function() {
    enforceButtonStyling();
    setTimeout(enforceButtonStyling, 100);
    setTimeout(enforceButtonStyling, 500);
    setTimeout(enforceButtonStyling, 1000);
    setTimeout(enforceButtonStyling, 2000);
});

// Also enforce on window load
window.addEventListener('load', function() {
    setTimeout(enforceButtonStyling, 100);
    setTimeout(enforceButtonStyling, 500);
});

// Continuous monitoring for styling
setInterval(function() {
    const addBtn = document.getElementById('addProductBtn');
    if (addBtn) {
        const computedStyle = window.getComputedStyle(addBtn);
        const bgColor = computedStyle.backgroundColor;
        
        // Check if button lost its green styling
        if (!bgColor.includes('rgb(40, 167, 69)') && !bgColor.includes('rgb(32, 201, 151)')) {
            console.log('üîß Re-applying button styling...');
            enforceButtonStyling();
        }
    }
}, 2000);

console.log('üöÄ Critical JavaScript loaded and monitoring started');
</script>

<!-- Customer Search and Filter JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerSearch = document.getElementById('customer_search');
    const customerSelect = document.getElementById('id_customer');
    const customerDropdown = document.getElementById('customer-dropdown');
    
    // Store customer data
    const customers = [
        {% for customer in customers %}
        {id: {{ customer.id }}, name: "{{ customer.name|escapejs }}"},
        {% endfor %}
    ];
    
    if (customerSearch && customerSelect && customerDropdown) {
        // Function to filter and show customers
        function filterCustomers() {
            const searchTerm = customerSearch.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                customerDropdown.style.display = 'none';
                return;
            }
            
            // Clear previous options
            customerDropdown.innerHTML = '';
            
            // Filter customers
            const filteredCustomers = customers.filter(customer => 
                customer.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredCustomers.length === 0) {
                customerDropdown.style.display = 'none';
                return;
            }
            
            // Create dropdown options
            filteredCustomers.forEach(customer => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'dropdown-item';
                option.textContent = customer.name;
                option.setAttribute('data-id', customer.id);
                
                option.addEventListener('click', function() {
                    customerSearch.value = customer.name;
                    customerSelect.value = customer.id;
                    customerDropdown.style.display = 'none';
                    // Trigger change event for balance update
                    customerSelect.dispatchEvent(new Event('change'));
                });
                
                customerDropdown.appendChild(option);
            });
            
            customerDropdown.style.display = 'block';
        }
        
        // Handle input changes
        customerSearch.addEventListener('input', filterCustomers);
        
        // Handle focus to show all customers if empty
        customerSearch.addEventListener('focus', function() {
            if (customerSearch.value.trim() === '') {
                // Show all customers
                customerDropdown.innerHTML = '';
                customers.forEach(customer => {
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'dropdown-item';
                    option.textContent = customer.name;
                    option.setAttribute('data-id', customer.id);
                    
                    option.addEventListener('click', function() {
                        customerSearch.value = customer.name;
                        customerSelect.value = customer.id;
                        customerDropdown.style.display = 'none';
                        // Trigger change event for balance update
                        customerSelect.dispatchEvent(new Event('change'));
                    });
                    
                    customerDropdown.appendChild(option);
                });
                customerDropdown.style.display = 'block';
            }
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!customerSearch.contains(e.target) && !customerDropdown.contains(e.target)) {
                customerDropdown.style.display = 'none';
            }
        });
        
        // Handle blur with delay to allow click on dropdown items
        customerSearch.addEventListener('blur', function() {
            setTimeout(() => {
                if (customerSearch.value && !customerSelect.value) {
                    // If user typed something but didn't select from dropdown, clear it
                    customerSearch.value = '';
                    customerSelect.value = '';
                }
            }, 200);
        });
        
        // Update search input when select changes (e.g., from new customer modal)
        customerSelect.addEventListener('change', function() {
            if (customerSelect.value) {
                const selectedOption = customerSelect.querySelector('option[value="' + customerSelect.value + '"]');
                if (selectedOption) {
                    customerSearch.value = selectedOption.textContent;
                }
            } else {
                customerSearch.value = '';
            }
        });
    }
});
</script>

<!-- Product Name Search and Filter JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Store product data
    const products = [
        {% for product in products %}
        {
            id: '{{ product.id }}',
            code: '{{ product.code|escapejs }}',
            name: '{{ product.name|escapejs }}',
            description: '{{ product.description|escapejs|truncatechars:50|default:"No description available"|escapejs }}',
            sale_price: '{{ product.sale_price }}',
            tax_rate: '{{ product.tax_rate }}',
            current_stock: '{{ product.current_stock }}'
        },
        {% endfor %}
    ];

    // Function to handle product search for each row
    function setupProductSearch(row) {
        const nameInput = row.querySelector('.product-name-input');
        const dropdown = row.querySelector('.product-dropdown');
        const productIdInput = row.querySelector('.product-id-input');
        const codeInput = row.querySelector('.product-code-input');
        const availableQuantityInput = row.querySelector('.available-quantity-input');
        const priceInput = row.querySelector('.price-input');
        const taxRateInput = row.querySelector('.tax-rate-input');

        if (!nameInput || !dropdown) return;

        // Function to filter and show products
        function filterProducts() {
            const searchTerm = nameInput.value.toLowerCase().trim();

            if (searchTerm === '') {
                dropdown.style.display = 'none';
                return;
            }

            // Clear previous options
            dropdown.innerHTML = '';

            // Filter products
            const filteredProducts = products.filter(product =>
                product.name.toLowerCase().includes(searchTerm) ||
                product.code.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );

            if (filteredProducts.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            // Create dropdown options
            filteredProducts.forEach(product => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'dropdown-item';
                option.textContent = product.name;
                option.setAttribute('data-id', product.id);
                
                option.addEventListener('click', function() {
                    // Fill all product fields
                    productIdInput.value = product.id;
                    codeInput.value = product.code;
                    nameInput.value = product.name;
                    if (availableQuantityInput) {
                        availableQuantityInput.value = formatCurrency(parseFloat(product.current_stock || 0), 3);
                    }
                    
                    // Calculate displayed price as sale_price / (1 + tax_rate/100)
                    const salePrice = parseFloat(product.sale_price || 0);
                    const taxRate = parseFloat(product.tax_rate || 0);
                    const displayedPrice = taxRate > 0 ? salePrice / (1 + taxRate / 100) : salePrice;
                    
                    priceInput.value = formatCurrency(displayedPrice, 3);
                    taxRateInput.value = parseFloat(product.tax_rate) || 0;

                    dropdown.style.display = 'none';

                    // Calculate row total
                    const row = nameInput.closest('tr');
                    if (row) {
                        calculateRowTotal(row);
                        calculateGrandTotal();
                    }
                });

                dropdown.appendChild(option);
            });

            dropdown.style.display = 'block';
        }

        // Handle input changes
        nameInput.addEventListener('input', filterProducts);

        // Handle keyboard navigation (Arrow keys and Enter)
        nameInput.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.dropdown-item');
            if (items.length === 0) return;

            let currentIndex = -1;
            items.forEach((item, index) => {
                if (item.classList.contains('active')) {
                    currentIndex = index;
                }
            });

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                // Remove active class from current item
                if (currentIndex >= 0) {
                    items[currentIndex].classList.remove('active');
                }
                // Add active class to next item
                currentIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
                items[currentIndex].classList.add('active');
                items[currentIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                // Remove active class from current item
                if (currentIndex >= 0) {
                    items[currentIndex].classList.remove('active');
                }
                // Add active class to previous item
                currentIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                items[currentIndex].classList.add('active');
                items[currentIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter') {
                e.preventDefault();
                // Click the active item or the first item if none is active
                const activeItem = dropdown.querySelector('.dropdown-item.active') || items[0];
                if (activeItem) {
                    activeItem.click();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                dropdown.style.display = 'none';
            }
        });

        // Handle focus to show all products if empty
        nameInput.addEventListener('focus', function() {
            if (nameInput.value.trim() === '') {
                // Show all products
                dropdown.innerHTML = '';
                products.slice(0, 20).forEach(product => { // Show first 20 products
                    const option = document.createElement('button');
                    option.type = 'button';
                    option.className = 'dropdown-item';
                    option.textContent = product.name;
                    option.setAttribute('data-id', product.id);
                    
                    option.addEventListener('click', function() {
                        // Fill all product fields
                        productIdInput.value = product.id;
                        codeInput.value = product.code;
                        nameInput.value = product.name;
                        if (availableQuantityInput) {
                            availableQuantityInput.value = formatCurrency(parseFloat(product.current_stock || 0), 3);
                        }
                        priceInput.value = formatCurrency(parseFloat(product.sale_price || 0), 3);
                        taxRateInput.value = parseFloat(product.tax_rate) || 0;

                        dropdown.style.display = 'none';

                        // Calculate row total
                        const row = nameInput.closest('tr');
                        if (row) {
                            calculateRowTotal(row);
                            calculateGrandTotal();
                        }
                    });

                    dropdown.appendChild(option);
                });
                dropdown.style.display = 'block';
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!nameInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Handle blur with delay to allow click on dropdown items
        nameInput.addEventListener('blur', function() {
            setTimeout(() => {
                if (nameInput.value && !productIdInput.value) {
                    // If user typed something but didn't select from dropdown, clear it
                    nameInput.value = '';
                }
            }, 200);
        });
    }

    // Function to handle product code search for each row
    function setupProductCodeSearch(row) {
        const codeInput = row.querySelector('.product-code-input');
        const dropdown = row.querySelector('.product-code-dropdown');
        const productIdInput = row.querySelector('.product-id-input');
        const nameInput = row.querySelector('.product-name-input');
        const availableQuantityInput = row.querySelector('.available-quantity-input');
        const priceInput = row.querySelector('.price-input');
        const taxRateInput = row.querySelector('.tax-rate-input');

        if (!codeInput || !dropdown) return;

        // Function to filter and show products by code
        function filterProductsByCode() {
            const searchTerm = codeInput.value.toLowerCase().trim();

            if (searchTerm === '') {
                dropdown.style.display = 'none';
                return;
            }

            // Clear previous options
            dropdown.innerHTML = '';

            // Filter products by code
            const filteredProducts = products.filter(product =>
                product.code.toLowerCase().includes(searchTerm) ||
                product.name.toLowerCase().includes(searchTerm) ||
                product.description.toLowerCase().includes(searchTerm)
            );

            if (filteredProducts.length === 0) {
                dropdown.style.display = 'none';
                return;
            }

            // Create dropdown options
            filteredProducts.forEach(product => {
                const option = document.createElement('button');
                option.type = 'button';
                option.className = 'dropdown-item';
                option.innerHTML = `<strong>${product.code}</strong> - ${product.name} (${product.current_stock} available)`;
                option.setAttribute('data-product', JSON.stringify(product));

                option.addEventListener('click', function() {
                    // Fill all product fields
                    productIdInput.value = product.id;
                    codeInput.value = product.code;
                    nameInput.value = product.name;
                    if (availableQuantityInput) {
                        availableQuantityInput.value = formatCurrency(parseFloat(product.current_stock || 0), 3);
                    }
                    
                    // Calculate displayed price as sale_price / (1 + tax_rate/100)
                    const salePrice = parseFloat(product.sale_price || 0);
                    const taxRate = parseFloat(product.tax_rate || 0);
                    const displayedPrice = taxRate > 0 ? salePrice / (1 + taxRate / 100) : salePrice;
                    
                    priceInput.value = formatCurrency(displayedPrice, 3);
                    taxRateInput.value = parseFloat(product.tax_rate) || 0;

                    dropdown.style.display = 'none';

                    // Calculate row total
                    const row = codeInput.closest('tr');
                    if (row) {
                        calculateRowTotal(row);
                        calculateGrandTotal();
                    }
                });

                dropdown.appendChild(option);
            });

            dropdown.style.display = 'block';
        }

        // Handle input changes
        codeInput.addEventListener('input', filterProductsByCode);

        // Handle keyboard navigation (Arrow keys and Enter)
        codeInput.addEventListener('keydown', function(e) {
            const items = dropdown.querySelectorAll('.dropdown-item');
            if (items.length === 0) return;

            let currentIndex = -1;
            items.forEach((item, index) => {
                if (item.classList.contains('active')) {
                    currentIndex = index;
                }
            });

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                // Remove active class from current item
                if (currentIndex >= 0) {
                    items[currentIndex].classList.remove('active');
                }
                // Add active class to next item
                currentIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
                items[currentIndex].classList.add('active');
                items[currentIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                // Remove active class from current item
                if (currentIndex >= 0) {
                    items[currentIndex].classList.remove('active');
                }
                // Add active class to previous item
                currentIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                items[currentIndex].classList.add('active');
                items[currentIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter') {
                e.preventDefault();
                // Click the active item or the first item if none is active
                const activeItem = dropdown.querySelector('.dropdown-item.active') || items[0];
                if (activeItem) {
                    activeItem.click();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                dropdown.style.display = 'none';
            }
        });

        // Handle focus to show matching products if not empty
        codeInput.addEventListener('focus', function() {
            if (codeInput.value.trim() !== '') {
                filterProductsByCode();
            }
        });

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!codeInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Handle blur with delay to allow click on dropdown items
        codeInput.addEventListener('blur', function() {
            setTimeout(() => {
                if (codeInput.value && !productIdInput.value) {
                    // If user typed something but didn't select from dropdown, clear it
                    codeInput.value = '';
                }
            }, 200);
        });
    }

    // Setup product search for existing rows and new rows
    function setupAllProductSearches() {
        document.querySelectorAll('#productsTableBody tr').forEach(row => {
            if (!row.hasAttribute('data-product-search-setup')) {
                setupProductSearch(row);
                setupProductCodeSearch(row);
                row.setAttribute('data-product-search-setup', 'true');
            }
        });
    }

    // Initial setup
    setupAllProductSearches();

    // Setup for new rows when added
    const originalAddProductRow = window.addProductRow;
    window.addProductRow = function() {
        originalAddProductRow();
        // Small delay to ensure DOM is updated
        setTimeout(setupAllProductSearches, 100);
    };
});

// Keyboard shortcuts for invoice management
document.addEventListener('keydown', function(e) {
    // Shift+A to add new product row
    if (e.shiftKey && e.key.toLowerCase() === 'a' && !e.ctrlKey && !e.altKey) {
        // Don't trigger if user is typing in an input field
        const activeElement = document.activeElement;
        const isInputField = activeElement && (
            activeElement.tagName === 'INPUT' || 
            activeElement.tagName === 'TEXTAREA' || 
            activeElement.tagName === 'SELECT' ||
            activeElement.isContentEditable
        );
        
        if (!isInputField) {
            e.preventDefault();
            
            try {
                addProductRow();
                console.log('‚úÖ Product row added via Shift+A shortcut');
                
                // Focus on the first product code input of the new row
                setTimeout(() => {
                    const lastRow = document.querySelector('#productsTableBody tr:last-child');
                    if (lastRow) {
                        const productCodeInput = lastRow.querySelector('.product-code-input');
                        if (productCodeInput) {
                            productCodeInput.focus();
                            console.log('‚úÖ Focus set on new product code input');
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('‚ùå Error adding product row via Shift+A:', error);
            }
        }
    }
    
    // Shift+D to delete current product row
    if (e.shiftKey && e.key.toLowerCase() === 'd' && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        
        // Find the row containing the currently focused element
        const activeElement = document.activeElement;
        const currentRow = activeElement ? activeElement.closest('#productsTableBody tr') : null;
        
        if (currentRow) {
            // Get row ID
            const rowId = currentRow.id.replace('productRow', '');
            
            // Check if this is the last row
            const allRows = document.querySelectorAll('#productsTableBody tr');
            if (allRows.length <= 1) {
                alert("{% trans 'Cannot delete the last product row. At least one product row must remain.' %}");
                return;
            }
            
            // Show confirmation dialog
            if (confirm("{% trans 'Are you sure you want to delete this product row?' %}")) {
                // Find the previous row to focus after deletion
                const previousRow = currentRow.previousElementSibling;
                
                // Delete the row
                removeProductRow(rowId);
                console.log(`‚úÖ Product row ${rowId} deleted via Shift+D shortcut`);
                
                // Focus on the first input of the previous row
                if (previousRow) {
                    setTimeout(() => {
                        const firstInput = previousRow.querySelector('input:not([type="hidden"]):not([readonly])');
                        if (firstInput) {
                            firstInput.focus();
                            console.log('‚úÖ Focus moved to previous row');
                        }
                    }, 100);
                }
            }
        } else {
            alert("{% trans 'Please select a product row to delete by clicking on any field in that row.' %}");
        }
    }
    
    // Ctrl+Enter to save invoice
    if (e.ctrlKey && e.key === 'Enter') {
        e.preventDefault(); // Prevent default behavior
        
        const saveButton = document.querySelector('button[type="submit"][name="action"][value="save"]');
        if (saveButton) {
            saveButton.click();
            console.log('Invoice save triggered via Ctrl+Enter shortcut');
        }
    }
    
    // Show shortcut hint on Ctrl+? or Ctrl+H
    if (e.ctrlKey && (e.key === '?' || e.key === 'h' || e.key.toLowerCase() === 'h')) {
        e.preventDefault();
        showKeyboardShortcuts();
    }
});

// Function to show keyboard shortcuts help
function showKeyboardShortcuts() {
    const shortcuts = [
        { key: 'Shift+A', description: '{% trans "ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ∑ÿ± ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ" %}' },
        { key: 'Shift+D', description: '{% trans "ÿ≠ÿ∞ŸÅ ÿ≥ÿ∑ÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿ≠ÿßŸÑŸä" %}' },
        { key: 'Ctrl+Enter', description: '{% trans "ÿ≠ŸÅÿ∏ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©" %}' },
        { key: 'Ctrl+H or Ctrl+?', description: '{% trans "ÿπÿ±ÿ∂ ÿßÿÆÿ™ÿµÿßÿ±ÿßÿ™ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠" %}' }
    ];
    
    let message = 'ÿßÿÆÿ™ÿµÿßÿ±ÿßÿ™ ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠:\n\n';
    shortcuts.forEach(shortcut => {
        message += `${shortcut.key}: ${shortcut.description}\n`;
    });
    
    alert(message);
}

// Unsaved changes warning
let hasUnsavedChanges = false;

// Track form changes
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('salesInvoiceForm');
    if (form) {
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                hasUnsavedChanges = true;
            });
        });
    }
});

// Intercept navigation links
document.addEventListener('click', function(e) {
    console.log('Click event detected, hasUnsavedChanges:', hasUnsavedChanges);
    if (hasUnsavedChanges && e.target.closest('a')) {
        const link = e.target.closest('a');
        const href = link.getAttribute('href');
        console.log('Link clicked:', href, 'has data-bs-toggle:', link.hasAttribute('data-bs-toggle'));
        if (href && !href.startsWith('#') && !href.startsWith('javascript:') && !link.hasAttribute('data-bs-toggle')) {
            e.preventDefault();
            console.log('Preventing default and showing modal for:', href);
            showUnsavedChangesModal(href);
        }
    }
});

// Function to show unsaved changes modal
function showUnsavedChangesModal(targetUrl) {
    console.log('showUnsavedChangesModal called with URL:', targetUrl);
    const transTitle = document.getElementById('trans-unsaved-changes').textContent;
    const transMessage = document.getElementById('trans-unsaved-message').textContent;
    const transCancel = document.getElementById('trans-cancel').textContent;
    const transLeave = document.getElementById('trans-leave').textContent;
    
    console.log('Translations:', {transTitle, transMessage, transCancel, transLeave});
    
    const modalHtml = `
        <div class="modal fade" id="unsavedChangesModal" tabindex="-1" aria-labelledby="unsavedChangesModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="unsavedChangesModalLabel">${transTitle}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        ${transMessage}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${transCancel}</button>
                        <button type="button" class="btn btn-primary" onclick="proceedToUrl('${targetUrl}')">${transLeave}</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('unsavedChangesModal'));
    modal.show();
    
    // Remove modal from DOM after hiding
    document.getElementById('unsavedChangesModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Function to proceed to URL
function proceedToUrl(url) {
    window.location.href = url;
}

// Payment type change handler
document.getElementById('id_payment_type').addEventListener('change', function() {
    const paymentType = this.value;
    const cashboxContainer = document.getElementById('cashbox_container');
    const cashboxSelect = document.getElementById('id_cashbox');
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿ≠ŸÇŸÑ ÿßŸÑÿµŸÜÿØŸàŸÇ ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿßÿÆÿ™Ÿäÿßÿ± "ŸÜŸÇÿØÿßŸã"
    // ÿßŸÑÿ¥ŸäŸÉÿßÿ™ ÿ™ŸèÿπÿßŸÑÿ¨ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ≥ŸÜÿØ ÿßŸÑŸÇÿ®ÿ∂
    if (paymentType === 'cash') {
        cashboxContainer.style.display = 'block';
        if (cashboxSelect) {
            cashboxSelect.required = true;
        }
    } else {
        cashboxContainer.style.display = 'none';
        if (cashboxSelect) {
            cashboxSelect.required = false;
            cashboxSelect.value = '';
        }
    }
});
</script>

<!-- Script to repopulate form data on page load -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸÜÿØŸàŸÇ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπ "ŸÜŸÇÿØÿßŸã"
    const paymentTypeSelect = document.getElementById('id_payment_type');
    const cashboxContainer = document.getElementById('cashbox_container');
    
    if (paymentTypeSelect && cashboxContainer) {
        const currentPaymentType = paymentTypeSelect.value;
        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿµŸÜÿØŸàŸÇ ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÜŸàÿπ ÿßŸÑÿØŸÅÿπ "ŸÜŸÇÿØÿßŸã"
        // ÿßŸÑÿ¥ŸäŸÉÿßÿ™ ÿ™ŸèÿπÿßŸÑÿ¨ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ≥ŸÜÿØ ÿßŸÑŸÇÿ®ÿ∂
        if (currentPaymentType === 'cash') {
            cashboxContainer.style.display = 'block';
            const cashboxSelect = document.getElementById('id_cashbox');
            if (cashboxSelect) {
                cashboxSelect.required = true;
            }
        }
    }
    
    // Repopulate form fields with previously entered data
    {% if form_data_json %}
    const formData = JSON.parse({{ form_data_json|safe }});
    
    // Repopulate customer
    if (formData.customer_id) {
        document.getElementById('id_customer').value = formData.customer_id;
        // Trigger customer selection to update balance info
        const customerSelect = document.getElementById('id_customer');
        if (customerSelect) {
            const event = new Event('change', { bubbles: true });
            customerSelect.dispatchEvent(event);
        }
    }
    
    // Repopulate payment type
    if (formData.payment_type) {
        document.getElementById('id_payment_type').value = formData.payment_type;
        // Trigger payment type change
        const paymentTypeSelect = document.getElementById('id_payment_type');
        if (paymentTypeSelect) {
            const event = new Event('change', { bubbles: true });
            paymentTypeSelect.dispatchEvent(event);
        }
    }
    
    // Repopulate warehouse
    if (formData.warehouse_id) {
        document.getElementById('id_warehouse').value = formData.warehouse_id;
    }
    
    // Repopulate cashbox
    if (formData.cashbox_id) {
        document.getElementById('id_cashbox').value = formData.cashbox_id;
    }
    
    // Repopulate notes
    if (formData.notes) {
        document.getElementById('id_notes').value = formData.notes;
    }
    
    // Repopulate discount
    if (formData.discount_amount) {
        document.getElementById('id_discount').value = formData.discount_amount;
    }
    
    // Repopulate invoice number
    if (formData.manual_invoice) {
        document.getElementById('id_invoice_number').value = formData.manual_invoice;
    }
    
    // Repopulate date
    if (formData.invoice_date) {
        document.getElementById('id_date').value = formData.invoice_date;
    }
    
    // Repopulate inclusive tax checkbox
    if (formData.inclusive_tax) {
        document.getElementById('id_inclusive_tax').checked = true;
    }
    
    // Repopulate products
    if (formData.products && formData.products.length > 0) {
        for (let i = 0; i < formData.products.length; i++) {
            if (formData.products[i]) {
                // Add product row if not the first one
                if (i > 0) {
                    addProduct();  // Call the function directly instead of click
                }
                
                // Wait a bit for the row to be added
                setTimeout(() => {
                    const rows = document.querySelectorAll('.product-row');
                    if (rows[i]) {
                        const row = rows[i];
                        const productIdInput = row.querySelector('.product-id-input');
                        const quantityInput = row.querySelector('.quantity-input');
                        const priceInput = row.querySelector('.price-input');
                        const taxRateInput = row.querySelector('.tax-rate-input');
                        
                        if (productIdInput) productIdInput.value = formData.products[i];
                        if (quantityInput && formData.quantities && formData.quantities[i]) quantityInput.value = formData.quantities[i];
                        if (priceInput && formData.prices && formData.prices[i]) priceInput.value = formData.prices[i];
                        if (taxRateInput && formData.tax_rates && formData.tax_rates[i]) taxRateInput.value = formData.tax_rates[i];
                        
                        // Trigger product selection to fill other fields
                        if (productIdInput && productIdInput.value) {
                            // Find the product in the products array and fill the fields
                            const product = products.find(p => p.id == productIdInput.value);
                            if (product) {
                                const codeInput = row.querySelector('.product-code-input');
                                const nameInput = row.querySelector('.product-name-input');
                                const availableQuantityInput = row.querySelector('.available-quantity-input');
                                
                                if (codeInput) codeInput.value = product.code;
                                if (nameInput) nameInput.value = product.name;
                                if (availableQuantityInput) availableQuantityInput.value = product.current_stock;
                                if (taxRateInput && !taxRateInput.value) taxRateInput.value = product.tax_rate;
                                if (priceInput && !priceInput.value) priceInput.value = product.sale_price;
                            }
                        }
                        
                        // Trigger calculation
                        if (quantityInput) {
                            const event = new Event('input', { bubbles: true });
                            quantityInput.dispatchEvent(event);
                        }
                        if (priceInput) {
                            const event = new Event('input', { bubbles: true });
                            priceInput.dispatchEvent(event);
                        }
                    }
                }, 200 * (i + 1));  // Increased timeout
            }
        }
    }
    {% endif %}
    
    // Attach event listeners to existing product rows
    {% if existing_products %}
    document.querySelectorAll('.product-row').forEach(row => {
        attachRowEventListeners(row);
    });
    {% endif %}
    
    // ‚úÖ ÿ™ŸÅÿπŸäŸÑ Bootstrap Tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>

<!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ ŸÖŸÜÿ®ÿ´ŸÇÿ© -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProductModalLabel">
                    <i class="fas fa-plus text-primary me-2"></i>
                    {% trans "Create New Product" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addProductForm" enctype="multipart/form-data">
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    {% csrf_token %}

                    <!-- Basic Information -->
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>{% trans "Basic Information" %}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">{% trans "Product Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productNameEn" class="form-label">{% trans "English Name" %}</label>
                                <input type="text" class="form-control" id="productNameEn" name="name_en">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productType" class="form-label">{% trans "Product Type" %} <span class="text-danger">*</span></label>
                                <select class="form-control" id="productType" name="product_type" required>
                                    <option value="physical">{% trans "Physical Product" %}</option>
                                    <option value="service">{% trans "Service" %}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productSku" class="form-label">{% trans "Product Code (SKU)" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productSku" name="sku" placeholder="{% trans 'Example: PROD-001' %}" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productBarcode" class="form-label">{% trans "Barcode" %}</label>
                                <input type="text" class="form-control" id="productBarcode" name="barcode">
                            </div>
                        </div>
                    </div>

                    <!-- Serial Number field for pieces only -->
                    <div class="row" id="productSerialNumberRow" style="display: none;">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="productSerialNumber" class="form-label">
                                    {% trans "Serial Number" %}
                                    <small class="text-muted">- {% trans "For Warranty" %}</small>
                                </label>
                                <input type="text" class="form-control" id="productSerialNumber" name="serial_number"
                                       placeholder="{% trans 'Example: SN123456789' %}">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% trans "This field is for products sold per piece that need warranty (optional)" %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">{% trans "Category" %} <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="position-relative flex-grow-1">
                                        <input type="text" class="form-control" id="productCategorySearch" placeholder="{% trans 'Type to search categories...' %}" autocomplete="off"
                                               data-categories="{% for category in categories %}{{ category.id }}|{{ category.name|escapejs }}|{{ category.code|escapejs }}{% if not forloop.last %}||{% endif %}{% endfor %}">
                                        <div id="productCategoryDropdown" class="dropdown-menu w-100" style="display: none; max-height: 200px; overflow-y: auto;">
                                            <!-- Category options will be populated here -->
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary" id="productSearchCategoryBtn" title="{% trans 'Search categories' %}">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <input type="hidden" id="productCategory" name="category" required>
                                    <button type="button" class="btn btn-outline-primary" id="productAddCategoryBtn" title="{% trans 'Add new category' %}"
                                            data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                        <i class="fas fa-plus"></i>
                                        {% trans "Add Category" %}
                                    </button>
                                </div>
                                <div class="form-text">
                                    <small class="text-muted">{% trans "Start typing to search categories or click search button" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="productIsService" name="is_service">
                                    <label class="form-check-label" for="productIsService">
                                        <i class="fas fa-concierge-bell text-primary me-2"></i>
                                        <strong>{% trans "Service Product (Non-countable)" %}</strong>
                                    </label>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        {% trans "Service products do not affect inventory Service products do not need quantities" %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productUnit" class="form-label">{% trans "Unit of Measurement" %} <span class="text-danger">*</span></label>
                                <select class="form-select" id="productUnit" name="unit" required>
                                    <option value="piece">{% trans "Piece" %}</option>
                                    <option value="service">{% trans "Service" %}</option>
                                    <option value="kg">{% trans "Kilogram" %}</option>
                                    <option value="liter">{% trans "Liter" %}</option>
                                    <option value="meter">{% trans "Meter" %}</option>
                                    <option value="box">{% trans "Box" %}</option>
                                    <option value="pack">{% trans "Pack" %}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing -->
                    <h6 class="mt-4 mb-3"><i class="fas fa-dollar-sign me-2"></i>{% trans "Pricing" %}</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">{% trans "Cost Price" %}</label>
                                <input type="text" class="form-control" value="{% trans 'Calculated automatically from purchases' %}" readonly disabled>
                                <small class="form-text text-muted">{% trans "Cost is calculated from purchase invoices using weighted average method" %}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productSellingPrice" class="form-label">{% trans "Selling Price" %} <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="productSellingPrice" name="selling_price" step="0.001" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productWholesalePrice" class="form-label">{% trans "Wholesale Price" %}</label>
                                <input type="number" class="form-control" id="productWholesalePrice" name="wholesale_price" step="0.001" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productTaxRate" class="form-label">
                                    <i class="fas fa-percentage text-primary me-1"></i>
                                    {% trans "Tax Rate" %} % <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="productTaxRate" name="tax_rate"
                                           step="0.01" min="0" max="100" value="0" placeholder="{% trans 'Example: 15' %}" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    {% trans "It will be calculated automatically in invoices" %}
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info" style="display: none;" id="productTaxCalculation">
                                <h6 class="alert-heading">
                                    <i class="fas fa-calculator me-2"></i>
                                    {% trans "Tax Calculation" %}
                                </h6>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>{% trans "Selling Price" %}:</span>
                                    <span id="productBasePrice">0.00</span>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>{% trans "Tax Amount" %}:</span>
                                    <span id="productTaxAmount">0.00</span>
                                </div>
                                <hr class="my-2">
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>{% trans "Price Including Tax" %}:</span>
                                    <span id="productPriceWithTax">0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory -->
                    <div id="productInventorySection">
                        <h6 class="mt-4 mb-3"><i class="fas fa-warehouse me-2"></i>{% trans "Inventory" %}</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            {% trans "This section is for countable products only. Service products do not need inventory management." %}
                        </div>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="productOpeningBalance" class="form-label">
                                        <i class="fas fa-balance-scale text-success me-1"></i>
                                        {% trans "Opening Balance Quantity" %}
                                    </label>
                                    <input type="number" class="form-control" id="productOpeningBalance" name="opening_balance" step="0.001" min="0" value="0">
                                    <small class="form-text text-muted">{% trans "Initial stock when starting to use the system" %}</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="productOpeningBalanceUnitCost" class="form-label">
                                        <i class="fas fa-coins text-primary me-1"></i>
                                        {% trans "Opening Balance Unit Cost" %}
                                    </label>
                                    <input type="number" class="form-control" id="productOpeningBalanceUnitCost" name="opening_balance_unit_cost" step="0.001" min="0" value="0">
                                    <small class="form-text text-muted">{% trans "Cost per unit for opening balance (exclusive of VAT)" %}</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="productOpeningBalanceCost" class="form-label">
                                        <i class="fas fa-dollar-sign text-warning me-1"></i>
                                        {% trans "Opening Balance Total Cost" %}
                                    </label>
                                    <input type="number" class="form-control" id="productOpeningBalanceCost" name="opening_balance_cost" step="0.001" min="0" value="0" readonly>
                                    <small class="form-text text-muted">{% trans "Auto-calculated: Quantity √ó Unit Cost" %}</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="productOpeningBalanceWarehouse" class="form-label">
                                        <i class="fas fa-warehouse text-info me-1"></i>
                                        {% trans "Opening Balance Warehouse" %}
                                    </label>
                                    <select class="form-control" id="productOpeningBalanceWarehouse" name="opening_balance_warehouse">
                                        <option value="">{% trans "Select Warehouse" %}</option>
                                        {% for warehouse in warehouses %}
                                        <option value="{{ warehouse.id }}">{{ warehouse.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">{% trans "Warehouse where the opening balance will be placed" %}</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="productMinStock" class="form-label">{% trans "Minimum Stock Level" %}</label>
                                    <input type="number" class="form-control" id="productMinStock" name="min_stock" min="0" value="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="productMaxStock" class="form-label">{% trans "Maximum Stock Level" %}</label>
                                    <input type="number" class="form-control" id="productMaxStock" name="max_stock" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Description, Image and Settings -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="productDescription" class="form-label">{% trans "Description" %}</label>
                                <textarea class="form-control" id="productDescription" name="description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productImage" class="form-label">{% trans "Product Image" %}</label>
                                <input type="file" class="form-control" id="productImage" name="image" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="productIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="productIsActive">
                                        {% trans "Active" %}
                                    </label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="productTrackStock" name="track_stock" checked>
                                    <label class="form-check-label" for="productTrackStock">
                                        {% trans "Track Stock" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveProductBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        <i class="fas fa-save me-2"></i>
                        <span class="btn-text">{% trans "Save Product" %}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ¶ÿ© ŸÖŸÜÿ®ÿ´ŸÇÿ© -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">
                    <i class="fas fa-folder-plus text-warning me-2"></i>
                    {% trans "Add Category" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCategoryForm">
                <div class="modal-body">
                    {% csrf_token %}

                    <!-- Basic Information -->
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>{% trans "Basic Information" %}</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryName" class="form-label">{% trans "Category Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="categoryName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryNameEn" class="form-label">{% trans "English Name" %} <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="categoryNameEn" name="name_en" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryCode" class="form-label">{% trans "Category Code" %}</label>
                                <input type="text" class="form-control" id="categoryCode" name="code" placeholder="{% trans 'Example: CAT-001' %}">
                                <div class="form-text">{% trans "Unique code for the category (optional)" %}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoryParent" class="form-label">{% trans "Parent Category" %}</label>
                                <select class="form-select" id="categoryParent" name="parent">
                                    <option value="">{% trans "Choose Parent Category (Optional)" %}</option>
                                    <!-- Options will be loaded dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="categoryDescription" class="form-label">{% trans "Description" %}</label>
                                <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="categoryIsActive" name="is_active" checked>
                                    <label class="form-check-label" for="categoryIsActive">
                                        {% trans "Active" %}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        {% trans "Cancel" %}
                    </button>
                    <button type="submit" class="btn btn-warning" id="saveCategoryBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        <i class="fas fa-save me-2"></i>
                        <span class="btn-text">{% trans "Save Category" %}</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// JavaScript ŸÑŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨
const addProductModal = document.getElementById('addProductModal');
const addProductForm = document.getElementById('addProductForm');
const saveProductBtn = document.getElementById('saveProductBtn');

// ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÖŸÜÿ™ÿ¨
if (addProductForm) {
    addProductForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(addProductForm);
        const spinner = saveProductBtn.querySelector('.spinner-border');
        const btnText = saveProductBtn.querySelector('.btn-text');
        const icon = saveProductBtn.querySelector('.fa-save');
        
        // Disable button and show spinner
        saveProductBtn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = '{% trans "Saving..." %}';
        icon.style.display = 'none';

        // Send data
        fetch('{% url "products:product_add_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // Insert message at the top of the page
                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);

                // Close modal
                const modal = bootstrap.Modal.getInstance(addProductModal);
                modal.hide();

                // Reset form
                addProductForm.reset();

                // Update available products list if function exists
                if (typeof loadAvailableProducts === 'function') {
                    loadAvailableProducts(data.product);
                }
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => alertDiv.remove(), 3000);

            } else {
                alert('{% trans "Error" %}: ' + data.error);
            }
        })
        .catch(error => {
            console.error('{% trans "Error" %}:', error);
            alert('{% trans "An error occurred while saving the product. Please try again." %}');
        })
        .finally(() => {
            // Re-enable button
            saveProductBtn.disabled = false;
            spinner.classList.add('d-none');
            btnText.textContent = '{% trans "Save Product" %}';
            icon.style.display = 'inline';
        });
    });
}

// ÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿπÿ±ÿ∂ ÿ≠ŸÇŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ≥ŸÑÿ≥ŸÑŸä
function toggleProductSerialNumberField() {
    const unitSelect = document.getElementById('productUnit');
    const serialNumberRow = document.getElementById('productSerialNumberRow');
    
    if (unitSelect && serialNumberRow) {
        if (unitSelect.value === 'piece') {
            serialNumberRow.style.display = 'block';
        } else {
            serialNumberRow.style.display = 'none';
        }
    }
}

// ÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿ•ÿÆŸÅÿßÿ°/ÿ•ÿ∏Ÿáÿßÿ± ÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÑŸÑÿÆÿØŸÖÿßÿ™
function toggleProductInventorySection() {
    const isServiceCheckbox = document.getElementById('productIsService');
    const inventorySection = document.getElementById('productInventorySection');
    const unitSelect = document.getElementById('productUnit');
    const productType = document.getElementById('productType');
    
    if (isServiceCheckbox && inventorySection) {
        if (isServiceCheckbox.checked) {
            inventorySection.style.display = 'none';
            if (unitSelect) unitSelect.value = 'service';
            if (productType) productType.value = 'service';
        } else {
            inventorySection.style.display = 'block';
            if (productType) productType.value = 'physical';
        }
    }
}

// ÿ≠ÿ≥ÿßÿ® ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿßŸÅÿ™ÿ™ÿßÿ≠Ÿä
function calculateProductOpeningBalanceCost() {
    const quantity = parseFloat(document.getElementById('productOpeningBalance').value) || 0;
    const unitCost = parseFloat(document.getElementById('productOpeningBalanceUnitCost').value) || 0;
    const totalCostInput = document.getElementById('productOpeningBalanceCost');
    
    if (totalCostInput) {
        const totalCost = quantity * unitCost;
        totalCostInput.value = totalCost.toFixed(3);
    }
}

// ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©
function calculateProductTax() {
    var sellingPrice = parseFloat($('#productSellingPrice').val()) || 0;
    var taxRate = parseFloat($('#productTaxRate').val()) || 0;
    
    if (sellingPrice > 0 && taxRate > 0) {
        var taxAmount = sellingPrice * (taxRate / 100);
        var priceWithTax = sellingPrice + taxAmount;
        
        $('#productBasePrice').text(sellingPrice.toFixed(3));
        $('#productTaxAmount').text(taxAmount.toFixed(3));
        $('#productPriceWithTax').text(priceWithTax.toFixed(3));
        $('#productTaxCalculation').show();
    } else {
        $('#productTaxCalculation').hide();
    }
}

// ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
document.addEventListener('DOMContentLoaded', function() {
    const productUnitSelect = document.getElementById('productUnit');
    if (productUnitSelect) {
        productUnitSelect.addEventListener('change', function() {
            toggleProductSerialNumberField();
            // If "service" is selected as unit, activate service product
            if (this.value === 'service') {
                const isServiceCheckbox = document.getElementById('productIsService');
                if (isServiceCheckbox) {
                    isServiceCheckbox.checked = true;
                    toggleProductInventorySection();
                }
            }
        });
        toggleProductSerialNumberField();
    }
    
    // Bind is_service checkbox change event
    const isServiceCheckbox = document.getElementById('productIsService');
    if (isServiceCheckbox) {
        isServiceCheckbox.addEventListener('change', toggleProductInventorySection);
        toggleProductInventorySection();
    }
    
    // Bind opening balance calculation events
    const openingBalanceQty = document.getElementById('productOpeningBalance');
    const openingBalanceUnitCost = document.getElementById('productOpeningBalanceUnitCost');
    if (openingBalanceQty) {
        openingBalanceQty.addEventListener('input', calculateProductOpeningBalanceCost);
    }
    if (openingBalanceUnitCost) {
        openingBalanceUnitCost.addEventListener('input', calculateProductOpeningBalanceCost);
    }
    
    // Bind events for tax calculation
    $('#productSellingPrice, #productTaxRate').on('input', calculateProductTax);
});

// Category search functionality for product modal
$(document).ready(function() {
    var categoriesData = $('#productCategorySearch').data('categories') || '';
    var categories = [];
    
    if (categoriesData) {
        var categoryPairs = categoriesData.split('||');
        categoryPairs.forEach(function(pair) {
            var parts = pair.split('|');
            if (parts.length >= 2) {
                categories.push({
                    id: parts[0],
                    name: parts[1],
                    code: parts[2] || ''
                });
            }
        });
    }

    var categorySearch = $('#productCategorySearch');
    var categoryDropdown = $('#productCategoryDropdown');
    var categoryHidden = $('#productCategory');
    var selectedIndex = -1;
    
    function filterCategories() {
        var searchTerm = categorySearch.val().toLowerCase();
        categoryDropdown.empty();
        selectedIndex = -1;
        
        if (!searchTerm) {
            categoryDropdown.hide();
            return;
        }
        
        var filteredCategories = categories.filter(function(cat) {
            return cat.name.toLowerCase().includes(searchTerm) || 
                   (cat.code && cat.code.toLowerCase().includes(searchTerm));
        });
        
        if (filteredCategories.length === 0) {
            categoryDropdown.hide();
            return;
        }
        
        filteredCategories.forEach(function(cat, index) {
            var item = $('<button type="button" class="dropdown-item"></button>')
                .text(cat.name + (cat.code ? ' (' + cat.code + ')' : ''))
                .attr('data-id', cat.id)
                .attr('data-index', index);
            
            item.on('click', function() {
                categorySearch.val(cat.name);
                categoryHidden.val(cat.id);
                categoryDropdown.hide();
            });
            
            categoryDropdown.append(item);
        });
        
        categoryDropdown.show();
    }
    
    function highlightSelectedItem() {
        categoryDropdown.find('.dropdown-item').removeClass('active');
        if (selectedIndex >= 0) {
            categoryDropdown.find('.dropdown-item[data-index="' + selectedIndex + '"]').addClass('active');
        }
    }
    
    categorySearch.on('input', filterCategories);
    
    categorySearch.on('keydown', function(e) {
        var items = categoryDropdown.find('.dropdown-item');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (selectedIndex < items.length - 1) {
                selectedIndex++;
                highlightSelectedItem();
            }
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (selectedIndex > 0) {
                selectedIndex--;
                highlightSelectedItem();
            }
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            items.eq(selectedIndex).click();
        }
    });
    
    $(document).on('click', function(e) {
        if (!categorySearch.is(e.target) && !categoryDropdown.is(e.target) && categoryDropdown.has(e.target).length === 0) {
            categoryDropdown.hide();
        }
    });
});

// JavaScript ŸÑŸÑÿ™ÿπÿßŸÖŸÑ ŸÖÿπ ŸÜÿßŸÅÿ∞ÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿ¶ÿ©
const addCategoryModal = document.getElementById('addCategoryModal');
const addCategoryForm = document.getElementById('addCategoryForm');
const saveCategoryBtn = document.getElementById('saveCategoryBtn');
const categoryParentSelect = document.getElementById('categoryParent');

// ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÜÿßŸÅÿ∞ÿ©
if (addCategoryModal) {
    addCategoryModal.addEventListener('shown.bs.modal', function() {
        // Load parent categories
        fetch('{% url "products:category_add_ajax" %}')
            .then(response => response.json())
            .then(data => {
                if (data.categories) {
                    categoryParentSelect.innerHTML = '<option value="">{% trans "Choose Parent Category (Optional)" %}</option>';
                    data.categories.forEach(function(category) {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        categoryParentSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('{% trans "Error loading categories" %}:', error));
    });
}

// ŸÖÿπÿßŸÑÿ¨ÿ© ÿ•ÿ±ÿ≥ÿßŸÑ ŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑŸÅÿ¶ÿ©
if (addCategoryForm) {
    addCategoryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(addCategoryForm);
        const spinner = saveCategoryBtn.querySelector('.spinner-border');
        const btnText = saveCategoryBtn.querySelector('.btn-text');
        const icon = saveCategoryBtn.querySelector('.fa-save');
        
        // Disable button and show spinner
        saveCategoryBtn.disabled = true;
        spinner.classList.remove('d-none');
        btnText.textContent = '{% trans "Saving..." %}';
        icon.style.display = 'none';

        fetch('{% url "products:category_add_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);

                // Close modal
                const modal = bootstrap.Modal.getInstance(addCategoryModal);
                modal.hide();

                // Reset form
                addCategoryForm.reset();
                
                // Update category search if in product modal
                if (data.category) {
                    $('#productCategorySearch').val(data.category.name);
                    $('#productCategory').val(data.category.id);
                }
                
                // Auto-dismiss after 3 seconds
                setTimeout(() => alertDiv.remove(), 3000);

            } else {
                alert('{% trans "Error" %}: ' + data.error);
            }
        })
        .catch(error => {
            console.error('{% trans "Error" %}:', error);
            alert('{% trans "An error occurred while saving the category. Please try again." %}');
        })
        .finally(() => {
            // Re-enable button
            saveCategoryBtn.disabled = false;
            spinner.classList.add('d-none');
            btnText.textContent = '{% trans "Save Category" %}';
            icon.style.display = 'inline';
        });
    });
}
</script>

{% endblock %}