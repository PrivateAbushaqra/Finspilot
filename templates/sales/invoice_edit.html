{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}
{% load l10n %}



{% block title %}{% trans "Edit Sales Invoice" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 2rem;
    }
    
    .invoice-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px 8px 0 0;
        margin: -2rem -2rem 2rem -2rem;
    }
    
    .invoice-items {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .item-row {
        border-bottom: 1px solid #f0f0f0;
        padding: 0.5rem 0;
    }
    
    .item-row:last-child {
        border-bottom: none;
    }
    
    .totals-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø®Ø§Ù†Ø§Øª Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø± */
    .quantity-input,
    .price-input {
        color: #000 !important;
        background-color: #fff !important;
        font-size: 14px;
        font-weight: 500;
        text-align: right;
        padding: 0.375rem 0.75rem !important;
        min-width: 120px;
        max-width: 100%;
        overflow: visible !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        border: 1px solid #ced4da !important;
        display: block !important;
        width: 100% !important;
        height: auto !important;
        line-height: 1.5 !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .quantity-input::placeholder,
    .price-input::placeholder {
        color: #999;
        opacity: 0.7;
    }
    
    .quantity-input:focus,
    .price-input:focus {
        color: #000;
        background-color: #fff;
        border-color: #80bdff !important;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    }
    
    /* Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ¬ÙŠØ¨ */
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    #invoice-items-table td {
        vertical-align: middle;
        padding: 0.75rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-edit text-warning me-2"></i>
                {% trans "Edit" %} {% trans "Invoice" %} {% trans "Sales" %}
            </h2>
            <p class="text-muted mb-0">{% trans "Edit" %} {% trans "Data" %} {% trans "Invoice" %} {% trans "Sales" %} {% trans "Number" %} {{ object.invoice_number }}</p>
        </div>
        <div>
            <a href="{% url 'sales:invoice_list' %}" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-right me-1"></i>
                {% trans "Back to" %} {% trans "List" %}
            </a>
            <a href="{% url 'sales:invoice_detail' object.pk %}" class="btn btn-info">
                <i class="fas fa-eye me-1"></i>
                {% trans "View" %} Ø§Ù„{% trans "Details" %}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="form-container">
                <div class="invoice-header">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                {% trans "Edit" %} {% trans "Invoice" %} {% trans "Sales" %}
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <h5 class="mb-0">{% trans "Number" %} {% trans "Invoice" %}: {{ object.invoice_number }}</h5>
                        </div>
                    </div>
                </div>

                {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>{% trans "There are errors in the form" %}</h5>
                    <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li><strong>{{ field }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="inclusive_tax" value="0">
                    
                    <div class="row">
                        <!-- Basic Invoice Information -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.invoice_number.id_for_label }}" class="form-label">
                                    <i class="fas fa-hashtag text-primary me-1"></i>
                                    {% trans "Number" %} {% trans "Invoice" %}
                                </label>
                                {{ form.invoice_number }}
                                {% if form.invoice_number.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.invoice_number.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.date.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar text-primary me-1"></i>
                                    {% trans "Date" %}
                                </label>
                                {{ form.date }}
                                {% if form.date.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.date.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.customer.id_for_label }}" class="form-label">
                                    <i class="fas fa-user text-primary me-1"></i>
                                    Ø§Ù„Ø¹Ù…ÙŠÙ„
                                </label>
                                {{ form.customer }}
                                {% if form.customer.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.customer.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.payment_type.id_for_label }}" class="form-label">
                                    <i class="fas fa-credit-card text-primary me-1"></i>
                                    Ù†ÙˆØ¹ Ø§Ù„{% trans "Payment" %}
                                </label>
                                {{ form.payment_type }}
                                {% if form.payment_type.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.payment_type.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- ØµÙ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-warehouse me-1"></i> Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹</label>
                                <select class="form-select" name="warehouse">
                                    <option value="">{% trans "Select Warehouse" %}</option>
                                    {% for warehouse in warehouses %}
                                    <option value="{{ warehouse.id }}" {% if object.warehouse and warehouse.id == object.warehouse.id %}selected{% endif %}>
                                        {{ warehouse.name }} - {{ warehouse.code }}
                                        {% if warehouse.is_default %} (Ø§ÙØªØ±Ø§Ø¶ÙŠ){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">{% trans "Select the warehouse from which products will be sold." %}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            {% if can_change_creator %}
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user-edit text-warning me-1"></i> 
                                    {% trans "Created By" %}
                                </label>
                                <select class="form-select" name="created_by">
                                    {% for user in all_users %}
                                    <option value="{{ user.id }}" {% if object.created_by and user.id == object.created_by.id %}selected{% endif %}>
                                        {{ user.get_full_name|default:user.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text text-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    {% trans "Changing the creator requires special permission" %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    <i class="fas fa-sticky-note text-primary me-1"></i>
                                    Ù…Ù„Ø§Ø­Ø¸Ø§Øª
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.notes.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Items Display -->
                    <div class="invoice-items">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-list text-primary me-2"></i>
                                Ø¹Ù†Ø§ØµØ± Ø§Ù„{% trans "Invoice" %}
                            </h5>
                            <button type="button" class="btn btn-success btn-sm" id="add-item-btn">
                                <i class="fas fa-plus me-1"></i>
                                Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="invoice-items-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
                                        <th>{% trans "Quantity" %}</th>
                                        <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                                        <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                                        <th>Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in object.items.all %}
                                    <tr data-item-id="{{ item.id }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="product-name">{{ item.product.name }}</span>
                                                <small class="text-muted ms-2">({{ item.product.code }})</small>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm quantity-input" 
                                                   value="{{ item.quantity|unlocalize }}" min="0.01" step="0.01" 
                                                   data-item-id="{{ item.id }}">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm price-input" 
                                                   value="{{ item.unit_price|unlocalize }}" min="0" step="0.01" 
                                                   data-item-id="{{ item.id }}">
                                        </td>
                                        <td>{{ item.tax_rate }}%</td>
                                        <td class="tax-amount">{{ item.tax_amount|currency_format }}</td>
                                        <td class="total-amount"><strong>{{ item.total_amount|currency_format }}</strong></td>
                                        <td>
                                            <button type="button" class="btn btn-warning btn-sm edit-item-btn" 
                                                    data-item-id="{{ item.id }}">
                                                <i class="fas fa-save"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm delete-item-btn" 
                                                    data-item-id="{{ item.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Add New Item Form -->
                        <div id="add-item-form" class="mt-3" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-plus me-2"></i>
                                        Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Ø§Ù„Ù…Ù†ØªØ¬</label>
                                            <select class="form-select" id="new-product-select">
                                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>
                                                {% for product in products %}
                                                <option value="{{ product.id }}" data-code="{{ product.code }}" 
                                                        data-price="{{ product.sale_price }}" 
                                                        data-tax="{{ product.tax_rate }}">
                                                    {{ product.name }} ({{ product.code }})
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                            <input type="number" class="form-control" id="new-quantity" 
                                                   min="0.01" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                            <input type="number" class="form-control" id="new-price" 
                                                   min="0" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</label>
                                            <input type="number" class="form-control" id="new-tax-rate" 
                                                   min="0" max="100" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-success me-2" id="save-new-item-btn">
                                                <i class="fas fa-save me-1"></i>
                                                Ø­ÙØ¸
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="cancel-add-item-btn">
                                                <i class="fas fa-times me-1"></i>
                                                Ø¥Ù„ØºØ§Ø¡
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="totals-section">
                            <div class="row">
                                <div class="col-md-6"></div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>{% trans "Total" %} Ø§Ù„ÙØ±Ø¹ÙŠ:</span>
                                        <strong id="invoice-subtotal-display">{{ object.subtotal|currency_format }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:</span>
                                        <strong id="invoice-tax-display">{{ object.tax_amount|currency_format }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2 align-items-center">
                                        <div>
                                            <label class="form-check-label me-2">{% trans "Ø´Ø§Ù…Ù„ Ø¶Ø±ÙŠØ¨Ø©" %}</label>
                                            <input type="checkbox" id="id_inclusive_tax_edit" name="inclusive_tax" value="1" {% if object.inclusive_tax %}checked{% endif %}
                                                   {% if not user.is_superuser and not perms.sales.can_toggle_invoice_tax %} disabled {% endif %}>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…:</span>
                                        <strong id="invoice-discount-display">{{ object.discount_amount|currency_format }}</strong>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span class="h5">{% trans "Total" %} Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                                        <strong class="h5 text-primary" id="invoice-total-display">{{ object.total_amount|currency_format }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end mt-4">
                        <a href="{% url 'sales:invoice_detail' object.pk %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-1"></i>
                            Ø¥Ù„ØºØ§Ø¡
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            {% trans "Save" %} Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// UPDATED: 2025-10-18 - Fixed TRANSLATIONS and auto-save
$(document).ready(function() {
    console.log('âœ… ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ - v2.1');
    
    // CSRF token setup for AJAX
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Add item button click
    $('#add-item-btn').click(function() {
        $('#add-item-form').slideDown();
        $('#new-product-select').focus();
    });

    // Cancel add item
    $('#cancel-add-item-btn').click(function() {
        $('#add-item-form').slideUp();
        $('#add-item-form input, #add-item-form select').val('');
    });

    // Product selection change - Ø§Ø³ØªØ®Ø¯Ø§Ù… POS API (Ø¨Ù†ÙØ³ Ø·Ø±ÙŠÙ‚Ø© POS ÙˆØµÙØ­Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
    $('#new-product-select').change(function() {
        const productId = $(this).val();
        
        if (!productId) {
            $('#new-price').val('');
            $('#new-tax-rate').val('');
            return;
        }
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
        $('#new-price').val('...').prop('disabled', true);
        $('#new-tax-rate').val('...').prop('disabled', true);
        
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ POS API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØµØ­ÙŠØ­ (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©)
        $.ajax({
            url: `/sales/pos/product/${productId}/`,
            type: 'GET',
            success: function(data) {
                $('#new-price').prop('disabled', false);
                $('#new-tax-rate').prop('disabled', false);
                
                if (data && data.success && data.product) {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø¹Ø± Ù…Ù† API (Ø¨Ø¯ÙˆÙ† Ø¶Ø±ÙŠØ¨Ø©)
                    $('#new-price').val(parseFloat(data.product.price || 0).toFixed(3));
                    $('#new-tax-rate').val(parseFloat(data.product.tax_rate || 0).toFixed(2));
                    console.info('âœ… Ø§Ù„Ø³Ø¹Ø± Ù…Ù† POS API:', data.product.price);
                } else {
                    // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ APIØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù€ template
                    const selectedOption = $('#new-product-select').find('option:selected');
                    const fallbackPrice = parseFloat(selectedOption.data('price')) || 0;
                    const fallbackTax = parseFloat(selectedOption.data('tax')) || 0;
                    const calculatedPrice = fallbackTax > 0 ? fallbackPrice / (1 + fallbackTax / 100) : fallbackPrice;
                    
                    $('#new-price').val(calculatedPrice.toFixed(3));
                    $('#new-tax-rate').val(fallbackTax.toFixed(2));
                    console.warn('âš ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
                }
            },
            error: function(xhr, status, error) {
                $('#new-price').prop('disabled', false);
                $('#new-tax-rate').prop('disabled', false);
                
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø®Ø·Ø£ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù€ template
                const selectedOption = $('#new-product-select').find('option:selected');
                const fallbackPrice = parseFloat(selectedOption.data('price')) || 0;
                const fallbackTax = parseFloat(selectedOption.data('tax')) || 0;
                const calculatedPrice = fallbackTax > 0 ? fallbackPrice / (1 + fallbackTax / 100) : fallbackPrice;
                
                $('#new-price').val(calculatedPrice.toFixed(3));
                $('#new-tax-rate').val(fallbackTax.toFixed(2));
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ POS API:', error);
            }
        });
    });

    // Save new item
    $('#save-new-item-btn').click(function() {
        const productId = $('#new-product-select').val();
        const quantity = parseFloat($('#new-quantity').val());
        const price = parseFloat($('#new-price').val());
        const taxRate = parseFloat($('#new-tax-rate').val());

        if (!productId || !quantity || !price || taxRate === null) {
            alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
            return;
        }

        $.ajax({
            url: `${apiBaseUrl}/items/add/`,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: csrftoken,
                product_id: productId,
                quantity: quantity,
                unit_price: price,
                tax_rate: taxRate
            },
            success: function(response) {
                if (response.success) {
                    location.reload(); // Reload to show updated items
                } else {
                    alert('Ø®Ø·Ø£: ' + response.message);
                }
            },
            error: function() {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬');
            }
        });
    });

    // Format currency for display
    function formatCurrency(value) {
        if (typeof value === 'string') {
            value = parseFloat(value);
        }
        // Return with 3 decimal places
        return value.toFixed(3).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Parse number from string
    function parseNumber(str) {
        if (!str) return 0;
        if (typeof str === 'number') return str;
        // Remove any non-numeric characters except decimal point
        return parseFloat(str.toString().replace(/[^\d.-]/g, '')) || 0;
    }

    // Build the correct base URL for API calls
    const currentPath = window.location.pathname;
    // Extract the language and invoice ID
    const pathMatch = currentPath.match(/^\/([a-z]{2})\/sales\/invoices\/edit\/(\d+)\/$/);
    const language = pathMatch ? pathMatch[1] : 'ar';
    const invoiceId = '{{ object.pk }}';
    const apiBaseUrl = `/${language}/sales/invoices/${invoiceId}`;

    // Auto-save when pressing Enter in quantity or price inputs
    $('.quantity-input, .price-input').on('keypress', function(e) {
        if (e.which === 13) { // Enter key
            const row = $(this).closest('tr');
            const itemId = $(this).data('item-id');
            const btn = row.find('.edit-item-btn[data-item-id="' + itemId + '"]');
            btn.click();
        }
    });

    // Edit item buttons
    $('.edit-item-btn').click(function() {
        const itemId = $(this).data('item-id');
        const row = $(this).closest('tr');
        const quantity = row.find('.quantity-input').val();
        const price = row.find('.price-input').val();
        
        console.log(`ğŸ” ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ± ${itemId}: Ø§Ù„ÙƒÙ…ÙŠØ©=${quantity}, Ø§Ù„Ø³Ø¹Ø±=${price}`);
        
        // Validate input
        if (!quantity || !price) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©');
            return;
        }
        
        const qtyNum = parseFloat(quantity);
        const priceNum = parseFloat(price);
        
        if (qtyNum <= 0 || priceNum < 0) {
            alert('Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±ØŒ ÙˆØ§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† â‰¥ ØµÙØ±');
            return;
        }

        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

        $.ajax({
            url: `${apiBaseUrl}/items/${itemId}/update/`,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: csrftoken,
                quantity: quantity,
                unit_price: price
            },
            success: function(response) {
                console.log('âœ… Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', response);
                
                if (response.success) {
                    // Update the item display values
                    const taxAmount = parseNumber(response.item.tax_amount);
                    const totalAmount = parseNumber(response.item.total_amount);
                    
                    row.find('.tax-amount').text(formatCurrency(taxAmount));
                    row.find('.total-amount strong').text(formatCurrency(totalAmount));
                    
                    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„ - Ø¶Ø±ÙŠØ¨Ø©: ${taxAmount}, Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAmount}`);
                    
                    // Update invoice totals if provided
                    if (response.invoice) {
                        const invoiceSubtotal = parseNumber(response.invoice.subtotal);
                        const invoiceTaxAmount = parseNumber(response.invoice.tax_amount);
                        const invoiceTotalAmount = parseNumber(response.invoice.total_amount);
                        const invoiceDiscountAmount = parseNumber(response.invoice.discount_amount);
                        
                        console.log(`ğŸ“Š Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:`, response.invoice);
                        
                        // Update totals using IDs directly
                        $('#invoice-subtotal-display').text(formatCurrency(invoiceSubtotal));
                        $('#invoice-tax-display').text(formatCurrency(invoiceTaxAmount));
                        $('#invoice-discount-display').text(formatCurrency(invoiceDiscountAmount));
                        $('#invoice-total-display').text(formatCurrency(invoiceTotalAmount));
                        
                        console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹:`);
                        console.log(`  Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ: ${invoiceSubtotal}`);
                        console.log(`  Ù…Ø¨Ù„Øº Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©: ${invoiceTaxAmount}`);
                        console.log(`  Ù…Ø¨Ù„Øº Ø§Ù„Ø®ØµÙ…: ${invoiceDiscountAmount}`);
                        console.log(`  Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${invoiceTotalAmount}`);
                    }
                    
                    // Reset button
                    $('.edit-item-btn[data-item-id="' + itemId + '"]').prop('disabled', false).html('<i class="fas fa-save"></i>');
                    
                    // Show success message
                    showMessage('âœ… ' + response.message, 'success');
                    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­:', response.item);
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + response.message);
                    $('.edit-item-btn[data-item-id="' + itemId + '"]').prop('disabled', false).html('<i class="fas fa-save"></i>');
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ Ø®Ø·Ø£ AJAX:', error, xhr);
                console.log('Status:', status);
                console.log('Response:', xhr.responseText);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ØµØ±. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø¹Ø±.');
                $('.edit-item-btn[data-item-id="' + itemId + '"]').prop('disabled', false).html('<i class="fas fa-save"></i>');
            }
        });
    });

    // Delete item buttons
    $('.delete-item-btn').click(function() {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) {
            return;
        }

        const itemId = $(this).data('item-id');

        $.ajax({
            url: `${apiBaseUrl}/items/${itemId}/delete/`,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: csrftoken
            },
            success: function(response) {
                if (response.success) {
                    location.reload(); // Reload to show updated items
                } else {
                    alert('Ø®Ø·Ø£: ' + response.message);
                }
            },
            error: function() {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±');
            }
        });
    });

    // Function to show messages
    function showMessage(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        $('.container-fluid').prepend(alertHtml);
        
        // Auto hide after 3 seconds
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 3000);
    }
});
</script>
{% endblock %}
