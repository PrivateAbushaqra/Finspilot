{% extends 'base.html' %}
{% load i18n %}
{% load currency_tags %}



{% block title %}{% trans "Edit Sales Invoice" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        padding: 2rem;
    }
    
    .invoice-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px 8px 0 0;
        margin: -2rem -2rem 2rem -2rem;
    }
    
    .invoice-items {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .item-row {
        border-bottom: 1px solid #f0f0f0;
        padding: 0.5rem 0;
    }
    
    .item-row:last-child {
        border-bottom: none;
    }
    
    .totals-section {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-edit text-warning me-2"></i>
                {% trans "Edit" %} {% trans "Invoice" %} المبيعات
            </h2>
            <p class="text-muted mb-0">{% trans "Edit" %} بيانات {% trans "Invoice" %} المبيعات رقم {{ object.invoice_number }}</p>
        </div>
        <div>
            <a href="{% url 'sales:invoice_list' %}" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-right me-1"></i>
                العودة لل{% trans "List" %}
            </a>
            <a href="{% url 'sales:invoice_detail' object.pk %}" class="btn btn-info">
                <i class="fas fa-eye me-1"></i>
                {% trans "View" %} ال{% trans "Details" %}
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="form-container">
                <div class="invoice-header">
                    <div class="row">
                        <div class="col-md-6">
                            <h4 class="mb-0">
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                {% trans "Edit" %} {% trans "Invoice" %} المبيعات
                            </h4>
                        </div>
                        <div class="col-md-6 text-end">
                            <h5 class="mb-0">رقم ال{% trans "Invoice" %}: {{ object.invoice_number }}</h5>
                        </div>
                    </div>
                </div>

                {% if form.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>يوجد أخطاء في النموذج</h5>
                    <ul class="mb-0">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li><strong>{{ field }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}
                
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="inclusive_tax" value="0">
                    
                    <div class="row">
                        <!-- Basic Invoice Information -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.invoice_number.id_for_label }}" class="form-label">
                                    <i class="fas fa-hashtag text-primary me-1"></i>
                                    رقم ال{% trans "Invoice" %}
                                </label>
                                {{ form.invoice_number }}
                                {% if form.invoice_number.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.invoice_number.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.date.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar text-primary me-1"></i>
                                    {% trans "Date" %}
                                </label>
                                {{ form.date }}
                                {% if form.date.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.date.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.customer.id_for_label }}" class="form-label">
                                    <i class="fas fa-user text-primary me-1"></i>
                                    العميل
                                </label>
                                {{ form.customer }}
                                {% if form.customer.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.customer.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.payment_type.id_for_label }}" class="form-label">
                                    <i class="fas fa-credit-card text-primary me-1"></i>
                                    نوع ال{% trans "Payment" %}
                                </label>
                                {{ form.payment_type }}
                                {% if form.payment_type.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.payment_type.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- صف المستودع -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><i class="fas fa-warehouse me-1"></i> المستودع</label>
                                <select class="form-select" name="warehouse">
                                    <option value="">{% trans "Select Warehouse" %}</option>
                                    {% for warehouse in warehouses %}
                                    <option value="{{ warehouse.id }}" {% if object.warehouse and warehouse.id == object.warehouse.id %}selected{% endif %}>
                                        {{ warehouse.name }} - {{ warehouse.code }}
                                        {% if warehouse.is_default %} (افتراضي){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">{% trans "Select the warehouse from which products will be sold." %}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            {% if can_change_creator %}
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user-edit text-warning me-1"></i> 
                                    {% trans "Created By" %}
                                </label>
                                <select class="form-select" name="created_by">
                                    {% for user in all_users %}
                                    <option value="{{ user.id }}" {% if object.created_by and user.id == object.created_by.id %}selected{% endif %}>
                                        {{ user.get_full_name|default:user.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="form-text text-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    {% trans "Changing the creator requires special permission" %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">
                                    <i class="fas fa-sticky-note text-primary me-1"></i>
                                    ملاحظات
                                </label>
                                {{ form.notes }}
                                {% if form.notes.errors %}
                                    <div class="text-danger mt-1">
                                        {{ form.notes.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Items Display -->
                    <div class="invoice-items">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-list text-primary me-2"></i>
                                عناصر ال{% trans "Invoice" %}
                            </h5>
                            <button type="button" class="btn btn-success btn-sm" id="add-item-btn">
                                <i class="fas fa-plus me-1"></i>
                                إضافة منتج
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-hover" id="invoice-items-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>المنتج</th>
                                        <th>{% trans "Quantity" %}</th>
                                        <th>سعر الوحدة</th>
                                        <th>نسبة الضريبة</th>
                                        <th>مبلغ الضريبة</th>
                                        <th>الإجمالي</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in object.items.all %}
                                    <tr data-item-id="{{ item.id }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="product-name">{{ item.product.name }}</span>
                                                <small class="text-muted ms-2">({{ item.product.code }})</small>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm quantity-input" 
                                                   value="{{ item.quantity }}" min="0.01" step="0.01" 
                                                   data-item-id="{{ item.id }}">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm price-input" 
                                                   value="{{ item.unit_price }}" min="0" step="0.01" 
                                                   data-item-id="{{ item.id }}">
                                        </td>
                                        <td>{{ item.tax_rate }}%</td>
                                        <td class="tax-amount">{{ item.tax_amount|currency_format }}</td>
                                        <td class="total-amount"><strong>{{ item.total_amount|currency_format }}</strong></td>
                                        <td>
                                            <button type="button" class="btn btn-warning btn-sm edit-item-btn" 
                                                    data-item-id="{{ item.id }}">
                                                <i class="fas fa-save"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger btn-sm delete-item-btn" 
                                                    data-item-id="{{ item.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Add New Item Form -->
                        <div id="add-item-form" class="mt-3" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-plus me-2"></i>
                                        إضافة منتج جديد
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">المنتج</label>
                                            <select class="form-select" id="new-product-select">
                                                <option value="">اختر المنتج...</option>
                                                {% for product in products %}
                                                <option value="{{ product.id }}" data-code="{{ product.code }}" 
                                                        data-price="{{ product.sale_price }}" 
                                                        data-tax="{{ product.tax_rate }}">
                                                    {{ product.name }} ({{ product.code }})
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">الكمية</label>
                                            <input type="number" class="form-control" id="new-quantity" 
                                                   min="0.01" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">سعر الوحدة</label>
                                            <input type="number" class="form-control" id="new-price" 
                                                   min="0" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">نسبة الضريبة</label>
                                            <input type="number" class="form-control" id="new-tax-rate" 
                                                   min="0" max="100" step="0.01" placeholder="0.00">
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-success me-2" id="save-new-item-btn">
                                                <i class="fas fa-save me-1"></i>
                                                حفظ
                                            </button>
                                            <button type="button" class="btn btn-secondary" id="cancel-add-item-btn">
                                                <i class="fas fa-times me-1"></i>
                                                إلغاء
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="totals-section">
                            <div class="row">
                                <div class="col-md-6"></div>
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>{% trans "Total" %} الفرعي:</span>
                                        <strong>{{ object.subtotal|currency_format }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>مبلغ الضريبة:</span>
                                        <strong>{{ object.tax_amount|currency_format }}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2 align-items-center">
                                        <div>
                                            <label class="form-check-label me-2">{% trans "شامل ضريبة" %}</label>
                                            <input type="checkbox" id="id_inclusive_tax_edit" name="inclusive_tax" value="1" {% if object.inclusive_tax %}checked{% endif %}
                                                   {% if not user.is_superuser and not perms.sales.can_toggle_invoice_tax %} disabled {% endif %}>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>مبلغ الخصم:</span>
                                        <strong>{{ object.discount_amount|currency_format }}</strong>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <span class="h5">{% trans "Total" %} الإجمالي:</span>
                                        <strong class="h5 text-primary">{{ object.total_amount|currency_format }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end mt-4">
                        <a href="{% url 'sales:invoice_detail' object.pk %}" class="btn btn-secondary me-2">
                            <i class="fas fa-times me-1"></i>
                            إلغاء
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            {% trans "Save" %} التغييرات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    console.log('✅ صفحة تعديل الفاتورة تم تحميلها');
    
    // عداد لإرسال النموذج
    let isSubmitting = false;
    
    // Add form submit listener
    $('form').on('submit', function(e) {
        // منع الإرسال المكرر
        if (isSubmitting) {
            console.log('⏳ النموذج قيد الإرسال...');
            e.preventDefault();
            return false;
        }
        
        console.log('✅ النموذج يتم إرساله...');
        console.log('البيانات:', $(this).serialize());
        
        // تعطيل زر الحفظ
        $('button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> جاري الحفظ...');
        
        isSubmitting = true;
        // السماح للنموذج بالإرسال
        return true;
    });

    // CSRF token setup for AJAX
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Add item button click
    $('#add-item-btn').click(function() {
        $('#add-item-form').slideDown();
        $('#new-product-select').focus();
    });

    // Cancel add item
    $('#cancel-add-item-btn').click(function() {
        $('#add-item-form').slideUp();
        $('#add-item-form input, #add-item-form select').val('');
    });

    // Product selection change - استخدام POS API (بنفس طريقة POS وصفحة الإضافة)
    $('#new-product-select').change(function() {
        const productId = $(this).val();
        
        if (!productId) {
            $('#new-price').val('');
            $('#new-tax-rate').val('');
            return;
        }
        
        // عرض رسالة تحميل
        $('#new-price').val('...').prop('disabled', true);
        $('#new-tax-rate').val('...').prop('disabled', true);
        
        // استدعاء POS API للحصول على السعر الصحيح (بدون ضريبة)
        $.ajax({
            url: `/sales/pos/product/${productId}/`,
            type: 'GET',
            success: function(data) {
                $('#new-price').prop('disabled', false);
                $('#new-tax-rate').prop('disabled', false);
                
                if (data && data.success && data.product) {
                    // استخدام السعر من API (بدون ضريبة)
                    $('#new-price').val(parseFloat(data.product.price || 0).toFixed(3));
                    $('#new-tax-rate').val(parseFloat(data.product.tax_rate || 0).toFixed(2));
                    console.info('✅ السعر من POS API:', data.product.price);
                } else {
                    // في حالة فشل API، استخدام القيم من الـ template
                    const selectedOption = $('#new-product-select').find('option:selected');
                    const fallbackPrice = parseFloat(selectedOption.data('price')) || 0;
                    const fallbackTax = parseFloat(selectedOption.data('tax')) || 0;
                    const calculatedPrice = fallbackTax > 0 ? fallbackPrice / (1 + fallbackTax / 100) : fallbackPrice;
                    
                    $('#new-price').val(calculatedPrice.toFixed(3));
                    $('#new-tax-rate').val(fallbackTax.toFixed(2));
                    console.warn('⚠️ استخدام القيم الاحتياطية');
                }
            },
            error: function(xhr, status, error) {
                $('#new-price').prop('disabled', false);
                $('#new-tax-rate').prop('disabled', false);
                
                // في حالة خطأ، استخدام القيم من الـ template
                const selectedOption = $('#new-product-select').find('option:selected');
                const fallbackPrice = parseFloat(selectedOption.data('price')) || 0;
                const fallbackTax = parseFloat(selectedOption.data('tax')) || 0;
                const calculatedPrice = fallbackTax > 0 ? fallbackPrice / (1 + fallbackTax / 100) : fallbackPrice;
                
                $('#new-price').val(calculatedPrice.toFixed(3));
                $('#new-tax-rate').val(fallbackTax.toFixed(2));
                console.error('❌ خطأ في استدعاء POS API:', error);
            }
        });
    });

    // Save new item
    $('#save-new-item-btn').click(function() {
        const productId = $('#new-product-select').val();
        const quantity = parseFloat($('#new-quantity').val());
        const price = parseFloat($('#new-price').val());
        const taxRate = parseFloat($('#new-tax-rate').val());

        if (!productId || !quantity || !price || taxRate === null) {
            alert('يرجى ملء جميع الحقول');
            return;
        }

        $.ajax({
            url: `/ar/sales/invoices/{{ object.pk }}/items/add/`,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: csrftoken,
                product_id: productId,
                quantity: quantity,
                unit_price: price,
                tax_rate: taxRate
            },
            success: function(response) {
                if (response.success) {
                    location.reload(); // Reload to show updated items
                } else {
                    alert('خطأ: ' + response.message);
                }
            },
            error: function() {
                alert('حدث خطأ أثناء إضافة المنتج');
            }
        });
    });

    // Edit item buttons
    $('.edit-item-btn').click(function() {
        const itemId = $(this).data('item-id');
        const row = $(this).closest('tr');
        const quantity = row.find('.quantity-input').val();
        const price = row.find('.price-input').val();

        $.ajax({
            url: `/ar/sales/invoices/{{ object.pk }}/items/${itemId}/update/`,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: csrftoken,
                quantity: quantity,
                unit_price: price
            },
            success: function(response) {
                if (response.success) {
                    // Update the display values
                    const taxAmount = response.item.tax_amount;
                    const totalAmount = response.item.total_amount;
                    
                    row.find('.tax-amount').html('{{ base_currency.symbol }}' + taxAmount.toFixed(3));
                    row.find('.total-amount strong').html('{{ base_currency.symbol }}' + totalAmount.toFixed(3));
                    
                    // Show success message
                    showMessage('تم تحديث العنصر بنجاح', 'success');
                } else {
                    alert('خطأ: ' + response.message);
                }
            },
            error: function() {
                alert('حدث خطأ أثناء تحديث العنصر');
            }
        });
    });

    // Delete item buttons
    $('.delete-item-btn').click(function() {
        if (!confirm('هل أنت متأكد من حذف هذا العنصر؟')) {
            return;
        }

        const itemId = $(this).data('item-id');

        $.ajax({
            url: `/ar/sales/invoices/{{ object.pk }}/items/${itemId}/delete/`,
            type: 'POST',
            data: {
                csrfmiddlewaretoken: csrftoken
            },
            success: function(response) {
                if (response.success) {
                    location.reload(); // Reload to show updated items
                } else {
                    alert('خطأ: ' + response.message);
                }
            },
            error: function() {
                alert('حدث خطأ أثناء حذف العنصر');
            }
        });
    });

    // Function to show messages
    function showMessage(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        $('.container-fluid').prepend(alertHtml);
        
        // Auto hide after 3 seconds
        setTimeout(function() {
            $('.alert').fadeOut();
        }, 3000);
    }
});
</script>
{% endblock %}
