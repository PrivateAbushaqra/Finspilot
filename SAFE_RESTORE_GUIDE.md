# دليل الاستعادة الآمن (بدون مخاطر)

## ⚠️ قاعدة ذهبية: لا تمسح شيئاً قبل أخذ نسخة احتياطية!

---

## المرحلة 1: حفظ البيانات الحالية (إلزامي) 🔒

### 1.1 نسخة احتياطية من الريموت

**على Render.com:**

1. سجّل دخول إلى النظام
2. اذهب إلى صفحة **النسخ الاحتياطي والاستعادة**
3. اضغط **"إنشاء نسخة احتياطية"**
4. انتظر حتى تكتمل
5. **حمّل الملف** واحفظه في مكان آمن
6. **سمّ الملف:** `render_backup_before_restore_[التاريخ].json`

### 1.2 نسخة احتياطية من PostgreSQL مباشرة

**من Render Dashboard:**

1. اذهب إلى **Database → [your-database]**
2. انقر على **Backups**
3. تأكد من وجود نسخة حديثة
4. إذا لم توجد، أنشئ واحدة يدوياً

---

## المرحلة 2: التشخيص أولاً (قبل أي تعديل) 🔍

### 2.1 فحص البيانات الحالية على الريموت

**على Render Shell:**

```bash
python diagnose_remote.py
```

**اقرأ النتائج واحفظها في ملف:**
- كم عدد السجلات الموجودة؟
- هل المستخدمين موجودين؟
- هل البيانات الأساسية موجودة؟

### 2.2 فحص النسخة الاحتياطية المحلية

**على الجهاز المحلي:**

```bash
python test_backup_restore_full.py
```

**تأكد من:**
- ✅ النسخة المحلية تحتوي على بيانات (عدد السجلات > 0)
- ✅ المستخدمين موجودين في النسخة
- ✅ البيانات الأساسية موجودة

---

## المرحلة 3: الاختبار الآمن (بدون مخاطرة) 🧪

### الخيار الأول: استعادة بدون مسح (آمن)

**الميزة:** لن تخسر أي بيانات، سيتم فقط تحديث/إضافة البيانات الجديدة

**الخطوات:**

1. على الريموت، اذهب إلى صفحة النسخ الاحتياطي
2. **لا تفعّل** خيار "مسح البيانات" ❌
3. ارفع ملف النسخة الاحتياطية المحلية
4. انتظر حتى تكتمل العملية
5. افحص البيانات - هل ظهرت البيانات المحلية؟

**النتيجة المتوقعة:**
- إذا نجحت: ستظهر البيانات المحلية مع الإبقاء على الريموت
- إذا فشلت: البيانات القديمة لا تزال موجودة، لم تخسر شيئاً

### الخيار الثاني: إنشاء قاعدة بيانات تجريبية (الأكثر أماناً)

**على Render:**

1. أنشئ **خدمة جديدة** (مؤقتة) مع قاعدة بيانات جديدة
2. انسخ إعدادات المشروع للخدمة الجديدة
3. جرّب الاستعادة مع "مسح البيانات" على القاعدة التجريبية
4. إذا نجحت، كرّرها على القاعدة الحقيقية
5. إذا فشلت، احذف الخدمة التجريبية - لم تخسر شيئاً!

---

## المرحلة 4: الاستعادة الكاملة (فقط بعد النجاح في الاختبار) ⚡

### شروط الاستعادة الكاملة:

✅ لديك نسخة احتياطية من الريموت محفوظة  
✅ جرّبت الاستعادة بدون مسح ونجحت  
✅ أو جرّبت على قاعدة تجريبية ونجحت  
✅ لديك نسخة احتياطية من PostgreSQL مباشرة  

**فقط بعد استيفاء جميع الشروط:**

1. على الريموت، اذهب إلى صفحة النسخ الاحتياطي
2. **فعّل** خيار "مسح جميع البيانات قبل الاستعادة" ☑️
3. ارفع ملف النسخة الاحتياطية المحلية
4. انتظر حتى تكتمل العملية
5. افحص البيانات

---

## المرحلة 5: خطة الطوارئ (إذا حدث خطأ) 🚨

### إذا فشلت الاستعادة:

#### الخطوة 1: استعادة نسخة الريموت الأصلية

```bash
# على Render Shell
python manage.py shell
```

```python
# داخل Shell
from backup.views import perform_backup_restore, load_backup_from_xlsx
import json

# استعادة النسخة الأصلية التي حفظتها
with open('render_backup_before_restore_[التاريخ].json', 'r') as f:
    backup_data = json.load(f)

perform_backup_restore(backup_data, clear_data=True, user=None)
```

#### الخطوة 2: استعادة من PostgreSQL Backup

**من Render Dashboard:**

1. اذهب إلى **Database → Backups**
2. اختر النسخة التي أخذتها قبل الاستعادة
3. انقر **Restore**

---

## التحقق من نجاح الاستعادة ✅

### بعد كل استعادة، نفّذ:

```bash
python diagnose_remote.py
```

**تحقق من:**

1. ✅ عدد السجلات يطابق النسخة المحلية (أو قريب منها)
2. ✅ المستخدمين موجودين ويمكن تسجيل الدخول
3. ✅ البيانات الأساسية ظاهرة (منتجات، عملاء، فواتير)
4. ✅ يمكن فتح الصفحات بدون أخطاء
5. ✅ يمكن إنشاء سجلات جديدة

---

## سيناريوهات المشاكل وحلولها

### السيناريو 1: الاستعادة تكتمل لكن لا توجد بيانات

**التشخيص:**
```bash
python diagnose_remote.py
```

**إذا كانت النتيجة "0 سجلات":**
- المشكلة في عملية الاستعادة نفسها
- افحص Render Logs للأخطاء
- جرّب نسخة أصغر أولاً

### السيناريو 2: البيانات موجودة لكن لا تظهر في الواجهة

**التشخيص:**
```bash
python diagnose_remote.py
```

**إذا كانت النتيجة "8000+ سجلات":**
- البيانات موجودة فعلاً!
- المشكلة في عرض الواجهة
- الحل: سجّل خروج ودخول، امسح Cache

### السيناريو 3: أخطاء Foreign Key أثناء الاستعادة

**الأعراض:**
```
FK_NOT_FOUND: user_id=5
IntegrityError: foreign key constraint
```

**الحل:**
1. تأكد من وجود جميع المستخدمين في النسخة
2. استخدم خيار "مسح البيانات" لتجنب التضاربات
3. تحقق من ترتيب الاستعادة (المستخدمين أولاً)

---

## الخلاصة النهائية

### ✅ افعل:
1. خذ نسخة احتياطية من الريموت أولاً (JSON + PostgreSQL)
2. اختبر باستعادة بدون مسح أولاً
3. أو اختبر على قاعدة تجريبية
4. احتفظ بجميع النسخ الاحتياطية في أماكن متعددة

### ❌ لا تفعل:
1. لا تمسح البيانات بدون نسخة احتياطية
2. لا تستعد مباشرة مع "مسح البيانات" بدون اختبار
3. لا تثق بنسخة احتياطية واحدة فقط
4. لا تحذف النسخ القديمة فوراً

---

## الأمان أولاً! 🛡️

**قاعدة 3-2-1 للنسخ الاحتياطي:**
- **3** نسخ من بياناتك
- **2** صيغ مختلفة (JSON + PostgreSQL dump)
- **1** نسخة خارج الخادم (على جهازك المحلي)

**مع هذا الدليل، لن تخسر أي بيانات مهما حدث!**
