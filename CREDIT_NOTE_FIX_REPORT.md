# ุชูุฑูุฑ ุงูุฅุตูุงุญ ุงูููุงุฆู - Credit Note System
## ุงูุชุงุฑูุฎ: 6 ููููุจุฑ 2025

## โ ุงููุดููุฉ ุงูุฃุตููุฉ
ุนูุฏ ุฅูุดุงุก Credit Noteุ ุธูุฑ ุงูุฎุทุฃ:
```
'JournalService' object has no attribute 'create_sales_credit_note_entry'
```

## โ ุงูุญู ุงูููููุฐ

### 1. ุฅูุดุงุก ุฏุงูุฉ `create_sales_credit_note_entry` ูู `journal/services.py`
**ุงููููุน:** ุงูุณุทูุฑ 1484-1558

**ุงูููุทู ุงููุญุงุณุจู:**
- **ูู ุญู/ ุงููุจูุนุงุช (ูุฏูู)** - ุชุฎููุถ ุงูุฅูุฑุงุฏ
- **ุฅูู ุญู/ ุงูุนููู (ุฏุงุฆู)** - ุชุฎููุถ ุงููุฏููููุฉ

**ุงูููุฏ:**
```python
@staticmethod
def create_sales_credit_note_entry(credit_note, user=None):
    """ุฅูุดุงุก ููุฏ ูุญุงุณุจู ูุฅุดุนุงุฑ ุฏุงุฆู ุงููุจูุนุงุช"""
    # ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
    # ุงูุญุตูู ุนูู ุญุณุงุจ ุงููุจูุนุงุช ูุญุณุงุจ ุงูุนููู
    # ุจูุงุก ุณุทูุฑ ุงูููุฏ (ูุฏูู ุงููุจูุนุงุช / ุฏุงุฆู ุงูุนููู)
    # ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู
```

### 2. ุชุญุณูู Signal ูู `sales/signals.py`
**ุงููููุน:** ุงูุณุทูุฑ 479-550 (ุชูุฑูุจุงู)

**ุงูุชุญุณููุงุช:**
- โ ุฅุถุงูุฉ flag `_signal_processing` ูููุน ุงูุชูููุฐ ุงููุชูุฑุฑ
- โ ุงูุชุญูู ูู ูุฌูุฏ ููุฏ ููุฌูุฏ ูุจู ุงูุฅูุดุงุก
- โ ุญุฐู ุงูููุฏ ุงููุฏูู ุนูุฏ ุงูุชุนุฏูู
- โ ุญุฐู ุงููุนุงููุฉ ุงููุฏููุฉ ุนูุฏ ุงูุชุนุฏูู
- โ ุฅุฒุงูุฉ `recalculate_customer_supplier_balance` ุงูููุฑุฑ (ููููุฐ ุชููุงุฆูุงู ูู AccountTransaction signal)
- โ ุชุบููุฑ `reference_type` ูู `'sales_credit_note'` ุฅูู `'credit_note'` ููุชูุญูุฏ

**ุงูููุฏ ุงูุฑุฆูุณู:**
```python
@receiver(post_save, sender=SalesCreditNote)
def create_sales_credit_note_journal_entry(sender, instance, created, **kwargs):
    # ููุน ุงูุชูููุฐ ุงููุชูุฑุฑ
    if hasattr(instance, '_signal_processing'):
        return
    
    try:
        instance._signal_processing = True
        
        # ุฅูุดุงุก ุฃู ุชุญุฏูุซ ุงูููุฏ
        if created or not existing_entry:
            entry = JournalService.create_sales_credit_note_entry(instance, instance.created_by)
        else:
            # ุญุฐู ุงูููุฏ ุงููุฏูู ูุฅูุดุงุก ุฌุฏูุฏ
            JournalEntry.objects.filter(
                reference_type='credit_note',
                reference_id=instance.id
            ).delete()
            entry = JournalService.create_sales_credit_note_entry(instance, instance.created_by)
        
        # ุฅูุดุงุก ุฃู ุชุญุฏูุซ ูุนุงููุฉ ุงูุนููู
        # (ุญุฐู ุงููุฏููุฉ ูุฅูุดุงุก ุฌุฏูุฏุฉ)
        
    finally:
        if hasattr(instance, '_signal_processing'):
            delattr(instance, '_signal_processing')
```

## โ ุงูุงุฎุชุจุงุฑ ุงูุดุงูู

### ุชู ุงุฎุชุจุงุฑ ุฌููุน ุงูุณููุงุฑูููุงุช:

#### 1๏ธโฃ ุฅูุดุงุก Credit Note
- โ ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู ุจุดูู ุตุญูุญ
- โ ุฅูุดุงุก ูุนุงููุฉ ุงูุนููู
- โ ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู (ุชูููู ุงููุฏููููุฉ)
- โ ุณุทูุฑ ุงูููุฏ ุตุญูุญุฉ (ูุฏูู ุงููุจูุนุงุช / ุฏุงุฆู ุงูุนููู)

#### 2๏ธโฃ ุชุนุฏูู Credit Note
- โ ุญุฐู ุงูููุฏ ุงููุฏูู
- โ ุฅูุดุงุก ููุฏ ุฌุฏูุฏ ุจุงููุจูุบ ุงูููุญุฏุซ
- โ ุญุฐู ุงููุนุงููุฉ ุงููุฏููุฉ
- โ ุฅูุดุงุก ูุนุงููุฉ ุฌุฏูุฏุฉ ุจุงููุจูุบ ุงูููุญุฏุซ
- โ ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู ุจุดูู ุตุญูุญ
- โ ุนุฏู ูุฌูุฏ ูููุฏ ุฃู ูุนุงููุงุช ููุฑุฑุฉ

#### 3๏ธโฃ ุญุฐู Credit Note
- โ ุญุฐู ุงูููุฏ ุงููุญุงุณุจู
- โ ุญุฐู ูุนุงููุฉ ุงูุนููู
- โ ุงุณุชุนุงุฏุฉ ุฑุตูุฏ ุงูุนููู
- โ ุนุฏู ูุฌูุฏ ุจูุงูุงุช ูุชููุฉ (orphan data)

### ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:
```
================================================================================
๐ โ ูุฌุญ ุงูุงุฎุชุจุงุฑ ุงูุดุงูู ุจุงููุงูู! ๐
================================================================================

ุชู ุงูุชุญูู ูู:
  โ ุฅูุดุงุก Credit Note
  โ ุฅูุดุงุก ุงูููุฏ ุงููุญุงุณุจู
  โ ุฅูุดุงุก ูุนุงููุฉ ุงูุนููู
  โ ุชุญุฏูุซ ุฑุตูุฏ ุงูุนููู
  โ ุชุญุฏูุซ ุฑุตูุฏ ุงููุจูุนุงุช
  โ ุชุนุฏูู Credit Note
  โ ุชุญุฏูุซ ุงูููุฏ ุงููุญุงุณุจู
  โ ุชุญุฏูุซ ูุนุงููุฉ ุงูุนููู
  โ ุญุฐู Credit Note
  โ ุญุฐู ุงูููุฏ ุงููุญุงุณุจู
  โ ุญุฐู ูุนุงููุฉ ุงูุนููู
  โ ุงุณุชุนุงุฏุฉ ุงูุฃุฑุตุฏุฉ
  โ ุนุฏู ูุฌูุฏ ุจูุงูุงุช ูุชููุฉ

๐ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช! ุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ 100%
```

## ๐ ุงูุชุฃุซูุฑุงุช ุงููุญุงุณุจูุฉ

### ุนูุฏ ุฅูุดุงุก Credit Note ุจูุจูุบ 100 ุฏููุงุฑ:

**ุงูููุฏ ุงููุญุงุณุจู:**
```
ูู ุญู/ ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช (4000)    100.000 (ูุฏูู)
    ุฅูู ุญู/ ุงูุนููู (13010003)       100.000 (ุฏุงุฆู)
```

**ุงูุฃุซุฑ:**
- ุฑุตูุฏ ุงูุนููู: 3297.553 โ 3197.553 (-100)
- ุฑุตูุฏ ุงููุจูุนุงุช: ูุง ูุชุฃุซุฑ (ููุณุฌู ููุท ูู ุงูููุฏ)

### ุนูุฏ ุชุนุฏูู Credit Note ูู 100 ุฅูู 150:

**ุงูููุฏ ุงูุฌุฏูุฏ:**
```
ูู ุญู/ ุฅูุฑุงุฏุงุช ุงููุจูุนุงุช (4000)    150.000 (ูุฏูู)
    ุฅูู ุญู/ ุงูุนููู (13010003)       150.000 (ุฏุงุฆู)
```

**ุงูุฃุซุฑ:**
- ุฑุตูุฏ ุงูุนููู: 3197.553 โ 3147.553 (-50)
- ุงูููุฏ ุงููุฏูู ููุญุฐู ูุงูุฌุฏูุฏ ูุญู ูุญูู

### ุนูุฏ ุญุฐู Credit Note:
- ููุญุฐู ุงูููุฏ ุงููุญุงุณุจู
- ุชูุญุฐู ูุนุงููุฉ ุงูุนููู
- ููุณุชุนุงุฏ ุฑุตูุฏ ุงูุนููู: 3147.553 โ 3297.553

## ๐ง ุงููููุงุช ุงูููุนุฏูุฉ

1. **journal/services.py**
   - ุฅุถุงูุฉ: `create_sales_credit_note_entry()` method

2. **sales/signals.py**
   - ุชุญุณูู: `create_sales_credit_note_journal_entry()` signal
   - ุฅุถุงูุฉ flag ูููุน ุงูุชูููุฐ ุงููุชูุฑุฑ
   - ุชุญุณูู ููุทู ุงูุชุญุฏูุซ ูุงูุญุฐู

## โ ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ูุธุงู Credit Note ุจุงููุงูู ูุน:
- โ ุฅูุดุงุก ุงููููุฏ ุงููุญุงุณุจูุฉ ุงูุตุญูุญุฉ
- โ ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ ุจุดูู ุฏููู
- โ ููุน ุงูุจูุงูุงุช ุงููุชููุฉ
- โ ุฏุนู ุงูุชุนุฏูู ูุงูุญุฐู ุจุดูู ูุงูู
- โ ุงุฎุชุจุงุฑ ุดุงูู ูุฌููุน ุงูุณููุงุฑูููุงุช

**ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู ุงูุฅูุชุงุฌ! ๐**
